<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: KBRTestApp.cc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OverSim
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('KBRTestApp_8cc.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">KBRTestApp.cc</div>  </div>
</div>
<div class="contents">
<a href="KBRTestApp_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2006 Institut fuer Telematik, Universitaet Karlsruhe (TH)</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment">// modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment">// GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment">// along with this program; if not, write to the Free Software</span>
<a name="l00016"></a>00016 <span class="comment">// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;IPAddressResolver.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="CommonMessages__m_8h.html">CommonMessages_m.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="GlobalStatistics_8h.html">GlobalStatistics.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="code" href="UnderlayConfigurator_8h.html">UnderlayConfigurator.h</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="code" href="GlobalNodeList_8h.html">GlobalNodeList.h</a>&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="KBRTestApp_8h.html">KBRTestApp.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="KBRTestMessage__m_8h.html">KBRTestMessage_m.h</a>&quot;</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <a class="code" href="ALMTest_8cc.html#a3b5014f410c7989e8bad4b467ecc94cd">Define_Module</a>(<a class="code" href="classKBRTestApp.html" title="Test application for KBR interface.">KBRTestApp</a>);
<a name="l00034"></a>00034 
<a name="l00035"></a><a class="code" href="classKBRTestApp.html#a3ffbda9662ea20986ea2e0856a0c89f4">00035</a> <a class="code" href="classKBRTestApp.html#a3ffbda9662ea20986ea2e0856a0c89f4">KBRTestApp::KBRTestApp</a>()
<a name="l00036"></a>00036 {
<a name="l00037"></a>00037     <a class="code" href="classKBRTestApp.html#ae5be1d5ec79f8e69184fa221d1b3d3d0">onewayTimer</a> = NULL;
<a name="l00038"></a>00038     <a class="code" href="classKBRTestApp.html#a13818c2e1fb89ff3639fc4dc48962100">rpcTimer</a> = NULL;
<a name="l00039"></a>00039     <a class="code" href="classKBRTestApp.html#a2f4f7a5ef238222fdcf9cc890ab5c40f">lookupTimer</a> = NULL;
<a name="l00040"></a>00040     <a class="code" href="classKBRTestApp.html#ad5ac3f97138ebeaf211db5d5b48d505b">underlayTimer</a> = NULL;
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a><a class="code" href="classKBRTestApp.html#a6f65cfb13966c697b51b0ab5c02b2503">00043</a> <a class="code" href="classKBRTestApp.html#a6f65cfb13966c697b51b0ab5c02b2503">KBRTestApp::~KBRTestApp</a>()
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045     cancelAndDelete(<a class="code" href="classKBRTestApp.html#ae5be1d5ec79f8e69184fa221d1b3d3d0">onewayTimer</a>);
<a name="l00046"></a>00046     cancelAndDelete(<a class="code" href="classKBRTestApp.html#a13818c2e1fb89ff3639fc4dc48962100">rpcTimer</a>);
<a name="l00047"></a>00047     cancelAndDelete(<a class="code" href="classKBRTestApp.html#a2f4f7a5ef238222fdcf9cc890ab5c40f">lookupTimer</a>);
<a name="l00048"></a>00048     cancelAndDelete(<a class="code" href="classKBRTestApp.html#ad5ac3f97138ebeaf211db5d5b48d505b">underlayTimer</a>);
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="classKBRTestApp.html#a40381ef6a970530fa0706d138fe256f6">00051</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#a40381ef6a970530fa0706d138fe256f6" title="initializes derived class-attributes">KBRTestApp::initializeApp</a>(<span class="keywordtype">int</span> stage)
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053     <span class="keywordflow">if</span> (stage != <a class="code" href="InitStages_8h.html#a42fde1aa1e14a1c45d29061d6e87e532ad9afa81d0184c5f0649fa111f7a821bc" title="deprecated">MIN_STAGE_APP</a>) {
<a name="l00054"></a>00054         <span class="keywordflow">return</span>;
<a name="l00055"></a>00055     }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     <a class="code" href="classKBRTestApp.html#afd14f68bbfff247b4f32498e5b241993">kbrOneWayTest</a> = par(<span class="stringliteral">&quot;kbrOneWayTest&quot;</span>);
<a name="l00058"></a>00058     <a class="code" href="classKBRTestApp.html#a64f89ade2d0af91791f6524b7b08cc29">kbrRpcTest</a> = par(<span class="stringliteral">&quot;kbrRpcTest&quot;</span>);
<a name="l00059"></a>00059     <a class="code" href="classKBRTestApp.html#aea8edb2d1c871881b1090c93b0325338">kbrLookupTest</a> = par(<span class="stringliteral">&quot;kbrLookupTest&quot;</span>);
<a name="l00060"></a>00060     <a class="code" href="classKBRTestApp.html#aaf1a1a1fdbaa133fb8dc06d4dc6c9093">underlayTest</a> = par(<span class="stringliteral">&quot;underlayTest&quot;</span>);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     <span class="keywordflow">if</span> (!<a class="code" href="classKBRTestApp.html#afd14f68bbfff247b4f32498e5b241993">kbrOneWayTest</a> &amp;&amp; !<a class="code" href="classKBRTestApp.html#a64f89ade2d0af91791f6524b7b08cc29">kbrRpcTest</a> &amp;&amp; !<a class="code" href="classKBRTestApp.html#aea8edb2d1c871881b1090c93b0325338">kbrLookupTest</a> &amp;&amp; !<a class="code" href="classKBRTestApp.html#aaf1a1a1fdbaa133fb8dc06d4dc6c9093">underlayTest</a>) {
<a name="l00063"></a>00063         <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;KBRTestApp::initializeApp(): &quot;</span>
<a name="l00064"></a>00064                             <span class="stringliteral">&quot;no tests are configured!&quot;</span>);
<a name="l00065"></a>00065     }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067     <a class="code" href="classKBRTestApp.html#ab7d25f9b4fd4445596114c7ae1912496" title="this latency is recorded for failed lookups and RPCs">failureLatency</a> = par(<span class="stringliteral">&quot;failureLatency&quot;</span>);
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <a class="code" href="classKBRTestApp.html#af332ff958983a9bb25252feba3e2590e">testMsgSize</a> = par(<span class="stringliteral">&quot;testMsgSize&quot;</span>);
<a name="l00070"></a>00070     <a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a> = par(<span class="stringliteral">&quot;lookupNodeIds&quot;</span>);
<a name="l00071"></a>00071     <a class="code" href="classKBRTestApp.html#a73450fb0a1503f2751c75d8cf9d51e04" title="mean time interval between sending test messages">mean</a> = par(<span class="stringliteral">&quot;testMsgInterval&quot;</span>);
<a name="l00072"></a>00072     <a class="code" href="classKBRTestApp.html#af8c8a7e64e6ed514be5cd90920dd115e" title="deviation of time interval">deviation</a> = <a class="code" href="classKBRTestApp.html#a73450fb0a1503f2751c75d8cf9d51e04" title="mean time interval between sending test messages">mean</a> / 10;
<a name="l00073"></a>00073     <a class="code" href="classKBRTestApp.html#a5664ac71c5ceb3cc70e710717c8888e2" title="is app active in network init phase?">activeNetwInitPhase</a> = par(<span class="stringliteral">&quot;activeNetwInitPhase&quot;</span>);
<a name="l00074"></a>00074     <a class="code" href="classKBRTestApp.html#af60509b56e28684a4eb49f25df6552f6" title="how many MsgHandles to store in circular buffer">msgHandleBufSize</a> = par(<span class="stringliteral">&quot;msgHandleBufSize&quot;</span>);
<a name="l00075"></a>00075     <a class="code" href="classKBRTestApp.html#a833410beacd955fe47a27bbf7f29107f" title="if true only search for inoffensive nodes (use together with lookupNodeIds)">onlyLookupInoffensiveNodes</a> = par(<span class="stringliteral">&quot;onlyLookupInoffensiveNodes&quot;</span>);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">//rpcTimeout = par(&quot;rpcTimeout&quot;);</span>
<a name="l00078"></a>00078     <a class="code" href="classKBRTestApp.html#a41dcfc5b05deda0623530dd85bc3fc74">rpcRetries</a> = par(<span class="stringliteral">&quot;rpcRetries&quot;</span>);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080     <a class="code" href="classKBRTestApp.html#a8ce13256ea63aa80192971d5c2ac50cc">numSent</a> = 0;
<a name="l00081"></a>00081     <a class="code" href="classKBRTestApp.html#a52e5ba5ffe02fd9800db83b15a796b40">bytesSent</a> = 0;
<a name="l00082"></a>00082     <a class="code" href="classKBRTestApp.html#a12358b55f911eed27f411a402e308542" title="number of delivered packets">numDelivered</a> = 0;
<a name="l00083"></a>00083     <a class="code" href="classKBRTestApp.html#ad71a94daa5c574ab6d57c1baa984bc9d" title="number of delivered bytes">bytesDelivered</a> = 0;
<a name="l00084"></a>00084     <a class="code" href="classKBRTestApp.html#a0b9c2e82f3287e4200d6f12d26371739">numDropped</a> = 0;
<a name="l00085"></a>00085     <a class="code" href="classKBRTestApp.html#a3243446a1be631c71455e80d8c25e475">bytesDropped</a> = 0;
<a name="l00086"></a>00086     WATCH(<a class="code" href="classKBRTestApp.html#a8ce13256ea63aa80192971d5c2ac50cc">numSent</a>);
<a name="l00087"></a>00087     WATCH(<a class="code" href="classKBRTestApp.html#a52e5ba5ffe02fd9800db83b15a796b40">bytesSent</a>);
<a name="l00088"></a>00088     WATCH(<a class="code" href="classKBRTestApp.html#a12358b55f911eed27f411a402e308542" title="number of delivered packets">numDelivered</a>);
<a name="l00089"></a>00089     WATCH(<a class="code" href="classKBRTestApp.html#ad71a94daa5c574ab6d57c1baa984bc9d" title="number of delivered bytes">bytesDelivered</a>);
<a name="l00090"></a>00090     WATCH(<a class="code" href="classKBRTestApp.html#a0b9c2e82f3287e4200d6f12d26371739">numDropped</a>);
<a name="l00091"></a>00091     WATCH(<a class="code" href="classKBRTestApp.html#a3243446a1be631c71455e80d8c25e475">bytesDropped</a>);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     <a class="code" href="classKBRTestApp.html#aafa44894b8e262682596aea6b235bcf1">numRpcSent</a> = 0;
<a name="l00094"></a>00094     <a class="code" href="classKBRTestApp.html#a2d746dbca5bf7f81ac484c763c651cf1">bytesRpcSent</a> = 0;
<a name="l00095"></a>00095     <a class="code" href="classKBRTestApp.html#ad9ea83ac232db846335c38619e6d9d04" title="number of delivered packets">numRpcDelivered</a> = 0;
<a name="l00096"></a>00096     <a class="code" href="classKBRTestApp.html#ac9287ba30b44d05c1f1e2b3af6e0f2e4" title="number of delivered bytes">bytesRpcDelivered</a> = 0;
<a name="l00097"></a>00097     <a class="code" href="classKBRTestApp.html#a837931e670a4117501d5b5d06d91a147">numRpcDropped</a> = 0;
<a name="l00098"></a>00098     <a class="code" href="classKBRTestApp.html#a1c76cf2493d997bea95577ad53792e5a">bytesRpcDropped</a> = 0;
<a name="l00099"></a>00099     <a class="code" href="classKBRTestApp.html#ae755fda691b0e7b8ed23b318c52871f8">rpcSuccLatencyCount</a> = 0;
<a name="l00100"></a>00100     <a class="code" href="classKBRTestApp.html#aeb37374bdf671e95a65ce93143cb2afc">rpcSuccLatencySum</a> = 0;
<a name="l00101"></a>00101     <a class="code" href="classKBRTestApp.html#acb9b120ab10edc6a08b554e7ea6f732b">rpcTotalLatencyCount</a> = 0;
<a name="l00102"></a>00102     <a class="code" href="classKBRTestApp.html#af4d1d4d8f6c1e5ce301b25ca958cc2e5">rpcTotalLatencySum</a> = 0;
<a name="l00103"></a>00103     WATCH(<a class="code" href="classKBRTestApp.html#aafa44894b8e262682596aea6b235bcf1">numRpcSent</a>);
<a name="l00104"></a>00104     WATCH(<a class="code" href="classKBRTestApp.html#a2d746dbca5bf7f81ac484c763c651cf1">bytesRpcSent</a>);
<a name="l00105"></a>00105     WATCH(<a class="code" href="classKBRTestApp.html#ad9ea83ac232db846335c38619e6d9d04" title="number of delivered packets">numRpcDelivered</a>);
<a name="l00106"></a>00106     WATCH(<a class="code" href="classKBRTestApp.html#ac9287ba30b44d05c1f1e2b3af6e0f2e4" title="number of delivered bytes">bytesRpcDelivered</a>);
<a name="l00107"></a>00107     WATCH(<a class="code" href="classKBRTestApp.html#a837931e670a4117501d5b5d06d91a147">numRpcDropped</a>);
<a name="l00108"></a>00108     WATCH(<a class="code" href="classKBRTestApp.html#a1c76cf2493d997bea95577ad53792e5a">bytesRpcDropped</a>);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110     <a class="code" href="classKBRTestApp.html#a7d87083e30472441f161c47b617a427f">numLookupSent</a> = 0;
<a name="l00111"></a>00111     <a class="code" href="classKBRTestApp.html#a627fe29d5bed8ea2d7f1b2fbe2881e53">numLookupSuccess</a> = 0;
<a name="l00112"></a>00112     <a class="code" href="classKBRTestApp.html#ae243723c9d57797ed147e668c953f6ae">numLookupFailed</a> = 0;
<a name="l00113"></a>00113     WATCH(<a class="code" href="classKBRTestApp.html#a7d87083e30472441f161c47b617a427f">numLookupSent</a>);
<a name="l00114"></a>00114     WATCH(<a class="code" href="classKBRTestApp.html#a627fe29d5bed8ea2d7f1b2fbe2881e53">numLookupSuccess</a>);
<a name="l00115"></a>00115     WATCH(<a class="code" href="classKBRTestApp.html#ae243723c9d57797ed147e668c953f6ae">numLookupFailed</a>);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <a class="code" href="classKBRTestApp.html#aa3ce14b7182753ccf770d6aeb74913f9">numUnderlaySent</a> = 0;
<a name="l00118"></a>00118     <a class="code" href="classKBRTestApp.html#a509fe672ed218ffeaa255fd2b45a6ef3">bytesUnderlaySent</a> = 0;
<a name="l00119"></a>00119     <a class="code" href="classKBRTestApp.html#a207c30de6b17507d64187fd78d7f705e" title="number of delivered packets">numUnderlayDelivered</a> = 0;
<a name="l00120"></a>00120     <a class="code" href="classKBRTestApp.html#a1d7a3ba320bc3046d87262d7fd7722b1" title="number of delivered bytes">bytesUnderlayDelivered</a> = 0;
<a name="l00121"></a>00121     WATCH(<a class="code" href="classKBRTestApp.html#aa3ce14b7182753ccf770d6aeb74913f9">numUnderlaySent</a>);
<a name="l00122"></a>00122     WATCH(<a class="code" href="classKBRTestApp.html#a509fe672ed218ffeaa255fd2b45a6ef3">bytesUnderlaySent</a>);
<a name="l00123"></a>00123     WATCH(<a class="code" href="classKBRTestApp.html#a207c30de6b17507d64187fd78d7f705e" title="number of delivered packets">numUnderlayDelivered</a>);
<a name="l00124"></a>00124     WATCH(<a class="code" href="classKBRTestApp.html#a1d7a3ba320bc3046d87262d7fd7722b1" title="number of delivered bytes">bytesUnderlayDelivered</a>);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <a class="code" href="classKBRTestApp.html#a6ef9eba5d0b033538a778f288f4a4654">sequenceNumber</a> = 0;
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <a class="code" href="classKBRTestApp.html#a567d933d3c6a8f0c1d0194c5e779dbea" title="true if the node is going to be killed shortly">nodeIsLeavingSoon</a> = <span class="keyword">false</span>;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <span class="comment">// initialize circular buffer</span>
<a name="l00131"></a>00131     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#af60509b56e28684a4eb49f25df6552f6" title="how many MsgHandles to store in circular buffer">msgHandleBufSize</a> &gt; 0) {
<a name="l00132"></a>00132         <a class="code" href="classKBRTestApp.html#a5af0e7b9efe2ae1aad0d815f19ef25e8" title="circular buffer of MsgHandles">mhBuf</a>.resize(<a class="code" href="classKBRTestApp.html#af60509b56e28684a4eb49f25df6552f6" title="how many MsgHandles to store in circular buffer">msgHandleBufSize</a>);
<a name="l00133"></a>00133         <a class="code" href="classKBRTestApp.html#a3485ceb9284504b412d371e9eecaf27f" title="begin of circular buffer">mhBufBegin</a> = <a class="code" href="classKBRTestApp.html#a5af0e7b9efe2ae1aad0d815f19ef25e8" title="circular buffer of MsgHandles">mhBuf</a>.begin();
<a name="l00134"></a>00134         <a class="code" href="classKBRTestApp.html#a9a44c784eb9297c7b8fadf276a358c9f" title="end of circular buffer">mhBufEnd</a> = <a class="code" href="classKBRTestApp.html#a5af0e7b9efe2ae1aad0d815f19ef25e8" title="circular buffer of MsgHandles">mhBuf</a>.end();
<a name="l00135"></a>00135         <a class="code" href="classKBRTestApp.html#a26eff89ff4d9ea19681a4e2df67e7332" title="next element to insert">mhBufNext</a> = <a class="code" href="classKBRTestApp.html#a3485ceb9284504b412d371e9eecaf27f" title="begin of circular buffer">mhBufBegin</a>;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <a class="code" href="classBaseApp.html#a3fb90c6906b6a742246af14e4626dfef" title="Tells UDP we want to get all packets arriving on the given port.">bindToPort</a>(1025);
<a name="l00139"></a>00139     <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a46a1b53760e5f2d3f8af8c9591160a48" title="sets this-&gt;port to the given port">setPort</a>(1025);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">// start periodic timer</span>
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#afd14f68bbfff247b4f32498e5b241993">kbrOneWayTest</a>) {
<a name="l00143"></a>00143         <a class="code" href="classKBRTestApp.html#ae5be1d5ec79f8e69184fa221d1b3d3d0">onewayTimer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;onewayTimer&quot;</span>);
<a name="l00144"></a>00144         scheduleAt(simTime() + truncnormal(<a class="code" href="classKBRTestApp.html#a73450fb0a1503f2751c75d8cf9d51e04" title="mean time interval between sending test messages">mean</a>, <a class="code" href="classKBRTestApp.html#af8c8a7e64e6ed514be5cd90920dd115e" title="deviation of time interval">deviation</a>), <a class="code" href="classKBRTestApp.html#ae5be1d5ec79f8e69184fa221d1b3d3d0">onewayTimer</a>);
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#a64f89ade2d0af91791f6524b7b08cc29">kbrRpcTest</a>) {
<a name="l00147"></a>00147         <a class="code" href="classKBRTestApp.html#a13818c2e1fb89ff3639fc4dc48962100">rpcTimer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;rpcTimer&quot;</span>);
<a name="l00148"></a>00148         scheduleAt(simTime() + truncnormal(<a class="code" href="classKBRTestApp.html#a73450fb0a1503f2751c75d8cf9d51e04" title="mean time interval between sending test messages">mean</a>, <a class="code" href="classKBRTestApp.html#af8c8a7e64e6ed514be5cd90920dd115e" title="deviation of time interval">deviation</a>), <a class="code" href="classKBRTestApp.html#a13818c2e1fb89ff3639fc4dc48962100">rpcTimer</a>);
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#aea8edb2d1c871881b1090c93b0325338">kbrLookupTest</a>) {
<a name="l00151"></a>00151         <a class="code" href="classKBRTestApp.html#a2f4f7a5ef238222fdcf9cc890ab5c40f">lookupTimer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;lookupTimer&quot;</span>);
<a name="l00152"></a>00152         scheduleAt(simTime() + truncnormal(<a class="code" href="classKBRTestApp.html#a73450fb0a1503f2751c75d8cf9d51e04" title="mean time interval between sending test messages">mean</a>, <a class="code" href="classKBRTestApp.html#af8c8a7e64e6ed514be5cd90920dd115e" title="deviation of time interval">deviation</a>), <a class="code" href="classKBRTestApp.html#a2f4f7a5ef238222fdcf9cc890ab5c40f">lookupTimer</a>);
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#aaf1a1a1fdbaa133fb8dc06d4dc6c9093">underlayTest</a>) {
<a name="l00155"></a>00155         <a class="code" href="classKBRTestApp.html#ad5ac3f97138ebeaf211db5d5b48d505b">underlayTimer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;underlayTimer&quot;</span>);
<a name="l00156"></a>00156         scheduleAt(simTime() + truncnormal(<a class="code" href="classKBRTestApp.html#a73450fb0a1503f2751c75d8cf9d51e04" title="mean time interval between sending test messages">mean</a>, <a class="code" href="classKBRTestApp.html#af8c8a7e64e6ed514be5cd90920dd115e" title="deviation of time interval">deviation</a>), <a class="code" href="classKBRTestApp.html#ad5ac3f97138ebeaf211db5d5b48d505b">underlayTimer</a>);
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="classKBRTestApp.html#a544559c72c244032558522e8345bf6a1">00160</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#a544559c72c244032558522e8345bf6a1">KBRTestApp::handleTimerEvent</a>(cMessage* msg)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <span class="comment">// schedule next timer event</span>
<a name="l00163"></a>00163     scheduleAt(simTime() + truncnormal(<a class="code" href="classKBRTestApp.html#a73450fb0a1503f2751c75d8cf9d51e04" title="mean time interval between sending test messages">mean</a>, <a class="code" href="classKBRTestApp.html#af8c8a7e64e6ed514be5cd90920dd115e" title="deviation of time interval">deviation</a>), msg);
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="comment">// do nothing if the network is still in the initialization phase</span>
<a name="l00166"></a>00166     <span class="keywordflow">if</span> ((!<a class="code" href="classKBRTestApp.html#a5664ac71c5ceb3cc70e710717c8888e2" title="is app active in network init phase?">activeNetwInitPhase</a> &amp;&amp; <a class="code" href="classBaseApp.html#a0587e13700e8641eec8143628dfd34cd" title="pointer to UnderlayConfigurator in this node">underlayConfigurator</a>-&gt;<a class="code" href="classUnderlayConfigurator.html#a00c2e85286a38799c7a04edb52ae6e76" title="still in initialization phase?">isInInitPhase</a>())
<a name="l00167"></a>00167             || <a class="code" href="classBaseApp.html#a0587e13700e8641eec8143628dfd34cd" title="pointer to UnderlayConfigurator in this node">underlayConfigurator</a>-&gt;<a class="code" href="classUnderlayConfigurator.html#abf1b95b990ec72831e5b288b5fb3b013" title="Is the simulation ending soon?">isSimulationEndingSoon</a>()
<a name="l00168"></a>00168             || <a class="code" href="classKBRTestApp.html#a567d933d3c6a8f0c1d0194c5e779dbea" title="true if the node is going to be killed shortly">nodeIsLeavingSoon</a>) {
<a name="l00169"></a>00169         <span class="keywordflow">return</span>;
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keywordflow">if</span> (msg == <a class="code" href="classKBRTestApp.html#ae5be1d5ec79f8e69184fa221d1b3d3d0">onewayTimer</a>) {
<a name="l00173"></a>00173         <span class="comment">// TEST 1: route a test message to a key (one-way)</span>
<a name="l00174"></a>00174         <span class="comment">// do nothing if there are currently no nodes in the network</span>
<a name="l00175"></a>00175         std::pair&lt;OverlayKey,TransportAddress&gt; dest = <a class="code" href="classKBRTestApp.html#af428946a37da5ca4a29b85a034869e61">createDestKey</a>();
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (!dest.first.isUnspecified()) {
<a name="l00177"></a>00177             <span class="comment">// create a 100 byte test message</span>
<a name="l00178"></a>00178             <a class="code" href="classKBRTestMessage.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KBRTestMessage</a>* testMsg = <span class="keyword">new</span> <a class="code" href="classKBRTestMessage.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KBRTestMessage</a>(<span class="stringliteral">&quot;KBRTestMessage&quot;</span>);
<a name="l00179"></a>00179             testMsg-&gt;<a class="code" href="classKBRTestMessage.html#ac3b7ce126aa6ae945cc8c1b5147e138a">setId</a>(getId());
<a name="l00180"></a>00180             testMsg-&gt;<a class="code" href="classKBRTestMessage.html#ad2e21c9dac484de1f77fa68aa0b3f388">setSeqNum</a>(<a class="code" href="classKBRTestApp.html#a6ef9eba5d0b033538a778f288f4a4654">sequenceNumber</a>++);
<a name="l00181"></a>00181             testMsg-&gt;setByteLength(<a class="code" href="classKBRTestApp.html#af332ff958983a9bb25252feba3e2590e">testMsgSize</a>);
<a name="l00182"></a>00182             testMsg-&gt;<a class="code" href="classKBRTestMessage.html#a0219f4d92022698ce12cb6039a5ee268">setMeasurementPhase</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#ac7fcc2200ed2da08e8f8b8b957c0c1dd">isMeasuring</a>());
<a name="l00183"></a>00183 
<a name="l00184"></a>00184             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#ac46f28e295e3d8a66045d4f7d742b795" title="total number of messages sent by KBRTestApp">sentKBRTestAppMessages</a>++;
<a name="l00185"></a>00185                          <a class="code" href="classKBRTestApp.html#a8ce13256ea63aa80192971d5c2ac50cc">numSent</a>++; <a class="code" href="classKBRTestApp.html#a52e5ba5ffe02fd9800db83b15a796b40">bytesSent</a> += testMsg-&gt;getByteLength());
<a name="l00186"></a>00186 
<a name="l00187"></a>00187             <a class="code" href="classBaseApp.html#a629659835cf4ccd86a995fd00e5f4794" title="Common API function: calls route-method in overlay.">callRoute</a>(dest.first, testMsg);
<a name="l00188"></a>00188         }
<a name="l00189"></a>00189     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg == <a class="code" href="classKBRTestApp.html#a13818c2e1fb89ff3639fc4dc48962100">rpcTimer</a>) {
<a name="l00190"></a>00190         <span class="comment">// TEST 2: send a remote procedure call to a specific key and wait for a response</span>
<a name="l00191"></a>00191         <span class="comment">// do nothing if there are currently no nodes in the network</span>
<a name="l00192"></a>00192         std::pair&lt;OverlayKey,TransportAddress&gt; dest = <a class="code" href="classKBRTestApp.html#af428946a37da5ca4a29b85a034869e61">createDestKey</a>();
<a name="l00193"></a>00193         <span class="keywordflow">if</span> (!dest.first.isUnspecified()) {
<a name="l00194"></a>00194             <a class="code" href="classKbrTestCall.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrTestCall</a>* call = <span class="keyword">new</span> <a class="code" href="classKbrTestCall.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrTestCall</a>;
<a name="l00195"></a>00195             call-&gt;setByteLength(<a class="code" href="classKBRTestApp.html#af332ff958983a9bb25252feba3e2590e">testMsgSize</a>);
<a name="l00196"></a>00196             <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* context = <span class="keyword">new</span> <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>;
<a name="l00197"></a>00197             context-&gt;<a class="code" href="classKbrRpcContext.html#a23f96766445d8bb622cd466f889bc5e3">setDestKey</a>(dest.first);
<a name="l00198"></a>00198             <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a>) {
<a name="l00199"></a>00199                 context-&gt;<a class="code" href="classKbrRpcContext.html#a23cd0dcda8a59174370fcc16b44c70a5">setDestAddr</a>(dest.second);
<a name="l00200"></a>00200             }
<a name="l00201"></a>00201             context-&gt;<a class="code" href="classKbrRpcContext.html#a4a4448c7a3d64c78f06a56f2dc1ecd7d">setMeasurementPhase</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#ac7fcc2200ed2da08e8f8b8b957c0c1dd">isMeasuring</a>());
<a name="l00202"></a>00202 
<a name="l00203"></a>00203             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#aafa44894b8e262682596aea6b235bcf1">numRpcSent</a>++;
<a name="l00204"></a>00204                          <a class="code" href="classKBRTestApp.html#a2d746dbca5bf7f81ac484c763c651cf1">bytesRpcSent</a> += call-&gt;getByteLength());
<a name="l00205"></a>00205 
<a name="l00206"></a>00206             <a class="code" href="classBaseRpc.html#a816918e82652f724c291923e018eabe2" title="Routes a Remote-Procedure-Call message to an OverlayKey.">sendRouteRpcCall</a>(<a class="code" href="CommonMessages__m_8h.html#aad57ef0110fe8675eb299d467148bc5ea098b73cd039f61df8b83f056c12b4d3b">TIER1_COMP</a>, dest.first, call, context,
<a name="l00207"></a>00207                              <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551a931137cd67090e50ef2ea3ccfb9e8d90">DEFAULT_ROUTING</a>, -1, <a class="code" href="classKBRTestApp.html#a41dcfc5b05deda0623530dd85bc3fc74">rpcRetries</a>);
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg == <a class="code" href="classKBRTestApp.html#a2f4f7a5ef238222fdcf9cc890ab5c40f">lookupTimer</a>) {
<a name="l00210"></a>00210         <span class="comment">// TEST 3: perform a lookup of a specific key</span>
<a name="l00211"></a>00211         <span class="comment">// do nothing if there are currently no nodes in the network</span>
<a name="l00212"></a>00212         std::pair&lt;OverlayKey,TransportAddress&gt; dest = <a class="code" href="classKBRTestApp.html#af428946a37da5ca4a29b85a034869e61">createDestKey</a>();
<a name="l00213"></a>00213         <span class="keywordflow">if</span> (!dest.first.isUnspecified()) {
<a name="l00214"></a>00214             <a class="code" href="classLookupCall.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">LookupCall</a>* call = <span class="keyword">new</span> <a class="code" href="classLookupCall.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">LookupCall</a>();
<a name="l00215"></a>00215             call-&gt;<a class="code" href="classLookupCall.html#ac9cfcf7fe5298270b6b3898b65541a4b">setKey</a>(dest.first);
<a name="l00216"></a>00216             call-&gt;<a class="code" href="classLookupCall.html#a1a365b8c947e000203e7fdc144715c2b">setNumSiblings</a>(<a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseOverlay.html#acd3058ad15b470e024500dd4872e2f09" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">getMaxNumSiblings</a>());
<a name="l00217"></a>00217             <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* context = <span class="keyword">new</span> <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>;
<a name="l00218"></a>00218             context-&gt;<a class="code" href="classKbrRpcContext.html#a23f96766445d8bb622cd466f889bc5e3">setDestKey</a>(dest.first);
<a name="l00219"></a>00219             <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a>) {
<a name="l00220"></a>00220                 context-&gt;<a class="code" href="classKbrRpcContext.html#a23cd0dcda8a59174370fcc16b44c70a5">setDestAddr</a>(dest.second);
<a name="l00221"></a>00221             }
<a name="l00222"></a>00222             context-&gt;<a class="code" href="classKbrRpcContext.html#a4a4448c7a3d64c78f06a56f2dc1ecd7d">setMeasurementPhase</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#ac7fcc2200ed2da08e8f8b8b957c0c1dd">isMeasuring</a>());
<a name="l00223"></a>00223             <a class="code" href="classBaseRpc.html#a0dea7eed103c0e97176576d6642f7bfa" title="Sends an internal Remote-Procedure-Call between two tiers ">sendInternalRpcCall</a>(<a class="code" href="CommonMessages__m_8h.html#aad57ef0110fe8675eb299d467148bc5ead1b904580b02f8adaa1ab2de239c4c79">OVERLAY_COMP</a>, call, context);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#a7d87083e30472441f161c47b617a427f">numLookupSent</a>++);
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227     } <span class="keywordflow">else</span> <span class="comment">/*if (msg == underlayRpcTimer)*/</span> {
<a name="l00228"></a>00228         <span class="comment">// TEST 4: send a remote procedure call to a specific transportAddress</span>
<a name="l00229"></a>00229         <span class="comment">// and wait for a response, do nothing if there are currently no nodes</span>
<a name="l00230"></a>00230         <span class="comment">// in the network</span>
<a name="l00231"></a>00231         <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a>* address =
<a name="l00232"></a>00232             <a class="code" href="classBaseApp.html#ac8a54fad527bfd03a05ee6aed434243e" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#afb768cce8523f2c55eb9449b2d489678" title="Selects a random node from the peerSet, which is not already marked for deletion.">getRandomAliveNode</a>(-1); <span class="comment">//TODO</span>
<a name="l00233"></a>00233 
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (address == NULL) {
<a name="l00235"></a>00235             EV &lt;&lt; <span class="stringliteral">&quot;no node!!!&quot;</span> &lt;&lt; std::endl;
<a name="l00236"></a>00236             <span class="keywordflow">return</span>;
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239         address-&gt;<a class="code" href="classTransportAddress.html#a46a1b53760e5f2d3f8af8c9591160a48" title="sets this-&gt;port to the given port">setPort</a>(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a4cf99c434c5110935683624dc3702e0f" title="returns port">getPort</a>());
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (!address-&gt;<a class="code" href="classTransportAddress.html#a026e777c423ff2a0280edd2fa5472e74" title="indicates if TransportAddress is specified">isUnspecified</a>()) {
<a name="l00241"></a>00241             <a class="code" href="classUnderlayTestCall.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">UnderlayTestCall</a>* call = <span class="keyword">new</span> <a class="code" href="classUnderlayTestCall.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">UnderlayTestCall</a>;
<a name="l00242"></a>00242             call-&gt;setByteLength(<a class="code" href="classKBRTestApp.html#af332ff958983a9bb25252feba3e2590e">testMsgSize</a>);
<a name="l00243"></a>00243             call-&gt;<a class="code" href="classUnderlayTestCall.html#a6781f43e8cc1aaa6475b7bbcce0b4ad2">setSendTime</a>(simTime());
<a name="l00244"></a>00244 
<a name="l00245"></a>00245             <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* context = <span class="keyword">new</span> <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>;
<a name="l00246"></a>00246             context-&gt;<a class="code" href="classKbrRpcContext.html#a4a4448c7a3d64c78f06a56f2dc1ecd7d">setMeasurementPhase</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#ac7fcc2200ed2da08e8f8b8b957c0c1dd">isMeasuring</a>());
<a name="l00247"></a>00247 
<a name="l00248"></a>00248             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#aa3ce14b7182753ccf770d6aeb74913f9">numUnderlaySent</a>++;
<a name="l00249"></a>00249                          <a class="code" href="classKBRTestApp.html#a509fe672ed218ffeaa255fd2b45a6ef3">bytesUnderlaySent</a> += call-&gt;getByteLength());
<a name="l00250"></a>00250 
<a name="l00251"></a>00251             <span class="comment">//dest.second.setPort(thisNode.getPort());</span>
<a name="l00252"></a>00252             <a class="code" href="classBaseRpc.html#ac128e0ff0d09f81b652f7d3e00ce9441" title="Sends a Remote-Procedure-Call message to the underlay ">sendUdpRpcCall</a>(*address, call, context,
<a name="l00253"></a>00253                            <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551aec961f27dcdb3050f97033fbd88b89b3">NO_OVERLAY_ROUTING</a>, -1, <a class="code" href="classKBRTestApp.html#a41dcfc5b05deda0623530dd85bc3fc74">rpcRetries</a>);
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 <span class="preprocessor">#if 0</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span>    <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a46a1b53760e5f2d3f8af8c9591160a48" title="sets this-&gt;port to the given port">setPort</a>(1025);
<a name="l00258"></a>00258     <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> handle = <a class="code" href="classBaseApp.html#ac8a54fad527bfd03a05ee6aed434243e" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#ac2b8737b7228a19ddc599adddfbdc5e9" title="Returns a random NodeHandle.">getBootstrapNode</a>();
<a name="l00259"></a>00259     handle.<a class="code" href="classTransportAddress.html#a46a1b53760e5f2d3f8af8c9591160a48" title="sets this-&gt;port to the given port">setPort</a>(1025);
<a name="l00260"></a>00260     <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(handle, -1, -1, NULL, <span class="stringliteral">&quot;TestPING&quot;</span>, NULL, -1, <a class="code" href="CommonMessages__m_8h.html#aca1e72535e7f260e54ed8bbf984dade9a01580b2e886cd821bd7f3f2bcd7c690c">UDP_TRANSPORT</a>);
<a name="l00261"></a>00261 <span class="preprocessor">#endif</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 
<a name="l00266"></a><a class="code" href="classKBRTestApp.html#afec33d48dc2b5c2920391f29abab1237">00266</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#afec33d48dc2b5c2920391f29abab1237">KBRTestApp::pingResponse</a>(<a class="code" href="classPingResponse.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">PingResponse</a>* response, cPolymorphic* context,
<a name="l00267"></a>00267                               <span class="keywordtype">int</span> rpcId, simtime_t rtt)
<a name="l00268"></a>00268 {
<a name="l00269"></a>00269     <span class="comment">//std::cout &lt;&lt; rtt &lt;&lt; std::endl;</span>
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 
<a name="l00273"></a><a class="code" href="classKBRTestApp.html#acffbd277d53a7b3e9c854395563b37d0">00273</a> <span class="keywordtype">bool</span> <a class="code" href="classKBRTestApp.html#acffbd277d53a7b3e9c854395563b37d0" title="Processes Remote-Procedure-Call invocation messages.">KBRTestApp::handleRpcCall</a>(<a class="code" href="classBaseCallMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseCallMessage</a>* msg)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275     <a class="code" href="RpcMacros_8h.html#aa75b135e279b574267e1a7dc4ab79da4" title="Marks the beginning of a Remote-Procedure-Call Switch block.">RPC_SWITCH_START</a>( msg );
<a name="l00276"></a>00276         <a class="code" href="RpcMacros_8h.html#ad81d44e9bc59d2fb2cfcacc4d5ecda35" title="Declares a RPC method delegation.">RPC_DELEGATE</a>( KbrTest, <a class="code" href="classKBRTestApp.html#a5d99afa79b6a0d5b9ec46ce2aab86290">kbrTestCall</a> );
<a name="l00277"></a>00277         <a class="code" href="RpcMacros_8h.html#ad81d44e9bc59d2fb2cfcacc4d5ecda35" title="Declares a RPC method delegation.">RPC_DELEGATE</a>( UnderlayTest, <a class="code" href="classKBRTestApp.html#a1eb66b9882fd5f602b5e0fbf70fe7043">underlayTestCall</a> );
<a name="l00278"></a>00278     <a class="code" href="RpcMacros_8h.html#a29a8a3f21e67ecb25f58608a54df5191" title="Marks the end of a Remote-Procedure-Call Switch block.">RPC_SWITCH_END</a>( );
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     <span class="keywordflow">return</span> <a class="code" href="RpcMacros_8h.html#aa5e964b7c7129c0943237a786e455e9a">RPC_HANDLED</a>;
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="classKBRTestApp.html#a5d99afa79b6a0d5b9ec46ce2aab86290">00284</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#a5d99afa79b6a0d5b9ec46ce2aab86290">KBRTestApp::kbrTestCall</a>(<a class="code" href="classKbrTestCall.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrTestCall</a>* call)
<a name="l00285"></a>00285 {
<a name="l00286"></a>00286     <a class="code" href="classKbrTestResponse.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrTestResponse</a>* response = <span class="keyword">new</span> <a class="code" href="classKbrTestResponse.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrTestResponse</a>;
<a name="l00287"></a>00287     response-&gt;setByteLength(call-&gt;getByteLength());
<a name="l00288"></a>00288     <a class="code" href="classBaseRpc.html#adc06091d348c98a5efbf54fe0afe8747" title="Send Remote-Procedure response message and deletes call message.">sendRpcResponse</a>(call, response);
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 
<a name="l00292"></a><a class="code" href="classKBRTestApp.html#a1eb66b9882fd5f602b5e0fbf70fe7043">00292</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#a1eb66b9882fd5f602b5e0fbf70fe7043">KBRTestApp::underlayTestCall</a>(<a class="code" href="classUnderlayTestCall.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">UnderlayTestCall</a>* call)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294     <a class="code" href="classUnderlayTestResponse.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">UnderlayTestResponse</a>* response = <span class="keyword">new</span> <a class="code" href="classUnderlayTestResponse.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">UnderlayTestResponse</a>;
<a name="l00295"></a>00295     response-&gt;setByteLength(call-&gt;getByteLength());
<a name="l00296"></a>00296     response-&gt;<a class="code" href="classUnderlayTestResponse.html#aa22e58f6ec138dd44cc5b1678cffeab3">setOneWayLatency</a>(simTime() - call-&gt;<a class="code" href="classUnderlayTestCall.html#aee283554424c48040d54f1a9b76cf9d9">getSendTime</a>());
<a name="l00297"></a>00297     <a class="code" href="classBaseRpc.html#adc06091d348c98a5efbf54fe0afe8747" title="Send Remote-Procedure response message and deletes call message.">sendRpcResponse</a>(call, response);
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a><a class="code" href="classKBRTestApp.html#a16c87b0aff614a09cf41271cb45ec4f0">00301</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#a16c87b0aff614a09cf41271cb45ec4f0" title="This method is called if an RPC response has been received.">KBRTestApp::handleRpcResponse</a>(<a class="code" href="classBaseResponseMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseResponseMessage</a>* msg,
<a name="l00302"></a>00302                                    cPolymorphic* context, <span class="keywordtype">int</span> rpcId,
<a name="l00303"></a>00303                                    simtime_t rtt)
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305     <a class="code" href="RpcMacros_8h.html#aa75b135e279b574267e1a7dc4ab79da4" title="Marks the beginning of a Remote-Procedure-Call Switch block.">RPC_SWITCH_START</a>(msg)
<a name="l00306"></a>00306     <a class="code" href="RpcMacros_8h.html#a0394d2dc4f9f1e15d7e99c9f43da10c7">RPC_ON_RESPONSE</a>(<a class="code" href="classLookup.html">Lookup</a>) {
<a name="l00307"></a>00307         EV &lt;&lt; <span class="stringliteral">&quot;[KBRTestApp::handleRpcResponse() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00308"></a>00308            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00309"></a>00309            &lt;&lt; <span class="stringliteral">&quot;    Lookup RPC Response received: id=&quot;</span> &lt;&lt; rpcId &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00310"></a>00310            &lt;&lt; <span class="stringliteral">&quot;    msg=&quot;</span> &lt;&lt; *_LookupResponse &lt;&lt; <span class="stringliteral">&quot; rtt=&quot;</span> &lt;&lt; rtt
<a name="l00311"></a>00311            &lt;&lt; endl;
<a name="l00312"></a>00312         <a class="code" href="classKBRTestApp.html#abe4fcc0a674ba6c843a2e1467bc458c8">handleLookupResponse</a>(_LookupResponse, context, rtt);
<a name="l00313"></a>00313         <span class="keywordflow">break</span>;
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315     <a class="code" href="RpcMacros_8h.html#a0394d2dc4f9f1e15d7e99c9f43da10c7">RPC_ON_RESPONSE</a>(KbrTest) {
<a name="l00316"></a>00316         <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* kbrRpcContext = check_and_cast&lt;<a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>*&gt;(context);
<a name="l00317"></a>00317         <span class="keywordflow">if</span> (kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#a0c2d69d2d75cecbd5b35b888db5b6069">getMeasurementPhase</a>() == <span class="keyword">true</span>) {
<a name="l00318"></a>00318             <span class="keywordflow">if</span> (!<a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a> ||
<a name="l00319"></a>00319                 (kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#ac380908abfe9686cf5aa708b41da712a">getDestKey</a>() == msg-&gt;<a class="code" href="classBaseRpcMessage.html#ada3e122125cfb5acc7350277ca69c45a">getSrcNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() &amp;&amp;
<a name="l00320"></a>00320                  kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#aefc33ab8b0fca563b931f38fe702666f">getDestAddr</a>() == msg-&gt;<a class="code" href="classBaseRpcMessage.html#ada3e122125cfb5acc7350277ca69c45a">getSrcNode</a>())) {
<a name="l00321"></a>00321 
<a name="l00322"></a>00322                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#ad9ea83ac232db846335c38619e6d9d04" title="number of delivered packets">numRpcDelivered</a>++;
<a name="l00323"></a>00323                              <a class="code" href="classKBRTestApp.html#ac9287ba30b44d05c1f1e2b3af6e0f2e4" title="number of delivered bytes">bytesRpcDelivered</a> += msg-&gt;getByteLength());
<a name="l00324"></a>00324                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00325"></a>00325                         <span class="stringliteral">&quot;KBRTestApp: RPC Success Latency&quot;</span>, SIMTIME_DBL(rtt)));
<a name="l00326"></a>00326                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00327"></a>00327                         <span class="stringliteral">&quot;KBRTestApp: RPC Total Latency&quot;</span>, SIMTIME_DBL(rtt)));
<a name="l00328"></a>00328                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#ae755fda691b0e7b8ed23b318c52871f8">rpcSuccLatencyCount</a>++;
<a name="l00329"></a>00329                              <a class="code" href="classKBRTestApp.html#aeb37374bdf671e95a65ce93143cb2afc">rpcSuccLatencySum</a> += SIMTIME_DBL(rtt));
<a name="l00330"></a>00330                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#acb9b120ab10edc6a08b554e7ea6f732b">rpcTotalLatencyCount</a>++;
<a name="l00331"></a>00331                              <a class="code" href="classKBRTestApp.html#af4d1d4d8f6c1e5ce301b25ca958cc2e5">rpcTotalLatencySum</a> += SIMTIME_DBL(rtt));
<a name="l00332"></a>00332                 <a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>* overlayCtrlInfo =
<a name="l00333"></a>00333                         <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>*<span class="keyword">&gt;</span>(msg-&gt;getControlInfo());
<a name="l00334"></a>00334 
<a name="l00335"></a>00335                 uint16_t hopSum = msg-&gt;<a class="code" href="classBaseResponseMessage.html#a37417381f7d44bcdf98f9ac8fea75751">getCallHopCount</a>();
<a name="l00336"></a>00336                 hopSum += (overlayCtrlInfo ? overlayCtrlInfo-&gt;getHopCount() : 1);
<a name="l00337"></a>00337                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00338"></a>00338                         <span class="stringliteral">&quot;KBRTestApp: RPC Hop Count&quot;</span>, hopSum));
<a name="l00339"></a>00339 <span class="comment">//              RECORD_STATS(globalStatistics-&gt;recordHistogram(</span>
<a name="l00340"></a>00340 <span class="comment">//                      &quot;KBRTestApp: RPC Hop Count Histogram&quot;, hopSum));</span>
<a name="l00341"></a>00341             } <span class="keywordflow">else</span> {
<a name="l00342"></a>00342                 <span class="comment">//std::cout &lt;&lt; simTime() &lt;&lt; &quot; &quot; &lt;&lt; thisNode.getAddress()</span>
<a name="l00343"></a>00343                 <span class="comment">//          &lt;&lt; &quot; &quot; &lt;&lt; msg-&gt;getSrcNode().getAddress()</span>
<a name="l00344"></a>00344                 <span class="comment">//          &lt;&lt; &quot; &quot; &lt;&lt; kbrRpcContext-&gt;getDestKey() &lt;&lt; std::endl;</span>
<a name="l00345"></a>00345                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#a837931e670a4117501d5b5d06d91a147">numRpcDropped</a>++;
<a name="l00346"></a>00346                              <a class="code" href="classKBRTestApp.html#a1c76cf2493d997bea95577ad53792e5a">bytesRpcDropped</a> += msg-&gt;getByteLength());
<a name="l00347"></a>00347                 <span class="comment">// for failed RPCs add failureLatency to latency statistics vector</span>
<a name="l00348"></a>00348                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00349"></a>00349                         <span class="stringliteral">&quot;KBRTestApp: RPC Total Latency&quot;</span>,
<a name="l00350"></a>00350                         SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#ab7d25f9b4fd4445596114c7ae1912496" title="this latency is recorded for failed lookups and RPCs">failureLatency</a>)));
<a name="l00351"></a>00351                 <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#acb9b120ab10edc6a08b554e7ea6f732b">rpcTotalLatencyCount</a>++;
<a name="l00352"></a>00352                              <a class="code" href="classKBRTestApp.html#af4d1d4d8f6c1e5ce301b25ca958cc2e5">rpcTotalLatencySum</a> += SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#ab7d25f9b4fd4445596114c7ae1912496" title="this latency is recorded for failed lookups and RPCs">failureLatency</a>));
<a name="l00353"></a>00353             }
<a name="l00354"></a>00354         }
<a name="l00355"></a>00355         <span class="keyword">delete</span> kbrRpcContext;
<a name="l00356"></a>00356         <span class="keywordflow">break</span>;
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358     <a class="code" href="RpcMacros_8h.html#a0394d2dc4f9f1e15d7e99c9f43da10c7">RPC_ON_RESPONSE</a>(UnderlayTest) {
<a name="l00359"></a>00359         <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* kbrRpcContext = check_and_cast&lt;<a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>*&gt;(context);
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#a0c2d69d2d75cecbd5b35b888db5b6069">getMeasurementPhase</a>() == <span class="keyword">true</span>) {
<a name="l00361"></a>00361             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#a207c30de6b17507d64187fd78d7f705e" title="number of delivered packets">numUnderlayDelivered</a>++;
<a name="l00362"></a>00362                 <a class="code" href="classKBRTestApp.html#a1d7a3ba320bc3046d87262d7fd7722b1" title="number of delivered bytes">bytesUnderlayDelivered</a> += msg-&gt;getByteLength());
<a name="l00363"></a>00363             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00364"></a>00364                 <span class="stringliteral">&quot;KBRTestApp: Underlay RTT&quot;</span>, SIMTIME_DBL(rtt)));
<a name="l00365"></a>00365             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00366"></a>00366                 <span class="stringliteral">&quot;KBRTestApp: Underlay One-way Latency&quot;</span>,
<a name="l00367"></a>00367                 SIMTIME_DBL(_UnderlayTestResponse-&gt;getOneWayLatency())));
<a name="l00368"></a>00368         }
<a name="l00369"></a>00369         <span class="keyword">delete</span> kbrRpcContext;
<a name="l00370"></a>00370         <span class="keywordflow">break</span>;
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372     <a class="code" href="RpcMacros_8h.html#a29a8a3f21e67ecb25f58608a54df5191" title="Marks the end of a Remote-Procedure-Call Switch block.">RPC_SWITCH_END</a>( )
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00375"></a><a class="code" href="classKBRTestApp.html#aa5cd3e30e7a2ecefc0821a5291dce864">00375</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#aa5cd3e30e7a2ecefc0821a5291dce864" title="This method is called if an RPC timeout has been reached.">KBRTestApp::handleRpcTimeout</a>(<a class="code" href="classBaseCallMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseCallMessage</a>* msg,
<a name="l00376"></a>00376                                   <span class="keyword">const</span> <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a>&amp; dest,
<a name="l00377"></a>00377                                   cPolymorphic* context, <span class="keywordtype">int</span> rpcId,
<a name="l00378"></a>00378                                   <span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; destKey)
<a name="l00379"></a>00379 {
<a name="l00380"></a>00380     <a class="code" href="RpcMacros_8h.html#aa75b135e279b574267e1a7dc4ab79da4" title="Marks the beginning of a Remote-Procedure-Call Switch block.">RPC_SWITCH_START</a>(msg)
<a name="l00381"></a>00381     <a class="code" href="RpcMacros_8h.html#ae07fad586ce7b9e82ad12848767a32e5">RPC_ON_CALL</a>(KbrTest) {
<a name="l00382"></a>00382         EV &lt;&lt; <span class="stringliteral">&quot;[KBRTestApp::handleRpcTimeout() @ &quot;</span>
<a name="l00383"></a>00383            &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00384"></a>00384            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00385"></a>00385            &lt;&lt; <span class="stringliteral">&quot;    KBR-Test RPC Response timeout: id=&quot;</span> &lt;&lt; rpcId
<a name="l00386"></a>00386            &lt;&lt; endl;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="comment">/*</span>
<a name="l00389"></a>00389 <span class="comment">        std::cout &lt;&lt; simTime() &lt;&lt; &quot;: [KBRTestApp::handleRpcTimeout() @ &quot;</span>
<a name="l00390"></a>00390 <span class="comment">                  &lt;&lt; overlay-&gt;getThisNode().getIp()</span>
<a name="l00391"></a>00391 <span class="comment">                  &lt;&lt; &quot; (&quot; &lt;&lt; overlay-&gt;getThisNode().getKey().toString(16) &lt;&lt; &quot;)]\n&quot;</span>
<a name="l00392"></a>00392 <span class="comment">                  &lt;&lt; &quot;    KBR-Test RPC Response (&quot; &lt;&lt; *msg &lt;&lt; &quot;) timeout: id=&quot; &lt;&lt; rpcId</span>
<a name="l00393"></a>00393 <span class="comment">                  &lt;&lt; std::endl;</span>
<a name="l00394"></a>00394 <span class="comment">         */</span>
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* kbrRpcContext = check_and_cast&lt;<a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>*&gt;(context);
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#a0c2d69d2d75cecbd5b35b888db5b6069">getMeasurementPhase</a>() == <span class="keyword">true</span>) {
<a name="l00398"></a>00398              <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#a837931e670a4117501d5b5d06d91a147">numRpcDropped</a>++;
<a name="l00399"></a>00399                           <a class="code" href="classKBRTestApp.html#a1c76cf2493d997bea95577ad53792e5a">bytesRpcDropped</a> += msg-&gt;getByteLength());
<a name="l00400"></a>00400              <span class="comment">// for failed RPCs add failureLatency to latency statistics vector</span>
<a name="l00401"></a>00401              <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00402"></a>00402                          <span class="stringliteral">&quot;KBRTestApp: RPC Total Latency&quot;</span>,
<a name="l00403"></a>00403                          SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#ab7d25f9b4fd4445596114c7ae1912496" title="this latency is recorded for failed lookups and RPCs">failureLatency</a>)));
<a name="l00404"></a>00404              <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#acb9b120ab10edc6a08b554e7ea6f732b">rpcTotalLatencyCount</a>++;
<a name="l00405"></a>00405                           <a class="code" href="classKBRTestApp.html#af4d1d4d8f6c1e5ce301b25ca958cc2e5">rpcTotalLatencySum</a> += SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#ab7d25f9b4fd4445596114c7ae1912496" title="this latency is recorded for failed lookups and RPCs">failureLatency</a>));
<a name="l00406"></a>00406 
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408         <span class="keywordflow">break</span>;
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <a class="code" href="RpcMacros_8h.html#ae07fad586ce7b9e82ad12848767a32e5">RPC_ON_CALL</a>(<a class="code" href="classLookup.html">Lookup</a>) {
<a name="l00411"></a>00411         <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* kbrRpcContext = check_and_cast&lt;<a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>*&gt;(context);
<a name="l00412"></a>00412         <span class="keywordflow">if</span> (kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#a0c2d69d2d75cecbd5b35b888db5b6069">getMeasurementPhase</a>() == <span class="keyword">true</span>) {
<a name="l00413"></a>00413             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#ae243723c9d57797ed147e668c953f6ae">numLookupFailed</a>++);
<a name="l00414"></a>00414             <span class="comment">// for failed lookups add failureLatency to latency statistics vector</span>
<a name="l00415"></a>00415             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00416"></a>00416                          <span class="stringliteral">&quot;KBRTestApp: Lookup Total Latency&quot;</span>,
<a name="l00417"></a>00417                          SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#ab7d25f9b4fd4445596114c7ae1912496" title="this latency is recorded for failed lookups and RPCs">failureLatency</a>)));
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419         <span class="keywordflow">break</span>;
<a name="l00420"></a>00420     }
<a name="l00421"></a>00421     <a class="code" href="RpcMacros_8h.html#a29a8a3f21e67ecb25f58608a54df5191" title="Marks the end of a Remote-Procedure-Call Switch block.">RPC_SWITCH_END</a>()
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <span class="keyword">delete</span> context;
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="classKBRTestApp.html#abe4fcc0a674ba6c843a2e1467bc458c8">00426</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#abe4fcc0a674ba6c843a2e1467bc458c8">KBRTestApp::handleLookupResponse</a>(<a class="code" href="classLookupResponse.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">LookupResponse</a>* msg,
<a name="l00427"></a>00427                                       cObject* context, simtime_t latency)
<a name="l00428"></a>00428 {
<a name="l00429"></a>00429     EV &lt;&lt; <span class="stringliteral">&quot;[KBRTestApp::handleLookupResponse() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00430"></a>00430        &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00431"></a>00431        &lt;&lt; <span class="stringliteral">&quot;    Lookup response for key &quot;</span> &lt;&lt; msg-&gt;<a class="code" href="classLookupResponse.html#a0eb7ae69a84948251e35be07be9e3911">getKey</a>()&lt;&lt; <span class="stringliteral">&quot; : &quot;</span>;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>* kbrRpcContext = check_and_cast&lt;<a class="code" href="classKbrRpcContext.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KbrRpcContext</a>*&gt;(context);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#a0c2d69d2d75cecbd5b35b888db5b6069">getMeasurementPhase</a>() == <span class="keyword">true</span>) {
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="classLookupResponse.html#a86a9d5fd7849c18b989f2e5260cfbf12">getIsValid</a>() &amp;&amp; (!<a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a> ||
<a name="l00437"></a>00437                 ((msg-&gt;<a class="code" href="classLookupResponse.html#a294d30cb0b365a24c1b1bff9478f45ef">getSiblingsArraySize</a>() &gt; 0) &amp;&amp;
<a name="l00438"></a>00438                  (msg-&gt;<a class="code" href="classLookupResponse.html#a4c0f21b5ab1a7865cd23d8f6e3a1640c">getSiblings</a>(0).<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() == msg-&gt;<a class="code" href="classLookupResponse.html#a0eb7ae69a84948251e35be07be9e3911">getKey</a>()) &amp;&amp;
<a name="l00439"></a>00439                  (kbrRpcContext-&gt;<a class="code" href="classKbrRpcContext.html#aefc33ab8b0fca563b931f38fe702666f">getDestAddr</a>() == msg-&gt;<a class="code" href="classLookupResponse.html#a4c0f21b5ab1a7865cd23d8f6e3a1640c">getSiblings</a>(0))))) {
<a name="l00440"></a>00440             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#a627fe29d5bed8ea2d7f1b2fbe2881e53">numLookupSuccess</a>++);
<a name="l00441"></a>00441             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00442"></a>00442                    <span class="stringliteral">&quot;KBRTestApp: Lookup Success Latency&quot;</span>, SIMTIME_DBL(latency)));
<a name="l00443"></a>00443             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00444"></a>00444                    <span class="stringliteral">&quot;KBRTestApp: Lookup Total Latency&quot;</span>, SIMTIME_DBL(latency)));
<a name="l00445"></a>00445             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00446"></a>00446                     <span class="stringliteral">&quot;KBRTestApp: Lookup Hop Count&quot;</span>, msg-&gt;<a class="code" href="classLookupResponse.html#a277634ab3f48de28473727805f8af76f">getHopCount</a>()));
<a name="l00447"></a>00447         } <span class="keywordflow">else</span> {
<a name="l00448"></a>00448 <span class="preprocessor">#if 0</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!msg-&gt;<a class="code" href="classLookupResponse.html#a86a9d5fd7849c18b989f2e5260cfbf12">getIsValid</a>()) {
<a name="l00450"></a>00450                 std::cout &lt;&lt; <span class="stringliteral">&quot;invalid&quot;</span> &lt;&lt; std::endl;
<a name="l00451"></a>00451             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="classLookupResponse.html#a294d30cb0b365a24c1b1bff9478f45ef">getSiblingsArraySize</a>() == 0) {
<a name="l00452"></a>00452                 std::cout &lt;&lt; <span class="stringliteral">&quot;empty&quot;</span> &lt;&lt; std::endl;
<a name="l00453"></a>00453             } <span class="keywordflow">else</span> {
<a name="l00454"></a>00454                 std::cout &lt;&lt; <span class="stringliteral">&quot;wrong key&quot;</span> &lt;&lt; std::endl;
<a name="l00455"></a>00455             }
<a name="l00456"></a>00456 <span class="preprocessor">#endif</span>
<a name="l00457"></a>00457 <span class="preprocessor"></span>            <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#ae243723c9d57797ed147e668c953f6ae">numLookupFailed</a>++);
<a name="l00458"></a>00458             <span class="comment">// for failed lookups add failureLatency to latency statistics vector</span>
<a name="l00459"></a>00459             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00460"></a>00460                          <span class="stringliteral">&quot;KBRTestApp: Lookup Total Latency&quot;</span>,
<a name="l00461"></a>00461                          SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#ab7d25f9b4fd4445596114c7ae1912496" title="this latency is recorded for failed lookups and RPCs">failureLatency</a>)));
<a name="l00462"></a>00462             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l00463"></a>00463                     <span class="stringliteral">&quot;KBRTestApp: Failed Lookup Hop Count&quot;</span>, msg-&gt;<a class="code" href="classLookupResponse.html#a277634ab3f48de28473727805f8af76f">getHopCount</a>()));
<a name="l00464"></a>00464         }
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     <span class="keyword">delete</span> kbrRpcContext;
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00470"></a><a class="code" href="classKBRTestApp.html#a67197e64e41b044dc37a9d8d6fbadc75">00470</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#a67197e64e41b044dc37a9d8d6fbadc75" title="This method gets call **.gracefulLeaveDelay seconds before it is killed.">KBRTestApp::handleNodeLeaveNotification</a>()
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     <a class="code" href="classKBRTestApp.html#a567d933d3c6a8f0c1d0194c5e779dbea" title="true if the node is going to be killed shortly">nodeIsLeavingSoon</a> = <span class="keyword">true</span>;
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a><a class="code" href="classKBRTestApp.html#aab30e051b905b39deef371ad3a418473">00475</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#aab30e051b905b39deef371ad3a418473" title="Common API function: handles delivered messages from overlay.">KBRTestApp::deliver</a>(<a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key, cMessage* msg)
<a name="l00476"></a>00476 {
<a name="l00477"></a>00477     <a class="code" href="classKBRTestMessage.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KBRTestMessage</a>* testMsg = check_and_cast&lt;<a class="code" href="classKBRTestMessage.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KBRTestMessage</a>*&gt;(msg);
<a name="l00478"></a>00478     <a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>* overlayCtrlInfo =
<a name="l00479"></a>00479         check_and_cast&lt;<a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>*&gt;(msg-&gt;removeControlInfo());
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (<a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#abe357a4d1babcf7d30598a61cbc0f5c2" title="Returns true, if the key is unspecified.">isUnspecified</a>())
<a name="l00482"></a>00482         <a class="code" href="yang_8cc.html#adb989392f8aada21b0f7ec2f7a41dc00">error</a>(<span class="stringliteral">&quot;key&quot;</span>);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">// check for duplicate</span>
<a name="l00485"></a>00485     <span class="keywordflow">if</span> ((<a class="code" href="classKBRTestApp.html#af60509b56e28684a4eb49f25df6552f6" title="how many MsgHandles to store in circular buffer">msgHandleBufSize</a> &gt; 0 )
<a name="l00486"></a>00486             &amp;&amp; <a class="code" href="classKBRTestApp.html#a1c22d7bc56871a63cce151e599a83229" title="Checks if a message was already seen before.">checkSeen</a>(overlayCtrlInfo-&gt;getSrcNode().getKey(), testMsg-&gt;<a class="code" href="classKBRTestMessage.html#afef3881404f5399344823456b5605284">getSeqNum</a>())) {
<a name="l00487"></a>00487         EV &lt;&lt; <span class="stringliteral">&quot;[KBRTestApp::deliver() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00488"></a>00488            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00489"></a>00489            &lt;&lt; <span class="stringliteral">&quot;    Duplicate dropped.&quot;</span>
<a name="l00490"></a>00490            &lt;&lt; endl;
<a name="l00491"></a>00491         <span class="keyword">delete</span> overlayCtrlInfo;
<a name="l00492"></a>00492         <span class="keyword">delete</span> testMsg;
<a name="l00493"></a>00493         <span class="keywordflow">return</span>;
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="comment">// Return statistical data to the sender.</span>
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (cModule* mod = simulation.getModule(testMsg-&gt;<a class="code" href="classKBRTestMessage.html#a122ee155877c50d1a8197f6bf10c3c33">getId</a>())) {
<a name="l00498"></a>00498         <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html" title="Test application for KBR interface.">KBRTestApp</a>* sender = dynamic_cast&lt;KBRTestApp*&gt;(mod)) {
<a name="l00499"></a>00499             <span class="keywordflow">if</span> ((!<a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a>) || (<a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() == key)) {
<a name="l00500"></a>00500                 <span class="keywordflow">if</span> (testMsg-&gt;<a class="code" href="classKBRTestMessage.html#a51abb3c29b2b4d109994530269035282">getMeasurementPhase</a>() == <span class="keyword">true</span>) {
<a name="l00501"></a>00501                         sender-&gt;evaluateData((simTime() - testMsg-&gt;getCreationTime()),
<a name="l00502"></a>00502                                              overlayCtrlInfo-&gt;getHopCount(),
<a name="l00503"></a>00503                                              testMsg-&gt;getByteLength());
<a name="l00504"></a>00504                 }
<a name="l00505"></a>00505             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a>) {
<a name="l00506"></a>00506                 <span class="keywordflow">if</span> (testMsg-&gt;<a class="code" href="classKBRTestMessage.html#a51abb3c29b2b4d109994530269035282">getMeasurementPhase</a>() == <span class="keyword">true</span>) {
<a name="l00507"></a>00507                     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#a0b9c2e82f3287e4200d6f12d26371739">numDropped</a>++;
<a name="l00508"></a>00508                                  <a class="code" href="classKBRTestApp.html#a3243446a1be631c71455e80d8c25e475">bytesDropped</a> += testMsg-&gt;getByteLength());
<a name="l00509"></a>00509                 }
<a name="l00510"></a>00510                 EV &lt;&lt; <span class="stringliteral">&quot;[KBRTestApp::deliver() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00511"></a>00511                    &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00512"></a>00512                    &lt;&lt; <span class="stringliteral">&quot;    Error: Lookup of NodeIDs and KBRTestMessage&quot;</span>
<a name="l00513"></a>00513                    &lt;&lt; <span class="stringliteral">&quot; received with different destKey!&quot;</span>
<a name="l00514"></a>00514                    &lt;&lt; endl;
<a name="l00515"></a>00515             }
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     EV &lt;&lt; <span class="stringliteral">&quot;[KBRTestApp::deliver() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00520"></a>00520        &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00521"></a>00521        &lt;&lt; <span class="stringliteral">&quot;    Received \&quot;&quot;</span> &lt;&lt; testMsg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;(seqNr: &quot;</span>
<a name="l00522"></a>00522        &lt;&lt; testMsg-&gt;<a class="code" href="classKBRTestMessage.html#afef3881404f5399344823456b5605284">getSeqNum</a>() &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span>
<a name="l00523"></a>00523        &lt;&lt; <span class="stringliteral">&quot;    with destination key: &quot;</span> &lt;&lt; key.<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16)
<a name="l00524"></a>00524        &lt;&lt; endl;
<a name="l00525"></a>00525 
<a name="l00526"></a>00526     <span class="keyword">delete</span> overlayCtrlInfo;
<a name="l00527"></a>00527     <span class="keyword">delete</span> testMsg;
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a><a class="code" href="classKBRTestApp.html#a860b762b8a8b843551c349beb130966c">00530</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#a860b762b8a8b843551c349beb130966c" title="Common API function: handles messages from overlay to be forwarded.">KBRTestApp::forward</a>(<a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>* key, cPacket** msg,
<a name="l00531"></a>00531                          <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>* nextHopNode)
<a name="l00532"></a>00532 {
<a name="l00533"></a>00533     <a class="code" href="classKBRTestMessage.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KBRTestMessage</a>* tempMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classKBRTestMessage.html" title="Class generated from applications/kbrtestapp/KBRTestMessage.msg by opp_msgc.">KBRTestMessage</a>*<span class="keyword">&gt;</span>(*msg);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="keywordflow">if</span> (tempMsg == NULL) <span class="keywordflow">return</span>;
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     tempMsg-&gt;<a class="code" href="classKBRTestMessage.html#a3ccdd28b9b2708727f35808a69a106ea">setVisitedNodesArraySize</a>(tempMsg-&gt;<a class="code" href="classKBRTestMessage.html#a506760f8eae4c5ddd19d7848f032ef29">getVisitedNodesArraySize</a>() + 1);
<a name="l00538"></a>00538     tempMsg-&gt;<a class="code" href="classKBRTestMessage.html#a4142fc2a5707109af7d38d8428f7a6f1">setVisitedNodes</a>(tempMsg-&gt;<a class="code" href="classKBRTestMessage.html#a506760f8eae4c5ddd19d7848f032ef29">getVisitedNodesArraySize</a>() - 1,
<a name="l00539"></a>00539                              <a class="code" href="classBaseRpc.html#a9a633ad17071241f981fb76a9678337a">overlay</a>-&gt;<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>());
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00542"></a><a class="code" href="classKBRTestApp.html#af428946a37da5ca4a29b85a034869e61">00542</a> std::pair&lt;OverlayKey, TransportAddress&gt; <a class="code" href="classKBRTestApp.html#af428946a37da5ca4a29b85a034869e61">KBRTestApp::createDestKey</a>()
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#af63f7f8bdcfce448593663484c0cd5a2" title="lookup only existing nodeIDs">lookupNodeIds</a>) {
<a name="l00545"></a>00545         <span class="comment">// TODO parameter to choose only nodes with own nodeType</span>
<a name="l00546"></a>00546         <span class="comment">// getPeerInfo(getThisNode())-&gt;getTypeID()</span>
<a name="l00547"></a>00547         <span class="keyword">const</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp; handle = <a class="code" href="classBaseApp.html#ac8a54fad527bfd03a05ee6aed434243e" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a4a52b6c813beb1e42e882da2451e623e" title="Returns a random NodeHandle.">getRandomNode</a>(-1, -1, <span class="keyword">true</span>,
<a name="l00548"></a>00548                                                    <a class="code" href="classKBRTestApp.html#a833410beacd955fe47a27bbf7f29107f" title="if true only search for inoffensive nodes (use together with lookupNodeIds)">onlyLookupInoffensiveNodes</a>);
<a name="l00549"></a>00549         <span class="keywordflow">return</span> std::make_pair(handle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>(), handle);
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551     <span class="comment">// generate random destination key</span>
<a name="l00552"></a>00552     <span class="keywordflow">return</span> std::make_pair(<a class="code" href="classOverlayKey.html#a1983e1b47e32783f8ccd5e59fe725290" title="Returns a random key.">OverlayKey::random</a>(), <a class="code" href="classTransportAddress.html#ac1709545db722cbbce1367034142d31f" title="TransportAddress without specified ip and port.">TransportAddress::UNSPECIFIED_NODE</a>);
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a><a class="code" href="classKBRTestApp.html#a1c22d7bc56871a63cce151e599a83229">00555</a> <span class="keywordtype">bool</span> <a class="code" href="classKBRTestApp.html#a1c22d7bc56871a63cce151e599a83229" title="Checks if a message was already seen before.">KBRTestApp::checkSeen</a>(<span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key, <span class="keywordtype">int</span> seqNum)
<a name="l00556"></a>00556 {
<a name="l00557"></a>00557     <a class="code" href="structKBRTestApp_1_1MsgHandle.html" title="type for storing seen messages in a circular buffer, holds OverlayKey of the sender and SequenceNumbe...">MsgHandle</a> hdl(key, seqNum);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     <span class="keywordflow">for</span> (MsgHandleBuf::iterator it = <a class="code" href="classKBRTestApp.html#a3485ceb9284504b412d371e9eecaf27f" title="begin of circular buffer">mhBufBegin</a>; it != <a class="code" href="classKBRTestApp.html#a9a44c784eb9297c7b8fadf276a358c9f" title="end of circular buffer">mhBufEnd</a>; ++it) {
<a name="l00560"></a>00560         <span class="keywordflow">if</span> (it-&gt;key.isUnspecified()) {
<a name="l00561"></a>00561             <span class="keywordflow">continue</span>;
<a name="l00562"></a>00562         }
<a name="l00563"></a>00563         <span class="keywordflow">if</span> (*it == hdl) {
<a name="l00564"></a>00564             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00565"></a>00565         }
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     *(<a class="code" href="classKBRTestApp.html#a26eff89ff4d9ea19681a4e2df67e7332" title="next element to insert">mhBufNext</a>++) = hdl;
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#a26eff89ff4d9ea19681a4e2df67e7332" title="next element to insert">mhBufNext</a> == <a class="code" href="classKBRTestApp.html#a9a44c784eb9297c7b8fadf276a358c9f" title="end of circular buffer">mhBufEnd</a>) {
<a name="l00570"></a>00570         <a class="code" href="classKBRTestApp.html#a26eff89ff4d9ea19681a4e2df67e7332" title="next element to insert">mhBufNext</a> = <a class="code" href="classKBRTestApp.html#a3485ceb9284504b412d371e9eecaf27f" title="begin of circular buffer">mhBufBegin</a>;
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00574"></a>00574 }
<a name="l00575"></a>00575 
<a name="l00576"></a><a class="code" href="classKBRTestApp.html#acf7fa74f658d890e579a60ea04a5b0a6">00576</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#acf7fa74f658d890e579a60ea04a5b0a6" title="Analyses and records measuring data handed over from nodes that previously had been the destination f...">KBRTestApp::evaluateData</a>(simtime_t latency, <span class="keywordtype">int</span> hopCount, <span class="keywordtype">long</span> <span class="keywordtype">int</span> bytes)
<a name="l00577"></a>00577 {
<a name="l00578"></a>00578     <span class="comment">// count the number and size of successfully delivered messages</span>
<a name="l00579"></a>00579     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classKBRTestApp.html#a12358b55f911eed27f411a402e308542" title="number of delivered packets">numDelivered</a>++; <a class="code" href="classKBRTestApp.html#ad71a94daa5c574ab6d57c1baa984bc9d" title="number of delivered bytes">bytesDelivered</a> += bytes;
<a name="l00580"></a>00580                  <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a59bfce2d2d29f05ca1f0610db9c508f0" title="total number of messages delivered by KBRTestApp">deliveredKBRTestAppMessages</a>++);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#a8ce13256ea63aa80192971d5c2ac50cc">numSent</a> &lt; <a class="code" href="classKBRTestApp.html#a12358b55f911eed27f411a402e308542" title="number of delivered packets">numDelivered</a>) {
<a name="l00583"></a>00583         std::ostringstream tempString;
<a name="l00584"></a>00584         tempString &lt;&lt; <span class="stringliteral">&quot;KBRTestApp::evaluateData(): numSent (&quot;</span>
<a name="l00585"></a>00585                    &lt;&lt; <a class="code" href="classKBRTestApp.html#a8ce13256ea63aa80192971d5c2ac50cc">numSent</a> &lt;&lt; <span class="stringliteral">&quot;) &lt; numDelivered (&quot;</span> &lt;&lt; <a class="code" href="classKBRTestApp.html#a12358b55f911eed27f411a402e308542" title="number of delivered packets">numDelivered</a> &lt;&lt; <span class="stringliteral">&quot;)!&quot;</span>;
<a name="l00586"></a>00586         <span class="keywordflow">throw</span> cRuntimeError(tempString.str().c_str());
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(<span class="stringliteral">&quot;KBRTestApp: One-way Hop &quot;</span>
<a name="l00590"></a>00590                                                    <span class="stringliteral">&quot;Count&quot;</span>, hopCount));
<a name="l00591"></a>00591     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(<span class="stringliteral">&quot;KBRTestApp: One-way Latency&quot;</span>,
<a name="l00592"></a>00592                                                    SIMTIME_DBL(latency)));
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a><a class="code" href="classKBRTestApp.html#ad99186daad4bdf6c77fa667a0bb07056">00595</a> <span class="keywordtype">void</span> <a class="code" href="classKBRTestApp.html#ad99186daad4bdf6c77fa667a0bb07056" title="collects statistical data of derived app">KBRTestApp::finishApp</a>()
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597     simtime_t time = <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a610799ebfbf64696c59b811870cc8300">calcMeasuredLifetime</a>(<a class="code" href="classBaseApp.html#ac365b8c1cb45fb1e37f95535936a0f31" title="simTime when the App has been created">creationTime</a>);
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (time &gt;= <a class="code" href="classGlobalStatistics.html#a169810c78519b271f7e32fdc7c9fc641" title="minimum useful measured lifetime in seconds">GlobalStatistics::MIN_MEASURED</a>) {
<a name="l00600"></a>00600         <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#afd14f68bbfff247b4f32498e5b241993">kbrOneWayTest</a>) {
<a name="l00601"></a>00601             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: One-way Delivered Messages/s&quot;</span>,
<a name="l00602"></a>00602                                         <a class="code" href="classKBRTestApp.html#a12358b55f911eed27f411a402e308542" title="number of delivered packets">numDelivered</a> / time);
<a name="l00603"></a>00603             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: One-way Delivered Bytes/s&quot;</span>,
<a name="l00604"></a>00604                                         <a class="code" href="classKBRTestApp.html#ad71a94daa5c574ab6d57c1baa984bc9d" title="number of delivered bytes">bytesDelivered</a> / time);
<a name="l00605"></a>00605             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: One-way Dropped Messages/s&quot;</span>,
<a name="l00606"></a>00606                                         <a class="code" href="classKBRTestApp.html#a0b9c2e82f3287e4200d6f12d26371739">numDropped</a> / time);
<a name="l00607"></a>00607             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: One-way Dropped Bytes/s&quot;</span>,
<a name="l00608"></a>00608                                         <a class="code" href="classKBRTestApp.html#a3243446a1be631c71455e80d8c25e475">bytesDropped</a> / time);
<a name="l00609"></a>00609             <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#a8ce13256ea63aa80192971d5c2ac50cc">numSent</a> &gt; 0) {
<a name="l00610"></a>00610                 <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: One-way Delivery Ratio&quot;</span>,
<a name="l00611"></a>00611                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#a12358b55f911eed27f411a402e308542" title="number of delivered packets">numDelivered</a> /
<a name="l00612"></a>00612                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#a8ce13256ea63aa80192971d5c2ac50cc">numSent</a>);
<a name="l00613"></a>00613 <span class="comment">/*                globalStatistics-&gt;addStdDev(&quot;KBRTestApp: One-way Total Latency&quot;,</span>
<a name="l00614"></a>00614 <span class="comment">                                             globalStatistics-&gt;getv * (1 - ((float)numDelivered /</span>
<a name="l00615"></a>00615 <span class="comment">                                                     (float)numSent)));*/</span>
<a name="l00616"></a>00616             }
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#a64f89ade2d0af91791f6524b7b08cc29">kbrRpcTest</a>) {
<a name="l00620"></a>00620             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: RPC Delivered Messages/s&quot;</span>,
<a name="l00621"></a>00621                                         <a class="code" href="classKBRTestApp.html#ad9ea83ac232db846335c38619e6d9d04" title="number of delivered packets">numRpcDelivered</a> / time);
<a name="l00622"></a>00622             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: RPC Delivered Bytes/s&quot;</span>,
<a name="l00623"></a>00623                                         <a class="code" href="classKBRTestApp.html#ac9287ba30b44d05c1f1e2b3af6e0f2e4" title="number of delivered bytes">bytesRpcDelivered</a> / time);
<a name="l00624"></a>00624             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: RPC Dropped Messages/s&quot;</span>,
<a name="l00625"></a>00625                                         <a class="code" href="classKBRTestApp.html#a837931e670a4117501d5b5d06d91a147">numRpcDropped</a> / time);
<a name="l00626"></a>00626             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: RPC Dropped Bytes/s&quot;</span>,
<a name="l00627"></a>00627                                         <a class="code" href="classKBRTestApp.html#a1c76cf2493d997bea95577ad53792e5a">bytesRpcDropped</a> / time);
<a name="l00628"></a>00628 <span class="preprocessor">#if 0</span>
<a name="l00629"></a>00629 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#ae755fda691b0e7b8ed23b318c52871f8">rpcSuccLatencyCount</a> &gt; 0) {
<a name="l00630"></a>00630                 <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: RPC Success Session Latency&quot;</span>,
<a name="l00631"></a>00631                                         SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#aeb37374bdf671e95a65ce93143cb2afc">rpcSuccLatencySum</a>) / <a class="code" href="classKBRTestApp.html#ae755fda691b0e7b8ed23b318c52871f8">rpcSuccLatencyCount</a>);
<a name="l00632"></a>00632             }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634             <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#acb9b120ab10edc6a08b554e7ea6f732b">rpcTotalLatencyCount</a> &gt; 0) {
<a name="l00635"></a>00635                 <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: RPC Total Session Latency&quot;</span>,
<a name="l00636"></a>00636                                         SIMTIME_DBL(<a class="code" href="classKBRTestApp.html#af4d1d4d8f6c1e5ce301b25ca958cc2e5">rpcTotalLatencySum</a>) / <a class="code" href="classKBRTestApp.html#acb9b120ab10edc6a08b554e7ea6f732b">rpcTotalLatencyCount</a>);
<a name="l00637"></a>00637             }
<a name="l00638"></a>00638 <span class="preprocessor">#endif</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span>
<a name="l00640"></a>00640             <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#aafa44894b8e262682596aea6b235bcf1">numRpcSent</a> &gt; 0) {
<a name="l00641"></a>00641                 <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: RPC Delivery Ratio&quot;</span>,
<a name="l00642"></a>00642                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#ad9ea83ac232db846335c38619e6d9d04" title="number of delivered packets">numRpcDelivered</a> /
<a name="l00643"></a>00643                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#aafa44894b8e262682596aea6b235bcf1">numRpcSent</a>);
<a name="l00644"></a>00644             }
<a name="l00645"></a>00645         }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647         <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#aea8edb2d1c871881b1090c93b0325338">kbrLookupTest</a>) {
<a name="l00648"></a>00648             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: Successful Lookups/s&quot;</span>,
<a name="l00649"></a>00649                                         <a class="code" href="classKBRTestApp.html#a627fe29d5bed8ea2d7f1b2fbe2881e53">numLookupSuccess</a> / time);
<a name="l00650"></a>00650             <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: Failed Lookups/s&quot;</span>,
<a name="l00651"></a>00651                                         <a class="code" href="classKBRTestApp.html#ae243723c9d57797ed147e668c953f6ae">numLookupFailed</a> / time);
<a name="l00652"></a>00652             <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#a7d87083e30472441f161c47b617a427f">numLookupSent</a> &gt; 0) {
<a name="l00653"></a>00653                 <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: Lookup Success Ratio&quot;</span>,
<a name="l00654"></a>00654                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#a627fe29d5bed8ea2d7f1b2fbe2881e53">numLookupSuccess</a> /
<a name="l00655"></a>00655                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#a7d87083e30472441f161c47b617a427f">numLookupSent</a>);
<a name="l00656"></a>00656             }
<a name="l00657"></a>00657         }
<a name="l00658"></a>00658         <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#aaf1a1a1fdbaa133fb8dc06d4dc6c9093">underlayTest</a>) {
<a name="l00659"></a>00659             <span class="keywordflow">if</span> (<a class="code" href="classKBRTestApp.html#aa3ce14b7182753ccf770d6aeb74913f9">numUnderlaySent</a> &gt; 0) {
<a name="l00660"></a>00660                 <a class="code" href="classBaseApp.html#a70bdab2d4ea3553205115f057194f692" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;KBRTestApp: Underlay Delivery Ratio&quot;</span>,
<a name="l00661"></a>00661                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#a207c30de6b17507d64187fd78d7f705e" title="number of delivered packets">numUnderlayDelivered</a> /
<a name="l00662"></a>00662                                             (<span class="keywordtype">float</span>)<a class="code" href="classKBRTestApp.html#aa3ce14b7182753ccf770d6aeb74913f9">numUnderlaySent</a>);
<a name="l00663"></a>00663             }
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="KBRTestApp_8cc.html">KBRTestApp.cc</a>      </li>

    <li class="footer">Generated on Thu Mar 6 2014 14:06:28 for OverSim by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
