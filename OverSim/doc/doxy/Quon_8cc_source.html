<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: Quon.cc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OverSim
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('Quon_8cc.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Quon.cc</div>  </div>
</div>
<div class="contents">
<a href="Quon_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2006 Institut fuer Telematik, Universitaet Karlsruhe (TH)</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment">// modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment">// GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment">// along with this program; if not, write to the Free Software</span>
<a name="l00016"></a>00016 <span class="comment">// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="Quon_8h.html">Quon.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="BootstrapList_8h.html">BootstrapList.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;limits&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <a class="code" href="ALMTest_8cc.html#a3b5014f410c7989e8bad4b467ecc94cd">Define_Module</a>(<a class="code" href="classQuon.html" title="QuON: An overlay network based on quadtrees.">Quon</a>);
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="classQuon.html#ae17dfb6ef0492454b6b1b4e455e0f403">00031</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ae17dfb6ef0492454b6b1b4e455e0f403" title="Initializes derived-class-attributes.">Quon::initializeOverlay</a>(<span class="keywordtype">int</span> stage)
<a name="l00032"></a>00032 {
<a name="l00033"></a>00033     <span class="comment">// because of IPAddressResolver, we need to wait until interfaces are registered,</span>
<a name="l00034"></a>00034     <span class="comment">// address auto-assignment takes place etc.</span>
<a name="l00035"></a>00035     <span class="keywordflow">if</span>(stage != <a class="code" href="InitStages_8h.html#a42fde1aa1e14a1c45d29061d6e87e532a58e83c497c7c8495e9c592ff3148b6b9" title="first stage for overlay modules (Tier 0 / KBR)">MIN_STAGE_OVERLAY</a>) {
<a name="l00036"></a>00036         <span class="keywordflow">return</span>;
<a name="l00037"></a>00037     }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="comment">// fetch parameters</span>
<a name="l00040"></a>00040     <a class="code" href="classQuon.html#a5321c54300684011b310874cb504cc3b">minAOI</a> = (double)par(<span class="stringliteral">&quot;minAOIWidth&quot;</span>) + (double)par(<span class="stringliteral">&quot;AOIBuffer&quot;</span>); <span class="comment">// FIXME: use buffer only where required</span>
<a name="l00041"></a>00041     <a class="code" href="classQuon.html#a4031fe13e201230e6822a0b6d312b9c0">maxAOI</a> = (double)par(<span class="stringliteral">&quot;AOIWidth&quot;</span>) + (double)par(<span class="stringliteral">&quot;AOIBuffer&quot;</span>); <span class="comment">// FIXME: use buffer only where required</span>
<a name="l00042"></a>00042     <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> = <a class="code" href="classQuon.html#a4031fe13e201230e6822a0b6d312b9c0">maxAOI</a>;
<a name="l00043"></a>00043     <a class="code" href="classQuon.html#aed45985bf8ae12aa4a05e3c74f0a03ed">connectionLimit</a> = par(<span class="stringliteral">&quot;connectionLimit&quot;</span>);
<a name="l00044"></a>00044     <a class="code" href="classQuon.html#ac0c61c44ee942bcb8f71ffa069a681fc">areaDimension</a> = par(<span class="stringliteral">&quot;areaDimension&quot;</span>);
<a name="l00045"></a>00045     <a class="code" href="classQuon.html#a8f89d751256d37ac702a2820130755ad">joinTimeout</a> = par(<span class="stringliteral">&quot;joinTimeout&quot;</span>);
<a name="l00046"></a>00046     <a class="code" href="classQuon.html#a29afd14267371b2fdccb31e8d5bcebee">deleteTimeout</a> = par(<span class="stringliteral">&quot;deleteTimeout&quot;</span>);
<a name="l00047"></a>00047     <a class="code" href="classQuon.html#a6657a1bdcf332a5a383a5e380cbc16c0">aliveTimeout</a> = (double)par(<span class="stringliteral">&quot;aliveTimeout&quot;</span>) / 2.0;
<a name="l00048"></a>00048     <a class="code" href="classQuon.html#a45b886170e957fd9326a4c34abe4839b">backupIntervall</a> = par(<span class="stringliteral">&quot;contactBackupIntervall&quot;</span>);
<a name="l00049"></a>00049     <a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a> = par(<span class="stringliteral">&quot;numBackups&quot;</span>);
<a name="l00050"></a>00050     <a class="code" href="classQuon.html#a369f0916dfd5f306a4a31a9bac648be6">linearAdaption</a> = par(<span class="stringliteral">&quot;AOIAdaptLinear&quot;</span>);
<a name="l00051"></a>00051     <a class="code" href="classQuon.html#ae44950a7619cd0e9bcb65071f9871302">adaptionSensitivity</a> = par(<span class="stringliteral">&quot;AOIAdaptionSensitivity&quot;</span>);
<a name="l00052"></a>00052     <a class="code" href="classQuon.html#acfff4768dab96f6a068f05385c806da9">gossipSensitivity</a> = par(<span class="stringliteral">&quot;AOIGossipSensitivity&quot;</span>);
<a name="l00053"></a>00053     <a class="code" href="classQuon.html#ad1c9991e5c1094281e552c88ea4f0612">useSquareMetric</a> = par(<span class="stringliteral">&quot;useSquareMetric&quot;</span>);
<a name="l00054"></a>00054     <a class="code" href="classQuon.html#aa9793f8df0a8a1e1e448f2ff28233457">nnOnlyBinding</a> = par(<span class="stringliteral">&quot;newNeighborsOnlyBinding&quot;</span>);
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     <a class="code" href="classQuon.html#a560b63c7e1d4ad9c34bc4ac9f70311e9">bindingBackup</a> = <span class="keyword">new</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>[<a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>][4];
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     <a class="code" href="classQuon.html#a7affc6a652f7df6a00a9fa9616989cba">loginCache</a> = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classLoginCache.html">LoginCache</a>*<span class="keyword">&gt;</span>(simulation.getModuleByPath(<span class="stringliteral">&quot;globalObserver.globalFunctions[0].function.loginCache&quot;</span>));
<a name="l00059"></a>00059     <a class="code" href="classQuon.html#aa29f3d95a21cf376d2116afd879bcd51">cacheInterval</a> = par(<span class="stringliteral">&quot;cacheInterval&quot;</span>);
<a name="l00060"></a>00060     <a class="code" href="classQuon.html#af3a8c48d58d3ae799f8e84491cc590d8">timeSinceCache</a> = 0;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     <span class="comment">// determine wether we want dynamic AOI or not</span>
<a name="l00063"></a>00063     <a class="code" href="classQuon.html#a82f95ed825de6241bcf407bcb6732686">useDynamicAOI</a> = <a class="code" href="classQuon.html#aed45985bf8ae12aa4a05e3c74f0a03ed">connectionLimit</a> &gt; 0 &amp;&amp; <a class="code" href="classQuon.html#a5321c54300684011b310874cb504cc3b">minAOI</a> &lt; <a class="code" href="classQuon.html#a4031fe13e201230e6822a0b6d312b9c0">maxAOI</a>;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065     <span class="comment">// set node key and thisSite pointer</span>
<a name="l00066"></a>00066     <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#af3992f1fda9ea42dc10bf4739e47700a" title="saves given key to NodeHandle::key">setKey</a>(<a class="code" href="classOverlayKey.html#a1983e1b47e32783f8ccd5e59fe725290" title="Returns a random key.">OverlayKey::random</a>());
<a name="l00067"></a>00067     <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a> = <span class="keyword">new</span> <a class="code" href="classQuonSite.html">QuonSite</a>();
<a name="l00068"></a>00068     <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a> = <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>;
<a name="l00069"></a>00069     <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#afa6fe24c5adadabe18529bb5736d321b">type</a> = <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a5f0c262d908147d33dd7235bd5cd5515">QTHIS</a>;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     <span class="comment">// initialize self-messages</span>
<a name="l00072"></a>00072     <a class="code" href="classQuon.html#a50bdccb83a076a567533790cef1a7c84">join_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;join_timer&quot;</span>);
<a name="l00073"></a>00073     <a class="code" href="classQuon.html#a90247744dc8738653a4830170ac600e4">sec_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;sec_timer&quot;</span>);
<a name="l00074"></a>00074     <a class="code" href="classQuon.html#a77a68e7de92d342999c42495e23691c1">alive_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;alive_timer&quot;</span>);
<a name="l00075"></a>00075     <a class="code" href="classQuon.html#a41c411546eafb1dd79c0640a3937090e">backup_timer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;backup_timer&quot;</span>);
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     <span class="comment">// statistics</span>
<a name="l00078"></a>00078     <a class="code" href="classQuon.html#acd2d26c06a998552d4d57d7d54a9203c">joinRequestBytesSend</a> = 0.0;
<a name="l00079"></a>00079     <a class="code" href="classQuon.html#a877edb5c60f4374580611db5e87f9b03">joinAcknowledgeBytesSend</a> = 0.0;
<a name="l00080"></a>00080     <a class="code" href="classQuon.html#ac662039da04c611b551ca0b5b0989242">nodeMoveBytesSend</a> = 0.0;
<a name="l00081"></a>00081     <a class="code" href="classQuon.html#a60b6442582b349621a5b916b5f63bfdb">newNeighborsBytesSend</a> = 0.0;
<a name="l00082"></a>00082     <a class="code" href="classQuon.html#ac2d00865bf9e11a6f768434266fc6634">nodeLeaveBytesSend</a> = 0.0;
<a name="l00083"></a>00083     <a class="code" href="classQuon.html#a479502f99f21bf405210eb0c7c00a9b6">maxBytesPerSecondSend</a> = 0.0;
<a name="l00084"></a>00084     <a class="code" href="classQuon.html#ab43ea338aa35a082c379716a3fcd02c1">averageBytesPerSecondSend</a> = 0.0;
<a name="l00085"></a>00085     <a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a> = 0.0;
<a name="l00086"></a>00086     <a class="code" href="classQuon.html#ad842d00209159d0d47c0abe7aec573c2">softConnections</a> = 0;
<a name="l00087"></a>00087     <a class="code" href="classQuon.html#a5450bc23ca2b380316b38903536cad1c">softNeighborCount</a> = 0;
<a name="l00088"></a>00088     <a class="code" href="classQuon.html#ac8e1a28cfc559f56cfa51ee757a5b44d">bindingNeighborCount</a> = 0;
<a name="l00089"></a>00089     <a class="code" href="classQuon.html#a98466c67a6d900869219e4c8acf1dd7c">directNeighborCount</a> = 0;
<a name="l00090"></a>00090     <a class="code" href="classQuon.html#acdba7ca61befddc0377f74b502f24a1c">secTimerCount</a> = 0;
<a name="l00091"></a>00091     <span class="comment">//rejoinCount = 0;</span>
<a name="l00092"></a>00092     <a class="code" href="classQuon.html#a2412db36457ab9bae180b8dd1c3cec47">avgAOI</a>= 0 ;
<a name="l00093"></a>00093     <a class="code" href="classQuon.html#a288de6387349541943a75fe3d4894491">joinTime</a> = 0;
<a name="l00094"></a>00094 
<a name="l00095"></a>00095     <span class="comment">// watch some variables</span>
<a name="l00096"></a>00096     WATCH(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00097"></a>00097     WATCH(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00098"></a>00098     WATCH(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00099"></a>00099     <span class="comment">//WATCH_POINTER_MAP(Sites);</span>
<a name="l00100"></a>00100     <span class="comment">//WATCH_POINTER_MAP(deletedSites);</span>
<a name="l00101"></a>00101     <span class="comment">//WATCH_SET(Positions);</span>
<a name="l00102"></a>00102     WATCH(<a class="code" href="classQuon.html#acd2d26c06a998552d4d57d7d54a9203c">joinRequestBytesSend</a>);
<a name="l00103"></a>00103     WATCH(<a class="code" href="classQuon.html#a877edb5c60f4374580611db5e87f9b03">joinAcknowledgeBytesSend</a>);
<a name="l00104"></a>00104     WATCH(<a class="code" href="classQuon.html#ac662039da04c611b551ca0b5b0989242">nodeMoveBytesSend</a>);
<a name="l00105"></a>00105     WATCH(<a class="code" href="classQuon.html#a60b6442582b349621a5b916b5f63bfdb">newNeighborsBytesSend</a>);
<a name="l00106"></a>00106     WATCH(<a class="code" href="classQuon.html#ac2d00865bf9e11a6f768434266fc6634">nodeLeaveBytesSend</a>);
<a name="l00107"></a>00107     WATCH(<a class="code" href="classQuon.html#a479502f99f21bf405210eb0c7c00a9b6">maxBytesPerSecondSend</a>);
<a name="l00108"></a>00108     WATCH(<a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a>);
<a name="l00109"></a>00109     WATCH(<a class="code" href="classQuon.html#ad842d00209159d0d47c0abe7aec573c2">softConnections</a>);
<a name="l00110"></a>00110     WATCH(<a class="code" href="classQuon.html#a5450bc23ca2b380316b38903536cad1c">softNeighborCount</a>);
<a name="l00111"></a>00111     WATCH(<a class="code" href="classQuon.html#ac8e1a28cfc559f56cfa51ee757a5b44d">bindingNeighborCount</a>);
<a name="l00112"></a>00112     WATCH(<a class="code" href="classQuon.html#a98466c67a6d900869219e4c8acf1dd7c">directNeighborCount</a>);
<a name="l00113"></a>00113     <span class="comment">//WATCH(rejoinCount);</span>
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">// set initial state</span>
<a name="l00116"></a>00116     <a class="code" href="classQuon.html#a58914d072978b36b252a96a7df1fadae">aloneInOverlay</a> = <span class="keyword">false</span>;
<a name="l00117"></a>00117     <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>);
<a name="l00118"></a>00118     <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a6159e3ad96e5cc7ce4cc87a9ac499213">QJOINING</a>);
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">00121</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">Quon::changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1" title="Common Quon Definitions.">QState</a> qstate)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123     this-&gt;qstate = <a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a>;
<a name="l00124"></a>00124     <span class="keywordflow">switch</span>(qstate) {
<a name="l00125"></a>00125         <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>:
<a name="l00126"></a>00126             <a class="code" href="classBaseOverlay.html#a933e505ea77cae4ab0c8edcb77ade2c7" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#ad71420e64d6f5466ecfd95d8ab56ca55" title="Debootstraps peers in the peer set.">removePeer</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00127"></a>00127             cancelEvent(<a class="code" href="classQuon.html#a50bdccb83a076a567533790cef1a7c84">join_timer</a>);
<a name="l00128"></a>00128             cancelEvent(<a class="code" href="classQuon.html#a90247744dc8738653a4830170ac600e4">sec_timer</a>);
<a name="l00129"></a>00129             cancelEvent(<a class="code" href="classQuon.html#a77a68e7de92d342999c42495e23691c1">alive_timer</a>);
<a name="l00130"></a>00130             cancelEvent(<a class="code" href="classQuon.html#a41c411546eafb1dd79c0640a3937090e">backup_timer</a>);
<a name="l00131"></a>00131             <span class="keywordflow">break</span>;
<a name="l00132"></a>00132         <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a6159e3ad96e5cc7ce4cc87a9ac499213">QJOINING</a>:
<a name="l00133"></a>00133             <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#a288de6387349541943a75fe3d4894491">joinTime</a> == 0 ) <a class="code" href="classQuon.html#a288de6387349541943a75fe3d4894491">joinTime</a> = simTime();
<a name="l00134"></a>00134             scheduleAt(simTime(), <a class="code" href="classQuon.html#a50bdccb83a076a567533790cef1a7c84">join_timer</a>);
<a name="l00135"></a>00135             scheduleAt(simTime() + 1.0, <a class="code" href="classQuon.html#a90247744dc8738653a4830170ac600e4">sec_timer</a>);
<a name="l00136"></a>00136             <span class="keywordflow">break</span>;
<a name="l00137"></a>00137         <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>:
<a name="l00138"></a>00138             cancelEvent(<a class="code" href="classQuon.html#a50bdccb83a076a567533790cef1a7c84">join_timer</a>);
<a name="l00139"></a>00139             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(
<a name="l00140"></a>00140                 <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(
<a name="l00141"></a>00141                     <span class="stringliteral">&quot;QuON: JoinTime&quot;</span>,
<a name="l00142"></a>00142                     SIMTIME_DBL(simTime()) - SIMTIME_DBL(<a class="code" href="classQuon.html#a288de6387349541943a75fe3d4894491">joinTime</a>) + par(<span class="stringliteral">&quot;addJoinDelay&quot;</span>).doubleValue()
<a name="l00143"></a>00143                     );
<a name="l00144"></a>00144             );
<a name="l00145"></a>00145             <a class="code" href="classQuon.html#a288de6387349541943a75fe3d4894491">joinTime</a> = 0;
<a name="l00146"></a>00146             <a class="code" href="classBaseOverlay.html#a933e505ea77cae4ab0c8edcb77ade2c7" title="pointer to GlobalNodeList in this node">globalNodeList</a>-&gt;<a class="code" href="classGlobalNodeList.html#a944218e1a3f9a3fcb029079db32eee03" title="Bootstraps peers in the peer set.">registerPeer</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00147"></a>00147             <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#a7affc6a652f7df6a00a9fa9616989cba">loginCache</a> ) <a class="code" href="classQuon.html#a7affc6a652f7df6a00a9fa9616989cba">loginCache</a>-&gt;<a class="code" href="classLoginCache.html#ae9ee5141c732f56eacbf64f179336084">registerPos</a>( <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>, <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a> );
<a name="l00148"></a>00148             <span class="comment">// tell the application we are ready unless we are rejoining the overlay</span>
<a name="l00149"></a>00149             <span class="comment">//if(rejoinCount == 0) {</span>
<a name="l00150"></a>00150             <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>* readyMsg = <span class="keyword">new</span> <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>(<span class="stringliteral">&quot;OVERLAY_READY&quot;</span>);
<a name="l00151"></a>00151             readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#a07d2b2a15889728c23ed4d80730de2cf">setReady</a>(<span class="keyword">true</span>);
<a name="l00152"></a>00152             readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#a77640d7f3566804064921b2520ed51b6">setComp</a>(<a class="code" href="classBaseOverlay.html#a92e0d3f96a5716245465e05da60ef487" title="Return the component type of this module.">getThisCompType</a>());
<a name="l00153"></a>00153             <span class="comment">// TODO/FIXME: use overlay-&gt;sendMessageToAllComp(msg, getThisCompType())?</span>
<a name="l00154"></a>00154             <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(readyMsg);
<a name="l00155"></a>00155             <span class="comment">//}</span>
<a name="l00156"></a>00156             <span class="comment">// set initial AOI size</span>
<a name="l00157"></a>00157             <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> = <a class="code" href="classQuon.html#a4031fe13e201230e6822a0b6d312b9c0">maxAOI</a>;
<a name="l00158"></a>00158             <a class="code" href="classGameAPIResizeAOIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIResizeAOIMessage</a>* gameMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIResizeAOIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIResizeAOIMessage</a>(<span class="stringliteral">&quot;RESIZE_AOI&quot;</span>);
<a name="l00159"></a>00159             gameMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3fe3071c66623191477b903527280ddc">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba04223e5523bbf330b2553e5ba3e320d1">RESIZE_AOI</a>);
<a name="l00160"></a>00160             gameMsg-&gt;<a class="code" href="classGameAPIResizeAOIMessage.html#ae8df0a2a6adc664d2dc8a5c0291f9f49">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00161"></a>00161             <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(gameMsg);
<a name="l00162"></a>00162             <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a6657a1bdcf332a5a383a5e380cbc16c0">aliveTimeout</a> &gt; 0.0) {
<a name="l00163"></a>00163                 scheduleAt(simTime() + <a class="code" href="classQuon.html#a6657a1bdcf332a5a383a5e380cbc16c0">aliveTimeout</a>, <a class="code" href="classQuon.html#a77a68e7de92d342999c42495e23691c1">alive_timer</a>);
<a name="l00164"></a>00164             }
<a name="l00165"></a>00165             <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a45b886170e957fd9326a4c34abe4839b">backupIntervall</a> &gt; 0.0) {
<a name="l00166"></a>00166                 scheduleAt(simTime() + <a class="code" href="classQuon.html#a45b886170e957fd9326a4c34abe4839b">backupIntervall</a>, <a class="code" href="classQuon.html#a41c411546eafb1dd79c0640a3937090e">backup_timer</a>);
<a name="l00167"></a>00167             }
<a name="l00168"></a>00168             <span class="keywordflow">break</span>;
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170     <a class="code" href="classQuon.html#a21e2a16a7d0c8eb408c6f936fecf9df4">setBootstrapedIcon</a>();
<a name="l00171"></a>00171     <span class="comment">// debug output</span>
<a name="l00172"></a>00172     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00173"></a>00173         EV &lt;&lt; <span class="stringliteral">&quot;[Quon::changeState() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00174"></a>00174            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00175"></a>00175            &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; entered &quot;</span>;
<a name="l00176"></a>00176         <span class="keywordflow">switch</span>(qstate) {
<a name="l00177"></a>00177             <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>:
<a name="l00178"></a>00178                 EV &lt;&lt; <span class="stringliteral">&quot;UNINITIALIZED&quot;</span>;
<a name="l00179"></a>00179                 <span class="keywordflow">break</span>;
<a name="l00180"></a>00180             <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a6159e3ad96e5cc7ce4cc87a9ac499213">QJOINING</a>:
<a name="l00181"></a>00181                 EV &lt;&lt; <span class="stringliteral">&quot;JOINING&quot;</span>;
<a name="l00182"></a>00182                 <span class="keywordflow">break</span>;
<a name="l00183"></a>00183             <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>:
<a name="l00184"></a>00184                 EV &lt;&lt; <span class="stringliteral">&quot;READY&quot;</span>;
<a name="l00185"></a>00185                 <span class="keywordflow">break</span>;
<a name="l00186"></a>00186         }
<a name="l00187"></a>00187         EV &lt;&lt; <span class="stringliteral">&quot; state.&quot;</span> &lt;&lt; endl;
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="classQuon.html#a77a76cd536634a9d90b208cb3f662bd4">00191</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a77a76cd536634a9d90b208cb3f662bd4">Quon::handleTimerEvent</a>(cMessage* msg)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;join_timer&quot;</span>)) {
<a name="l00194"></a>00194         <span class="comment">//reset timer</span>
<a name="l00195"></a>00195         cancelEvent(<a class="code" href="classQuon.html#a50bdccb83a076a567533790cef1a7c84">join_timer</a>);
<a name="l00196"></a>00196         <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> != <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>) {
<a name="l00197"></a>00197             scheduleAt(simTime() + <a class="code" href="classQuon.html#a8f89d751256d37ac702a2820130755ad">joinTimeout</a>, msg);
<a name="l00198"></a>00198             <span class="comment">// handle event</span>
<a name="l00199"></a>00199             <a class="code" href="classQuon.html#ac29ea34a956954a1fa1386eaf8cb02be">processJoinTimer</a>();
<a name="l00200"></a>00200         }
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;sec_timer&quot;</span>)) {
<a name="l00203"></a>00203         <span class="comment">//reset timer</span>
<a name="l00204"></a>00204         cancelEvent(<a class="code" href="classQuon.html#a90247744dc8738653a4830170ac600e4">sec_timer</a>);
<a name="l00205"></a>00205         scheduleAt(simTime() + 1, msg);
<a name="l00206"></a>00206         <span class="comment">// handle event</span>
<a name="l00207"></a>00207         <a class="code" href="classQuon.html#a5d098a9b74d485d8e68f7a8d5325ddd1">processSecTimer</a>();
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;delete_timer&quot;</span>)) {
<a name="l00210"></a>00210         <span class="comment">// handle event</span>
<a name="l00211"></a>00211         <a class="code" href="classQuon.html#a430d10cb5e1b77a630ed4657e34f1695">processDeleteTimer</a>(msg);
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;alive_timer&quot;</span>)) {
<a name="l00214"></a>00214         <span class="comment">//reset timer</span>
<a name="l00215"></a>00215         cancelEvent(<a class="code" href="classQuon.html#a77a68e7de92d342999c42495e23691c1">alive_timer</a>);
<a name="l00216"></a>00216         scheduleAt(simTime() + <a class="code" href="classQuon.html#a6657a1bdcf332a5a383a5e380cbc16c0">aliveTimeout</a>, msg);
<a name="l00217"></a>00217         <span class="comment">// handle event</span>
<a name="l00218"></a>00218         <a class="code" href="classQuon.html#a86dbfd8cb030da488a06f4322a0d9f54">processAliveTimer</a>();
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(msg-&gt;isName(<span class="stringliteral">&quot;backup_timer&quot;</span>)) {
<a name="l00221"></a>00221         <span class="comment">//reset timer</span>
<a name="l00222"></a>00222         cancelEvent(<a class="code" href="classQuon.html#a41c411546eafb1dd79c0640a3937090e">backup_timer</a>);
<a name="l00223"></a>00223         scheduleAt(simTime() + <a class="code" href="classQuon.html#a45b886170e957fd9326a4c34abe4839b">backupIntervall</a>, msg);
<a name="l00224"></a>00224         <span class="comment">// handle event</span>
<a name="l00225"></a>00225         <a class="code" href="classQuon.html#af1ff297b237f314e3dd96f8999e0ccb0">processBackupTimer</a>();
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a><a class="code" href="classQuon.html#ae1e1b8da4dc8347f67905eff7b01b458">00229</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ae1e1b8da4dc8347f67905eff7b01b458" title="Processes &quot;timer&quot; self-messages.">Quon::handleAppMessage</a>(cMessage* msg)
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231     <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>* gameAPIMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00232"></a>00232     <span class="keywordflow">if</span>(gameAPIMsg != NULL) {
<a name="l00233"></a>00233         <span class="comment">// debug output</span>
<a name="l00234"></a>00234         <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00235"></a>00235             EV &lt;&lt; <span class="stringliteral">&quot;[Quon::handleAppMessage() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00236"></a>00236                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00237"></a>00237                &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; received &quot;</span> &lt;&lt; gameAPIMsg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; from application.&quot;</span>
<a name="l00238"></a>00238                &lt;&lt; endl;
<a name="l00239"></a>00239         }
<a name="l00240"></a>00240         <span class="keywordflow">switch</span>(gameAPIMsg-&gt;<a class="code" href="classGameAPIMessage.html#a310b7731f5d78aa25d103594d88d0edd">getCommand</a>()) {
<a name="l00241"></a>00241             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba7a7dbf862295be01b326c1d51e73d875">MOVEMENT_INDICATION</a>: {
<a name="l00242"></a>00242                 <a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a>* gameAPIPositionMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00243"></a>00243                 <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a6159e3ad96e5cc7ce4cc87a9ac499213">QJOINING</a>) {
<a name="l00244"></a>00244                     <a class="code" href="classQuon.html#ae55f17acbfe8963c1016aa4b8b52e43f">handleJoin</a>(gameAPIPositionMsg);
<a name="l00245"></a>00245                 }
<a name="l00246"></a>00246                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>) {
<a name="l00247"></a>00247                     <a class="code" href="classQuon.html#ac605f9c70749dc1ff7a4c45450ccfc60">handleMove</a>(gameAPIPositionMsg);
<a name="l00248"></a>00248                 }
<a name="l00249"></a>00249             } <span class="keywordflow">break</span>;
<a name="l00250"></a>00250             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba2d637d8d63fd5cc1921d781389e7482c">GAMEEVENT_CHAT</a>:
<a name="l00251"></a>00251             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba94d7bea1985e12fde4c9b7ba389a59c7">GAMEEVENT_SNOW</a>:
<a name="l00252"></a>00252             <span class="keywordflow">case</span> <a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba42bc017550219c838438200a3155c506">GAMEEVENT_FROZEN</a>: {
<a name="l00253"></a>00253                 <a class="code" href="classQuon.html#ac923ab87b84f63ac532cb148a90d3c30">handleEvent</a>(gameAPIMsg);
<a name="l00254"></a>00254             } <span class="keywordflow">break</span>;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     <span class="keyword">delete</span> msg;
<a name="l00258"></a>00258 }
<a name="l00259"></a>00259 
<a name="l00260"></a><a class="code" href="classQuon.html#a298fcf2d2e493783099f6d0b07cf04d1">00260</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a298fcf2d2e493783099f6d0b07cf04d1" title="Processes messages from underlay.">Quon::handleUDPMessage</a>(<a class="code" href="classBaseOverlayMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseOverlayMessage</a>* msg)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262     <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>) {
<a name="l00263"></a>00263         <span class="keyword">delete</span> msg;
<a name="l00264"></a>00264         <span class="keywordflow">return</span>;
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     <a class="code" href="classQuonMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMessage</a>* quonMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuonMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00267"></a>00267     <span class="keywordflow">if</span>(quonMsg != NULL) {
<a name="l00268"></a>00268         <span class="comment">// debug output</span>
<a name="l00269"></a>00269         <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00270"></a>00270             EV &lt;&lt; <span class="stringliteral">&quot;[Quon::handleUDPMessage() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00271"></a>00271                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00272"></a>00272                &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; received &quot;</span> &lt;&lt; quonMsg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; from &quot;</span> &lt;&lt; quonMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>().<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
<a name="l00273"></a>00273                &lt;&lt; endl;
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275         <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>) {
<a name="l00276"></a>00276             <span class="keywordflow">switch</span>(quonMsg-&gt;<a class="code" href="classQuonMessage.html#a006f8426093f22f07de8b82d8cf0c5be">getCommand</a>()) {
<a name="l00277"></a>00277                 <span class="keywordflow">case</span> <a class="code" href="GiaMessage__m_8h.html#ac712f468e66678ffb5df03be6d6a8157a71fec090ff88ece51771bbbf434064ec">JOIN_REQUEST</a>: {
<a name="l00278"></a>00278                     <a class="code" href="classQuon.html#ad08218dae9b27080131790ebaf6f4b54">handleJoinRequest</a>(quonMsg);
<a name="l00279"></a>00279                 } <span class="keywordflow">break</span>;
<a name="l00280"></a>00280                 <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>: {
<a name="l00281"></a>00281                     <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* quonMoveMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00282"></a>00282                     <a class="code" href="classQuon.html#adee71dee47991a9f5fffafc9b75b037a">handleNodeMove</a>(quonMoveMsg);
<a name="l00283"></a>00283                     <span class="keyword">delete</span> msg;
<a name="l00284"></a>00284                 } <span class="keywordflow">break</span>;
<a name="l00285"></a>00285                 <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa3aafac4a63883acb0402e9a5dcae8110">NEW_NEIGHBORS</a>: {
<a name="l00286"></a>00286                     <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00287"></a>00287                     <a class="code" href="classQuon.html#a74d83ab66d75e28a11a0356510a6eccb">handleNewNeighbors</a>(quonListMsg);
<a name="l00288"></a>00288                     <span class="keyword">delete</span> msg;
<a name="l00289"></a>00289                 } <span class="keywordflow">break</span>;
<a name="l00290"></a>00290                 <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fac2f6b0a84b96ac134911c0d532a4a91c">NODE_LEAVE</a>: {
<a name="l00291"></a>00291                     <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00292"></a>00292                     <a class="code" href="classQuon.html#ae4a338b42bb5ff3afdb34c2c8548c1a7">handleNodeLeave</a>(quonListMsg);
<a name="l00293"></a>00293                     <span class="keyword">delete</span> msg;
<a name="l00294"></a>00294                 } <span class="keywordflow">break</span>;
<a name="l00295"></a>00295                 <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa41da4915ade740f2d44932bedc63b858">QUON_EVENT</a>: {
<a name="l00296"></a>00296                     <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(quonMsg-&gt;decapsulate());
<a name="l00297"></a>00297                     <span class="keyword">delete</span> quonMsg;
<a name="l00298"></a>00298                 } <span class="keywordflow">break</span>;
<a name="l00299"></a>00299             }
<a name="l00300"></a>00300         }
<a name="l00301"></a>00301         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a6159e3ad96e5cc7ce4cc87a9ac499213">QJOINING</a> &amp;&amp; quonMsg-&gt;<a class="code" href="classQuonMessage.html#a006f8426093f22f07de8b82d8cf0c5be">getCommand</a>() == <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad2045a15ed8b82d3db379cc54ba0b7d4">JOIN_ACKNOWLEDGE</a>) {
<a name="l00302"></a>00302             <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00303"></a>00303             <a class="code" href="classQuon.html#a3e899c593816aa1d9b0b37bc710c87f2">handleJoinAcknowledge</a>(quonListMsg);
<a name="l00304"></a>00304             <span class="keyword">delete</span> msg;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306         <span class="keywordflow">else</span> {
<a name="l00307"></a>00307             <span class="keyword">delete</span> msg;
<a name="l00308"></a>00308         }
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310     <span class="keywordflow">else</span> {
<a name="l00311"></a>00311         <span class="keyword">delete</span> msg;
<a name="l00312"></a>00312     }
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a><a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">00315</a> <span class="keywordtype">bool</span> <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">Quon::addSite</a>(<a class="code" href="classVector2D.html">Vector2D</a> p, <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> node, <span class="keywordtype">double</span> AOI, <span class="keywordtype">bool</span> isSoft, <a class="code" href="QuonDefs_8h.html#ae1c9bee235e07483b1ca6526d3625148">QUpdateType</a> update)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317     <a class="code" href="classQuon.html#a58914d072978b36b252a96a7df1fadae">aloneInOverlay</a> = <span class="keyword">false</span>;
<a name="l00318"></a>00318     QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.find(node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00319"></a>00319     QDeleteMap::iterator delIt = <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.find(node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00320"></a>00320     <span class="comment">// add node if he is not in the delete list OR has changed position since </span>
<a name="l00321"></a>00321     <span class="comment">// put in the delete list. don&#39;t add node if he has signled his leave himself</span>
<a name="l00322"></a>00322     <span class="comment">// (i.e. his position in the delete list is 0,0)</span>
<a name="l00323"></a>00323     <span class="keywordflow">if</span>(node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() != <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() &amp;&amp; 
<a name="l00324"></a>00324             (delIt == <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.end() || (delIt-&gt;second != <a class="code" href="classVector2D.html">Vector2D</a>(0,0) &amp;&amp; delIt-&gt;second != p) )){
<a name="l00325"></a>00325         <span class="keywordflow">if</span>(itSites == <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end()) {
<a name="l00326"></a>00326             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00327"></a>00327                 EV &lt;&lt; <span class="stringliteral">&quot;[Quon::addSite() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00328"></a>00328                    &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00329"></a>00329                    &lt;&lt; <span class="stringliteral">&quot;    Site &quot;</span> &lt;&lt; node.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; p &lt;&lt; <span class="stringliteral">&quot; has been added to the list.&quot;</span>
<a name="l00330"></a>00330                    &lt;&lt; endl;
<a name="l00331"></a>00331             }
<a name="l00332"></a>00332             <a class="code" href="classQuonSite.html">QuonSite</a>* temp = <span class="keyword">new</span> <a class="code" href="classQuonSite.html">QuonSite</a>();
<a name="l00333"></a>00333             temp-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a> = p;
<a name="l00334"></a>00334             temp-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a> = node;
<a name="l00335"></a>00335             <span class="keywordflow">if</span>(update == <a class="code" href="QuonDefs_8h.html#ae1c9bee235e07483b1ca6526d3625148a9eda35317bbb785d73e49dc5d9eaf7bc">QDIRECT</a>) {
<a name="l00336"></a>00336                 temp-&gt;<a class="code" href="classQuonSite.html#a5ec803b5181547c3e859fc2200e10f1b">dirty</a> = <span class="keyword">true</span>;
<a name="l00337"></a>00337             }
<a name="l00338"></a>00338             temp-&gt;<a class="code" href="classQuonSite.html#a8b29306a2543f303a7551d621cec34b0">alive</a> = <span class="keyword">true</span>;
<a name="l00339"></a>00339             temp-&gt;<a class="code" href="classQuonSite.html#afa6fe24c5adadabe18529bb5736d321b">type</a> = <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a>;
<a name="l00340"></a>00340             temp-&gt;<a class="code" href="classQuonSite.html#a30d03e7411aaec2499d2319934899772">softNeighbor</a> = isSoft;
<a name="l00341"></a>00341             temp-&gt;<a class="code" href="classQuonSite.html#a0ae6ea9f18f72f1f493828186fecdee3">AOIwidth</a> = AOI;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343             <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.insert(std::make_pair(temp-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>(), temp));
<a name="l00344"></a>00344         }
<a name="l00345"></a>00345         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(update == <a class="code" href="QuonDefs_8h.html#ae1c9bee235e07483b1ca6526d3625148a9eda35317bbb785d73e49dc5d9eaf7bc">QDIRECT</a> || !itSites-&gt;second-&gt;alive) {
<a name="l00346"></a>00346             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00347"></a>00347                 EV &lt;&lt; <span class="stringliteral">&quot;[Quon::addSite() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00348"></a>00348                    &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00349"></a>00349                    &lt;&lt; <span class="stringliteral">&quot;    Site &quot;</span> &lt;&lt; node.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; p &lt;&lt; <span class="stringliteral">&quot; has been updated in the list.&quot;</span>
<a name="l00350"></a>00350                    &lt;&lt; endl;
<a name="l00351"></a>00351             }
<a name="l00352"></a>00352             itSites-&gt;second-&gt;position = p;
<a name="l00353"></a>00353             itSites-&gt;second-&gt;dirty = <span class="keyword">true</span>;
<a name="l00354"></a>00354             itSites-&gt;second-&gt;alive = <span class="keyword">true</span>;
<a name="l00355"></a>00355             itSites-&gt;second-&gt;softNeighbor = isSoft;
<a name="l00356"></a>00356             itSites-&gt;second-&gt;type = <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a>;
<a name="l00357"></a>00357             itSites-&gt;second-&gt;AOIwidth = AOI;
<a name="l00358"></a>00358         }
<a name="l00359"></a>00359         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="classQuon.html#aff5a4bfcea27a7ebfa42f38c3497a744">00364</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#aff5a4bfcea27a7ebfa42f38c3497a744">Quon::updateThisSite</a>(<a class="code" href="classVector2D.html">Vector2D</a> p)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00367"></a>00367         EV &lt;&lt; <span class="stringliteral">&quot;[Quon::updateThisSite() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00368"></a>00368            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00369"></a>00369            &lt;&lt; <span class="stringliteral">&quot;    This Site position has been updated to &quot;</span> &lt;&lt; p &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
<a name="l00370"></a>00370            &lt;&lt; endl;
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372     <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a> = p;
<a name="l00373"></a>00373 }
<a name="l00374"></a>00374 
<a name="l00375"></a><a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">00375</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">Quon::classifySites</a>()
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377     <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size() &gt; 0) {
<a name="l00378"></a>00378         <a class="code" href="classQuonAOI.html" title="QuonP Definitions.">QuonAOI</a> AOI(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>, <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>, <a class="code" href="classQuon.html#ad1c9991e5c1094281e552c88ea4f0612">useSquareMetric</a>);
<a name="l00379"></a>00379         <a class="code" href="classQuonSite.html">QuonSite</a>* (*bindingCandidates)[4] = <span class="keyword">new</span> <a class="code" href="classQuonSite.html">QuonSite</a>*[<a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>+1][4];
<a name="l00380"></a>00380         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt;= <a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>; ++i ){
<a name="l00381"></a>00381             <span class="keywordflow">for</span>( <span class="keywordtype">int</span> ii = 0; ii &lt; 4; ++ii ){
<a name="l00382"></a>00382                 bindingCandidates[i][ii] = 0;
<a name="l00383"></a>00383             }
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385         double (*bindingDistance)[4] = <span class="keyword">new</span> <span class="keywordtype">double</span>[<a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>+1][4];
<a name="l00386"></a>00386         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt;= <a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>; ++i ){
<a name="l00387"></a>00387             <span class="keywordflow">for</span>( <span class="keywordtype">int</span> ii = 0; ii &lt; 4; ++ii ){
<a name="l00388"></a>00388                 bindingDistance[i][ii] = std::numeric_limits&lt;double&gt;::infinity();
<a name="l00389"></a>00389             }
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00393"></a>00393             <a class="code" href="classQuonAOI.html" title="QuonP Definitions.">QuonAOI</a> NeighborAOI(itSites-&gt;second-&gt;position, itSites-&gt;second-&gt;AOIwidth, <a class="code" href="classQuon.html#ad1c9991e5c1094281e552c88ea4f0612">useSquareMetric</a>);
<a name="l00394"></a>00394             <span class="keywordflow">if</span>(AOI.<a class="code" href="classQuonAOI.html#aa99c43ea8785e696457221fcfc6a88db">collide</a>(itSites-&gt;second-&gt;position) || NeighborAOI.<a class="code" href="classQuonAOI.html#aa99c43ea8785e696457221fcfc6a88db">collide</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>)) {
<a name="l00395"></a>00395                 <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type != <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a9a4ea8f06501f7d26d66e134e0e1b015">QNEIGHBOR</a>) {
<a name="l00396"></a>00396                     itSites-&gt;second-&gt;type = <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a9a4ea8f06501f7d26d66e134e0e1b015">QNEIGHBOR</a>;
<a name="l00397"></a>00397                     itSites-&gt;second-&gt;dirty = <span class="keyword">true</span>;
<a name="l00398"></a>00398                 }
<a name="l00399"></a>00399             }
<a name="l00400"></a>00400             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type != <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a>) {
<a name="l00401"></a>00401                 itSites-&gt;second-&gt;type = <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a>;
<a name="l00402"></a>00402                 itSites-&gt;second-&gt;dirty = <span class="keyword">true</span>;
<a name="l00403"></a>00403             }
<a name="l00404"></a>00404             <span class="keywordtype">int</span> quad = <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>.<a class="code" href="classVector2D.html#a63be09d94b3845fbc280a296ee40e299" title="Determine the Quarant a point is contained in.">getQuadrant</a>( itSites-&gt;second-&gt;position );
<a name="l00405"></a>00405             <span class="keywordtype">double</span> dist;
<a name="l00406"></a>00406             <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#ad1c9991e5c1094281e552c88ea4f0612">useSquareMetric</a> ) {
<a name="l00407"></a>00407                 dist = <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>.<a class="code" href="classVector2D.html#a32737dea996933d64be2968ae8f5574a">xyMaxDistance</a>(itSites-&gt;second-&gt;position);
<a name="l00408"></a>00408             } <span class="keywordflow">else</span> {
<a name="l00409"></a>00409                 dist = <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>.<a class="code" href="classVector2D.html#ae01a1f04ce4ee6f09f3fbc72893412cb">distanceSqr</a>(itSites-&gt;second-&gt;position);
<a name="l00410"></a>00410             }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412             <span class="comment">// if dist is smaller than the most far binding candidate</span>
<a name="l00413"></a>00413             <span class="keywordflow">if</span>( dist &lt; bindingDistance[<a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>][quad] ){
<a name="l00414"></a>00414             <span class="comment">// Go through list of binding candidates until distance to current candidate</span>
<a name="l00415"></a>00415             <span class="comment">// is greater than distance to new candidate (i.e. look where in the binding</span>
<a name="l00416"></a>00416             <span class="comment">// candidate list the node belongs)</span>
<a name="l00417"></a>00417                 <span class="keywordtype">int</span> backupPos = <a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>-1;
<a name="l00418"></a>00418                 <span class="keywordflow">while</span>( backupPos &gt;= 0 &amp;&amp; dist &lt; bindingDistance[backupPos][quad] ){
<a name="l00419"></a>00419                     <span class="comment">// move old candidate one position back in the queue to make</span>
<a name="l00420"></a>00420                     <span class="comment">// room for new candidate</span>
<a name="l00421"></a>00421                     bindingCandidates[backupPos+1][quad] = bindingCandidates[backupPos][quad];
<a name="l00422"></a>00422                     bindingDistance[backupPos+1][quad] = bindingDistance[backupPos][quad];
<a name="l00423"></a>00423                     --backupPos;
<a name="l00424"></a>00424                 }
<a name="l00425"></a>00425                 <span class="comment">// place new candidate at appropriate position in candidate list</span>
<a name="l00426"></a>00426                 bindingCandidates[backupPos+1][quad] = itSites-&gt;second;
<a name="l00427"></a>00427                 bindingDistance[backupPos+1][quad] = dist;
<a name="l00428"></a>00428             }
<a name="l00429"></a>00429 
<a name="l00430"></a>00430         }
<a name="l00431"></a>00431         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; 4; ++i ){
<a name="l00432"></a>00432             <span class="keywordflow">if</span>( bindingCandidates[0][i] ){
<a name="l00433"></a>00433                 bindingCandidates[0][i]-&gt;<a class="code" href="classQuonSite.html#afa6fe24c5adadabe18529bb5736d321b">type</a> = <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663ade742dc8734ee1f2b8944e338a7992fa">QBINDING</a>;
<a name="l00434"></a>00434                 bindingCandidates[0][i]-&gt;<a class="code" href="classQuonSite.html#a5ec803b5181547c3e859fc2200e10f1b">dirty</a> = <span class="keyword">true</span>;
<a name="l00435"></a>00435                 <span class="keywordflow">for</span>( <span class="keywordtype">int</span> ii = 1; ii &lt;= <a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>; ++ii ){
<a name="l00436"></a>00436                     <span class="keywordflow">if</span>( bindingCandidates[ii][i] ){
<a name="l00437"></a>00437                         <a class="code" href="classQuon.html#a560b63c7e1d4ad9c34bc4ac9f70311e9">bindingBackup</a>[ii-1][i] = bindingCandidates[ii][i]-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>;
<a name="l00438"></a>00438                     }
<a name="l00439"></a>00439                 }
<a name="l00440"></a>00440             }
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         <span class="keyword">delete</span>[] bindingCandidates;
<a name="l00444"></a>00444         <span class="keyword">delete</span>[] bindingDistance;
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446     <span class="keywordflow">else</span> {
<a name="l00447"></a>00447         <span class="keywordflow">if</span>( !<a class="code" href="classQuon.html#a58914d072978b36b252a96a7df1fadae">aloneInOverlay</a>) {
<a name="l00448"></a>00448             ++<a class="code" href="classQuon.html#acbe0e10f8dc812606f89e799b21f0c5b">rejoinCount</a>;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450             <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>);
<a name="l00451"></a>00451             <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a6159e3ad96e5cc7ce4cc87a9ac499213">QJOINING</a>);
<a name="l00452"></a>00452         }
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a><a class="code" href="classQuon.html#acd349191dbc70d9e4e6801e16a6d3724">00456</a> <span class="keywordtype">bool</span> <a class="code" href="classQuon.html#acd349191dbc70d9e4e6801e16a6d3724">Quon::deleteSite</a>(<a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> node)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458     QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.find(node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00459"></a>00459     <span class="keywordflow">if</span>(itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end()) {
<a name="l00460"></a>00460         <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00461"></a>00461             EV &lt;&lt; <span class="stringliteral">&quot;[Quon::deleteSite() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00462"></a>00462                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00463"></a>00463                &lt;&lt; <span class="stringliteral">&quot;    Site &quot;</span> &lt;&lt; node.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; itSites-&gt;second-&gt;position &lt;&lt; <span class="stringliteral">&quot; has been removed from the list.&quot;</span>
<a name="l00464"></a>00464                &lt;&lt; endl;
<a name="l00465"></a>00465         }
<a name="l00466"></a>00466         <span class="keyword">delete</span> itSites-&gt;second;
<a name="l00467"></a>00467         <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.erase(itSites);
<a name="l00468"></a>00468         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a><a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">00473</a> <span class="keywordtype">int</span> <a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">Quon::purgeSites</a>(<a class="code" href="QuonDefs_8h.html#adc5a48b199e542d36b27075cdb579b26">QPurgeType</a> purgeSoftSites)
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475     <span class="keywordtype">int</span> purged = 0;
<a name="l00476"></a>00476     QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin();
<a name="l00477"></a>00477     <span class="keywordflow">while</span>(itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end()) {
<a name="l00478"></a>00478         <span class="comment">// Purge softNeighbors only if QPURGESOFT is set</span>
<a name="l00479"></a>00479         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a> &amp;&amp; ( purgeSoftSites == <a class="code" href="QuonDefs_8h.html#adc5a48b199e542d36b27075cdb579b26a01f818ce2945704d0a5df32f2301885c">QPURGESOFT</a> || !itSites-&gt;second-&gt;softNeighbor) ) {
<a name="l00480"></a>00480             <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l00481"></a>00481                 EV &lt;&lt; <span class="stringliteral">&quot;[Quon::purgeSites() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00482"></a>00482                    &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00483"></a>00483                    &lt;&lt; <span class="stringliteral">&quot;    Site &quot;</span> &lt;&lt; itSites-&gt;second-&gt;address.getIp() &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; itSites-&gt;second-&gt;position &lt;&lt; <span class="stringliteral">&quot; has been removed from the list.\n&quot;</span>
<a name="l00484"></a>00484                    &lt;&lt; <span class="stringliteral">&quot;    Status: &quot;</span> &lt;&lt; ((itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a>) ? <span class="stringliteral">&quot;QUNDEFINED&quot;</span> : <span class="stringliteral">&quot;QSOFT&quot;</span>)
<a name="l00485"></a>00485                    &lt;&lt; endl;
<a name="l00486"></a>00486             }
<a name="l00487"></a>00487             <span class="keyword">delete</span> itSites-&gt;second;
<a name="l00488"></a>00488             <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.erase(itSites++);
<a name="l00489"></a>00489             ++purged;
<a name="l00490"></a>00490         }
<a name="l00491"></a>00491         <span class="keywordflow">else</span> {
<a name="l00492"></a>00492             ++itSites;
<a name="l00493"></a>00493         }
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     <span class="keywordflow">return</span> purged;
<a name="l00496"></a>00496 }
<a name="l00497"></a>00497 
<a name="l00498"></a><a class="code" href="classQuon.html#a2c4fc441250953f22bba4e4398901154">00498</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a2c4fc441250953f22bba4e4398901154">Quon::adaptAoI</a>()
<a name="l00499"></a>00499 {
<a name="l00500"></a>00500     <span class="comment">// adjust AOIWidth</span>
<a name="l00501"></a>00501     <span class="keywordtype">double</span> oldAOI = <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>;
<a name="l00502"></a>00502     <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#a369f0916dfd5f306a4a31a9bac648be6">linearAdaption</a> ) {
<a name="l00503"></a>00503         <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> -= (<a class="code" href="classQuon.html#a4031fe13e201230e6822a0b6d312b9c0">maxAOI</a> - <a class="code" href="classQuon.html#a5321c54300684011b310874cb504cc3b">minAOI</a>) * ((<span class="keywordtype">double</span>) <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size() - (double) <a class="code" href="classQuon.html#aed45985bf8ae12aa4a05e3c74f0a03ed">connectionLimit</a>) * <a class="code" href="classQuon.html#ae44950a7619cd0e9bcb65071f9871302">adaptionSensitivity</a> / (double) <a class="code" href="classQuon.html#aed45985bf8ae12aa4a05e3c74f0a03ed">connectionLimit</a>;
<a name="l00504"></a>00504     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size() &gt; 0 ){
<a name="l00505"></a>00505         <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> *= (1-<a class="code" href="classQuon.html#ae44950a7619cd0e9bcb65071f9871302">adaptionSensitivity</a>) + (<span class="keywordtype">double</span>) <a class="code" href="classQuon.html#aed45985bf8ae12aa4a05e3c74f0a03ed">connectionLimit</a> * <a class="code" href="classQuon.html#ae44950a7619cd0e9bcb65071f9871302">adaptionSensitivity</a> / (double) <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size();
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507     <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#acfff4768dab96f6a068f05385c806da9">gossipSensitivity</a> &gt; 0  &amp;&amp; <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size() &gt; 0 ) {
<a name="l00508"></a>00508         <span class="keywordtype">double</span> avgNeighborAOI = 0;
<a name="l00509"></a>00509         <span class="keywordflow">for</span>( QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites ){
<a name="l00510"></a>00510             avgNeighborAOI += itSites-&gt;second-&gt;AOIwidth;
<a name="l00511"></a>00511         }
<a name="l00512"></a>00512         avgNeighborAOI /= <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size();
<a name="l00513"></a>00513         <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> = <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>*(1-<a class="code" href="classQuon.html#acfff4768dab96f6a068f05385c806da9">gossipSensitivity</a>) + avgNeighborAOI*<a class="code" href="classQuon.html#acfff4768dab96f6a068f05385c806da9">gossipSensitivity</a>;
<a name="l00514"></a>00514     }
<a name="l00515"></a>00515     <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> &gt; <a class="code" href="classQuon.html#a4031fe13e201230e6822a0b6d312b9c0">maxAOI</a>) {
<a name="l00516"></a>00516         <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> = <a class="code" href="classQuon.html#a4031fe13e201230e6822a0b6d312b9c0">maxAOI</a>;
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> &lt; <a class="code" href="classQuon.html#a5321c54300684011b310874cb504cc3b">minAOI</a>) {
<a name="l00519"></a>00519         <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> = <a class="code" href="classQuon.html#a5321c54300684011b310874cb504cc3b">minAOI</a>;
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521     
<a name="l00522"></a>00522     <span class="keywordflow">if</span>( oldAOI != <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> ){
<a name="l00523"></a>00523         <a class="code" href="classGameAPIResizeAOIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIResizeAOIMessage</a>* gameMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIResizeAOIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIResizeAOIMessage</a>(<span class="stringliteral">&quot;RESIZE_AOI&quot;</span>);
<a name="l00524"></a>00524         gameMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3fe3071c66623191477b903527280ddc">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba04223e5523bbf330b2553e5ba3e320d1">RESIZE_AOI</a>);
<a name="l00525"></a>00525         gameMsg-&gt;<a class="code" href="classGameAPIResizeAOIMessage.html#ae8df0a2a6adc664d2dc8a5c0291f9f49">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00526"></a>00526         <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(gameMsg);
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a><a class="code" href="classQuon.html#a54937c5eea5f1a673ddce36e3f34c9ba">00530</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a54937c5eea5f1a673ddce36e3f34c9ba" title="This method gets call **.gracefulLeaveDelay seconds before it is killed if this node is among the gra...">Quon::handleNodeGracefulLeaveNotification</a>()
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532     <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>) {
<a name="l00533"></a>00533         <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>* readyMsg = <span class="keyword">new</span> <a class="code" href="classCompReadyMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">CompReadyMessage</a>(<span class="stringliteral">&quot;OVERLAY_FINISHED&quot;</span>);
<a name="l00534"></a>00534         readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#a07d2b2a15889728c23ed4d80730de2cf">setReady</a>(<span class="keyword">false</span>);
<a name="l00535"></a>00535         readyMsg-&gt;<a class="code" href="classCompReadyMessage.html#a77640d7f3566804064921b2520ed51b6">setComp</a>(<a class="code" href="classBaseOverlay.html#a92e0d3f96a5716245465e05da60ef487" title="Return the component type of this module.">getThisCompType</a>());
<a name="l00536"></a>00536         <span class="comment">// TODO/FIXME: use overlay-&gt;sendMessageToAllComp(msg, getThisCompType())?</span>
<a name="l00537"></a>00537         <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(readyMsg);
<a name="l00538"></a>00538         <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size() &gt; 0) {
<a name="l00539"></a>00539             <span class="comment">// generate node leave messages</span>
<a name="l00540"></a>00540             <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg = <span class="keyword">new</span> <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>(<span class="stringliteral">&quot;NODE_LEAVE&quot;</span>);
<a name="l00541"></a>00541             quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fac2f6b0a84b96ac134911c0d532a4a91c">NODE_LEAVE</a>);
<a name="l00542"></a>00542             quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00543"></a>00543             quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00544"></a>00544             quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00545"></a>00545             <span class="comment">// fill neighbors list</span>
<a name="l00546"></a>00546             quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00547"></a>00547             quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00548"></a>00548             <span class="keywordtype">int</span> i = 0;
<a name="l00549"></a>00549             <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00550"></a>00550                 quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#af1e642a74712a5b4c90c396ea8fcc752">setNeighborHandle</a>(i, itSites-&gt;second-&gt;address);
<a name="l00551"></a>00551                 quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#a078d985df098bdf63b1e9052655da1ec">setNeighborPosition</a>(i, itSites-&gt;second-&gt;position);
<a name="l00552"></a>00552                 ++i;
<a name="l00553"></a>00553             }
<a name="l00554"></a>00554             quonListMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#acf84b923bf8e068d7e35df6078f252ba">QUONLIST_L</a>(quonListMsg));
<a name="l00555"></a>00555 
<a name="l00556"></a>00556             <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00557"></a>00557                 <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonCopyMsg = <span class="keyword">new</span> <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>(*quonListMsg);
<a name="l00558"></a>00558                 <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonCopyMsg, itSites-&gt;second-&gt;address);
<a name="l00559"></a>00559             }
<a name="l00560"></a>00560             <span class="keyword">delete</span> quonListMsg;
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562         <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>);
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 
<a name="l00566"></a><a class="code" href="classQuon.html#ac29ea34a956954a1fa1386eaf8cb02be">00566</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ac29ea34a956954a1fa1386eaf8cb02be">Quon::processJoinTimer</a>()
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568     <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>* gameMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>(<span class="stringliteral">&quot;MOVEMENT_REQUEST&quot;</span>);
<a name="l00569"></a>00569     gameMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3fe3071c66623191477b903527280ddc">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6baebd21087dd4fccf5bea6d56c351f76d1">MOVEMENT_REQUEST</a>);
<a name="l00570"></a>00570     <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(gameMsg);
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 
<a name="l00573"></a><a class="code" href="classQuon.html#a5d098a9b74d485d8e68f7a8d5325ddd1">00573</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a5d098a9b74d485d8e68f7a8d5325ddd1">Quon::processSecTimer</a>()
<a name="l00574"></a>00574 {
<a name="l00575"></a>00575     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(
<a name="l00576"></a>00576         <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a> &gt; <a class="code" href="classQuon.html#a479502f99f21bf405210eb0c7c00a9b6">maxBytesPerSecondSend</a>) {
<a name="l00577"></a>00577             <a class="code" href="classQuon.html#a479502f99f21bf405210eb0c7c00a9b6">maxBytesPerSecondSend</a> = <a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a>;
<a name="l00578"></a>00578         }
<a name="l00579"></a>00579         <a class="code" href="classQuon.html#a2412db36457ab9bae180b8dd1c3cec47">avgAOI</a> += <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>;
<a name="l00580"></a>00580         <a class="code" href="classQuon.html#ab43ea338aa35a082c379716a3fcd02c1">averageBytesPerSecondSend</a> += <a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a>;
<a name="l00581"></a>00581         <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00582"></a>00582             <span class="keywordflow">switch</span>(itSites-&gt;second-&gt;type) {
<a name="l00583"></a>00583                 <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a9a4ea8f06501f7d26d66e134e0e1b015">QNEIGHBOR</a>:
<a name="l00584"></a>00584                     <a class="code" href="classQuon.html#a98466c67a6d900869219e4c8acf1dd7c">directNeighborCount</a>++;
<a name="l00585"></a>00585                     <span class="keywordflow">break</span>;
<a name="l00586"></a>00586                 <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663ade742dc8734ee1f2b8944e338a7992fa">QBINDING</a>:
<a name="l00587"></a>00587                     <a class="code" href="classQuon.html#ac8e1a28cfc559f56cfa51ee757a5b44d">bindingNeighborCount</a>++;
<a name="l00588"></a>00588                     <span class="keywordflow">break</span>;
<a name="l00589"></a>00589                 <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a>:
<a name="l00590"></a>00590                     <span class="keywordflow">if</span>( itSites-&gt;second-&gt;softNeighbor ){
<a name="l00591"></a>00591                         <a class="code" href="classQuon.html#a5450bc23ca2b380316b38903536cad1c">softNeighborCount</a>++;
<a name="l00592"></a>00592                     }
<a name="l00593"></a>00593                     <span class="keywordflow">break</span>;
<a name="l00594"></a>00594                 <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a5f0c262d908147d33dd7235bd5cd5515">QTHIS</a>:
<a name="l00595"></a>00595                     <span class="keywordflow">break</span>;
<a name="l00596"></a>00596             }
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598         ++<a class="code" href="classQuon.html#acdba7ca61befddc0377f74b502f24a1c">secTimerCount</a>;
<a name="l00599"></a>00599     );
<a name="l00600"></a>00600     <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#a7affc6a652f7df6a00a9fa9616989cba">loginCache</a> ) {
<a name="l00601"></a>00601         ++<a class="code" href="classQuon.html#af3a8c48d58d3ae799f8e84491cc590d8">timeSinceCache</a>;
<a name="l00602"></a>00602         <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a> &amp;&amp; <a class="code" href="classQuon.html#af3a8c48d58d3ae799f8e84491cc590d8">timeSinceCache</a> &gt;= <a class="code" href="classQuon.html#aa29f3d95a21cf376d2116afd879bcd51">cacheInterval</a> ){
<a name="l00603"></a>00603             <a class="code" href="classQuon.html#a7affc6a652f7df6a00a9fa9616989cba">loginCache</a>-&gt;<a class="code" href="classLoginCache.html#ae9ee5141c732f56eacbf64f179336084">registerPos</a>( <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>, <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a> );
<a name="l00604"></a>00604             <a class="code" href="classQuon.html#af3a8c48d58d3ae799f8e84491cc590d8">timeSinceCache</a> = 0;
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607     <a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a> = 0.0;
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 
<a name="l00610"></a><a class="code" href="classQuon.html#a430d10cb5e1b77a630ed4657e34f1695">00610</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a430d10cb5e1b77a630ed4657e34f1695">Quon::processDeleteTimer</a>(cMessage* msg)
<a name="l00611"></a>00611 {
<a name="l00612"></a>00612     <a class="code" href="classQuonSelfMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonSelfMessage</a>* quonMsg = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classQuonSelfMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonSelfMessage</a>*<span class="keyword">&gt;</span>(msg);
<a name="l00613"></a>00613     QDeleteMap::iterator itSite = <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.find(quonMsg-&gt;<a class="code" href="classQuonSelfMessage.html#ab4e908561238298802392ac070bb71b5">getKey</a>());
<a name="l00614"></a>00614     <span class="keywordflow">if</span>(itSite != <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.end()) {
<a name="l00615"></a>00615         <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.erase(itSite);
<a name="l00616"></a>00616     }
<a name="l00617"></a>00617     cancelAndDelete(quonMsg);
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 
<a name="l00620"></a><a class="code" href="classQuon.html#a86dbfd8cb030da488a06f4322a0d9f54">00620</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a86dbfd8cb030da488a06f4322a0d9f54">Quon::processAliveTimer</a>()
<a name="l00621"></a>00621 {
<a name="l00622"></a>00622     <span class="keywordtype">bool</span> rebuild = <span class="keyword">false</span>;
<a name="l00623"></a>00623     QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin();
<a name="l00624"></a>00624     <span class="keywordflow">while</span>(itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end()) {
<a name="l00625"></a>00625         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;alive) {
<a name="l00626"></a>00626             itSites-&gt;second-&gt;alive = <span class="keyword">false</span>;
<a name="l00627"></a>00627             ++itSites;
<a name="l00628"></a>00628         }
<a name="l00629"></a>00629         <span class="keywordflow">else</span> {
<a name="l00630"></a>00630             <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> node = itSites-&gt;second-&gt;address;
<a name="l00631"></a>00631             <a class="code" href="classQuonSelfMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonSelfMessage</a>* msg = <span class="keyword">new</span> <a class="code" href="classQuonSelfMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonSelfMessage</a>(<span class="stringliteral">&quot;delete_timer&quot;</span>);
<a name="l00632"></a>00632             msg-&gt;<a class="code" href="classQuonSelfMessage.html#afdc2037f43329f285eac3742a55ef235">setKey</a>(node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00633"></a>00633             scheduleAt(simTime() + <a class="code" href="classQuon.html#a29afd14267371b2fdccb31e8d5bcebee">deleteTimeout</a>, msg);
<a name="l00634"></a>00634             <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.insert(std::make_pair(node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>(), itSites-&gt;second-&gt;position));
<a name="l00635"></a>00635             ++itSites;
<a name="l00636"></a>00636             <a class="code" href="classQuon.html#acd349191dbc70d9e4e6801e16a6d3724">deleteSite</a>(node);
<a name="l00637"></a>00637             <span class="comment">// update simple client</span>
<a name="l00638"></a>00638             <a class="code" href="classQuon.html#a1e7c49275495ea83e41988fe3748788c">deleteAppNeighbor</a>(node);
<a name="l00639"></a>00639             <span class="keywordflow">if</span>(!rebuild) {
<a name="l00640"></a>00640                 rebuild = <span class="keyword">true</span>;
<a name="l00641"></a>00641             }
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644     <span class="keywordflow">if</span>(rebuild) {
<a name="l00645"></a>00645         <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">classifySites</a>();
<a name="l00646"></a>00646         <span class="comment">// update simple client</span>
<a name="l00647"></a>00647         <a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">synchronizeAppNeighbors</a>();
<a name="l00648"></a>00648         <a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">purgeSites</a>();
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a><a class="code" href="classQuon.html#af1ff297b237f314e3dd96f8999e0ccb0">00652</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#af1ff297b237f314e3dd96f8999e0ccb0">Quon::processBackupTimer</a>()
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654     <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* quonMoveMsg = <span class="keyword">new</span> <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>(<span class="stringliteral">&quot;NODE_MOVE&quot;</span>);
<a name="l00655"></a>00655     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>);
<a name="l00656"></a>00656     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00657"></a>00657     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00658"></a>00658     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00659"></a>00659     quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#a68ac99a9b315c94afe4c6ef5d4746a89">setNewPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00660"></a>00660     quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#aee87a709a701208e4855c94829326d17">setIsBinding</a>(<span class="keyword">true</span>);
<a name="l00661"></a>00661     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;4; i++) {
<a name="l00662"></a>00662         <span class="keywordflow">for</span>( <span class="keywordtype">int</span> ii = 0; ii &lt; <a class="code" href="classQuon.html#ac8eb2eb8fff5eb75bdd6448882d046b7">numBackups</a>; ++ii ){
<a name="l00663"></a>00663             <span class="keywordflow">if</span>(!<a class="code" href="classQuon.html#a560b63c7e1d4ad9c34bc4ac9f70311e9">bindingBackup</a>[ii][i].isUnspecified()) {
<a name="l00664"></a>00664                 <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* copyMsg = <span class="keyword">new</span> <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>(*quonMoveMsg);
<a name="l00665"></a>00665                 copyMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#a3da2a269dbae8ed952a6b0a237710162">QUONMOVE_L</a>(copyMsg));
<a name="l00666"></a>00666                 <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(copyMsg, <a class="code" href="classQuon.html#a560b63c7e1d4ad9c34bc4ac9f70311e9">bindingBackup</a>[ii][i]);
<a name="l00667"></a>00667             }
<a name="l00668"></a>00668         }
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670     <span class="keyword">delete</span> quonMoveMsg;
<a name="l00671"></a>00671 }
<a name="l00672"></a>00672 
<a name="l00673"></a><a class="code" href="classQuon.html#ae55f17acbfe8963c1016aa4b8b52e43f">00673</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ae55f17acbfe8963c1016aa4b8b52e43f">Quon::handleJoin</a>(<a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a>* gameMsg)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675     <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a> joinNode;
<a name="l00676"></a>00676     <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#a7affc6a652f7df6a00a9fa9616989cba">loginCache</a> ) {
<a name="l00677"></a>00677         joinNode = <a class="code" href="classQuon.html#a7affc6a652f7df6a00a9fa9616989cba">loginCache</a>-&gt;<a class="code" href="classLoginCache.html#a94d884e9c619e981adeafdb12b21d7c1">getLoginNode</a>( gameMsg-&gt;<a class="code" href="classGameAPIPositionMessage.html#a62cb5e229193a2e0118e240de2494d53">getPosition</a>() );
<a name="l00678"></a>00678     } <span class="keywordflow">else</span> {
<a name="l00679"></a>00679         joinNode = <a class="code" href="classBaseOverlay.html#abe4dea93564123116c97d5c4721f0504" title="pointer to the BootstrapList module">bootstrapList</a>-&gt;<a class="code" href="classBootstrapList.html#ac351433be1d43bbf8cbb871e9f9e1f69" title="Get a bootstrap node from the bootstrap list.">getBootstrapNode</a>();
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681     <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a> = gameMsg-&gt;<a class="code" href="classGameAPIPositionMessage.html#a62cb5e229193a2e0118e240de2494d53">getPosition</a>();
<a name="l00682"></a>00682     <span class="comment">// check if this is the only node in the overlay</span>
<a name="l00683"></a>00683     <span class="keywordflow">if</span>(joinNode.<a class="code" href="classTransportAddress.html#a026e777c423ff2a0280edd2fa5472e74" title="indicates if TransportAddress is specified">isUnspecified</a>()) {
<a name="l00684"></a>00684         <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>);
<a name="l00685"></a>00685         <a class="code" href="classQuon.html#a58914d072978b36b252a96a7df1fadae">aloneInOverlay</a> = <span class="keyword">true</span>;
<a name="l00686"></a>00686     }
<a name="l00687"></a>00687     <span class="keywordflow">else</span> {
<a name="l00688"></a>00688         <a class="code" href="classQuonMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMessage</a>* quonMsg = <span class="keyword">new</span> <a class="code" href="classQuonMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMessage</a>(<span class="stringliteral">&quot;JOIN_REQUEST&quot;</span>);
<a name="l00689"></a>00689         quonMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="GiaMessage__m_8h.html#ac712f468e66678ffb5df03be6d6a8157a71fec090ff88ece51771bbbf434064ec">JOIN_REQUEST</a>);
<a name="l00690"></a>00690         quonMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00691"></a>00691         quonMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00692"></a>00692         quonMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00693"></a>00693         quonMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#a587b735bc9858abdd2351e73fd2081ed">QUON_L</a>(quonMsg));
<a name="l00694"></a>00694         <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonMsg, joinNode);
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696 }
<a name="l00697"></a>00697 
<a name="l00698"></a><a class="code" href="classQuon.html#ac605f9c70749dc1ff7a4c45450ccfc60">00698</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ac605f9c70749dc1ff7a4c45450ccfc60">Quon::handleMove</a>(<a class="code" href="classGameAPIPositionMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIPositionMessage</a>* gameMsg)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700     <span class="comment">// adapt aoi</span>
<a name="l00701"></a>00701     <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a82f95ed825de6241bcf407bcb6732686">useDynamicAOI</a>) {
<a name="l00702"></a>00702         <a class="code" href="classQuon.html#a2c4fc441250953f22bba4e4398901154">adaptAoI</a>();
<a name="l00703"></a>00703         <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">classifySites</a>();
<a name="l00704"></a>00704     }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     <a class="code" href="classVector2D.html">Vector2D</a> position = gameMsg-&gt;<a class="code" href="classGameAPIPositionMessage.html#a62cb5e229193a2e0118e240de2494d53">getPosition</a>();
<a name="l00707"></a>00707     <span class="comment">// send position update to neighbors</span>
<a name="l00708"></a>00708     <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* quonMoveMsg = <span class="keyword">new</span> <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>(<span class="stringliteral">&quot;NODE_MOVE&quot;</span>);
<a name="l00709"></a>00709     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>);
<a name="l00710"></a>00710     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00711"></a>00711     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00712"></a>00712     quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00713"></a>00713     quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#a68ac99a9b315c94afe4c6ef5d4746a89">setNewPosition</a>(position);
<a name="l00714"></a>00714     quonMoveMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#a3da2a269dbae8ed952a6b0a237710162">QUONMOVE_L</a>(quonMoveMsg));
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* quonMoveBindingMsg = <span class="keyword">new</span> <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>(*quonMoveMsg);
<a name="l00717"></a>00717     quonMoveBindingMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00718"></a>00718     quonMoveBindingMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00719"></a>00719     <span class="keywordtype">int</span> i = 0;
<a name="l00720"></a>00720     <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00721"></a>00721       <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663ade742dc8734ee1f2b8944e338a7992fa">QBINDING</a> || itSites-&gt;second-&gt;softNeighbor ) {
<a name="l00722"></a>00722         quonMoveBindingMsg-&gt;<a class="code" href="classQuonListMessage.html#af1e642a74712a5b4c90c396ea8fcc752">setNeighborHandle</a>(i, itSites-&gt;second-&gt;address);
<a name="l00723"></a>00723         quonMoveBindingMsg-&gt;<a class="code" href="classQuonListMessage.html#a078d985df098bdf63b1e9052655da1ec">setNeighborPosition</a>(i, itSites-&gt;second-&gt;position);
<a name="l00724"></a>00724         ++i;
<a name="l00725"></a>00725       }
<a name="l00726"></a>00726     }
<a name="l00727"></a>00727     quonMoveBindingMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(i);
<a name="l00728"></a>00728     quonMoveBindingMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(i);
<a name="l00729"></a>00729     <span class="keywordflow">if</span>(i &gt; 0) {
<a name="l00730"></a>00730       <span class="comment">// speedhack:</span>
<a name="l00731"></a>00731       <span class="comment">// instead of building individual MoveMessages for every binding and softstate neighbor,</span>
<a name="l00732"></a>00732       <span class="comment">// we just send all binding/soft to every other binding/soft neighbor and pretend we did not send  neighbors their own neighborslistentry</span>
<a name="l00733"></a>00733       quonMoveBindingMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#a3da2a269dbae8ed952a6b0a237710162">QUONMOVE_L</a>(quonMoveBindingMsg) - <a class="code" href="Quon__m_8h.html#a5fd7ebee6c8022277e3eb99e51c233e3">QUONENTRY_L</a>);
<a name="l00734"></a>00734     }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00737"></a>00737       <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* copyMsg;
<a name="l00738"></a>00738       <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663ade742dc8734ee1f2b8944e338a7992fa">QBINDING</a> || itSites-&gt;second-&gt;softNeighbor ) {
<a name="l00739"></a>00739         copyMsg = <span class="keyword">new</span> <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>(*quonMoveBindingMsg);
<a name="l00740"></a>00740         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663ade742dc8734ee1f2b8944e338a7992fa">QBINDING</a>) {
<a name="l00741"></a>00741           copyMsg-&gt;<a class="code" href="classQuonMoveMessage.html#aee87a709a701208e4855c94829326d17">setIsBinding</a>(<span class="keyword">true</span>);
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743         <span class="keywordflow">else</span> {
<a name="l00744"></a>00744           ++<a class="code" href="classQuon.html#ad842d00209159d0d47c0abe7aec573c2">softConnections</a>;
<a name="l00745"></a>00745         }
<a name="l00746"></a>00746       }
<a name="l00747"></a>00747       <span class="keywordflow">else</span> {
<a name="l00748"></a>00748         copyMsg = <span class="keyword">new</span> <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>(*quonMoveMsg);
<a name="l00749"></a>00749       }
<a name="l00750"></a>00750       <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(copyMsg, itSites-&gt;second-&gt;address);
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752     <span class="keyword">delete</span> quonMoveMsg;
<a name="l00753"></a>00753     <span class="keyword">delete</span> quonMoveBindingMsg;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <span class="comment">// update position</span>
<a name="l00756"></a>00756     <a class="code" href="classQuon.html#aff5a4bfcea27a7ebfa42f38c3497a744">updateThisSite</a>(position);
<a name="l00757"></a>00757     <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">classifySites</a>();
<a name="l00758"></a>00758     <span class="comment">// update simple client</span>
<a name="l00759"></a>00759     <a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">synchronizeAppNeighbors</a>(<a class="code" href="QuonDefs_8h.html#adc5a48b199e542d36b27075cdb579b26a01f818ce2945704d0a5df32f2301885c">QPURGESOFT</a>);
<a name="l00760"></a>00760     <a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">purgeSites</a>(<a class="code" href="QuonDefs_8h.html#adc5a48b199e542d36b27075cdb579b26a01f818ce2945704d0a5df32f2301885c">QPURGESOFT</a>);
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 
<a name="l00763"></a><a class="code" href="classQuon.html#ac923ab87b84f63ac532cb148a90d3c30">00763</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ac923ab87b84f63ac532cb148a90d3c30">Quon::handleEvent</a>(<a class="code" href="classGameAPIMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIMessage</a>* msg)
<a name="l00764"></a>00764 {
<a name="l00765"></a>00765     <span class="comment">// send event to neighbors</span>
<a name="l00766"></a>00766     <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00767"></a>00767         <a class="code" href="classQuonEventMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonEventMessage</a> *quonMsg = <span class="keyword">new</span> <a class="code" href="classQuonEventMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonEventMessage</a>(<span class="stringliteral">&quot;EVENT&quot;</span>);
<a name="l00768"></a>00768         quonMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa41da4915ade740f2d44932bedc63b858">QUON_EVENT</a>);
<a name="l00769"></a>00769         quonMsg-&gt;encapsulate((cPacket*)msg-&gt;<a class="code" href="classGameAPIMessage.html#a4efd0fa1b03d99fd4f063020d9250077">dup</a>());
<a name="l00770"></a>00770         <span class="comment">// FIXME: Message length!</span>
<a name="l00771"></a>00771         <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonMsg, itSites-&gt;second-&gt;address);
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773 }
<a name="l00774"></a>00774 
<a name="l00775"></a><a class="code" href="classQuon.html#ad08218dae9b27080131790ebaf6f4b54">00775</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ad08218dae9b27080131790ebaf6f4b54">Quon::handleJoinRequest</a>(<a class="code" href="classQuonMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMessage</a>* quonMsg)
<a name="l00776"></a>00776 {
<a name="l00777"></a>00777     <a class="code" href="classVector2D.html">Vector2D</a> joinPosition = quonMsg-&gt;<a class="code" href="classQuonMessage.html#af41132dfec6ec4055a13e9bcb7293cdf">getPosition</a>();
<a name="l00778"></a>00778     <span class="comment">// start with this node</span>
<a name="l00779"></a>00779     <span class="keywordtype">double</span> min_dist = <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>.<a class="code" href="classVector2D.html#ae01a1f04ce4ee6f09f3fbc72893412cb">distanceSqr</a>(joinPosition);
<a name="l00780"></a>00780     <a class="code" href="classQuonSite.html">QuonSite</a>* forwardSite = <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>;
<a name="l00781"></a>00781     <span class="comment">// iterate through all neighbors</span>
<a name="l00782"></a>00782     <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00783"></a>00783         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;position.distanceSqr(joinPosition) &lt; min_dist) { <span class="comment">//FIXME: use xy metric if desired?</span>
<a name="l00784"></a>00784             min_dist = itSites-&gt;second-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>.<a class="code" href="classVector2D.html#ae01a1f04ce4ee6f09f3fbc72893412cb">distanceSqr</a>(joinPosition);
<a name="l00785"></a>00785             forwardSite = itSites-&gt;second;
<a name="l00786"></a>00786         }
<a name="l00787"></a>00787     }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <span class="comment">// do nothing and let node retry with new position if current position is illegal</span>
<a name="l00790"></a>00790     <span class="keywordflow">if</span>(min_dist == 0.0) {
<a name="l00791"></a>00791         <span class="keyword">delete</span> quonMsg;
<a name="l00792"></a>00792     }
<a name="l00793"></a>00793     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(forwardSite-&gt;<a class="code" href="classQuonSite.html#afa6fe24c5adadabe18529bb5736d321b">type</a> == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a5f0c262d908147d33dd7235bd5cd5515">QTHIS</a>) {
<a name="l00794"></a>00794         <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg = <span class="keyword">new</span> <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>(<span class="stringliteral">&quot;JOIN_ACKNOWLEDGE&quot;</span>);
<a name="l00795"></a>00795         quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad2045a15ed8b82d3db379cc54ba0b7d4">JOIN_ACKNOWLEDGE</a>);
<a name="l00796"></a>00796         quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00797"></a>00797         quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00798"></a>00798         quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00799"></a>00799         <span class="comment">// fill neighbors list</span>
<a name="l00800"></a>00800         quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00801"></a>00801         quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00802"></a>00802         <span class="keywordtype">int</span> i = 0;
<a name="l00803"></a>00803         <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00804"></a>00804             quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#af1e642a74712a5b4c90c396ea8fcc752">setNeighborHandle</a>(i, itSites-&gt;second-&gt;address);
<a name="l00805"></a>00805             quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#a078d985df098bdf63b1e9052655da1ec">setNeighborPosition</a>(i, itSites-&gt;second-&gt;position);
<a name="l00806"></a>00806             ++i;
<a name="l00807"></a>00807         }
<a name="l00808"></a>00808         quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(i);
<a name="l00809"></a>00809         quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(i);
<a name="l00810"></a>00810 
<a name="l00811"></a>00811         quonListMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#acf84b923bf8e068d7e35df6078f252ba">QUONLIST_L</a>(quonListMsg));
<a name="l00812"></a>00812         <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonListMsg, quonMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>());
<a name="l00813"></a>00813         <span class="keyword">delete</span> quonMsg;
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <span class="keywordflow">else</span> {
<a name="l00816"></a>00816         <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonMsg, forwardSite-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00817"></a>00817     }
<a name="l00818"></a>00818 }
<a name="l00819"></a>00819 
<a name="l00820"></a><a class="code" href="classQuon.html#a3e899c593816aa1d9b0b37bc710c87f2">00820</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a3e899c593816aa1d9b0b37bc710c87f2">Quon::handleJoinAcknowledge</a>(<a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg)
<a name="l00821"></a>00821 {
<a name="l00822"></a>00822     <span class="comment">// add acceptor node</span>
<a name="l00823"></a>00823     <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>);
<a name="l00824"></a>00824     <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">addSite</a>(quonListMsg-&gt;<a class="code" href="classQuonMessage.html#af41132dfec6ec4055a13e9bcb7293cdf">getPosition</a>(), quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>(), quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>(), <span class="keyword">false</span>, <a class="code" href="QuonDefs_8h.html#ae1c9bee235e07483b1ca6526d3625148a9eda35317bbb785d73e49dc5d9eaf7bc">QDIRECT</a>);
<a name="l00825"></a>00825     <span class="comment">// add new neighbors</span>
<a name="l00826"></a>00826     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aede022556c3ccd0fe1b36691ac25a3c8">getNeighborHandleArraySize</a>(); i++) {
<a name="l00827"></a>00827         <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">addSite</a>(quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aaaf7776b06eeff20e3fc768ca5d77e53">getNeighborPosition</a>(i), quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#abc67afb0f579372dc26e5c1b482f188f">getNeighborHandle</a>(i), quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>());
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829     <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">classifySites</a>();
<a name="l00830"></a>00830     <span class="comment">// update simple client</span>
<a name="l00831"></a>00831     <a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">synchronizeAppNeighbors</a>();
<a name="l00832"></a>00832     <a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">purgeSites</a>();
<a name="l00833"></a>00833     <span class="comment">// contact new neighbors</span>
<a name="l00834"></a>00834     <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00835"></a>00835         <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* quonMoveMsg = <span class="keyword">new</span> <a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>(<span class="stringliteral">&quot;NODE_MOVE&quot;</span>);
<a name="l00836"></a>00836         quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>);
<a name="l00837"></a>00837         quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00838"></a>00838         quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(quonListMsg-&gt;<a class="code" href="classQuonMessage.html#af41132dfec6ec4055a13e9bcb7293cdf">getPosition</a>());
<a name="l00839"></a>00839         quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00840"></a>00840         quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#a68ac99a9b315c94afe4c6ef5d4746a89">setNewPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00841"></a>00841         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663ade742dc8734ee1f2b8944e338a7992fa">QBINDING</a>) {
<a name="l00842"></a>00842             quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#aee87a709a701208e4855c94829326d17">setIsBinding</a>(<span class="keyword">true</span>);
<a name="l00843"></a>00843         }
<a name="l00844"></a>00844         quonMoveMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#a3da2a269dbae8ed952a6b0a237710162">QUONMOVE_L</a>(quonMoveMsg));
<a name="l00845"></a>00845         <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonMoveMsg, itSites-&gt;second-&gt;address);
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847     <a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a> = 0.0;
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="classQuon.html#adee71dee47991a9f5fffafc9b75b037a">00850</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#adee71dee47991a9f5fffafc9b75b037a">Quon::handleNodeMove</a>(<a class="code" href="classQuonMoveMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMoveMessage</a>* quonMoveMsg)
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(
<a name="l00853"></a>00853             <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(
<a name="l00854"></a>00854                 <span class="stringliteral">&quot;QuON: MoveDelay&quot;</span>,
<a name="l00855"></a>00855                 SIMTIME_DBL(simTime()) - SIMTIME_DBL(quonMoveMsg-&gt;getCreationTime())
<a name="l00856"></a>00856                 );
<a name="l00857"></a>00857             );
<a name="l00858"></a>00858 
<a name="l00859"></a>00859     <span class="comment">// IF node was marked for deletetion, remove it from the delete list</span>
<a name="l00860"></a>00860     QDeleteMap::iterator delIt = <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.find(quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00861"></a>00861     <span class="keywordflow">if</span>( delIt != <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.end() ){
<a name="l00862"></a>00862         <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.erase( delIt );
<a name="l00863"></a>00863     }
<a name="l00864"></a>00864 
<a name="l00865"></a>00865     <span class="comment">// Compute old and new AOI of moving node</span>
<a name="l00866"></a>00866     <a class="code" href="classQuonAOI.html" title="QuonP Definitions.">QuonAOI</a> oldAOI(quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#af41132dfec6ec4055a13e9bcb7293cdf">getPosition</a>(), quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>(), <a class="code" href="classQuon.html#ad1c9991e5c1094281e552c88ea4f0612">useSquareMetric</a>);
<a name="l00867"></a>00867     <a class="code" href="classQuonAOI.html" title="QuonP Definitions.">QuonAOI</a> newAOI(quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#af2e7107f8b4dc5cfb757358acd206279">getNewPosition</a>(), quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>(), <a class="code" href="classQuon.html#ad1c9991e5c1094281e552c88ea4f0612">useSquareMetric</a>);
<a name="l00868"></a>00868     <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a82f95ed825de6241bcf407bcb6732686">useDynamicAOI</a>) {
<a name="l00869"></a>00869         QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.find(quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00870"></a>00870         <span class="keywordflow">if</span>(itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end() &amp;&amp; itSites-&gt;second-&gt;AOIwidth &lt; quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>()) {
<a name="l00871"></a>00871             oldAOI.resize(itSites-&gt;second-&gt;AOIwidth);
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874 
<a name="l00875"></a>00875     <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">addSite</a>(quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#af2e7107f8b4dc5cfb757358acd206279">getNewPosition</a>(), quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>(), quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>(), quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#a044fc1a90a3ca7a9575fb9ef8b03bfec">getIsBinding</a>(), <a class="code" href="QuonDefs_8h.html#ae1c9bee235e07483b1ca6526d3625148a9eda35317bbb785d73e49dc5d9eaf7bc">QDIRECT</a>);
<a name="l00876"></a>00876     <span class="comment">// add new neighbors</span>
<a name="l00877"></a>00877     <a class="code" href="classQuon.html#aacf333436374e811e7b2d74b5e9f7e9f">handleInvalidNode</a>(quonMoveMsg);
<a name="l00878"></a>00878     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;quonMoveMsg-&gt;<a class="code" href="classQuonListMessage.html#aede022556c3ccd0fe1b36691ac25a3c8">getNeighborHandleArraySize</a>(); i++) {
<a name="l00879"></a>00879         <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">addSite</a>(quonMoveMsg-&gt;<a class="code" href="classQuonListMessage.html#aaaf7776b06eeff20e3fc768ca5d77e53">getNeighborPosition</a>(i), quonMoveMsg-&gt;<a class="code" href="classQuonListMessage.html#abc67afb0f579372dc26e5c1b482f188f">getNeighborHandle</a>(i), quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>());
<a name="l00880"></a>00880     }
<a name="l00881"></a>00881     <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">classifySites</a>();
<a name="l00882"></a>00882     <span class="comment">// update simple client</span>
<a name="l00883"></a>00883     <a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">synchronizeAppNeighbors</a>();
<a name="l00884"></a>00884     <a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">purgeSites</a>();
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     <span class="comment">// send new neighbors</span>
<a name="l00887"></a>00887     <span class="keywordflow">if</span>( <a class="code" href="classQuon.html#aa9793f8df0a8a1e1e448f2ff28233457">nnOnlyBinding</a> &amp;&amp; !quonMoveMsg-&gt;<a class="code" href="classQuonMoveMessage.html#a044fc1a90a3ca7a9575fb9ef8b03bfec">getIsBinding</a>() ) <span class="keywordflow">return</span>; <span class="comment">//{</span>
<a name="l00888"></a>00888         <span class="comment">//QuonSiteMap::iterator itSites = Sites.find(quonMoveMsg-&gt;getSender().getKey());</span>
<a name="l00889"></a>00889         <span class="comment">//if (itSites-&gt;second-&gt;type != QBINDING &amp;&amp; ! itSites-&gt;second-&gt;softNeighbor ) return;</span>
<a name="l00890"></a>00890     <span class="comment">//}</span>
<a name="l00891"></a>00891     <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg = <span class="keyword">new</span> <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>(<span class="stringliteral">&quot;NEW_NEIGHBORS&quot;</span>);
<a name="l00892"></a>00892     quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa3aafac4a63883acb0402e9a5dcae8110">NEW_NEIGHBORS</a>);
<a name="l00893"></a>00893     quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>);
<a name="l00894"></a>00894     quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(<a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>);
<a name="l00895"></a>00895     quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00898"></a>00898     quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00899"></a>00899 
<a name="l00900"></a>00900     <span class="keywordtype">int</span> i = 0;
<a name="l00901"></a>00901     <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00902"></a>00902         <span class="keywordflow">if</span>(quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>() != itSites-&gt;second-&gt;address &amp;&amp;
<a name="l00903"></a>00903            !oldAOI.collide(itSites-&gt;second-&gt;position) &amp;&amp;
<a name="l00904"></a>00904            newAOI.collide(itSites-&gt;second-&gt;position)) {
<a name="l00905"></a>00905             quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#af1e642a74712a5b4c90c396ea8fcc752">setNeighborHandle</a>(i, itSites-&gt;second-&gt;address);
<a name="l00906"></a>00906             quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#a078d985df098bdf63b1e9052655da1ec">setNeighborPosition</a>(i, itSites-&gt;second-&gt;position);
<a name="l00907"></a>00907             ++i;
<a name="l00908"></a>00908         }
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911     <span class="keywordflow">if</span>(i &gt; 0) {
<a name="l00912"></a>00912         quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(i);
<a name="l00913"></a>00913         quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(i);
<a name="l00914"></a>00914         quonListMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#acf84b923bf8e068d7e35df6078f252ba">QUONLIST_L</a>(quonListMsg));
<a name="l00915"></a>00915         <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonListMsg, quonMoveMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>());
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917     <span class="keywordflow">else</span> {
<a name="l00918"></a>00918         <span class="keyword">delete</span> quonListMsg;
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00922"></a><a class="code" href="classQuon.html#a74d83ab66d75e28a11a0356510a6eccb">00922</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a74d83ab66d75e28a11a0356510a6eccb">Quon::handleNewNeighbors</a>(<a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg)
<a name="l00923"></a>00923 {
<a name="l00924"></a>00924     <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">addSite</a>(quonListMsg-&gt;<a class="code" href="classQuonMessage.html#af41132dfec6ec4055a13e9bcb7293cdf">getPosition</a>(), quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>(), quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>(), <span class="keyword">false</span>, <a class="code" href="QuonDefs_8h.html#ae1c9bee235e07483b1ca6526d3625148a9eda35317bbb785d73e49dc5d9eaf7bc">QDIRECT</a>);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="comment">// add new neighbors</span>
<a name="l00927"></a>00927     <a class="code" href="classQuon.html#aacf333436374e811e7b2d74b5e9f7e9f">handleInvalidNode</a>(quonListMsg);
<a name="l00928"></a>00928     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aede022556c3ccd0fe1b36691ac25a3c8">getNeighborHandleArraySize</a>(); i++) {
<a name="l00929"></a>00929         <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">addSite</a>(quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aaaf7776b06eeff20e3fc768ca5d77e53">getNeighborPosition</a>(i), quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#abc67afb0f579372dc26e5c1b482f188f">getNeighborHandle</a>(i), quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>());
<a name="l00930"></a>00930     }
<a name="l00931"></a>00931     <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">classifySites</a>();
<a name="l00932"></a>00932     <span class="comment">// update simple client</span>
<a name="l00933"></a>00933     <a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">synchronizeAppNeighbors</a>();
<a name="l00934"></a>00934     <a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">purgeSites</a>();
<a name="l00935"></a>00935 }
<a name="l00936"></a>00936 
<a name="l00937"></a><a class="code" href="classQuon.html#ae4a338b42bb5ff3afdb34c2c8548c1a7">00937</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#ae4a338b42bb5ff3afdb34c2c8548c1a7">Quon::handleNodeLeave</a>(<a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939     <a class="code" href="classQuon.html#acd349191dbc70d9e4e6801e16a6d3724">deleteSite</a>(quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>());
<a name="l00940"></a>00940     <span class="comment">// update simple client</span>
<a name="l00941"></a>00941     <a class="code" href="classQuon.html#a1e7c49275495ea83e41988fe3748788c">deleteAppNeighbor</a>(quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>());
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="comment">// insert into delete list</span>
<a name="l00944"></a>00944     <a class="code" href="classQuonSelfMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonSelfMessage</a>* msg = <span class="keyword">new</span> <a class="code" href="classQuonSelfMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonSelfMessage</a>(<span class="stringliteral">&quot;delete_timer&quot;</span>);
<a name="l00945"></a>00945     msg-&gt;setKey(quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00946"></a>00946     scheduleAt(simTime() + <a class="code" href="classQuon.html#a29afd14267371b2fdccb31e8d5bcebee">deleteTimeout</a>, msg);
<a name="l00947"></a>00947     <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.insert(std::make_pair(quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>(), <a class="code" href="classVector2D.html">Vector2D</a>(0,0)));
<a name="l00948"></a>00948 
<a name="l00949"></a>00949     <span class="comment">// add possible new neighbors</span>
<a name="l00950"></a>00950     <a class="code" href="classQuon.html#aacf333436374e811e7b2d74b5e9f7e9f">handleInvalidNode</a>(quonListMsg);
<a name="l00951"></a>00951     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aede022556c3ccd0fe1b36691ac25a3c8">getNeighborHandleArraySize</a>(); i++) {
<a name="l00952"></a>00952         <a class="code" href="classQuon.html#a75404768e34b6b3bab8fd3ff5e211322">addSite</a>(quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aaaf7776b06eeff20e3fc768ca5d77e53">getNeighborPosition</a>(i), quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#abc67afb0f579372dc26e5c1b482f188f">getNeighborHandle</a>(i), quonListMsg-&gt;<a class="code" href="classQuonMessage.html#a721236d0ec1f7d87635dc9009b566599">getAOIsize</a>(), <span class="keyword">true</span>);
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954     <a class="code" href="classQuon.html#a12ba4a2250699c84c776014c9b856b9d">classifySites</a>();
<a name="l00955"></a>00955     <span class="comment">// update simple client</span>
<a name="l00956"></a>00956     <a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">synchronizeAppNeighbors</a>();
<a name="l00957"></a>00957     <a class="code" href="classQuon.html#a3e94920f59c3f66959cfca7118f5706a">purgeSites</a>();
<a name="l00958"></a>00958 }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960 <span class="comment">// XXX FIXME Disabled, may cause exessive traffic</span>
<a name="l00961"></a><a class="code" href="classQuon.html#aacf333436374e811e7b2d74b5e9f7e9f">00961</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#aacf333436374e811e7b2d74b5e9f7e9f">Quon::handleInvalidNode</a>(<a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonListMsg)
<a name="l00962"></a>00962 {
<a name="l00963"></a>00963     <span class="keywordflow">return</span>;
<a name="l00964"></a>00964     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aede022556c3ccd0fe1b36691ac25a3c8">getNeighborHandleArraySize</a>(); i++) {
<a name="l00965"></a>00965         <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.find(quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#abc67afb0f579372dc26e5c1b482f188f">getNeighborHandle</a>(i).<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>()) != <a class="code" href="classQuon.html#a8101efc814ad37db2f2c15c8863634ea">deletedSites</a>.end()) {
<a name="l00966"></a>00966             <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>* quonLeaveMsg = <span class="keyword">new</span> <a class="code" href="classQuonListMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonListMessage</a>(<span class="stringliteral">&quot;NODE_LEAVE&quot;</span>);
<a name="l00967"></a>00967             quonLeaveMsg-&gt;<a class="code" href="classQuonMessage.html#a48ad691d0d0ef3db5fd0501acf41d88a">setCommand</a>(<a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fac2f6b0a84b96ac134911c0d532a4a91c">NODE_LEAVE</a>);
<a name="l00968"></a>00968             quonLeaveMsg-&gt;<a class="code" href="classQuonMessage.html#a3df1b81ad46ea65434b21048d21e3771">setSender</a>(quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#abc67afb0f579372dc26e5c1b482f188f">getNeighborHandle</a>(i));
<a name="l00969"></a>00969             quonLeaveMsg-&gt;<a class="code" href="classQuonMessage.html#ad6a95f356caac3db9b0c21d29e806a32">setPosition</a>(quonListMsg-&gt;<a class="code" href="classQuonListMessage.html#aaaf7776b06eeff20e3fc768ca5d77e53">getNeighborPosition</a>(i));
<a name="l00970"></a>00970             quonLeaveMsg-&gt;<a class="code" href="classQuonMessage.html#a9443f09c9d10e2d19ef33be37f84845a">setAOIsize</a>(<a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a>);
<a name="l00971"></a>00971             quonLeaveMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00972"></a>00972             quonLeaveMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00973"></a>00973             <span class="keywordtype">int</span> i = 0;
<a name="l00974"></a>00974             <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l00975"></a>00975                 <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663ade742dc8734ee1f2b8944e338a7992fa">QBINDING</a>) {
<a name="l00976"></a>00976                     quonLeaveMsg-&gt;<a class="code" href="classQuonListMessage.html#af1e642a74712a5b4c90c396ea8fcc752">setNeighborHandle</a>(i, itSites-&gt;second-&gt;address);
<a name="l00977"></a>00977                     quonLeaveMsg-&gt;<a class="code" href="classQuonListMessage.html#a078d985df098bdf63b1e9052655da1ec">setNeighborPosition</a>(i, itSites-&gt;second-&gt;position);
<a name="l00978"></a>00978                     ++i;
<a name="l00979"></a>00979                 }
<a name="l00980"></a>00980             }
<a name="l00981"></a>00981             quonLeaveMsg-&gt;<a class="code" href="classQuonListMessage.html#ac15bd0c23408399a6416c0fb97a98424">setNeighborHandleArraySize</a>(i);
<a name="l00982"></a>00982             quonLeaveMsg-&gt;<a class="code" href="classQuonListMessage.html#ae7545f2d6ee308d89c783d1d799495fd">setNeighborPositionArraySize</a>(i);
<a name="l00983"></a>00983             quonLeaveMsg-&gt;setBitLength(<a class="code" href="Quon__m_8h.html#acf84b923bf8e068d7e35df6078f252ba">QUONLIST_L</a>(quonLeaveMsg));
<a name="l00984"></a>00984             <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">sendMessage</a>(quonLeaveMsg, quonListMsg-&gt;<a class="code" href="classQuonMessage.html#ab4d2d2ad254bb5816219b93df827aece">getSender</a>());
<a name="l00985"></a>00985         }
<a name="l00986"></a>00986     }
<a name="l00987"></a>00987 }
<a name="l00988"></a>00988 
<a name="l00989"></a><a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">00989</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a4d364e805fecf9a14eb60b1280bc7a17">Quon::synchronizeAppNeighbors</a>(<a class="code" href="QuonDefs_8h.html#adc5a48b199e542d36b27075cdb579b26">QPurgeType</a> purgeSoftSites)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991     <a class="code" href="classGameAPIListMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIListMessage</a>* gameMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIListMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIListMessage</a>(<span class="stringliteral">&quot;NEIGHBOR_UPDATE&quot;</span>);
<a name="l00992"></a>00992     gameMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3fe3071c66623191477b903527280ddc">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba360dbdf5c7f61a4d26263e2a010057d7">NEIGHBOR_UPDATE</a>);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6cc71a3065a72e5636753f4e0904ad38">setRemoveNeighborArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00995"></a>00995     gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6bac1604abbdf9c0ec959343b7b64834">setAddNeighborArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00996"></a>00996     gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a81292ede7c0903f5982efcc7625024f1">setNeighborPositionArraySize</a>(<a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.size());
<a name="l00997"></a>00997 
<a name="l00998"></a>00998     <span class="keywordtype">int</span> remSize, addSize;
<a name="l00999"></a>00999     remSize = addSize = 0;
<a name="l01000"></a>01000     <span class="keywordflow">for</span>(QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin(); itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end(); ++itSites) {
<a name="l01001"></a>01001         <span class="keywordflow">if</span>(itSites-&gt;second-&gt;type == <a class="code" href="QuonDefs_8h.html#a65910f3553787356a3dc0bcea3b0c663a02657096ca1b200aae91c6f4c8f1fb5f">QUNDEFINED</a> &amp;&amp; (purgeSoftSites == <a class="code" href="QuonDefs_8h.html#adc5a48b199e542d36b27075cdb579b26a01f818ce2945704d0a5df32f2301885c">QPURGESOFT</a> || !itSites-&gt;second-&gt;softNeighbor) &amp;&amp; itSites-&gt;second-&gt;dirty) {
<a name="l01002"></a>01002             gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a8b48a0c0f6661b7adf07221130be2685">setRemoveNeighbor</a>(remSize, itSites-&gt;second-&gt;address);
<a name="l01003"></a>01003             ++remSize;
<a name="l01004"></a>01004         }
<a name="l01005"></a>01005         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(itSites-&gt;second-&gt;dirty) {
<a name="l01006"></a>01006             gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6fdd2736b4eaabac3e90a623f0e8e130">setAddNeighbor</a>(addSize, itSites-&gt;second-&gt;address);
<a name="l01007"></a>01007             gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#ad91052c0577545e987bf5b08244ece9e">setNeighborPosition</a>(addSize, itSites-&gt;second-&gt;position);
<a name="l01008"></a>01008             itSites-&gt;second-&gt;dirty = <span class="keyword">false</span>;
<a name="l01009"></a>01009             ++addSize;
<a name="l01010"></a>01010         }
<a name="l01011"></a>01011     }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013     <span class="keywordflow">if</span>(remSize &gt; 0 || addSize &gt; 0) {
<a name="l01014"></a>01014         gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6cc71a3065a72e5636753f4e0904ad38">setRemoveNeighborArraySize</a>(remSize);
<a name="l01015"></a>01015         gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6bac1604abbdf9c0ec959343b7b64834">setAddNeighborArraySize</a>(addSize);
<a name="l01016"></a>01016         gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a81292ede7c0903f5982efcc7625024f1">setNeighborPositionArraySize</a>(addSize);
<a name="l01017"></a>01017         <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(gameMsg);
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019     <span class="keywordflow">else</span> {
<a name="l01020"></a>01020         <span class="keyword">delete</span> gameMsg;
<a name="l01021"></a>01021     }
<a name="l01022"></a>01022 }
<a name="l01023"></a>01023 
<a name="l01024"></a><a class="code" href="classQuon.html#a1e7c49275495ea83e41988fe3748788c">01024</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a1e7c49275495ea83e41988fe3748788c">Quon::deleteAppNeighbor</a>(<a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> node)
<a name="l01025"></a>01025 {
<a name="l01026"></a>01026     <a class="code" href="classGameAPIListMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIListMessage</a>* gameMsg = <span class="keyword">new</span> <a class="code" href="classGameAPIListMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">GameAPIListMessage</a>(<span class="stringliteral">&quot;NEIGHBOR_UPDATE&quot;</span>);
<a name="l01027"></a>01027     gameMsg-&gt;<a class="code" href="classGameAPIMessage.html#a3fe3071c66623191477b903527280ddc">setCommand</a>(<a class="code" href="CommonMessages__m_8h.html#ac76e82bc37e4b2b364247c7cff8f7b6ba360dbdf5c7f61a4d26263e2a010057d7">NEIGHBOR_UPDATE</a>);
<a name="l01028"></a>01028     gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6cc71a3065a72e5636753f4e0904ad38">setRemoveNeighborArraySize</a>(1);
<a name="l01029"></a>01029     gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a6bac1604abbdf9c0ec959343b7b64834">setAddNeighborArraySize</a>(0);
<a name="l01030"></a>01030     gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a81292ede7c0903f5982efcc7625024f1">setNeighborPositionArraySize</a>(0);
<a name="l01031"></a>01031     gameMsg-&gt;<a class="code" href="classGameAPIListMessage.html#a8b48a0c0f6661b7adf07221130be2685">setRemoveNeighbor</a>(0, node);
<a name="l01032"></a>01032     <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">sendToApp</a>(gameMsg);
<a name="l01033"></a>01033 }
<a name="l01034"></a>01034 
<a name="l01035"></a><a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">01035</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#adfd1a6c88f3487ae4b57aadd4f0ac9e1">Quon::sendToApp</a>(cMessage* msg)
<a name="l01036"></a>01036 {
<a name="l01037"></a>01037     <span class="comment">// debug output</span>
<a name="l01038"></a>01038     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l01039"></a>01039         EV &lt;&lt; <span class="stringliteral">&quot;[Quon::sendToApp() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l01040"></a>01040            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l01041"></a>01041            &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; sending &quot;</span> &lt;&lt; msg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; to application.&quot;</span>
<a name="l01042"></a>01042            &lt;&lt; endl;
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044     send(msg, <span class="stringliteral">&quot;appOut&quot;</span>);
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01047"></a><a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">01047</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a804dcb69b3560421c1c9ae17a5ada43e">Quon::sendMessage</a>(<a class="code" href="classQuonMessage.html" title="Class generated from overlay/quon/Quon.msg by opp_msgc.">QuonMessage</a>* quonMsg, <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> destination)
<a name="l01048"></a>01048 {
<a name="l01049"></a>01049     <span class="comment">// collect statistics</span>
<a name="l01050"></a>01050     <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(
<a name="l01051"></a>01051         <span class="keywordflow">switch</span>(quonMsg-&gt;<a class="code" href="classQuonMessage.html#a006f8426093f22f07de8b82d8cf0c5be">getCommand</a>()) {
<a name="l01052"></a>01052             <span class="keywordflow">case</span> <a class="code" href="GiaMessage__m_8h.html#ac712f468e66678ffb5df03be6d6a8157a71fec090ff88ece51771bbbf434064ec">JOIN_REQUEST</a>:
<a name="l01053"></a>01053                 <a class="code" href="classQuon.html#acd2d26c06a998552d4d57d7d54a9203c">joinRequestBytesSend</a> += quonMsg-&gt;getByteLength();
<a name="l01054"></a>01054             <span class="keywordflow">break</span>;
<a name="l01055"></a>01055             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad2045a15ed8b82d3db379cc54ba0b7d4">JOIN_ACKNOWLEDGE</a>:
<a name="l01056"></a>01056                 <a class="code" href="classQuon.html#a877edb5c60f4374580611db5e87f9b03">joinAcknowledgeBytesSend</a> += quonMsg-&gt;getByteLength();
<a name="l01057"></a>01057             <span class="keywordflow">break</span>;
<a name="l01058"></a>01058             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fad9745223990da14f545a02e12e727b63">NODE_MOVE</a>:
<a name="l01059"></a>01059                 <a class="code" href="classQuon.html#ac662039da04c611b551ca0b5b0989242">nodeMoveBytesSend</a> += quonMsg-&gt;getByteLength();
<a name="l01060"></a>01060             <span class="keywordflow">break</span>;
<a name="l01061"></a>01061             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fa3aafac4a63883acb0402e9a5dcae8110">NEW_NEIGHBORS</a>:
<a name="l01062"></a>01062                 <a class="code" href="classQuon.html#a60b6442582b349621a5b916b5f63bfdb">newNeighborsBytesSend</a> += quonMsg-&gt;getByteLength();
<a name="l01063"></a>01063             <span class="keywordflow">break</span>;
<a name="l01064"></a>01064             <span class="keywordflow">case</span> <a class="code" href="Quon__m_8h.html#af6ba389f08ae3248fdcdcbcf600ea41fac2f6b0a84b96ac134911c0d532a4a91c">NODE_LEAVE</a>:
<a name="l01065"></a>01065                 <a class="code" href="classQuon.html#ac2d00865bf9e11a6f768434266fc6634">nodeLeaveBytesSend</a> += quonMsg-&gt;getByteLength();
<a name="l01066"></a>01066             <span class="keywordflow">break</span>;
<a name="l01067"></a>01067         }
<a name="l01068"></a>01068         <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a> == <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>) {
<a name="l01069"></a>01069             <a class="code" href="classQuon.html#ac371d756bd985b8a8dd4227f48c2e9fa">bytesPerSecond</a> += quonMsg-&gt;getByteLength();
<a name="l01070"></a>01070         }
<a name="l01071"></a>01071     );
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="comment">// debug output</span>
<a name="l01074"></a>01074     <span class="keywordflow">if</span>(<a class="code" href="classBaseOverlay.html#a49ff0fb8c25792a1339d54a60c36f2cd" title="debug output ?">debugOutput</a>) {
<a name="l01075"></a>01075         EV &lt;&lt; <span class="stringliteral">&quot;[Quon::sendMessage() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l01076"></a>01076            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l01077"></a>01077            &lt;&lt; <span class="stringliteral">&quot;    Node &quot;</span> &lt;&lt; <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot; sending &quot;</span> &lt;&lt; quonMsg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; to &quot;</span> &lt;&lt; destination.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>() &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>
<a name="l01078"></a>01078            &lt;&lt; endl;
<a name="l01079"></a>01079     }
<a name="l01080"></a>01080     <a class="code" href="classBaseOverlay.html#a10189697bd95f3de66c27c1ecf07e323" title="Sends message to underlay.">sendMessageToUDP</a>(destination, quonMsg);
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01083"></a><a class="code" href="classQuon.html#a21e2a16a7d0c8eb408c6f936fecf9df4">01083</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a21e2a16a7d0c8eb408c6f936fecf9df4">Quon::setBootstrapedIcon</a>()
<a name="l01084"></a>01084 {
<a name="l01085"></a>01085     <span class="keywordflow">if</span>(ev.isGUI()) {
<a name="l01086"></a>01086         <span class="keywordflow">switch</span>(<a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a>) {
<a name="l01087"></a>01087             <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>:
<a name="l01088"></a>01088                 getParentModule()-&gt;getParentModule()-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;i2&quot;</span>, 1, <span class="stringliteral">&quot;red&quot;</span>);
<a name="l01089"></a>01089                 getDisplayString().setTagArg(<span class="stringliteral">&quot;i&quot;</span>, 1, <span class="stringliteral">&quot;red&quot;</span>);
<a name="l01090"></a>01090                 <span class="keywordflow">break</span>;
<a name="l01091"></a>01091             <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a6159e3ad96e5cc7ce4cc87a9ac499213">QJOINING</a>:
<a name="l01092"></a>01092                 getParentModule()-&gt;getParentModule()-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;i2&quot;</span>, 1, <span class="stringliteral">&quot;yellow&quot;</span>);
<a name="l01093"></a>01093                 getDisplayString().setTagArg(<span class="stringliteral">&quot;i&quot;</span>, 1, <span class="stringliteral">&quot;yellow&quot;</span>);
<a name="l01094"></a>01094                 <span class="keywordflow">break</span>;
<a name="l01095"></a>01095             <span class="keywordflow">case</span> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1a22a0702a9f5ac0bad9f415323647cd18">QREADY</a>:
<a name="l01096"></a>01096                 getParentModule()-&gt;getParentModule()-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;i2&quot;</span>, 1, <span class="stringliteral">&quot;green&quot;</span>);
<a name="l01097"></a>01097                 getDisplayString().setTagArg(<span class="stringliteral">&quot;i&quot;</span>, 1, <span class="stringliteral">&quot;green&quot;</span>);
<a name="l01098"></a>01098                 <span class="keywordflow">break</span>;
<a name="l01099"></a>01099         }
<a name="l01100"></a>01100     }
<a name="l01101"></a>01101 }
<a name="l01102"></a>01102 
<a name="l01103"></a><a class="code" href="classQuon.html#a2e3fd357706467ba1238bdd8382f5be8">01103</a> <span class="keywordtype">void</span> <a class="code" href="classQuon.html#a2e3fd357706467ba1238bdd8382f5be8" title="collects statistical data in derived class">Quon::finishOverlay</a>()
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105     <span class="keywordtype">double</span> overallBytesSend = <a class="code" href="classQuon.html#acd2d26c06a998552d4d57d7d54a9203c">joinRequestBytesSend</a>
<a name="l01106"></a>01106                             + <a class="code" href="classQuon.html#a877edb5c60f4374580611db5e87f9b03">joinAcknowledgeBytesSend</a>
<a name="l01107"></a>01107                             + <a class="code" href="classQuon.html#ac662039da04c611b551ca0b5b0989242">nodeMoveBytesSend</a>
<a name="l01108"></a>01108                             + <a class="code" href="classQuon.html#a60b6442582b349621a5b916b5f63bfdb">newNeighborsBytesSend</a>
<a name="l01109"></a>01109                             + <a class="code" href="classQuon.html#ac2d00865bf9e11a6f768434266fc6634">nodeLeaveBytesSend</a>;
<a name="l01110"></a>01110     <span class="keywordflow">if</span>(overallBytesSend != 0.0) {
<a name="l01111"></a>01111         <span class="comment">// collect statistics in percent</span>
<a name="l01112"></a>01112         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: fraction of JOIN_REQUEST bytes sent &quot;</span>, <a class="code" href="classQuon.html#acd2d26c06a998552d4d57d7d54a9203c">joinRequestBytesSend</a> / overallBytesSend);
<a name="l01113"></a>01113         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: fraction of JOIN_ACKNOWLEDGE bytes sent&quot;</span>, <a class="code" href="classQuon.html#a877edb5c60f4374580611db5e87f9b03">joinAcknowledgeBytesSend</a> / overallBytesSend);
<a name="l01114"></a>01114         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: fraction of NODE_MOVE bytes sent&quot;</span>, <a class="code" href="classQuon.html#ac662039da04c611b551ca0b5b0989242">nodeMoveBytesSend</a> / overallBytesSend);
<a name="l01115"></a>01115         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: fraction of NEW_NEIGHBORS bytes sent&quot;</span>, <a class="code" href="classQuon.html#a60b6442582b349621a5b916b5f63bfdb">newNeighborsBytesSend</a> / overallBytesSend);
<a name="l01116"></a>01116         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: fraction of NODE_LEAVE bytes sent&quot;</span>, nodeLeaveBytesSend / overallBytesSend);
<a name="l01117"></a>01117     }
<a name="l01118"></a>01118     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: max bytes/second sent&quot;</span>, <a class="code" href="classQuon.html#a479502f99f21bf405210eb0c7c00a9b6">maxBytesPerSecondSend</a>);
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 <span class="comment">//    We use our own time count to avoid rounding errors</span>
<a name="l01121"></a>01121 <span class="comment">//    simtime_t time = globalStatistics-&gt;calcMeasuredLifetime(creationTime);</span>
<a name="l01122"></a>01122 <span class="comment">//    if(time != 0.0) {</span>
<a name="l01123"></a>01123     <span class="keywordflow">if</span>(<a class="code" href="classQuon.html#acdba7ca61befddc0377f74b502f24a1c">secTimerCount</a> != 0) {
<a name="l01124"></a>01124         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: average bytes/second sent&quot;</span>, <a class="code" href="classQuon.html#ab43ea338aa35a082c379716a3fcd02c1">averageBytesPerSecondSend</a> / (<span class="keywordtype">double</span>) <a class="code" href="classQuon.html#acdba7ca61befddc0377f74b502f24a1c">secTimerCount</a>);
<a name="l01125"></a>01125         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: average direct-neighbor count&quot;</span>, <a class="code" href="classQuon.html#a98466c67a6d900869219e4c8acf1dd7c">directNeighborCount</a> / (<span class="keywordtype">double</span>) secTimerCount);
<a name="l01126"></a>01126         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: average binding-neighbor count&quot;</span>, <a class="code" href="classQuon.html#ac8e1a28cfc559f56cfa51ee757a5b44d">bindingNeighborCount</a> / (<span class="keywordtype">double</span>) secTimerCount);
<a name="l01127"></a>01127         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: average soft-neighbor count&quot;</span>, <a class="code" href="classQuon.html#a5450bc23ca2b380316b38903536cad1c">softNeighborCount</a> / (<span class="keywordtype">double</span>) secTimerCount);
<a name="l01128"></a>01128         <span class="comment">//globalStatistics-&gt;addStdDev(&quot;Quon: average rejoin count&quot;, rejoinCount);</span>
<a name="l01129"></a>01129         <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Quon: average AOI width&quot;</span>, <a class="code" href="classQuon.html#a2412db36457ab9bae180b8dd1c3cec47">avgAOI</a> / (<span class="keywordtype">double</span>) secTimerCount);
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <a class="code" href="classQuon.html#aeaf445313feedba17bc0a724e86e7a22">changeState</a>(<a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1af0bde5b6e5ef90c75111f6b79fa4fe42">QUNINITIALIZED</a>);
<a name="l01133"></a>01133 }
<a name="l01134"></a>01134 
<a name="l01135"></a><a class="code" href="classQuon.html#a68e3080e90a657d328c4234f3d75fac7">01135</a> <a class="code" href="QuonDefs_8h.html#aca8402343f1e6379e68bc32d471c3ff1" title="Common Quon Definitions.">QState</a> <a class="code" href="classQuon.html#a68e3080e90a657d328c4234f3d75fac7">Quon::getState</a>()
<a name="l01136"></a>01136 {
<a name="l01137"></a>01137     Enter_Method_Silent();
<a name="l01138"></a>01138     <span class="keywordflow">return</span> <a class="code" href="classQuon.html#a50b8cb447b1d179dd9977161ca5724fe">qstate</a>;
<a name="l01139"></a>01139 }
<a name="l01140"></a>01140 
<a name="l01141"></a><a class="code" href="classQuon.html#a6140fcfc5f22d7a1b0a214e8d2035eeb">01141</a> <span class="keywordtype">double</span> <a class="code" href="classQuon.html#a6140fcfc5f22d7a1b0a214e8d2035eeb">Quon::getAOI</a>()
<a name="l01142"></a>01142 {
<a name="l01143"></a>01143     Enter_Method_Silent();
<a name="l01144"></a>01144     <span class="keywordflow">return</span> <a class="code" href="classQuon.html#aa08a19de1f063d2e75effc3cde6eeee1">AOIWidth</a> - (double)par(<span class="stringliteral">&quot;AOIBuffer&quot;</span>);
<a name="l01145"></a>01145 }
<a name="l01146"></a>01146 
<a name="l01147"></a><a class="code" href="classQuon.html#a2ee6ae30cf512cc9ebb2d76b603ffe61">01147</a> <a class="code" href="classVector2D.html">Vector2D</a> <a class="code" href="classQuon.html#a2ee6ae30cf512cc9ebb2d76b603ffe61">Quon::getPosition</a>()
<a name="l01148"></a>01148 {
<a name="l01149"></a>01149     Enter_Method_Silent();
<a name="l01150"></a>01150     <span class="keywordflow">return</span> <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#ab53cc9364d2f89e2c792f77383866c6c">position</a>;
<a name="l01151"></a>01151 }
<a name="l01152"></a>01152 
<a name="l01153"></a><a class="code" href="classQuon.html#af3c814c9a87a9557e8190fdbd92c7aa9">01153</a> <span class="keywordtype">double</span> <a class="code" href="classQuon.html#af3c814c9a87a9557e8190fdbd92c7aa9">Quon::getAreaDimension</a>()
<a name="l01154"></a>01154 {
<a name="l01155"></a>01155     Enter_Method_Silent();
<a name="l01156"></a>01156     <span class="keywordflow">return</span> <a class="code" href="classQuon.html#ac0c61c44ee942bcb8f71ffa069a681fc">areaDimension</a>;
<a name="l01157"></a>01157 }
<a name="l01158"></a>01158 
<a name="l01159"></a><a class="code" href="classQuon.html#a68a2c09dba9d923a88c972acc8710956">01159</a> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a> <a class="code" href="classQuon.html#a68a2c09dba9d923a88c972acc8710956">Quon::getKey</a>()
<a name="l01160"></a>01160 {
<a name="l01161"></a>01161     Enter_Method_Silent();
<a name="l01162"></a>01162     <span class="keywordflow">return</span> <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>-&gt;<a class="code" href="classQuonSite.html#aa317c162070862f2278a9d532d6d2215">address</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>();
<a name="l01163"></a>01163 }
<a name="l01164"></a>01164 
<a name="l01165"></a><a class="code" href="classQuon.html#a08f13af619a1b819315742449471e677">01165</a> <span class="keywordtype">long</span> <a class="code" href="classQuon.html#a08f13af619a1b819315742449471e677">Quon::getSoftNeighborCount</a>()
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167     Enter_Method_Silent();
<a name="l01168"></a>01168     <span class="keywordtype">long</span> temp = <a class="code" href="classQuon.html#ad842d00209159d0d47c0abe7aec573c2">softConnections</a>;
<a name="l01169"></a>01169     <a class="code" href="classQuon.html#ad842d00209159d0d47c0abe7aec573c2">softConnections</a> = 0;
<a name="l01170"></a>01170     <span class="keywordflow">return</span> temp;
<a name="l01171"></a>01171 }
<a name="l01172"></a>01172 
<a name="l01173"></a><a class="code" href="classQuon.html#ac9209e027a6b6722ce4480ecaa9974b4">01173</a> <a class="code" href="classQuon.html#ac9209e027a6b6722ce4480ecaa9974b4">Quon::~Quon</a>()
<a name="l01174"></a>01174 {
<a name="l01175"></a>01175     <span class="comment">// destroy self timer messages</span>
<a name="l01176"></a>01176     cancelAndDelete(<a class="code" href="classQuon.html#a50bdccb83a076a567533790cef1a7c84">join_timer</a>);
<a name="l01177"></a>01177     cancelAndDelete(<a class="code" href="classQuon.html#a90247744dc8738653a4830170ac600e4">sec_timer</a>);
<a name="l01178"></a>01178     cancelAndDelete(<a class="code" href="classQuon.html#a77a68e7de92d342999c42495e23691c1">alive_timer</a>);
<a name="l01179"></a>01179     cancelAndDelete(<a class="code" href="classQuon.html#a41c411546eafb1dd79c0640a3937090e">backup_timer</a>);
<a name="l01180"></a>01180     <span class="keyword">delete</span> <a class="code" href="classQuon.html#a5a21971a54b787e60309efd58b93636b">thisSite</a>;
<a name="l01181"></a>01181     QuonSiteMap::iterator itSites = <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.begin();
<a name="l01182"></a>01182     <span class="keywordflow">while</span>(itSites != <a class="code" href="classQuon.html#a2538460ed4a813703ab98d2b3901c5d3">Sites</a>.end()) {
<a name="l01183"></a>01183         <span class="keyword">delete</span> itSites-&gt;second;
<a name="l01184"></a>01184         ++itSites;
<a name="l01185"></a>01185     }
<a name="l01186"></a>01186 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="Quon_8cc.html">Quon.cc</a>      </li>

    <li class="footer">Generated on Thu Mar 6 2014 14:06:30 for OverSim by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
