<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: Kademlia.cc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OverSim
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('Kademlia_8cc.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Kademlia.cc</div>  </div>
</div>
<div class="contents">
<a href="Kademlia_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2006 Institut fuer Telematik, Universitaet Karlsruhe (TH)</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment">// modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment">// GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment">// along with this program; if not, write to the Free Software</span>
<a name="l00016"></a>00016 <span class="comment">// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<a name="l00017"></a>00017 
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="Kademlia_8h.html">Kademlia.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="KademliaMessage__m_8h.html">KademliaMessage_m.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;IPAddressResolver.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;IPvXAddress.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;IInterfaceTable.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;IPv4InterfaceData.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="TopologyVis_8h.html">TopologyVis.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="code" href="AbstractLookup_8h.html">AbstractLookup.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="LookupListener_8h.html">LookupListener.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="RpcMacros_8h.html" title="This file declares some macros for RPC implementation.">RpcMacros.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="BootstrapList_8h.html">BootstrapList.h</a>&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#if 0</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#define BUCKET_CONSISTENCY(msg) \</span>
<a name="l00042"></a>00042 <span class="preprocessor">    do {\</span>
<a name="l00043"></a>00043 <span class="preprocessor">        bool stFull = false;\</span>
<a name="l00044"></a>00044 <span class="preprocessor">        int z = 0;\</span>
<a name="l00045"></a>00045 <span class="preprocessor">        if (siblingTable != NULL &amp;&amp; siblingTable-&gt;size() &gt; 0) {\</span>
<a name="l00046"></a>00046 <span class="preprocessor">            stFull = siblingTable-&gt;isFull();\</span>
<a name="l00047"></a>00047 <span class="preprocessor">            z = routingBucketIndex(siblingTable-&gt;back().getKey()) - 1;\</span>
<a name="l00048"></a>00048 <span class="preprocessor">            if (routingTable[z - 1] != NULL &amp;&amp; routingTable[z - 1]-&gt;size())\</span>
<a name="l00049"></a>00049 <span class="preprocessor">                breakpoint(#msg);\</span>
<a name="l00050"></a>00050 <span class="preprocessor">        }\</span>
<a name="l00051"></a>00051 <span class="preprocessor">        for (int y = 0; y &lt; (z - 2); ++y) {\</span>
<a name="l00052"></a>00052 <span class="preprocessor">            if ((routingTable[y] != NULL &amp;&amp; routingTable[y]-&gt;size() &gt; k) ||\</span>
<a name="l00053"></a>00053 <span class="preprocessor">                (routingTable[y] != NULL &amp;&amp; routingTable[y]-&gt;size() &amp;&amp; !stFull))\</span>
<a name="l00054"></a>00054 <span class="preprocessor">                breakpoint(#msg);\</span>
<a name="l00055"></a>00055 <span class="preprocessor">        }\</span>
<a name="l00056"></a>00056 <span class="preprocessor">    } while (false)</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00058"></a><a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define BUCKET_CONSISTENCY(msg)</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>
<a name="l00061"></a>00061 <a class="code" href="ALMTest_8cc.html#a3b5014f410c7989e8bad4b467ecc94cd">Define_Module</a>(<a class="code" href="classKademlia.html" title="Kademlia overlay module.">Kademlia</a>);
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="Kademlia_8cc.html#a7af9c469c3de5bc5a4815c6be9f5dae5">00063</a> std::ostream&amp; <a class="code" href="MessageObserver_8cc.html#a8f32b0caa624b1003f9f7a382c634798">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* n)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     <span class="keywordflow">if</span> (n == NULL)
<a name="l00066"></a>00066         os &lt;&lt; <span class="stringliteral">&quot;NULL&quot;</span>;
<a name="l00067"></a>00067     <span class="keywordflow">else</span> {
<a name="l00068"></a>00068         <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#ae515dd1aaec0a9a300fd122a3d8b0867" title="read-only iterator for this vector">KademliaBucket::const_iterator</a> i=n-&gt;begin(); i !=n-&gt;end(); i++) {
<a name="l00069"></a>00069             os &lt;&lt; *i &lt;&lt; endl;
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071         os &lt;&lt; <span class="stringliteral">&quot;last usage = &quot;</span> &lt;&lt; n-&gt;<a class="code" href="classKademliaBucket.html#af0d14164aa8f871b1696245b78ad9a6d">getLastUsage</a>();
<a name="l00072"></a>00072     }
<a name="l00073"></a>00073     <span class="keywordflow">return</span> os;
<a name="l00074"></a>00074 };
<a name="l00075"></a>00075 
<a name="l00076"></a><a class="code" href="classKademliaLookupListener.html">00076</a> <span class="keyword">class </span><a class="code" href="classKademliaLookupListener.html">KademliaLookupListener</a> : <span class="keyword">public</span> <a class="code" href="classLookupListener.html" title="This class declares an abstract lookup listener.">LookupListener</a>
<a name="l00077"></a>00077 {
<a name="l00078"></a>00078 <span class="keyword">private</span>:
<a name="l00079"></a><a class="code" href="classKademliaLookupListener.html#ae50b49d95bf500c12de3f936ade6aa4e">00079</a>     <a class="code" href="classKademlia.html" title="Kademlia overlay module.">Kademlia</a>* <a class="code" href="classKademliaLookupListener.html#ae50b49d95bf500c12de3f936ade6aa4e">overlay</a>;
<a name="l00080"></a>00080 <span class="keyword">public</span>:
<a name="l00081"></a><a class="code" href="classKademliaLookupListener.html#a359df785f335d5d493f65b0f1387d5d9">00081</a>     <a class="code" href="classKademliaLookupListener.html#a359df785f335d5d493f65b0f1387d5d9">KademliaLookupListener</a>(<a class="code" href="classKademlia.html" title="Kademlia overlay module.">Kademlia</a>* <a class="code" href="classKademliaLookupListener.html#ae50b49d95bf500c12de3f936ade6aa4e">overlay</a>)
<a name="l00082"></a>00082     {
<a name="l00083"></a>00083         this-&gt;overlay = <a class="code" href="classKademliaLookupListener.html#ae50b49d95bf500c12de3f936ade6aa4e">overlay</a>;
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="classKademliaLookupListener.html#a587aaf8753012294f7320ed1ad7b35fb">00086</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classKademliaLookupListener.html#a587aaf8753012294f7320ed1ad7b35fb">lookupFinished</a>(<a class="code" href="classAbstractLookup.html" title="This class declares an abstract iterative lookup.">AbstractLookup</a> *lookup)
<a name="l00087"></a>00087     {
<a name="l00088"></a>00088         <a class="code" href="classKademliaLookupListener.html#ae50b49d95bf500c12de3f936ade6aa4e">overlay</a>-&gt;<a class="code" href="classKademlia.html#adac287af3943cfcbc1a3834fa8d0c37d">lookupFinished</a>(lookup-&gt;<a class="code" href="classAbstractLookup.html#a698d5d467c714e4d114359d1078b505d" title="Returns true, if the lookup was successful.">isValid</a>());
<a name="l00089"></a>00089         <span class="keyword">delete</span> <span class="keyword">this</span>;
<a name="l00090"></a>00090     }
<a name="l00091"></a>00091 };
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">//-----------------------------------------------------------------------------</span>
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="classKademlia.html#a3230c643b585b8f0745cebb7a577349c">00095</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a3230c643b585b8f0745cebb7a577349c" title="Initializes derived-class-attributes.">Kademlia::initializeOverlay</a>(<span class="keywordtype">int</span> stage)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (stage != <a class="code" href="InitStages_8h.html#a42fde1aa1e14a1c45d29061d6e87e532a58e83c497c7c8495e9c592ff3148b6b9" title="first stage for overlay modules (Tier 0 / KBR)">MIN_STAGE_OVERLAY</a>)
<a name="l00098"></a>00098         <span class="keywordflow">return</span>;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="comment">// Kademlia provides KBR services</span>
<a name="l00101"></a>00101     <a class="code" href="classBaseOverlay.html#a53389ea3326d2e8ad53f02b388487d0b" title="set this to true, if the overlay provides KBR services">kbr</a> = <span class="keyword">true</span>;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <span class="comment">// setup kademlia parameters</span>
<a name="l00104"></a>00104     <a class="code" href="classKademlia.html#ae22800e069a69a317d4906a29e4da71d">minSiblingTableRefreshInterval</a> = par(<span class="stringliteral">&quot;minSiblingTableRefreshInterval&quot;</span>);
<a name="l00105"></a>00105     <a class="code" href="classKademlia.html#abda8d541b714ec855d891a2938fa8b3f">minBucketRefreshInterval</a> = par(<span class="stringliteral">&quot;minBucketRefreshInterval&quot;</span>);
<a name="l00106"></a>00106     <a class="code" href="classKademlia.html#a99dbb3ee2302a9861a518b3d75cb3eb2">siblingPingInterval</a> = par(<span class="stringliteral">&quot;siblingPingInterval&quot;</span>);
<a name="l00107"></a>00107     <a class="code" href="classKademlia.html#ae7a670589ec838bbf79d684fba016185">exhaustiveRefresh</a> = par(<span class="stringliteral">&quot;exhaustiveRefresh&quot;</span>);
<a name="l00108"></a>00108     <a class="code" href="classKademlia.html#a742e20c8d232a8623f4a85c2f0cad1e4">maxStaleCount</a> = par(<span class="stringliteral">&quot;maxStaleCount&quot;</span>);
<a name="l00109"></a>00109     <a class="code" href="classKademlia.html#a113faa91ed3ec564f8b61718101695c2">pingNewSiblings</a> = par(<span class="stringliteral">&quot;pingNewSiblings&quot;</span>);
<a name="l00110"></a>00110     <a class="code" href="classKademlia.html#a151fd59bc6de940e684fbad408083ac4">enableReplacementCache</a> = par(<span class="stringliteral">&quot;enableReplacementCache&quot;</span>);
<a name="l00111"></a>00111     <a class="code" href="classKademlia.html#adc22fe7536c4bea9677ed901b95820a8">replacementCachePing</a> = par(<span class="stringliteral">&quot;replacementCachePing&quot;</span>);
<a name="l00112"></a>00112     <a class="code" href="classKademlia.html#a8ebc8abde092aad89dfa813ba640e6ef">replacementCandidates</a> = par(<span class="stringliteral">&quot;replacementCandidates&quot;</span>);
<a name="l00113"></a>00113     <a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a> = par(<span class="stringliteral">&quot;secureMaintenance&quot;</span>);
<a name="l00114"></a>00114     <a class="code" href="classKademlia.html#a68e77f3b48652f19219a6c6c9a1a76d2">newMaintenance</a> = par(<span class="stringliteral">&quot;newMaintenance&quot;</span>);
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="comment">// R/Kademlia</span>
<a name="l00117"></a>00117     <a class="code" href="classKademlia.html#aa83e5da5199e71427e731d4a1ad7ce9d">activePing</a> = par(<span class="stringliteral">&quot;activePing&quot;</span>);
<a name="l00118"></a>00118     <a class="code" href="classKademlia.html#aa8b1be416dea22c671ae2774936226c5">proximityRouting</a> = par(<span class="stringliteral">&quot;proximityRouting&quot;</span>);
<a name="l00119"></a>00119     <a class="code" href="classKademlia.html#aa1c9d6f7ff020a8a9249f1da3d1fedbe">proximityNeighborSelection</a> = par(<span class="stringliteral">&quot;proximityNeighborSelection&quot;</span>);
<a name="l00120"></a>00120     <a class="code" href="classKademlia.html#a53857e5e13f67a12e810db01a18400dc">altRecMode</a> = <a class="code" href="classBaseOverlay.html#a61186fd8bd7368c8a91a63ecc9c62a89" title="record visited hops on route">recordRoute</a> = par(<span class="stringliteral">&quot;altRecMode&quot;</span>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <a class="code" href="classKademlia.html#acc2f4767a1687764f2d732872511a7ad">k</a> = par(<span class="stringliteral">&quot;k&quot;</span>);
<a name="l00123"></a>00123     <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a> = par(<span class="stringliteral">&quot;b&quot;</span>);
<a name="l00124"></a>00124     <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a> = par(<span class="stringliteral">&quot;s&quot;</span>);
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <a class="code" href="classKademlia.html#ad4d31fcf8c7300404ae07523daab8cc6">siblingRefreshNodes</a> = par(<span class="stringliteral">&quot;siblingRefreshNodes&quot;</span>);
<a name="l00127"></a>00127 
<a name="l00128"></a>00128     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#ad4d31fcf8c7300404ae07523daab8cc6">siblingRefreshNodes</a> &lt;= 0) {
<a name="l00129"></a>00129         <a class="code" href="classKademlia.html#ad4d31fcf8c7300404ae07523daab8cc6">siblingRefreshNodes</a> = 5 * <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a>;
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <a class="code" href="classKademlia.html#a5ab8d39b7c098f21d9577d5dfc82a4f4">bucketRefreshNodes</a> = par(<span class="stringliteral">&quot;bucketRefreshNodes&quot;</span>);
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a5ab8d39b7c098f21d9577d5dfc82a4f4">bucketRefreshNodes</a> &lt;= 0) {
<a name="l00135"></a>00135         <a class="code" href="classKademlia.html#a5ab8d39b7c098f21d9577d5dfc82a4f4">bucketRefreshNodes</a> = <a class="code" href="classBaseOverlay.html#a32b8cfb47f3ef824dcf6ad882e6a6a9f">iterativeLookupConfig</a>.<a class="code" href="classIterativeLookupConfiguration.html#a5ffefd1d559420cc498307521ae1fac7" title="number of next hops in each step">redundantNodes</a>;
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="comment">// calculate number of buckets: ( (2^b)-1 ) * ( keylength / b )</span>
<a name="l00139"></a>00139     <a class="code" href="classKademlia.html#a307336180b2937d77360219c9ac91c3c">numBuckets</a> = ((1L &lt;&lt; <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) - 1L) * (<a class="code" href="classOverlayKey.html#af855a4dfc0e5dc0d2afc6b87fa1d7426" title="Returns the length in number of bits.">OverlayKey::getLength</a>() / <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">// init routing and sibling table</span>
<a name="l00142"></a>00142     <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a> = <span class="keyword">new</span> <a class="code" href="classKademliaBucket.html">KademliaBucket</a>(<a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a> * 5, NULL);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">// initialize pointers</span>
<a name="l00145"></a>00145     <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>.assign(<a class="code" href="classKademlia.html#a307336180b2937d77360219c9ac91c3c">numBuckets</a>, (<a class="code" href="classKademliaBucket.html">KademliaBucket</a>*)NULL);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     WATCH_VECTOR(*<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>);
<a name="l00148"></a>00148     WATCH_VECTOR(<a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="comment">// self-message</span>
<a name="l00151"></a>00151     <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;bucketRefreshTimer&quot;</span>);
<a name="l00152"></a>00152     <a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;siblingPingTimer&quot;</span>);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="comment">// statistics</span>
<a name="l00155"></a>00155     <a class="code" href="classKademlia.html#a210614b1ea667d544d256a1cc5e94490">bucketRefreshCount</a> = 0;
<a name="l00156"></a>00156     <a class="code" href="classKademlia.html#a9b7cdab70352fcc52c0cfe55541807ef">siblingTableRefreshCount</a> = 0;
<a name="l00157"></a>00157     <a class="code" href="classKademlia.html#aa1eda90d9ae7c58ff916a9d493d7c1e6">nodesReplaced</a> = 0;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a> = NULL;
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a><a class="code" href="classKademlia.html#a75d6af36c354ebd0a180eb15a392def5">00162</a> <a class="code" href="classKademlia.html#a75d6af36c354ebd0a180eb15a392def5">Kademlia::Kademlia</a>()
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164     <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a> = NULL;
<a name="l00165"></a>00165     <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a> = NULL;
<a name="l00166"></a>00166     <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a> = NULL;
<a name="l00167"></a>00167     <a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a> = NULL;
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a><a class="code" href="classKademlia.html#a76944a48a365d24b78df662970484bc5">00170</a> <a class="code" href="classKademlia.html#a76944a48a365d24b78df662970484bc5">Kademlia::~Kademlia</a>()
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     <a class="code" href="classKademlia.html#ad54c5bcac7db895e0e0eec5cd0109da2">routingDeinit</a>();
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keyword">delete</span> <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>;
<a name="l00175"></a>00175     <span class="keyword">delete</span> <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a>;
<a name="l00176"></a>00176     cancelAndDelete(<a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l00177"></a>00177     cancelAndDelete(<a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>);
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a><a class="code" href="classKademlia.html#a9682b56476fa08cd0af341312d2c8186">00180</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a9682b56476fa08cd0af341312d2c8186" title="collects statistical data in derived class">Kademlia::finishOverlay</a>()
<a name="l00181"></a>00181 {
<a name="l00182"></a>00182     simtime_t time = <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a610799ebfbf64696c59b811870cc8300">calcMeasuredLifetime</a>(<a class="code" href="classBaseOverlay.html#af0eebaddea732ee4ab4d247c388e62bd" title="simtime when the node has been created">creationTime</a>);
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (time &lt; <a class="code" href="classGlobalStatistics.html#a169810c78519b271f7e32fdc7c9fc641" title="minimum useful measured lifetime in seconds">GlobalStatistics::MIN_MEASURED</a>) <span class="keywordflow">return</span>;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Kademlia: Nodes replaced in buckets/s&quot;</span>,
<a name="l00186"></a>00186                                 <a class="code" href="classKademlia.html#aa1eda90d9ae7c58ff916a9d493d7c1e6">nodesReplaced</a> / time);
<a name="l00187"></a>00187     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Kademlia: Bucket Refreshes/s&quot;</span>,
<a name="l00188"></a>00188                                 <a class="code" href="classKademlia.html#a210614b1ea667d544d256a1cc5e94490">bucketRefreshCount</a> / time);
<a name="l00189"></a>00189     <a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#a6a697a0b67f344e4bc214159761f943a" title="Add a new value to the cStdDev container specified by the name parameter.">addStdDev</a>(<span class="stringliteral">&quot;Kademlia: Sibling Table Refreshes/s&quot;</span>,
<a name="l00190"></a>00190                                 <a class="code" href="classKademlia.html#a9b7cdab70352fcc52c0cfe55541807ef">siblingTableRefreshCount</a> / time);
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a><a class="code" href="classKademlia.html#a837fc1c137eebd1189ff401b4bd97a99">00193</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a837fc1c137eebd1189ff401b4bd97a99">Kademlia::sendSiblingFindNodeCall</a>(<span class="keyword">const</span> <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a>&amp; dest)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195     <a class="code" href="classFindNodeCall.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">FindNodeCall</a>* call = <span class="keyword">new</span> <a class="code" href="classFindNodeCall.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">FindNodeCall</a>(<span class="stringliteral">&quot;FindNodeCall&quot;</span>);
<a name="l00196"></a>00196     call-&gt;<a class="code" href="classFindNodeCall.html#a23d81e4dffecd7b5ba72dce892af2159">setExhaustiveIterative</a>(<span class="keyword">true</span>);
<a name="l00197"></a>00197     call-&gt;<a class="code" href="classFindNodeCall.html#a2abda290bf29528fddc71c5b2e89b4ad">setLookupKey</a>(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00198"></a>00198     call-&gt;<a class="code" href="classFindNodeCall.html#a59d13e29485b5f38b1d105cb6016cf98">setNumRedundantNodes</a>(<a class="code" href="classKademlia.html#ad4d31fcf8c7300404ae07523daab8cc6">siblingRefreshNodes</a>);
<a name="l00199"></a>00199     call-&gt;<a class="code" href="classFindNodeCall.html#a743e7a1901266a50953eb276c4420f67">setNumSiblings</a>(<a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">getMaxNumSiblings</a>());
<a name="l00200"></a>00200     call-&gt;setBitLength(<a class="code" href="CommonMessages__m_8h.html#aac2b8db2e1b70d585c2262cb346130e4">FINDNODECALL_L</a>(call));
<a name="l00201"></a>00201     <a class="code" href="classBaseRpc.html#ac128e0ff0d09f81b652f7d3e00ce9441" title="Sends a Remote-Procedure-Call message to the underlay ">sendUdpRpcCall</a>(dest, call);
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a><a class="code" href="classKademlia.html#a23662900f3d17541a2b9051a3821a226">00204</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a23662900f3d17541a2b9051a3821a226" title="Join the overlay with a given nodeID in thisNode.key.">Kademlia::joinOverlay</a>()
<a name="l00205"></a>00205 {
<a name="l00206"></a>00206     <span class="comment">// remove current node handle from the bootstrap list</span>
<a name="l00207"></a>00207     <span class="keywordflow">if</span> (!<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#abe357a4d1babcf7d30598a61cbc0f5c2" title="Returns true, if the key is unspecified.">isUnspecified</a>()) {
<a name="l00208"></a>00208         <a class="code" href="classBaseOverlay.html#abe4dea93564123116c97d5c4721f0504" title="pointer to the BootstrapList module">bootstrapList</a>-&gt;<a class="code" href="classBootstrapList.html#a918cbbc5c592fb9069abba47a50af7c0">removeBootstrapNode</a>(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>);
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">// initialize routing</span>
<a name="l00212"></a>00212     <a class="code" href="classKademlia.html#ad54c5bcac7db895e0e0eec5cd0109da2">routingDeinit</a>();
<a name="l00213"></a>00213     <a class="code" href="classKademlia.html#a0fc8d7eadb6ed086536cbc273460d7a9">routingInit</a>();
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a> handle = <a class="code" href="classBaseOverlay.html#abe4dea93564123116c97d5c4721f0504" title="pointer to the BootstrapList module">bootstrapList</a>-&gt;<a class="code" href="classBootstrapList.html#ac351433be1d43bbf8cbb871e9f9e1f69" title="Get a bootstrap node from the bootstrap list.">getBootstrapNode</a>();
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="keywordflow">if</span> (!handle.<a class="code" href="classTransportAddress.html#a026e777c423ff2a0280edd2fa5472e74" title="indicates if TransportAddress is specified">isUnspecified</a>()) {
<a name="l00218"></a>00218         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a>) {
<a name="l00219"></a>00219             <a class="code" href="classKademlia.html#a837fc1c137eebd1189ff401b4bd97a99">sendSiblingFindNodeCall</a>(handle);
<a name="l00220"></a>00220         } <span class="keywordflow">else</span> {
<a name="l00221"></a>00221             <span class="comment">// ping the bootstrap node to start bootstrapping</span>
<a name="l00222"></a>00222             <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(handle);
<a name="l00223"></a>00223         }
<a name="l00224"></a>00224     } <span class="keywordflow">else</span> {
<a name="l00225"></a>00225         <span class="comment">// we&#39;re the only node in the network</span>
<a name="l00226"></a>00226         <a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> = <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>;
<a name="l00227"></a>00227         <a class="code" href="classBaseOverlay.html#a9da615809e832cbc4645cc732d510277" title="Sets the overlay ready icon and register/deregisters the node at the GlobalNodeList.">setOverlayReady</a>(<span class="keyword">true</span>);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229         <span class="comment">// schedule bucket refresh timer</span>
<a name="l00230"></a>00230         cancelEvent(<a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l00231"></a>00231         scheduleAt(simTime(), <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l00232"></a>00232         cancelEvent(<a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>);
<a name="l00233"></a>00233         scheduleAt(simTime() + <a class="code" href="classKademlia.html#a99dbb3ee2302a9861a518b3d75cb3eb2">siblingPingInterval</a>, <a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>);
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="comment">//-----------------------------------------------------------------------------</span>
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="classKademlia.html#a0fc8d7eadb6ed086536cbc273460d7a9">00239</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a0fc8d7eadb6ed086536cbc273460d7a9">Kademlia::routingInit</a>()
<a name="l00240"></a>00240 {
<a name="l00241"></a>00241     <span class="comment">// set join state</span>
<a name="l00242"></a>00242     <a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> = <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <a class="code" href="classBaseOverlay.html#a9da615809e832cbc4645cc732d510277" title="Sets the overlay ready icon and register/deregisters the node at the GlobalNodeList.">setOverlayReady</a>(<span class="keyword">false</span>);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="comment">// setup comparator</span>
<a name="l00247"></a>00247     <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a> = <span class="keyword">new</span> <a class="code" href="classKeyDistanceComparator.html">KeyDistanceComparator&lt;KeyXorMetric&gt;</a>(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#ac509494faf9fa46ca1d11964a21c8247">setComparator</a>(<a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a>);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <a class="code" href="classKademlia.html#acd029f455e0c6150c038c69fa493696c" title="updates information shown in GUI">updateTooltip</a>();
<a name="l00252"></a>00252     <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a0fc8d7eadb6ed086536cbc273460d7a9">routingInit</a>: end);
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a><a class="code" href="classKademlia.html#ad54c5bcac7db895e0e0eec5cd0109da2">00255</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#ad54c5bcac7db895e0e0eec5cd0109da2">Kademlia::routingDeinit</a>()
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257     <span class="comment">// delete buckets</span>
<a name="l00258"></a>00258     <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>.size(); i++) {
<a name="l00259"></a>00259         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[i] != NULL) {
<a name="l00260"></a>00260             <span class="keyword">delete</span> <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[i];
<a name="l00261"></a>00261             <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[i] = NULL;
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a> != NULL) {
<a name="l00266"></a>00266         <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;clear();
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a> != NULL) {
<a name="l00270"></a>00270         <span class="keyword">delete</span> <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a>;
<a name="l00271"></a>00271         <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a> = NULL;
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 
<a name="l00275"></a><a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad">00275</a> <span class="keywordtype">int</span> <a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">Kademlia::getMaxNumSiblings</a>()
<a name="l00276"></a>00276 {
<a name="l00277"></a>00277     <span class="keywordflow">return</span> <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a>;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="classKademlia.html#a5127b16ed36be0a202ecb7b890a7e634">00280</a> <span class="keywordtype">int</span> <a class="code" href="classKademlia.html#a5127b16ed36be0a202ecb7b890a7e634" title="Query the maximum number of redundant next hop nodes that are returned by findNode().">Kademlia::getMaxNumRedundantNodes</a>()
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     <span class="keywordflow">return</span> <a class="code" href="classKademlia.html#acc2f4767a1687764f2d732872511a7ad">k</a>;
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 
<a name="l00285"></a><a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5">00285</a> <span class="keywordtype">int</span> <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">Kademlia::routingBucketIndex</a>(<span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key, <span class="keywordtype">bool</span> firstOnLayer)
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287     <span class="comment">// calculate XOR distance</span>
<a name="l00288"></a>00288     <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a> delta = key ^ <a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>();
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="comment">// find first subinteger that is not zero...</span>
<a name="l00291"></a>00291     <span class="keywordtype">int</span> i;
<a name="l00292"></a>00292     <span class="keywordflow">for</span> (i = key.<a class="code" href="classOverlayKey.html#af855a4dfc0e5dc0d2afc6b87fa1d7426" title="Returns the length in number of bits.">getLength</a>() - <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>; i &gt;= 0 &amp;&amp; delta.<a class="code" href="classOverlayKey.html#a25b2a67642f29fe2035a0abf74de3dd1" title="Returns a sub integer at position p with n-bits.">getBitRange</a>(i, <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) == 0;
<a name="l00293"></a>00293          i -= <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>);
<a name="l00294"></a>00294 
<a name="l00295"></a>00295     <span class="keywordflow">if</span> (i &lt; 0)
<a name="l00296"></a>00296         <span class="keywordflow">return</span> -1;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (!firstOnLayer)
<a name="l00299"></a>00299         <span class="keywordflow">return</span> (i / <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) * ((1 &lt;&lt; <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) - 1) + (delta.<a class="code" href="classOverlayKey.html#a25b2a67642f29fe2035a0abf74de3dd1" title="Returns a sub integer at position p with n-bits.">getBitRange</a>(i, <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) - 1);
<a name="l00300"></a>00300     <span class="keywordflow">else</span>
<a name="l00301"></a>00301         <span class="keywordflow">return</span> (i / <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) * ((1 &lt;&lt; <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) - 1) + (pow(2, <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) - 2);
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a><a class="code" href="classKademlia.html#a12ad26290a17accd9645415e7e8cb9d3">00304</a> <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* <a class="code" href="classKademlia.html#a12ad26290a17accd9645415e7e8cb9d3" title="Returns a Bucket or NULL if the bucket has not yet allocated.">Kademlia::routingBucket</a>(<span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key, <span class="keywordtype">bool</span> ensure)
<a name="l00305"></a>00305 {
<a name="l00306"></a>00306     <span class="comment">// get bucket index</span>
<a name="l00307"></a>00307     <span class="keywordtype">int</span> num = <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(key);
<a name="l00308"></a>00308     <span class="keywordflow">if</span> (num &lt; 0)
<a name="l00309"></a>00309         <span class="keywordflow">return</span> NULL;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     <span class="comment">// get bucket and allocate if necessary</span>
<a name="l00312"></a>00312     <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* bucket = <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[ num ];
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (bucket == NULL &amp;&amp; ensure)
<a name="l00314"></a>00314         bucket = <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[ num ] = <span class="keyword">new</span> <a class="code" href="classKademliaBucket.html">KademliaBucket</a>( <a class="code" href="classKademlia.html#acc2f4767a1687764f2d732872511a7ad">k</a>, <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a> );
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="comment">// return bucket</span>
<a name="l00317"></a>00317     <span class="keywordflow">return</span> bucket;
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a><a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9">00320</a> <span class="keywordtype">bool</span> <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">Kademlia::routingAdd</a>(<span class="keyword">const</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp; handle, <span class="keywordtype">bool</span> isAlive,
<a name="l00321"></a>00321                           simtime_t rtt, <span class="keywordtype">bool</span> maintenanceLookup)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323     <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>: start);
<a name="l00324"></a>00324     <span class="comment">// never add unspecified node handles</span>
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (handle.<a class="code" href="classNodeHandle.html#ab5136375a4548ced7c2014a73c8743c9" title="indicates if this NodeHandle is specified">isUnspecified</a>() || handle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() == <a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>()) {
<a name="l00326"></a>00326         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00327"></a>00327     }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00330"></a>00330        &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00331"></a>00331        &lt;&lt; <span class="stringliteral">&quot;    inserting node &quot;</span> &lt;&lt; handle &lt;&lt; <span class="stringliteral">&quot; (rtt = &quot;</span>;
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (rtt == MAXTIME) {
<a name="l00333"></a>00333         EV &lt;&lt; <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>;
<a name="l00334"></a>00334     } <span class="keywordflow">else</span> {
<a name="l00335"></a>00335         EV &lt;&lt; SIMTIME_DBL(rtt);
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337     EV &lt;&lt; <span class="stringliteral">&quot;, isAlive = &quot;</span> &lt;&lt; (isAlive?<span class="stringliteral">&quot;true&quot;</span>:<span class="stringliteral">&quot;false&quot;</span>)
<a name="l00338"></a>00338        &lt;&lt; <span class="stringliteral">&quot;) ...&quot;</span> &lt;&lt; endl;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <span class="comment">// bucket index</span>
<a name="l00341"></a>00341     <a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i;
<a name="l00342"></a>00342     <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;
<a name="l00343"></a>00343     <span class="keywordtype">bool</span> authenticated = (isAlive &amp;&amp; (rtt != MAXTIME));
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     <span class="keywordtype">bool</span> needsRtt = (<a class="code" href="classKademlia.html#aa83e5da5199e71427e731d4a1ad7ce9d">activePing</a> &amp;&amp; ((rtt == MAXTIME) ? <span class="keyword">true</span> : <span class="keyword">false</span>));
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="comment">// convert node handle</span>
<a name="l00348"></a>00348     <a class="code" href="classKademliaBucketEntry.html">KademliaBucketEntry</a> kadHandle = handle;
<a name="l00349"></a>00349     kadHandle.<a class="code" href="classKademliaBucketEntry.html#a9e29a141071d1dcfb9b6a5ef8151aebd">setRtt</a>(rtt);
<a name="l00350"></a>00350     kadHandle.<a class="code" href="classKademliaBucketEntry.html#a7dcf9a1bf9e8f22d2f23bdee614e1dac">setLastSeen</a>(simTime());
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="comment">/* check if node is already a sibling -----------------------------------*/</span>
<a name="l00353"></a>00353     <span class="keywordflow">if</span> ((i = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#a5f7a2df11ab0a0b3c4c505b5d932c2aa" title="Searches for an OberlayKey in a NodeVector and returns an appropriate iterator.">findIterator</a>(kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>()))
<a name="l00354"></a>00354          != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end()) {
<a name="l00355"></a>00355         <span class="comment">// not alive? -&gt; do not change routing information</span>
<a name="l00356"></a>00356         <span class="keywordflow">if</span> (isAlive) {
<a name="l00357"></a>00357             <span class="keywordflow">if</span> (!<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a> || authenticated) {
<a name="l00358"></a>00358                 <span class="keywordflow">if</span> (kadHandle.<a class="code" href="classKademliaBucketEntry.html#a9f844940589695ff73900586247e47bb">getRtt</a>() == MAXTIME) {
<a name="l00359"></a>00359                     kadHandle.<a class="code" href="classKademliaBucketEntry.html#a9e29a141071d1dcfb9b6a5ef8151aebd">setRtt</a>(i-&gt;getRtt());
<a name="l00360"></a>00360                 }
<a name="l00361"></a>00361                 <span class="comment">// refresh sibling</span>
<a name="l00362"></a>00362                 (*i) = kadHandle;
<a name="l00363"></a>00363             } <span class="keywordflow">else</span> {
<a name="l00364"></a>00364                 <span class="keywordflow">if</span> (maintenanceLookup) {
<a name="l00365"></a>00365                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00366"></a>00366                 }
<a name="l00367"></a>00367 
<a name="l00368"></a>00368                 <span class="keywordflow">if</span> ((i-&gt;getIp() != kadHandle.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()) ||
<a name="l00369"></a>00369                     (i-&gt;getPort() != kadHandle.<a class="code" href="classTransportAddress.html#a4cf99c434c5110935683624dc3702e0f" title="returns port">getPort</a>())) {
<a name="l00370"></a>00370                     <span class="comment">// sibling could have changed transport address</span>
<a name="l00371"></a>00371                     <span class="comment">// ping new address for authentication</span>
<a name="l00372"></a>00372                     <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(kadHandle);
<a name="l00373"></a>00373                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00374"></a>00374                 }
<a name="l00375"></a>00375             }
<a name="l00376"></a>00376         }
<a name="l00377"></a>00377         <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>: node is sibling);
<a name="l00378"></a>00378         EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00379"></a>00379            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00380"></a>00380            &lt;&lt; <span class="stringliteral">&quot;    ... node is already in the sibling table.&quot;</span> &lt;&lt; endl;
<a name="l00381"></a>00381         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="comment">/* check if node is already in a bucket ---------------------------------*/</span>
<a name="l00385"></a>00385     <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* bucket = <a class="code" href="classKademlia.html#a12ad26290a17accd9645415e7e8cb9d3" title="Returns a Bucket or NULL if the bucket has not yet allocated.">routingBucket</a>(kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>(), <span class="keyword">false</span>);
<a name="l00386"></a>00386     <span class="keywordflow">if</span> (bucket != NULL &amp;&amp; (i = bucket-&gt;<a class="code" href="classBaseKeySortedVector.html#a5f7a2df11ab0a0b3c4c505b5d932c2aa" title="Searches for an OberlayKey in a NodeVector and returns an appropriate iterator.">findIterator</a>(kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() ) )
<a name="l00387"></a>00387             != bucket-&gt;end() ) {
<a name="l00388"></a>00388         <span class="comment">// not alive? -&gt; do not change routing information</span>
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (isAlive) {
<a name="l00390"></a>00390             <span class="keywordflow">if</span> (!<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a> || authenticated) {
<a name="l00391"></a>00391                 <span class="keywordflow">if</span> (kadHandle.<a class="code" href="classKademliaBucketEntry.html#a9f844940589695ff73900586247e47bb">getRtt</a>() == MAXTIME) {
<a name="l00392"></a>00392                     kadHandle.<a class="code" href="classKademliaBucketEntry.html#a9e29a141071d1dcfb9b6a5ef8151aebd">setRtt</a>(i-&gt;getRtt());
<a name="l00393"></a>00393                 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395                 <span class="comment">// R/Kademlia</span>
<a name="l00396"></a>00396                 <span class="keywordflow">if</span> (needsRtt &amp;&amp; (kadHandle.<a class="code" href="classKademliaBucketEntry.html#a9f844940589695ff73900586247e47bb">getRtt</a>() == MAXTIME)) {
<a name="l00397"></a>00397                     <a class="code" href="structProx.html">Prox</a> prox =
<a name="l00398"></a>00398                         <a class="code" href="classBaseRpc.html#ad80237130dc2316d0d76ac6757c50f4f" title="pointer to the neighbor cache">neighborCache</a>-&gt;<a class="code" href="classNeighborCache.html#ab934be8fb503f9629cf6eb83e7d1b576" title="Gets the proximity of a node.">getProx</a>(kadHandle, <a class="code" href="NeighborCache_8h.html#ada3b7deab861ead8c817d583da336ccba751bede7ee708c74811f4bd49ee74cea">NEIGHBORCACHE_DEFAULT</a>, -1,
<a name="l00399"></a>00399                                                <span class="keyword">this</span>, NULL);
<a name="l00400"></a>00400                     <span class="keywordflow">if</span> (prox != <a class="code" href="structProx.html#ae33fb924891e14e0161708bfadf8f033">Prox::PROX_SELF</a> &amp;&amp;
<a name="l00401"></a>00401                         prox != <a class="code" href="structProx.html#aa7ac832a04fe61863222d8631526647b">Prox::PROX_UNKNOWN</a> &amp;&amp;
<a name="l00402"></a>00402                         prox != <a class="code" href="structProx.html#abf2f5f92914e5e617c5ef157ea5ffc86">Prox::PROX_WAITING</a> &amp;&amp;
<a name="l00403"></a>00403                         prox != <a class="code" href="structProx.html#a5ded765f6344797ea0e9c35c85cd61af">Prox::PROX_TIMEOUT</a>) {
<a name="l00404"></a>00404                         kadHandle.<a class="code" href="classProxNodeHandle.html#a2f3e23f427dfbf4c36fef805d7fa8bc2">setProx</a>(prox);
<a name="l00405"></a>00405                         <span class="comment">//routingAdd(handle, true, prox.proximity);//ctrlInfo-&gt;getSrcRoute() //TODO</span>
<a name="l00406"></a>00406                     } <span class="comment">/*else if (prox == Prox::PROX_TIMEOUT) {</span>
<a name="l00407"></a>00407 <span class="comment">                        // remove from bucket</span>
<a name="l00408"></a>00408 <span class="comment">                        bucket-&gt;erase(i);</span>
<a name="l00409"></a>00409 <span class="comment">                        return false;</span>
<a name="l00410"></a>00410 <span class="comment">                    }*/</span> <span class="comment">//TODO inform NC that node is alive</span>
<a name="l00411"></a>00411                     <span class="keywordflow">else</span> {
<a name="l00412"></a>00412                         EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00413"></a>00413                            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00414"></a>00414                            <span class="stringliteral">&quot;    ... node not added, but ping sent.&quot;</span> &lt;&lt; endl;
<a name="l00415"></a>00415                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00416"></a>00416                     }
<a name="l00417"></a>00417                 }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419                 <span class="comment">// remove old handle</span>
<a name="l00420"></a>00420                 bucket-&gt;erase(i);
<a name="l00421"></a>00421                 <span class="comment">// re-add to tail</span>
<a name="l00422"></a>00422                 bucket-&gt;push_back(kadHandle);
<a name="l00423"></a>00423             } <span class="keywordflow">else</span> {
<a name="l00424"></a>00424                 <span class="keywordflow">if</span> (maintenanceLookup) {
<a name="l00425"></a>00425                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00426"></a>00426                 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428                 <span class="keywordflow">if</span> ((i-&gt;getIp() != kadHandle.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()) ||
<a name="l00429"></a>00429                     (i-&gt;getPort() != kadHandle.<a class="code" href="classTransportAddress.html#a4cf99c434c5110935683624dc3702e0f" title="returns port">getPort</a>())) {
<a name="l00430"></a>00430                     <span class="comment">// sibling could have changed transport address</span>
<a name="l00431"></a>00431                     <span class="comment">// ping new address for authentication</span>
<a name="l00432"></a>00432                     <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(kadHandle);
<a name="l00433"></a>00433                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00434"></a>00434                 }
<a name="l00435"></a>00435             }
<a name="l00436"></a>00436         }
<a name="l00437"></a>00437         <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>: node is in bucket);
<a name="l00438"></a>00438         EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00439"></a>00439            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00440"></a>00440            &lt;&lt; <span class="stringliteral">&quot;    ... node is already in bucket &quot;</span>
<a name="l00441"></a>00441            &lt;&lt; <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>()) &lt;&lt; <span class="stringliteral">&quot;.&quot;</span> &lt;&lt; endl;
<a name="l00442"></a>00442         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="comment">/* check if node can be added to the sibling list -----------------------*/</span>
<a name="l00446"></a>00446     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#ad640b8320ebc32c8ef574109273bb44f" title="indicates if an object of type T can be added to the NodeVector">isAddable</a>(kadHandle) ) {
<a name="l00447"></a>00447         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a> &amp;&amp; !authenticated) {
<a name="l00448"></a>00448             <span class="keywordflow">if</span> (!maintenanceLookup || (isAlive &amp;&amp; (rtt == MAXTIME))) {
<a name="l00449"></a>00449                 <span class="comment">// received a FindNodeCall or PingCall from a potential sibling</span>
<a name="l00450"></a>00450                 <span class="comment">// or new nodes from a FindNodeResponse app lookup</span>
<a name="l00451"></a>00451                 <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(kadHandle);
<a name="l00452"></a>00452             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a68e77f3b48652f19219a6c6c9a1a76d2">newMaintenance</a>) {
<a name="l00453"></a>00453                 <span class="comment">// new node from sibling table refresh</span>
<a name="l00454"></a>00454                 <span class="comment">//sendSiblingFindNodeCall(kadHandle);</span>
<a name="l00455"></a>00455                 <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(kadHandle);
<a name="l00456"></a>00456             }
<a name="l00457"></a>00457             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460         <span class="comment">// ping new siblings</span>
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a113faa91ed3ec564f8b61718101695c2">pingNewSiblings</a> &amp;&amp; !isAlive) {
<a name="l00462"></a>00462             <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(kadHandle);
<a name="l00463"></a>00463         }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465         <span class="comment">// R/Kademlia</span>
<a name="l00466"></a>00466         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (needsRtt) {
<a name="l00467"></a>00467             <span class="comment">// old version: pingNode(), now:</span>
<a name="l00468"></a>00468             <a class="code" href="structProx.html">Prox</a> prox =
<a name="l00469"></a>00469                     <a class="code" href="classBaseRpc.html#ad80237130dc2316d0d76ac6757c50f4f" title="pointer to the neighbor cache">neighborCache</a>-&gt;<a class="code" href="classNeighborCache.html#ab934be8fb503f9629cf6eb83e7d1b576" title="Gets the proximity of a node.">getProx</a>(kadHandle, <a class="code" href="NeighborCache_8h.html#ada3b7deab861ead8c817d583da336ccba751bede7ee708c74811f4bd49ee74cea">NEIGHBORCACHE_DEFAULT</a>, -1,
<a name="l00470"></a>00470                                            <span class="keyword">this</span>, NULL);
<a name="l00471"></a>00471             <span class="keywordflow">if</span> (prox != <a class="code" href="structProx.html#ae33fb924891e14e0161708bfadf8f033">Prox::PROX_SELF</a> &amp;&amp;
<a name="l00472"></a>00472                 prox != <a class="code" href="structProx.html#aa7ac832a04fe61863222d8631526647b">Prox::PROX_UNKNOWN</a> &amp;&amp;
<a name="l00473"></a>00473                 prox != <a class="code" href="structProx.html#a5ded765f6344797ea0e9c35c85cd61af">Prox::PROX_TIMEOUT</a>) {
<a name="l00474"></a>00474                 kadHandle.<a class="code" href="classProxNodeHandle.html#a2f3e23f427dfbf4c36fef805d7fa8bc2">setProx</a>(prox);
<a name="l00475"></a>00475             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prox == <a class="code" href="structProx.html#a5ded765f6344797ea0e9c35c85cd61af">Prox::PROX_TIMEOUT</a>) {
<a name="l00476"></a>00476                 <span class="comment">// do not put handle into sibling table</span>
<a name="l00477"></a>00477                 EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00478"></a>00478                    &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00479"></a>00479                    &lt;&lt; <span class="stringliteral">&quot;    ... node not added (node timeout).&quot;</span> &lt;&lt; endl;
<a name="l00480"></a>00480                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00481"></a>00481             }
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484         <span class="keywordtype">bool</span> finished = <span class="keyword">false</span>;
<a name="l00485"></a>00485         <span class="keywordtype">int</span> siblingPos = -1;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487         <span class="comment">// check if sibling list is full so a handle is preemted from the list</span>
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#ad96fd23183bf954e2613af5430ecb48d" title="indicates if NodeVector holds maxSize nodes">isFull</a>()) {
<a name="l00489"></a>00489             <span class="comment">// get handle thats about to be preempted</span>
<a name="l00490"></a>00490             <a class="code" href="classKademliaBucketEntry.html">KademliaBucketEntry</a> oldHandle = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;back();
<a name="l00491"></a>00491             assert(oldHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() != kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l00492"></a>00492 
<a name="l00493"></a>00493             <span class="comment">// add handle to the sibling list</span>
<a name="l00494"></a>00494             siblingPos = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(kadHandle);
<a name="l00495"></a>00495             EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00496"></a>00496                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00497"></a>00497                &lt;&lt; <span class="stringliteral">&quot;    ... node added to sibling table, replacing &quot;</span>
<a name="l00498"></a>00498                &lt;&lt; (<a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>)oldHandle &lt;&lt; endl;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500             <span class="comment">// change, so that the preempted handle is added to a bucket</span>
<a name="l00501"></a>00501             kadHandle = oldHandle;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503             <span class="comment">// call update() for removed sibling</span>
<a name="l00504"></a>00504             <span class="keywordflow">if</span> (!<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a>) {
<a name="l00505"></a>00505                 <a class="code" href="classTopologyVis.html#ae9629882d5f3bb7865f9c9501b23a172" title="Removes an arrow from this node to neighbor.">deleteOverlayNeighborArrow</a>(oldHandle);
<a name="l00506"></a>00506                 <a class="code" href="classBaseOverlay.html#a1422696a8eb138dde850390152ff88c7" title="Informs application about state changes of nodes or newly joined nodes.">callUpdate</a>(oldHandle, <span class="keyword">false</span>);
<a name="l00507"></a>00507             }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509             <span class="comment">// return always true, since the handle has been added</span>
<a name="l00510"></a>00510             result = <span class="keyword">true</span>;
<a name="l00511"></a>00511         } <span class="keywordflow">else</span> {
<a name="l00512"></a>00512             <span class="comment">// simply add the handle and stop</span>
<a name="l00513"></a>00513             siblingPos = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(kadHandle);
<a name="l00514"></a>00514             EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00515"></a>00515                &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00516"></a>00516                &lt;&lt; <span class="stringliteral">&quot;    ... node added to sibling table.&quot;</span> &lt;&lt; endl;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518             <span class="comment">// don&#39;t need to add kadHandle also to regular buckets</span>
<a name="l00519"></a>00519             finished = <span class="keyword">true</span>;
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521         assert(siblingPos &gt; -1);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523         <a class="code" href="classKademlia.html#acd029f455e0c6150c038c69fa493696c" title="updates information shown in GUI">updateTooltip</a>();
<a name="l00524"></a>00524 
<a name="l00525"></a>00525         <span class="comment">// call update() for new sibling</span>
<a name="l00526"></a>00526         <a class="code" href="classTopologyVis.html#a4fe67c060004c8ca76658c7b41514a4a" title="Draws an arrow from this node to neighbor.">showOverlayNeighborArrow</a>(<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;at(siblingPos), <span class="keyword">false</span>,
<a name="l00527"></a>00527                                  <span class="stringliteral">&quot;m=m,50,100,50,100;ls=green,1&quot;</span>);
<a name="l00528"></a>00528         <a class="code" href="classBaseOverlay.html#a1422696a8eb138dde850390152ff88c7" title="Informs application about state changes of nodes or newly joined nodes.">callUpdate</a>(<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;at(siblingPos), <span class="keyword">true</span>);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (finished) {
<a name="l00531"></a>00531             <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>: node is now sibling);
<a name="l00532"></a>00532             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00533"></a>00533         }
<a name="l00534"></a>00534     }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     <span class="comment">/* add node to the appropriate bucket, if not full ---------------------*/</span>
<a name="l00537"></a>00537     bucket = <a class="code" href="classKademlia.html#a12ad26290a17accd9645415e7e8cb9d3" title="Returns a Bucket or NULL if the bucket has not yet allocated.">routingBucket</a>(kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>(), <span class="keyword">true</span>);
<a name="l00538"></a>00538     <span class="keywordflow">if</span> (!bucket-&gt;<a class="code" href="classBaseKeySortedVector.html#ad96fd23183bf954e2613af5430ecb48d" title="indicates if NodeVector holds maxSize nodes">isFull</a>()) {
<a name="l00539"></a>00539         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a> &amp;&amp; !authenticated) {
<a name="l00540"></a>00540             <span class="keywordflow">if</span> ((isAlive &amp;&amp; (rtt == MAXTIME))) {
<a name="l00541"></a>00541                 <span class="comment">// received a FindNodeCall or PingCall from a potential new bucket entry</span>
<a name="l00542"></a>00542                 <span class="comment">// or new nodes from a FindNodeReponse app lookup</span>
<a name="l00543"></a>00543                 <span class="comment">// optimization: don&#39;t send a ping for nodes from FindNodeResponse for app lookups</span>
<a name="l00544"></a>00544                 <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(kadHandle);
<a name="l00545"></a>00545             }
<a name="l00546"></a>00546             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00547"></a>00547         }
<a name="l00548"></a>00548 
<a name="l00549"></a>00549         <span class="comment">//EV &lt;&lt; &quot;[Kademlia::routingAdd()]\n&quot;</span>
<a name="l00550"></a>00550         <span class="comment">//   &lt;&lt; &quot;    Adding new node &quot; &lt;&lt; kadHandle</span>
<a name="l00551"></a>00551         <span class="comment">//   &lt;&lt; &quot; to bucket &quot; &lt;&lt; routingBucketIndex(kadHandle.getKey())</span>
<a name="l00552"></a>00552         <span class="comment">//   &lt;&lt; endl;</span>
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <span class="comment">// PNS</span>
<a name="l00555"></a>00555         <span class="keywordflow">if</span> (needsRtt || <a class="code" href="classKademlia.html#aa1c9d6f7ff020a8a9249f1da3d1fedbe">proximityNeighborSelection</a>) {
<a name="l00556"></a>00556              <span class="comment">//pingNode(handle, -1, 0, NULL, NULL, NULL, -1, UDP_TRANSPORT, false);</span>
<a name="l00557"></a>00557              <a class="code" href="structProx.html">Prox</a> prox =
<a name="l00558"></a>00558                  <a class="code" href="classBaseRpc.html#ad80237130dc2316d0d76ac6757c50f4f" title="pointer to the neighbor cache">neighborCache</a>-&gt;<a class="code" href="classNeighborCache.html#ab934be8fb503f9629cf6eb83e7d1b576" title="Gets the proximity of a node.">getProx</a>(kadHandle, <a class="code" href="NeighborCache_8h.html#ada3b7deab861ead8c817d583da336ccba751bede7ee708c74811f4bd49ee74cea">NEIGHBORCACHE_DEFAULT</a>, -1,
<a name="l00559"></a>00559                                         <span class="keyword">this</span>, NULL);
<a name="l00560"></a>00560              <span class="keywordflow">if</span> (prox != <a class="code" href="structProx.html#ae33fb924891e14e0161708bfadf8f033">Prox::PROX_SELF</a> &amp;&amp;
<a name="l00561"></a>00561                  prox != <a class="code" href="structProx.html#aa7ac832a04fe61863222d8631526647b">Prox::PROX_UNKNOWN</a> &amp;&amp;
<a name="l00562"></a>00562                  prox != <a class="code" href="structProx.html#a5ded765f6344797ea0e9c35c85cd61af">Prox::PROX_TIMEOUT</a>) {
<a name="l00563"></a>00563                  <span class="comment">//routingAdd(handle, true, prox.proximity);//ctrlInfo-&gt;getSrcRoute() //TODO</span>
<a name="l00564"></a>00564                  kadHandle.<a class="code" href="classProxNodeHandle.html#a2f3e23f427dfbf4c36fef805d7fa8bc2">setProx</a>(prox);
<a name="l00565"></a>00565              }
<a name="l00566"></a>00566          }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         bucket-&gt;push_back(kadHandle);
<a name="l00569"></a>00569         result = <span class="keyword">true</span>;
<a name="l00570"></a>00570         EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00571"></a>00571            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00572"></a>00572            &lt;&lt; <span class="stringliteral">&quot;    ... node added to bucket &quot;</span>
<a name="l00573"></a>00573            &lt;&lt; <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>())
<a name="l00574"></a>00574            &lt;&lt; <span class="stringliteral">&quot; which was not yet full.&quot;</span> &lt;&lt; endl;
<a name="l00575"></a>00575     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isAlive) {
<a name="l00576"></a>00576         <span class="comment">//PNS node replacement</span>
<a name="l00577"></a>00577         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#aa1c9d6f7ff020a8a9249f1da3d1fedbe">proximityNeighborSelection</a> &amp;&amp;
<a name="l00578"></a>00578             kadHandle.<a class="code" href="classProxNodeHandle.html#a98f9354f8b28218eee5b30febb485b43">getProx</a>() != <a class="code" href="structProx.html#aa7ac832a04fe61863222d8631526647b">Prox::PROX_UNKNOWN</a>) {
<a name="l00579"></a>00579             <a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> kickHim, it;
<a name="l00580"></a>00580             kickHim = it = bucket-&gt;begin();
<a name="l00581"></a>00581             ++it;
<a name="l00582"></a>00582             <span class="keywordflow">while</span> (it != bucket-&gt;end()) {
<a name="l00583"></a>00583                 <span class="keywordflow">if</span> (it-&gt;getRtt() &gt; kickHim-&gt;getRtt()) {
<a name="l00584"></a>00584                     kickHim = it;
<a name="l00585"></a>00585                 }
<a name="l00586"></a>00586                 ++it;
<a name="l00587"></a>00587             }
<a name="l00588"></a>00588             <span class="keywordflow">if</span> (kickHim-&gt;getRtt() &gt; kadHandle.<a class="code" href="classKademliaBucketEntry.html#a9f844940589695ff73900586247e47bb">getRtt</a>()) {
<a name="l00589"></a>00589                 <a class="code" href="classKademliaBucketEntry.html">KademliaBucketEntry</a> temp = *kickHim;
<a name="l00590"></a>00590                 bucket-&gt;erase(kickHim);
<a name="l00591"></a>00591                 bucket-&gt;push_back(kadHandle);
<a name="l00592"></a>00592                 kadHandle = temp;
<a name="l00593"></a>00593                 EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::routingAdd()] @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00594"></a>00594                    &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00595"></a>00595                    &lt;&lt; <span class="stringliteral">&quot;    ... added to bucket &quot;</span>
<a name="l00596"></a>00596                    &lt;&lt; <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(kadHandle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>())
<a name="l00597"></a>00597                    &lt;&lt; <span class="stringliteral">&quot; (PNS: replacing another node).&quot;</span> &lt;&lt; endl;
<a name="l00598"></a>00598             }
<a name="l00599"></a>00599         }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a151fd59bc6de940e684fbad408083ac4">enableReplacementCache</a> &amp;&amp; (!<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a> || authenticated)) {
<a name="l00602"></a>00602             bucket-&gt;<a class="code" href="classKademliaBucket.html#a6b0dc39d58d9d8ba705d37c89529c16a">replacementCache</a>.push_front(kadHandle);
<a name="l00603"></a>00603             <span class="keywordflow">if</span> (bucket-&gt;<a class="code" href="classKademliaBucket.html#a6b0dc39d58d9d8ba705d37c89529c16a">replacementCache</a>.size() &gt; <a class="code" href="classKademlia.html#a8ebc8abde092aad89dfa813ba640e6ef">replacementCandidates</a>) {
<a name="l00604"></a>00604                 bucket-&gt;<a class="code" href="classKademliaBucket.html#a6b0dc39d58d9d8ba705d37c89529c16a">replacementCache</a>.pop_back();
<a name="l00605"></a>00605             }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607             <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#adc22fe7536c4bea9677ed901b95820a8">replacementCachePing</a>) {
<a name="l00608"></a>00608                 <a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> it = bucket-&gt;begin();
<a name="l00609"></a>00609                 <span class="keywordflow">while</span> (it != bucket-&gt;end() &amp;&amp; (it-&gt;getPingSent() == <span class="keyword">true</span>)) {
<a name="l00610"></a>00610                     it++;
<a name="l00611"></a>00611                 }
<a name="l00612"></a>00612                 <span class="keywordflow">if</span> (it != bucket-&gt;end()) {
<a name="l00613"></a>00613                     <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(*it);
<a name="l00614"></a>00614                     it-&gt;setPingSent(<span class="keyword">true</span>);
<a name="l00615"></a>00615                 }
<a name="l00616"></a>00616             }
<a name="l00617"></a>00617         }
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="comment">// PNS</span>
<a name="l00621"></a>00621     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#aa1c9d6f7ff020a8a9249f1da3d1fedbe">proximityNeighborSelection</a>) {
<a name="l00622"></a>00622         <a class="code" href="classBaseRpc.html#ad80237130dc2316d0d76ac6757c50f4f" title="pointer to the neighbor cache">neighborCache</a>-&gt;<a class="code" href="classNeighborCache.html#ab934be8fb503f9629cf6eb83e7d1b576" title="Gets the proximity of a node.">getProx</a>(kadHandle, <a class="code" href="NeighborCache_8h.html#ada3b7deab861ead8c817d583da336ccba46557811e0915cca5028188f13edf357">NEIGHBORCACHE_QUERY</a>, -1, <span class="keyword">this</span>, NULL);
<a name="l00623"></a>00623         <span class="comment">//pingNode(kadHandle);</span>
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626     <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>: end);
<a name="l00627"></a>00627     <span class="keywordflow">return</span> result;
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00630"></a><a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b">00630</a> <span class="keywordtype">bool</span> <a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">Kademlia::routingTimeout</a>(<span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key, <span class="keywordtype">bool</span> immediately)
<a name="l00631"></a>00631 {
<a name="l00632"></a>00632     <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>: start);
<a name="l00633"></a>00633     <span class="comment">// key unspecified? yes -&gt; ignore</span>
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (key.<a class="code" href="classOverlayKey.html#abe357a4d1babcf7d30598a61cbc0f5c2" title="Returns true, if the key is unspecified.">isUnspecified</a>())
<a name="l00635"></a>00635         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="comment">// bucket index</span>
<a name="l00638"></a>00638     <a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <span class="comment">/* check if the node is one of the siblings -----------------------------*/</span>
<a name="l00641"></a>00641     <span class="keywordflow">if</span> ((i = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#a5f7a2df11ab0a0b3c4c505b5d932c2aa" title="Searches for an OberlayKey in a NodeVector and returns an appropriate iterator.">findIterator</a>(key)) != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end()) {
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         i-&gt;incStaleCount();
<a name="l00644"></a>00644         i-&gt;setPingSent(<span class="keyword">false</span>);
<a name="l00645"></a>00645 
<a name="l00646"></a>00646         <span class="keywordflow">if</span> (i-&gt;getStaleCount() &gt; <a class="code" href="classKademlia.html#a742e20c8d232a8623f4a85c2f0cad1e4">maxStaleCount</a> || immediately) {
<a name="l00647"></a>00647             <span class="comment">// remove from sibling table</span>
<a name="l00648"></a>00648             <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> oldSibling = *i;
<a name="l00649"></a>00649             <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;erase(i);
<a name="l00650"></a>00650 
<a name="l00651"></a>00651             <span class="comment">// lost last sibling?</span>
<a name="l00652"></a>00652             <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size() == 0) {
<a name="l00653"></a>00653                 <a class="code" href="classBaseOverlay.html#acb8855faa86247ae37ab894891d9f4dd" title="Join the overlay with a given nodeID.">join</a>();
<a name="l00654"></a>00654                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00655"></a>00655             }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657             <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>: is sibling);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659             <span class="comment">// try to refill with new closest contact</span>
<a name="l00660"></a>00660             <a class="code" href="classKademlia.html#a0cf73bc94792b9be525f73fa3a4551da">refillSiblingTable</a>();
<a name="l00661"></a>00661 
<a name="l00662"></a>00662             <span class="comment">// call update() for removed sibling</span>
<a name="l00663"></a>00663             <a class="code" href="classTopologyVis.html#ae9629882d5f3bb7865f9c9501b23a172" title="Removes an arrow from this node to neighbor.">deleteOverlayNeighborArrow</a>(oldSibling);
<a name="l00664"></a>00664             <a class="code" href="classBaseOverlay.html#a1422696a8eb138dde850390152ff88c7" title="Informs application about state changes of nodes or newly joined nodes.">callUpdate</a>(oldSibling, <span class="keyword">false</span>);
<a name="l00665"></a>00665 
<a name="l00666"></a>00666             <a class="code" href="classKademlia.html#acd029f455e0c6150c038c69fa493696c" title="updates information shown in GUI">updateTooltip</a>();
<a name="l00667"></a>00667 
<a name="l00668"></a>00668             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00669"></a>00669         }
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="comment">/* check if node is already in a bucket ---------------------------------*/</span>
<a name="l00673"></a>00673     <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* bucket = <a class="code" href="classKademlia.html#a12ad26290a17accd9645415e7e8cb9d3" title="Returns a Bucket or NULL if the bucket has not yet allocated.">routingBucket</a>(key, <span class="keyword">false</span>);
<a name="l00674"></a>00674     <span class="keywordflow">if</span> (bucket != NULL &amp;&amp; (i = bucket-&gt;<a class="code" href="classBaseKeySortedVector.html#a5f7a2df11ab0a0b3c4c505b5d932c2aa" title="Searches for an OberlayKey in a NodeVector and returns an appropriate iterator.">findIterator</a>(key) ) != bucket-&gt;end() ) {
<a name="l00675"></a>00675 
<a name="l00676"></a>00676         i-&gt;incStaleCount();
<a name="l00677"></a>00677         i-&gt;setPingSent(<span class="keyword">false</span>);
<a name="l00678"></a>00678 
<a name="l00679"></a>00679         <span class="keywordflow">if</span> (i-&gt;getStaleCount() &gt; <a class="code" href="classKademlia.html#a742e20c8d232a8623f4a85c2f0cad1e4">maxStaleCount</a> || immediately) {
<a name="l00680"></a>00680             <span class="comment">// remove from routing table</span>
<a name="l00681"></a>00681             bucket-&gt;erase(i);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683             <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a151fd59bc6de940e684fbad408083ac4">enableReplacementCache</a>) {
<a name="l00684"></a>00684                 <span class="keywordflow">if</span> (bucket-&gt;<a class="code" href="classKademliaBucket.html#a6b0dc39d58d9d8ba705d37c89529c16a">replacementCache</a>.size()) {
<a name="l00685"></a>00685                     <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(bucket-&gt;<a class="code" href="classKademliaBucket.html#a6b0dc39d58d9d8ba705d37c89529c16a">replacementCache</a>.front(), <span class="keyword">true</span>,
<a name="l00686"></a>00686                                bucket-&gt;<a class="code" href="classKademliaBucket.html#a6b0dc39d58d9d8ba705d37c89529c16a">replacementCache</a>.front().getRtt());
<a name="l00687"></a>00687                     bucket-&gt;<a class="code" href="classKademliaBucket.html#a6b0dc39d58d9d8ba705d37c89529c16a">replacementCache</a>.pop_front();
<a name="l00688"></a>00688                     <a class="code" href="classKademlia.html#aa1eda90d9ae7c58ff916a9d493d7c1e6">nodesReplaced</a>++;
<a name="l00689"></a>00689                 }
<a name="l00690"></a>00690             }
<a name="l00691"></a>00691         }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693         <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>: is in bucket);
<a name="l00694"></a>00694         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696     <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>: end);
<a name="l00697"></a>00697     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00700"></a><a class="code" href="classKademlia.html#a0cf73bc94792b9be525f73fa3a4551da">00700</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a0cf73bc94792b9be525f73fa3a4551da">Kademlia::refillSiblingTable</a>()
<a name="l00701"></a>00701 {
<a name="l00702"></a>00702     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size() == 0 ||
<a name="l00703"></a>00703         <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#ad96fd23183bf954e2613af5430ecb48d" title="indicates if NodeVector holds maxSize nodes">isFull</a>())
<a name="l00704"></a>00704         <span class="keywordflow">return</span>;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706     <span class="keywordtype">int</span> index = <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;back().getKey()) - 1;
<a name="l00707"></a>00707     assert(index &gt; 0);
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     <span class="keywordflow">while</span> ((<a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index] == NULL ||
<a name="l00710"></a>00710             <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index]-&gt;empty()) &amp;&amp;
<a name="l00711"></a>00711             index &lt; (<span class="keywordtype">int</span>)(<a class="code" href="classOverlayKey.html#af855a4dfc0e5dc0d2afc6b87fa1d7426" title="Returns the length in number of bits.">OverlayKey::getLength</a>() - 1)) {
<a name="l00712"></a>00712         index++;
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (index &lt; (<span class="keywordtype">int</span>)<a class="code" href="classOverlayKey.html#af855a4dfc0e5dc0d2afc6b87fa1d7426" title="Returns the length in number of bits.">OverlayKey::getLength</a>() &amp;&amp;
<a name="l00715"></a>00715             <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index] != NULL &amp;&amp; <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index]-&gt;size()) {
<a name="l00716"></a>00716 
<a name="l00717"></a>00717         <a class="code" href="classKademliaBucket.html">KademliaBucket</a> sortedBucket(<a class="code" href="classKademlia.html#acc2f4767a1687764f2d732872511a7ad">k</a>, <a class="code" href="classKademlia.html#a2121cb9b6da909626b69a2253923ae11">comparator</a>);
<a name="l00718"></a>00718         <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index]-&gt;size(); ++i) {
<a name="l00719"></a>00719             sortedBucket.<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(<a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index]-&gt;at(i));
<a name="l00720"></a>00720         }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722         <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(sortedBucket.front());
<a name="l00723"></a>00723 
<a name="l00724"></a>00724         <span class="comment">// call update() for new sibling</span>
<a name="l00725"></a>00725         <span class="keywordflow">if</span> (!<a class="code" href="classKademlia.html#a1f28727c1a562f3e40cd315dd22dd8cd" title="if true, ping not authenticated nodes before adding them to a bucket">secureMaintenance</a>) {
<a name="l00726"></a>00726             <a class="code" href="classTopologyVis.html#a4fe67c060004c8ca76658c7b41514a4a" title="Draws an arrow from this node to neighbor.">showOverlayNeighborArrow</a>(sortedBucket.front(), <span class="keyword">false</span>,
<a name="l00727"></a>00727                                      <span class="stringliteral">&quot;m=m,50,100,50,100;ls=green,1&quot;</span>);
<a name="l00728"></a>00728             <a class="code" href="classBaseOverlay.html#a1422696a8eb138dde850390152ff88c7" title="Informs application about state changes of nodes or newly joined nodes.">callUpdate</a>(sortedBucket.front(), <span class="keyword">true</span>);
<a name="l00729"></a>00729         }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731         <span class="comment">// remove node from bucket</span>
<a name="l00732"></a>00732         <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index]-&gt;erase(<a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index]-&gt;
<a name="l00733"></a>00733               findIterator(sortedBucket.front().getKey()));
<a name="l00734"></a>00734         assert(<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#ad96fd23183bf954e2613af5430ecb48d" title="indicates if NodeVector holds maxSize nodes">isFull</a>());
<a name="l00735"></a>00735         <a class="code" href="Kademlia_8cc.html#aac1dc1d1f35365a3858fb0480153a467">BUCKET_CONSISTENCY</a>(<a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>: end <a class="code" href="classKademlia.html#a0cf73bc94792b9be525f73fa3a4551da">refillSiblingTable</a>());
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="classKademlia.html#a7581a168ae2e143001a7a93ff4a1779a">00739</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a7581a168ae2e143001a7a93ff4a1779a">Kademlia::setBucketUsage</a>(<span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key)
<a name="l00740"></a>00740 {
<a name="l00741"></a>00741     <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* bucket = <a class="code" href="classKademlia.html#a12ad26290a17accd9645415e7e8cb9d3" title="Returns a Bucket or NULL if the bucket has not yet allocated.">routingBucket</a>(key, <span class="keyword">true</span>);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743     <span class="keywordflow">if</span> (bucket) {
<a name="l00744"></a>00744         bucket-&gt;<a class="code" href="classKademliaBucket.html#a8b5481352d9ad3354647e5cae8c6e5fa">setLastUsage</a>(simTime());
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <span class="keywordflow">if</span> ((<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size() &lt; (uint32_t)<a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">getMaxNumSiblings</a>())
<a name="l00748"></a>00748         || ((<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;at(<a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">getMaxNumSiblings</a>() - 1).getKey() ^ <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>())
<a name="l00749"></a>00749                 &gt;= (key ^ <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>()))) {
<a name="l00750"></a>00750         <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classKademliaBucket.html#a8b5481352d9ad3354647e5cae8c6e5fa">setLastUsage</a>(simTime());
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
<a name="l00755"></a><a class="code" href="classKademlia.html#ada80a26aba760ec53ce539d8180cf865">00755</a> <span class="keywordtype">bool</span> <a class="code" href="classKademlia.html#ada80a26aba760ec53ce539d8180cf865" title="Query if a node is among the siblings for a given key.">Kademlia::isSiblingFor</a>(<span class="keyword">const</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp; node, <span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key,
<a name="l00756"></a>00756                             <span class="keywordtype">int</span> numSiblings, <span class="keywordtype">bool</span>* err)
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758     <span class="keywordflow">if</span> (key.<a class="code" href="classOverlayKey.html#abe357a4d1babcf7d30598a61cbc0f5c2" title="Returns true, if the key is unspecified.">isUnspecified</a>())
<a name="l00759"></a>00759         <a class="code" href="yang_8cc.html#adb989392f8aada21b0f7ec2f7a41dc00">error</a>(<span class="stringliteral">&quot;Kademlia::isSiblingFor(): key is unspecified!&quot;</span>);
<a name="l00760"></a>00760 
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> != <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>) {
<a name="l00762"></a>00762         EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::isSiblingFor()] @ &quot;</span>
<a name="l00763"></a>00763            &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00764"></a>00764            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00765"></a>00765            &lt;&lt; <span class="stringliteral">&quot;    state != READY&quot;</span>
<a name="l00766"></a>00766            &lt;&lt; endl;
<a name="l00767"></a>00767         *err = <span class="keyword">true</span>;
<a name="l00768"></a>00768         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     <span class="keywordflow">if</span> (numSiblings &gt; <a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">getMaxNumSiblings</a>()) {
<a name="l00772"></a>00772         opp_error(<span class="stringliteral">&quot;Kademlia::isSiblingFor(): numSiblings too big!&quot;</span>);
<a name="l00773"></a>00773     }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="comment">// set default number of siblings to consider</span>
<a name="l00776"></a>00776     <span class="keywordflow">if</span> (numSiblings == -1) {
<a name="l00777"></a>00777         numSiblings = <a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">getMaxNumSiblings</a>();
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     <span class="keywordflow">if</span> (numSiblings == 0) {
<a name="l00781"></a>00781         *err = <span class="keyword">false</span>;
<a name="l00782"></a>00782         <span class="keywordflow">return</span> (node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() == key);
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size() &lt; (uint)numSiblings) {
<a name="l00786"></a>00786         *err = <span class="keyword">false</span>;
<a name="l00787"></a>00787         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00788"></a>00788     }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#ad96fd23183bf954e2613af5430ecb48d" title="indicates if NodeVector holds maxSize nodes">isFull</a>() &amp;&amp;
<a name="l00791"></a>00791         ((<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() ^ key) &gt;
<a name="l00792"></a>00792          (<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() ^ <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;back().getKey()))) {
<a name="l00793"></a>00793         EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia::isSiblingFor()] @ &quot;</span>
<a name="l00794"></a>00794            &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l00795"></a>00795            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l00796"></a>00796            &lt;&lt; <span class="stringliteral">&quot;    Not sure if I am sibling for &quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; !\n&quot;</span>
<a name="l00797"></a>00797            &lt;&lt; <span class="stringliteral">&quot;    (&quot;</span> &lt;&lt; key &lt;&lt; <span class="stringliteral">&quot; is not closer to me than &quot;</span>
<a name="l00798"></a>00798            &lt;&lt; <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;back().getKey() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span>
<a name="l00799"></a>00799            &lt;&lt; endl;
<a name="l00800"></a>00800         *err = <span class="keyword">true</span>;
<a name="l00801"></a>00801         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00802"></a>00802     }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <a class="code" href="classKeyDistanceComparator.html">KeyDistanceComparator&lt;KeyXorMetric&gt;</a>* comp =
<a name="l00805"></a>00805         <span class="keyword">new</span> <a class="code" href="classKeyDistanceComparator.html">KeyDistanceComparator&lt;KeyXorMetric&gt;</a>(key);
<a name="l00806"></a>00806 
<a name="l00807"></a>00807     <span class="comment">// create result vector</span>
<a name="l00808"></a>00808     <a class="code" href="classBaseKeySortedVector.html">NodeVector</a>* result = <span class="keyword">new</span> <a class="code" href="NodeVector_8h.html#a442f90b66b22aa9fca51f83c5ce1b02b">NodeVector</a>(numSiblings, comp);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810     <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i=<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;begin();
<a name="l00811"></a>00811          i != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end(); i++) {
<a name="l00812"></a>00812         result-&gt;add( *i);
<a name="l00813"></a>00813     }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815     <span class="comment">// add local node</span>
<a name="l00816"></a>00816     result-&gt;add(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     *err = <span class="keyword">false</span>;
<a name="l00819"></a>00819     <span class="keyword">delete</span> comp;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     <span class="keywordflow">if</span> (result-&gt;contains(node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>())) {
<a name="l00822"></a>00822         <span class="keyword">delete</span> result;
<a name="l00823"></a>00823         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00824"></a>00824     } <span class="keywordflow">else</span> {
<a name="l00825"></a>00825         <span class="keyword">delete</span> result;
<a name="l00826"></a>00826         assert(!(numSiblings == 1 &amp;&amp; key == node.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>()));
<a name="l00827"></a>00827         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00828"></a>00828     }
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a><a class="code" href="classKademlia.html#ae21a58f63a448c1b41edd84c2e5a0cb0">00831</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#ae21a58f63a448c1b41edd84c2e5a0cb0" title="This method gets call **.gracefulLeaveDelay seconds before it is killed if this node is among the gra...">Kademlia::handleNodeGracefulLeaveNotification</a>()
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833     <span class="comment">// send failed node call to all siblings</span>
<a name="l00834"></a>00834     <a class="code" href="classFailedNodeCall.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">FailedNodeCall</a>* call = <span class="keyword">new</span> <a class="code" href="classFailedNodeCall.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">FailedNodeCall</a>();
<a name="l00835"></a>00835     call-&gt;<a class="code" href="classFailedNodeCall.html#a3aa565698093b08c3919263e197c97d4">setFailedNode</a>(<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>());
<a name="l00836"></a>00836     call-&gt;setBitLength(<a class="code" href="CommonMessages__m_8h.html#a2f5fa84bc72cc769fe63a311220673cc">FAILEDNODECALL_L</a>(call));
<a name="l00837"></a>00837     <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;begin();
<a name="l00838"></a>00838          i != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end(); i++) {
<a name="l00839"></a>00839         <a class="code" href="classBaseOverlay.html#a189d4d1410399ecd264b5bfe6fc85e0f">countFailedNodeCall</a>(call);
<a name="l00840"></a>00840         <a class="code" href="classBaseRpc.html#ac128e0ff0d09f81b652f7d3e00ce9441" title="Sends a Remote-Procedure-Call message to the underlay ">sendUdpRpcCall</a>(*i, call-&gt;<a class="code" href="classFailedNodeCall.html#aef0520606683586be77adef44fd4629d">dup</a>());
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843     <span class="keyword">delete</span> call;
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00846"></a><a class="code" href="classKademlia.html#aebd62488323d6cebf7812974114ed38b">00846</a> <span class="keywordtype">bool</span> <a class="code" href="classKademlia.html#aebd62488323d6cebf7812974114ed38b" title="Handles a failed node.">Kademlia::handleFailedNode</a>(<span class="keyword">const</span> <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a>&amp; failed)
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848     assert(!failed.<a class="code" href="classTransportAddress.html#a026e777c423ff2a0280edd2fa5472e74" title="indicates if TransportAddress is specified">isUnspecified</a>());
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i;
<a name="l00851"></a>00851     <span class="comment">// check sibling table</span>
<a name="l00852"></a>00852     <span class="keywordflow">for</span> (i = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;begin(); i != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end(); ++i) {
<a name="l00853"></a>00853         <span class="keywordflow">if</span> (failed == *i) <span class="keywordflow">break</span>;
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856     <span class="keywordflow">if</span> (i != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end()) {
<a name="l00857"></a>00857         <span class="comment">// remove from sibling table</span>
<a name="l00858"></a>00858         <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> oldSibling = *i;
<a name="l00859"></a>00859         <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;erase(i);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861         <span class="comment">// call update() for removed sibling</span>
<a name="l00862"></a>00862         <a class="code" href="classTopologyVis.html#ae9629882d5f3bb7865f9c9501b23a172" title="Removes an arrow from this node to neighbor.">deleteOverlayNeighborArrow</a>(oldSibling);
<a name="l00863"></a>00863         <a class="code" href="classBaseOverlay.html#a1422696a8eb138dde850390152ff88c7" title="Informs application about state changes of nodes or newly joined nodes.">callUpdate</a>(oldSibling, <span class="keyword">false</span>);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865         <a class="code" href="classKademlia.html#acd029f455e0c6150c038c69fa493696c" title="updates information shown in GUI">updateTooltip</a>();
<a name="l00866"></a>00866 
<a name="l00867"></a>00867         <span class="comment">// try to refill with new closest contact</span>
<a name="l00868"></a>00868         <a class="code" href="classKademlia.html#a0cf73bc94792b9be525f73fa3a4551da">refillSiblingTable</a>();
<a name="l00869"></a>00869     } <span class="keywordflow">else</span> {
<a name="l00870"></a>00870         <span class="comment">// check buckets</span>
<a name="l00871"></a>00871         uint32_t m;
<a name="l00872"></a>00872         <span class="keywordflow">for</span> (m = 0; m &lt; <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>.size(); ++m) {
<a name="l00873"></a>00873             <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[m] != NULL) {
<a name="l00874"></a>00874                 <span class="keywordflow">for</span> (i = <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[m]-&gt;begin(); i != <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[m]-&gt;end();
<a name="l00875"></a>00875                      ++i) {
<a name="l00876"></a>00876                     <span class="keywordflow">if</span> (failed == *i) {
<a name="l00877"></a>00877                         <span class="comment">// remove from routing table</span>
<a name="l00878"></a>00878                         <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[m]-&gt;erase(i);
<a name="l00879"></a>00879                         <span class="keywordflow">return</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size() != 0);
<a name="l00880"></a>00880                     }
<a name="l00881"></a>00881                 }
<a name="l00882"></a>00882             }
<a name="l00883"></a>00883         }
<a name="l00884"></a>00884     }
<a name="l00885"></a>00885     <span class="keywordflow">return</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size() != 0);
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="comment">// R/Kademlia</span>
<a name="l00889"></a><a class="code" href="classKademlia.html#a2d0f3eebfa308ff4c88831d917efa8fd">00889</a> <span class="keywordtype">bool</span> <a class="code" href="classKademlia.html#a2d0f3eebfa308ff4c88831d917efa8fd" title="Hook for forwarded message in recursive lookup mode.">Kademlia::recursiveRoutingHook</a>(<span class="keyword">const</span> <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a>&amp; dest,
<a name="l00890"></a>00890                                     <a class="code" href="classBaseRouteMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseRouteMessage</a>* msg)
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892     <span class="keywordflow">if</span> (msg-&gt;<a class="code" href="classBaseRouteMessage.html#af9787d89915f01a2055e920148015e17">getSrcNode</a>() != <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>) {
<a name="l00893"></a>00893         <span class="keywordflow">if</span> (!msg-&gt;<a class="code" href="classBaseRouteMessage.html#ad983641a05758bc9d25070f1659b2f34">getDestKey</a>().<a class="code" href="classOverlayKey.html#abe357a4d1babcf7d30598a61cbc0f5c2" title="Returns true, if the key is unspecified.">isUnspecified</a>()) {
<a name="l00894"></a>00894             <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(msg-&gt;<a class="code" href="classBaseRouteMessage.html#af9787d89915f01a2055e920148015e17">getSrcNode</a>(), <span class="keyword">true</span>);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896             <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a53857e5e13f67a12e810db01a18400dc">altRecMode</a> &amp;&amp; dest != <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898             <a class="code" href="classBaseKeySortedVector.html">NodeVector</a>* nextHops = <a class="code" href="classKademlia.html#aafad68d123da52e5fefb719699ed2dc3" title="Implements the find node call.">findNode</a>(msg-&gt;<a class="code" href="classBaseRouteMessage.html#ad983641a05758bc9d25070f1659b2f34">getDestKey</a>(), <span class="comment">/*recursiveLookupConfig.redundantNodes*/</span> <a class="code" href="classKademlia.html#acc2f4767a1687764f2d732872511a7ad">k</a>, <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a>, msg);
<a name="l00899"></a>00899             <a class="code" href="classKademliaRoutingInfoMessage.html" title="Class generated from overlay/kademlia/KademliaMessage.msg by opp_msgc.">KademliaRoutingInfoMessage</a>* kadRoutingInfoMsg =
<a name="l00900"></a>00900                 <span class="keyword">new</span> <a class="code" href="classKademliaRoutingInfoMessage.html" title="Class generated from overlay/kademlia/KademliaMessage.msg by opp_msgc.">KademliaRoutingInfoMessage</a>();
<a name="l00901"></a>00901 
<a name="l00902"></a>00902             kadRoutingInfoMsg-&gt;setSrcNode(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>);
<a name="l00903"></a>00903             kadRoutingInfoMsg-&gt;setDestKey(msg-&gt;<a class="code" href="classBaseRouteMessage.html#ad983641a05758bc9d25070f1659b2f34">getDestKey</a>());
<a name="l00904"></a>00904             kadRoutingInfoMsg-&gt;setNextHopsArraySize(nextHops-&gt;size());
<a name="l00905"></a>00905             kadRoutingInfoMsg-&gt;setName(<span class="stringliteral">&quot;KadRoutingInfoMsg&quot;</span>);
<a name="l00906"></a>00906             <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; nextHops-&gt;size(); i++) {
<a name="l00907"></a>00907                 kadRoutingInfoMsg-&gt;setNextHops(i, (*nextHops)[i]);
<a name="l00908"></a>00908                 <span class="keywordflow">if</span> (<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a> == kadRoutingInfoMsg-&gt;getNextHops(i)) {
<a name="l00909"></a>00909                     kadRoutingInfoMsg-&gt;getNextHops(i).setIsAlive(<span class="keyword">true</span>);
<a name="l00910"></a>00910                 }
<a name="l00911"></a>00911             }
<a name="l00912"></a>00912             kadRoutingInfoMsg-&gt;setBitLength(<a class="code" href="KademliaMessage__m_8h.html#ae7646d8e6e9aab79d12e8d5b9aff15ee">KADEMLIAROUTINGINFO_L</a>(kadRoutingInfoMsg));
<a name="l00913"></a>00913 
<a name="l00914"></a>00914             <span class="keyword">delete</span> nextHops;
<a name="l00915"></a>00915 
<a name="l00916"></a>00916             <span class="keywordflow">if</span> (!<a class="code" href="classKademlia.html#a53857e5e13f67a12e810db01a18400dc">altRecMode</a>) {
<a name="l00917"></a>00917                 <a class="code" href="classBaseOverlay.html#a10189697bd95f3de66c27c1ecf07e323" title="Sends message to underlay.">sendMessageToUDP</a>(msg-&gt;<a class="code" href="classBaseRouteMessage.html#af9787d89915f01a2055e920148015e17">getSrcNode</a>(), kadRoutingInfoMsg, 0.000001);
<a name="l00918"></a>00918             } <span class="keywordflow">else</span> {
<a name="l00919"></a>00919                 <span class="comment">// alternative maintenance mode</span>
<a name="l00920"></a>00920                 std::vector&lt;TransportAddress&gt; sourceRoute;
<a name="l00921"></a>00921                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = msg-&gt;<a class="code" href="classBaseRouteMessage.html#a4d937e983eb4887400e41749b55ebecb">getVisitedHopsArraySize</a>() - 1<span class="comment">/*2*/</span>; i &gt;= 0; i--) {
<a name="l00922"></a>00922                     <span class="comment">//TODO remove loops</span>
<a name="l00923"></a>00923                     sourceRoute.push_back(msg-&gt;<a class="code" href="classBaseRouteMessage.html#a5e4624df761b01f0df433ef0ace1c597">getVisitedHops</a>(i));
<a name="l00924"></a>00924                 }
<a name="l00925"></a>00925                 <span class="comment">//sourceRoute.push_back(msg-&gt;getSrcNode());</span>
<a name="l00926"></a>00926                 <a class="code" href="classBaseOverlay.html#a6f2c598f5d3989a63a8cc7220f1aaf76" title="Sends a message to an overlay node, with the generic routing algorithm.">sendToKey</a>(<a class="code" href="classOverlayKey.html#ac0d4135dff2985e3582fdbed2a37eb75" title="OverlayKey without defined key.">OverlayKey::UNSPECIFIED_KEY</a>, kadRoutingInfoMsg, 0,
<a name="l00927"></a>00927                           sourceRoute, <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551aec961f27dcdb3050f97033fbd88b89b3">NO_OVERLAY_ROUTING</a>);
<a name="l00928"></a>00928             }
<a name="l00929"></a>00929             <span class="comment">//TODO should be sent after baseroutemsg</span>
<a name="l00930"></a>00930         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a53857e5e13f67a12e810db01a18400dc">altRecMode</a> &amp;&amp;
<a name="l00931"></a>00931                    dynamic_cast&lt;KademliaRoutingInfoMessage*&gt;(msg-&gt;
<a name="l00932"></a>00932                            <a class="code" href="OverSimMessage__m_8h.html#a43f96a0a4abd079ab2402d8e74ad414f">getEncapsulatedPacket</a>())) {
<a name="l00933"></a>00933             <span class="comment">// alternative mode: infoMsg on its way back</span>
<a name="l00934"></a>00934             <a class="code" href="classKademliaRoutingInfoMessage.html" title="Class generated from overlay/kademlia/KademliaMessage.msg by opp_msgc.">KademliaRoutingInfoMessage</a>* infoMsg =
<a name="l00935"></a>00935                 <span class="keyword">static_cast&lt;</span><a class="code" href="classKademliaRoutingInfoMessage.html" title="Class generated from overlay/kademlia/KademliaMessage.msg by opp_msgc.">KademliaRoutingInfoMessage</a>*<span class="keyword">&gt;</span>(msg-&gt;decapsulate());
<a name="l00936"></a>00936             <a class="code" href="classBaseKeySortedVector.html">NodeVector</a>* nextHops = <a class="code" href="classKademlia.html#aafad68d123da52e5fefb719699ed2dc3" title="Implements the find node call.">findNode</a>(infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#aec43d7ac961b5007e034e4d37f5ab23e">getDestKey</a>(), <a class="code" href="classKademlia.html#acc2f4767a1687764f2d732872511a7ad">k</a>, <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a>, msg);
<a name="l00937"></a>00937 
<a name="l00938"></a>00938             <span class="comment">// merge vectors</span>
<a name="l00939"></a>00939             <a class="code" href="classKeyDistanceComparator.html">KeyDistanceComparator&lt;KeyXorMetric&gt;</a> comp(infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#aec43d7ac961b5007e034e4d37f5ab23e">getDestKey</a>());
<a name="l00940"></a>00940             <a class="code" href="classBaseKeySortedVector.html" title="A STL-vector that supports inserts sorted by an OverlayKey found somewhere in the type...">MarkedNodeVector</a> temp(UINT16_MAX, &amp;comp);
<a name="l00941"></a>00941 
<a name="l00942"></a>00942             <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; nextHops-&gt;size(); i++) {
<a name="l00943"></a>00943                 temp.push_back((*nextHops)[i]);
<a name="l00944"></a>00944             }
<a name="l00945"></a>00945             <span class="keyword">delete</span> nextHops;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947             <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#afc9c8f14e031dafada5cdad66e856f5d">getNextHopsArraySize</a>(); i++) {
<a name="l00948"></a>00948                 <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#a5f6910bf47ee3bbafb38db67c3a712f2">getNextHops</a>(i),
<a name="l00949"></a>00949                            infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#a5f6910bf47ee3bbafb38db67c3a712f2">getNextHops</a>(i).<a class="code" href="classMarkedNodeHandle.html#ae98d974c4b3edc4c3e37a2a5546d25d2">getIsAlive</a>());
<a name="l00950"></a>00950                 temp.add(infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#a5f6910bf47ee3bbafb38db67c3a712f2">getNextHops</a>(i));
<a name="l00951"></a>00951             }
<a name="l00952"></a>00952 
<a name="l00953"></a>00953             infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#a50d02e3579322c7ed1aae9a8d1e27d6f">setNextHopsArraySize</a>(temp.size());
<a name="l00954"></a>00954             <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; temp.size(); ++i) {
<a name="l00955"></a>00955                 infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#a710682e457400a471e846ca06e45a56a">setNextHops</a>(i, temp[i]);
<a name="l00956"></a>00956                 <span class="keywordflow">if</span> (<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a> == infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#a5f6910bf47ee3bbafb38db67c3a712f2">getNextHops</a>(i)) {
<a name="l00957"></a>00957                     infoMsg-&gt;<a class="code" href="classKademliaRoutingInfoMessage.html#a5f6910bf47ee3bbafb38db67c3a712f2">getNextHops</a>(i).<a class="code" href="classMarkedNodeHandle.html#a873307d5a571c71924b6e348a9ec994b">setIsAlive</a>(<span class="keyword">true</span>);
<a name="l00958"></a>00958                 }
<a name="l00959"></a>00959             }
<a name="l00960"></a>00960             infoMsg-&gt;setBitLength(<a class="code" href="KademliaMessage__m_8h.html#ae7646d8e6e9aab79d12e8d5b9aff15ee">KADEMLIAROUTINGINFO_L</a>(infoMsg));
<a name="l00961"></a>00961 
<a name="l00962"></a>00962             msg-&gt;encapsulate(infoMsg);
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00966"></a>00966 }
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 
<a name="l00969"></a><a class="code" href="classKademlia.html#aafad68d123da52e5fefb719699ed2dc3">00969</a> <a class="code" href="classBaseKeySortedVector.html">NodeVector</a>* <a class="code" href="classKademlia.html#aafad68d123da52e5fefb719699ed2dc3" title="Implements the find node call.">Kademlia::findNode</a>(<span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; key, <span class="keywordtype">int</span> numRedundantNodes,
<a name="l00970"></a>00970                                <span class="keywordtype">int</span> numSiblings, <a class="code" href="classBaseOverlayMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseOverlayMessage</a>* msg)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972     <span class="keywordflow">if</span> (numSiblings &gt; <a class="code" href="classKademlia.html#a7253ff80d709265f6e74d3ebf4e691ad" title="Query the maximum number of siblings (nodes close to a key) that are maintained by this overlay proto...">getMaxNumSiblings</a>()) {
<a name="l00973"></a>00973         opp_error(<span class="stringliteral">&quot;(Kademlia::findNode()) numRedundantNodes or numSiblings &quot;</span>
<a name="l00974"></a>00974                   <span class="stringliteral">&quot;too big!&quot;</span>);
<a name="l00975"></a>00975     }
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 <span class="preprocessor">#if 0</span>
<a name="l00978"></a>00978 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (numRedundantNodes &lt; 2) {
<a name="l00979"></a>00979         <span class="keywordflow">throw</span> cRuntimeError(<span class="stringliteral">&quot;Kademlia::findNode(): For Kademlia &quot;</span>
<a name="l00980"></a>00980                                 <span class="stringliteral">&quot;redundantNodes must be at least 2 &quot;</span>
<a name="l00981"></a>00981                                 <span class="stringliteral">&quot;and lookupMerge should be true!&quot;</span>);
<a name="l00982"></a>00982     }
<a name="l00983"></a>00983 <span class="preprocessor">#endif</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span>
<a name="l00985"></a>00985     <span class="comment">// create temporary comparator</span>
<a name="l00986"></a>00986     <a class="code" href="classKeyDistanceComparator.html">KeyDistanceComparator&lt;KeyXorMetric&gt;</a>* comp =
<a name="l00987"></a>00987         <span class="keyword">new</span> <a class="code" href="classKeyDistanceComparator.html">KeyDistanceComparator&lt;KeyXorMetric&gt;</a>( key );
<a name="l00988"></a>00988 
<a name="l00989"></a>00989     <span class="comment">// select result set size</span>
<a name="l00990"></a>00990     <span class="keywordtype">bool</span> err;
<a name="l00991"></a>00991     <span class="keywordtype">int</span> resultSize;
<a name="l00992"></a>00992 
<a name="l00993"></a>00993     <span class="keywordflow">if</span> (numSiblings &lt; 0) {
<a name="l00994"></a>00994         <span class="comment">// exhaustive iterative doesn&#39;t care about siblings</span>
<a name="l00995"></a>00995         resultSize = numRedundantNodes;
<a name="l00996"></a>00996     } <span class="keywordflow">else</span> {
<a name="l00997"></a>00997         resultSize = <a class="code" href="classKademlia.html#ada80a26aba760ec53ce539d8180cf865" title="Query if a node is among the siblings for a given key.">isSiblingFor</a>(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>, key, numSiblings, &amp;err) ?
<a name="l00998"></a>00998                 (numSiblings ? numSiblings : 1) : numRedundantNodes;
<a name="l00999"></a>00999     }
<a name="l01000"></a>01000     assert(numSiblings || numRedundantNodes);
<a name="l01001"></a>01001 
<a name="l01002"></a>01002     <a class="code" href="classBaseKeySortedVector.html">NodeVector</a>* result = <span class="keyword">new</span> <a class="code" href="NodeVector_8h.html#a442f90b66b22aa9fca51f83c5ce1b02b">NodeVector</a>(resultSize, comp);
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classBaseKeySortedVector.html#a3aaa6426ddc7dba9d2d2f4b05cad997c" title="indicates if NodeVector holds at least one node">isEmpty</a>()) {
<a name="l01005"></a>01005         result-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>);
<a name="l01006"></a>01006         <span class="keyword">delete</span> comp;
<a name="l01007"></a>01007         <span class="keywordflow">return</span> result;
<a name="l01008"></a>01008     }
<a name="l01009"></a>01009 
<a name="l01010"></a>01010     <span class="comment">// R/Kademlia: in recursive mode just speed up route messages //TODO iterative PR</span>
<a name="l01011"></a>01011     <span class="keywordtype">bool</span> returnProxNodes = <span class="keyword">false</span>;
<a name="l01012"></a>01012     <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#aa8b1be416dea22c671ae2774936226c5">proximityRouting</a>) {
<a name="l01013"></a>01013         <span class="keywordflow">if</span> (msg &amp;&amp;
<a name="l01014"></a>01014             (!dynamic_cast&lt;FindNodeCall*&gt;(msg-&gt;getEncapsulatedPacket()) &amp;&amp;
<a name="l01015"></a>01015              !dynamic_cast&lt;FindNodeCall*&gt;(msg))) {
<a name="l01016"></a>01016             returnProxNodes = <span class="keyword">true</span>;
<a name="l01017"></a>01017         }
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     <a class="code" href="classBaseKeySortedVector.html" title="A STL-vector that supports inserts sorted by an OverlayKey found somewhere in the type...">ProxNodeVector</a>* resultProx = NULL;
<a name="l01021"></a>01021     <a class="code" href="classKademliaPRComparator.html">KademliaPRComparator</a>* compProx = NULL;
<a name="l01022"></a>01022     <span class="keywordflow">if</span> (returnProxNodes) {
<a name="l01023"></a>01023         compProx = <span class="keyword">new</span> <a class="code" href="classKademliaPRComparator.html">KademliaPRComparator</a>(key);
<a name="l01024"></a>01024         resultProx = <span class="keyword">new</span> <a class="code" href="NodeVector_8h.html#a4d7500584bc52e84d4b6bb26397750c2">ProxNodeVector</a>(resultSize, NULL, NULL, compProx, 0, resultSize);
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027     <span class="comment">// add items from buckets</span>
<a name="l01028"></a>01028     <span class="keywordtype">int</span> index;
<a name="l01029"></a>01029     <span class="keywordtype">int</span> mainIndex = <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(key);
<a name="l01030"></a>01030     <span class="keywordtype">int</span> startIndex = <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(key, <span class="keyword">true</span>);
<a name="l01031"></a>01031     <span class="keywordtype">int</span> endIndex = <a class="code" href="classKademlia.html#ac281bfbd16423020b46561a0df3d28c5" title="Returns the index of the bucket the key would reside with respect to Kademlia parameters.">routingBucketIndex</a>(<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;back().getKey());
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     <span class="comment">// add nodes from best fitting bucket</span>
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (mainIndex != -1) {
<a name="l01035"></a>01035         <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* bucket = <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[mainIndex];
<a name="l01036"></a>01036         <span class="keywordflow">if</span> (bucket != NULL &amp;&amp; bucket-&gt;size()) {
<a name="l01037"></a>01037             <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i=bucket-&gt;begin(); i!=bucket-&gt;end(); i++) {
<a name="l01038"></a>01038                 result-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);
<a name="l01039"></a>01039                 <span class="keywordflow">if</span> (returnProxNodes)
<a name="l01040"></a>01040                     resultProx-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);
<a name="l01041"></a>01041                 <span class="comment">//EV &lt;&lt; &quot;Kademlia::findNode(): Adding &quot;</span>
<a name="l01042"></a>01042                 <span class="comment">//   &lt;&lt; *i &lt;&lt; &quot; from bucket &quot; &lt;&lt; mainIndex &lt;&lt; endl;</span>
<a name="l01043"></a>01043             }
<a name="l01044"></a>01044         }
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     <span class="comment">// add most fitting buckets</span>
<a name="l01048"></a>01048     <span class="keywordflow">if</span> (startIndex &gt;= endIndex || !result-&gt;<a class="code" href="classBaseKeySortedVector.html#ad96fd23183bf954e2613af5430ecb48d" title="indicates if NodeVector holds maxSize nodes">isFull</a>()) {
<a name="l01049"></a>01049         <span class="keywordflow">for</span> (index = startIndex; index &gt;= endIndex; --index) {
<a name="l01050"></a>01050             <span class="comment">// add bucket to result vector</span>
<a name="l01051"></a>01051             <span class="keywordflow">if</span> (index == mainIndex) <span class="keywordflow">continue</span>;
<a name="l01052"></a>01052             <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* bucket = <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index];
<a name="l01053"></a>01053             <span class="keywordflow">if</span> (bucket != NULL &amp;&amp; bucket-&gt;size()) {
<a name="l01054"></a>01054                 <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i=bucket-&gt;begin(); i!=bucket-&gt;end(); i++) {
<a name="l01055"></a>01055                     result-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);
<a name="l01056"></a>01056                     <span class="keywordflow">if</span> (returnProxNodes)
<a name="l01057"></a>01057                         resultProx-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);<span class="comment">//std::make_pair(*i, i-&gt;getRtt()));</span>
<a name="l01058"></a>01058                     <span class="comment">//EV &lt;&lt; &quot;Kademlia::routingGetClosestNodes(): Adding &quot;</span>
<a name="l01059"></a>01059                     <span class="comment">//   &lt;&lt; *i &lt;&lt; &quot; from bucket &quot; &lt;&lt; index &lt;&lt; endl;</span>
<a name="l01060"></a>01060                 }
<a name="l01061"></a>01061             }
<a name="l01062"></a>01062         }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064         <span class="comment">// add nodes from sibling table</span>
<a name="l01065"></a>01065         <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;begin();
<a name="l01066"></a>01066              i != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end(); i++) {
<a name="l01067"></a>01067             result-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);
<a name="l01068"></a>01068             <span class="keywordflow">if</span> (returnProxNodes)
<a name="l01069"></a>01069                 resultProx-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);
<a name="l01070"></a>01070         }
<a name="l01071"></a>01071         <span class="comment">// add local node</span>
<a name="l01072"></a>01072         result-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(<a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>);
<a name="l01073"></a>01073         <span class="keywordflow">if</span> (returnProxNodes) {
<a name="l01074"></a>01074             <a class="code" href="classKademliaBucketEntry.html">KademliaBucketEntry</a> temp = <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>;
<a name="l01075"></a>01075             <span class="keywordflow">if</span> (!result-&gt;size() || (*result)[0] == <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>) {
<a name="l01076"></a>01076                 temp.<a class="code" href="classProxNodeHandle.html#a2f3e23f427dfbf4c36fef805d7fa8bc2">setProx</a>(<a class="code" href="structProx.html#ae33fb924891e14e0161708bfadf8f033">Prox::PROX_SELF</a>);
<a name="l01077"></a>01077                 resultProx-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(temp);
<a name="l01078"></a>01078             } <span class="keywordflow">else</span> {
<a name="l01079"></a>01079                 temp.<a class="code" href="classProxNodeHandle.html#a2f3e23f427dfbf4c36fef805d7fa8bc2">setProx</a>(<a class="code" href="structProx.html#aa7ac832a04fe61863222d8631526647b">Prox::PROX_UNKNOWN</a>);
<a name="l01080"></a>01080                 resultProx-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(temp);
<a name="l01081"></a>01081             }
<a name="l01082"></a>01082         }
<a name="l01083"></a>01083     }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085     <span class="comment">// add more distant buckets</span>
<a name="l01086"></a>01086     <span class="keywordflow">for</span> (index = mainIndex + 1; !result-&gt;<a class="code" href="classBaseKeySortedVector.html#ad96fd23183bf954e2613af5430ecb48d" title="indicates if NodeVector holds maxSize nodes">isFull</a>() &amp;&amp; index &lt; <a class="code" href="classKademlia.html#a307336180b2937d77360219c9ac91c3c">numBuckets</a>;
<a name="l01087"></a>01087          ++index) {
<a name="l01088"></a>01088         <span class="comment">// add bucket to result vector</span>
<a name="l01089"></a>01089         <a class="code" href="classKademliaBucket.html">KademliaBucket</a>* bucket = <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index];
<a name="l01090"></a>01090         <span class="keywordflow">if</span> (bucket != NULL &amp;&amp; bucket-&gt;size()) {
<a name="l01091"></a>01091             <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i=bucket-&gt;begin(); i!=bucket-&gt;end(); i++) {
<a name="l01092"></a>01092                 result-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);
<a name="l01093"></a>01093                 <span class="keywordflow">if</span> (returnProxNodes)
<a name="l01094"></a>01094                     resultProx-&gt;<a class="code" href="classBaseKeySortedVector.html#afbcdfbd9680a475cceb48ccc841140cd" title="adds an element of type T in increasing order to the NodeVector and returns the position of the added...">add</a>(*i);
<a name="l01095"></a>01095                 <span class="comment">//EV &lt;&lt; &quot;[Kademlia::routingGetClosestNodes()]\n&quot;</span>
<a name="l01096"></a>01096                 <span class="comment">//   &lt;&lt; &quot;    Adding &quot; &lt;&lt; *i &lt;&lt; &quot; from bucket &quot; &lt;&lt; index</span>
<a name="l01097"></a>01097                 <span class="comment">//   &lt;&lt; endl;</span>
<a name="l01098"></a>01098             }
<a name="l01099"></a>01099         }
<a name="l01100"></a>01100     }
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     <span class="keywordflow">if</span> (returnProxNodes &amp;&amp; resultProx-&gt;size() &amp;&amp; result-&gt;size() &amp;&amp;
<a name="l01103"></a>01103         (<a class="code" href="classKeyPrefixMetric.html" title="OverlayKey prefix metric.">KeyPrefixMetric</a>().<a class="code" href="classKeyPrefixMetric.html#a78d831ece61ba3e17c9200f4ad733cdb" title="calculates the distance from x to y with the prefix metric">distance</a>(key, (*resultProx)[0].getKey()) &lt;
<a name="l01104"></a>01104          <a class="code" href="classKeyPrefixMetric.html" title="OverlayKey prefix metric.">KeyPrefixMetric</a>().<a class="code" href="classKeyPrefixMetric.html#a78d831ece61ba3e17c9200f4ad733cdb" title="calculates the distance from x to y with the prefix metric">distance</a>(key, (*result)[0].getKey()))) {
<a name="l01105"></a>01105         result-&gt;clear();
<a name="l01106"></a>01106         <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; resultProx-&gt;size(); ++i) {
<a name="l01107"></a>01107             result-&gt;push_back((*resultProx)[i]<span class="comment">/*.first*/</span>);
<a name="l01108"></a>01108         }
<a name="l01109"></a>01109     }
<a name="l01110"></a>01110     <span class="keyword">delete</span> compProx;
<a name="l01111"></a>01111     <span class="keyword">delete</span> resultProx;
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     <span class="keyword">delete</span> comp;
<a name="l01114"></a>01114 
<a name="l01115"></a>01115     <span class="keywordflow">return</span> result;
<a name="l01116"></a>01116 }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118 <span class="comment">//-----------------------------------------------------------------------------</span>
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 
<a name="l01121"></a><a class="code" href="classKademlia.html#a27b31a4a713eadd2c8f1a83d66dc69a7">01121</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a27b31a4a713eadd2c8f1a83d66dc69a7">Kademlia::handleTimerEvent</a>(cMessage* msg)
<a name="l01122"></a>01122 {
<a name="l01123"></a>01123     <span class="keywordflow">if</span> (msg == <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>) {
<a name="l01124"></a>01124         <a class="code" href="classKademlia.html#a53a73a3a496d4fe37c0310b7b6eee214" title="handle a expired bucket refresh timer">handleBucketRefreshTimerExpired</a>();
<a name="l01125"></a>01125     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg == <a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>) {
<a name="l01126"></a>01126         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a99dbb3ee2302a9861a518b3d75cb3eb2">siblingPingInterval</a> == 0) {
<a name="l01127"></a>01127             <span class="keywordflow">return</span>;
<a name="l01128"></a>01128         }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130         <span class="keywordflow">for</span> (<a class="code" href="classBaseKeySortedVector.html#adda2ae09639f7600c0f7ab759f4c9c0c" title="iterator for this vector">KademliaBucket::iterator</a> i = <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;begin();
<a name="l01131"></a>01131              i != <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;end(); i++) {
<a name="l01132"></a>01132             <a class="code" href="classBaseRpc.html#a421904b1b501580efed12e6490d3324a" title="ping a node by its TransportAddress">pingNode</a>(*i);
<a name="l01133"></a>01133         }
<a name="l01134"></a>01134         scheduleAt(simTime() + <a class="code" href="classKademlia.html#a99dbb3ee2302a9861a518b3d75cb3eb2">siblingPingInterval</a>, msg);
<a name="l01135"></a>01135     }
<a name="l01136"></a>01136 }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138 <span class="comment">// R/Kademlia</span>
<a name="l01139"></a><a class="code" href="classKademlia.html#af1edeee0ba2c1f2fb26355076814f102">01139</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#af1edeee0ba2c1f2fb26355076814f102" title="Processes messages from underlay.">Kademlia::handleUDPMessage</a>(<a class="code" href="classBaseOverlayMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseOverlayMessage</a>* msg)
<a name="l01140"></a>01140 {
<a name="l01141"></a>01141     <span class="comment">// only used for recursive Kademlia</span>
<a name="l01142"></a>01142     <a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>* ctrlInfo =
<a name="l01143"></a>01143             check_and_cast&lt;<a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>*&gt;(msg-&gt;removeControlInfo());
<a name="l01144"></a>01144     <a class="code" href="classKademliaRoutingInfoMessage.html" title="Class generated from overlay/kademlia/KademliaMessage.msg by opp_msgc.">KademliaRoutingInfoMessage</a>* kadRoutingInfoMsg =
<a name="l01145"></a>01145             check_and_cast&lt;<a class="code" href="classKademliaRoutingInfoMessage.html" title="Class generated from overlay/kademlia/KademliaMessage.msg by opp_msgc.">KademliaRoutingInfoMessage</a>*&gt;(msg);
<a name="l01146"></a>01146 
<a name="l01147"></a>01147     <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(kadRoutingInfoMsg-&gt;getSrcNode(), <span class="keyword">true</span>);
<a name="l01148"></a>01148 
<a name="l01149"></a>01149     <span class="keywordflow">for</span> (uint32_t i = 0; i &lt; kadRoutingInfoMsg-&gt;getNextHopsArraySize(); i++) {
<a name="l01150"></a>01150         <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(kadRoutingInfoMsg-&gt;getNextHops(i),
<a name="l01151"></a>01151                    kadRoutingInfoMsg-&gt;getNextHops(i).getIsAlive());
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154     <span class="keyword">delete</span> ctrlInfo;
<a name="l01155"></a>01155     <span class="keyword">delete</span> msg;
<a name="l01156"></a>01156 }
<a name="l01157"></a>01157 
<a name="l01158"></a>01158 <span class="comment">//In Kademlia this method is used to maintain the routing table.</span>
<a name="l01159"></a><a class="code" href="classKademlia.html#a82d872d3d7797e94985557d04f7c9ed5">01159</a> <span class="keywordtype">bool</span> <a class="code" href="classKademlia.html#a82d872d3d7797e94985557d04f7c9ed5" title="Processes Remote-Procedure-Call invocation messages.">Kademlia::handleRpcCall</a>(<a class="code" href="classBaseCallMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseCallMessage</a>* msg)
<a name="l01160"></a>01160 {
<a name="l01161"></a>01161     <span class="keywordtype">bool</span> maintenanceLookup = (msg-&gt;<a class="code" href="classBaseOverlayMessage.html#af0a4bf31778e05a809f8d55dff5bfcc1">getStatType</a>() == <a class="code" href="CommonMessages__m_8h.html#a25418fa818fbb01cd8c0b2c4b0732cdfad7989a419a7028d382d7b6e6d17e88c5">MAINTENANCE_STAT</a>);
<a name="l01162"></a>01162     <a class="code" href="RpcMacros_8h.html#aa75b135e279b574267e1a7dc4ab79da4" title="Marks the beginning of a Remote-Procedure-Call Switch block.">RPC_SWITCH_START</a>(msg)
<a name="l01163"></a>01163     <a class="code" href="RpcMacros_8h.html#ae07fad586ce7b9e82ad12848767a32e5">RPC_ON_CALL</a>(Ping) {
<a name="l01164"></a>01164         <span class="comment">// add active node</span>
<a name="l01165"></a>01165         <a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>* ctrlInfo =
<a name="l01166"></a>01166             check_and_cast&lt;<a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>*&gt;(msg-&gt;getControlInfo());
<a name="l01167"></a>01167         <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(ctrlInfo-&gt;<a class="code" href="classOverlayCtrlInfo.html#ad1a712f1757d7441e1a74ad98bfd71f4">getSrcRoute</a>(), <span class="keyword">true</span>, MAXTIME, maintenanceLookup);
<a name="l01168"></a>01168         <span class="keywordflow">break</span>;
<a name="l01169"></a>01169     }
<a name="l01170"></a>01170     <a class="code" href="RpcMacros_8h.html#ae07fad586ce7b9e82ad12848767a32e5">RPC_ON_CALL</a>(FindNode)
<a name="l01171"></a>01171     {
<a name="l01172"></a>01172         <span class="comment">// add active node</span>
<a name="l01173"></a>01173         <a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>* ctrlInfo =
<a name="l01174"></a>01174             check_and_cast&lt;<a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>*&gt;(msg-&gt;getControlInfo());
<a name="l01175"></a>01175         <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(ctrlInfo-&gt;<a class="code" href="classOverlayCtrlInfo.html#ad1a712f1757d7441e1a74ad98bfd71f4">getSrcRoute</a>(), <span class="keyword">true</span>, MAXTIME, maintenanceLookup);
<a name="l01176"></a>01176         <span class="keywordflow">break</span>;
<a name="l01177"></a>01177     }
<a name="l01178"></a>01178     <a class="code" href="RpcMacros_8h.html#a29a8a3f21e67ecb25f58608a54df5191" title="Marks the end of a Remote-Procedure-Call Switch block.">RPC_SWITCH_END</a>()
<a name="l01179"></a>01179     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01180"></a>01180 }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182 <span class="comment">//In Kademlia this method is used to maintain the routing table.</span>
<a name="l01183"></a><a class="code" href="classKademlia.html#af8451d8dae93dbb1117574b3820af76e">01183</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#af8451d8dae93dbb1117574b3820af76e" title="This method is called if an RPC response has been received.">Kademlia::handleRpcResponse</a>(<a class="code" href="classBaseResponseMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseResponseMessage</a>* msg,
<a name="l01184"></a>01184                                  cPolymorphic* context, <span class="keywordtype">int</span> rpcId,
<a name="l01185"></a>01185                                  simtime_t rtt)
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187     <span class="keywordtype">bool</span> maintenanceLookup = (msg-&gt;<a class="code" href="classBaseOverlayMessage.html#af0a4bf31778e05a809f8d55dff5bfcc1">getStatType</a>() == <a class="code" href="CommonMessages__m_8h.html#a25418fa818fbb01cd8c0b2c4b0732cdfad7989a419a7028d382d7b6e6d17e88c5">MAINTENANCE_STAT</a>);
<a name="l01188"></a>01188     <a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>* ctrlInfo =
<a name="l01189"></a>01189         <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classOverlayCtrlInfo.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">OverlayCtrlInfo</a>*<span class="keyword">&gt;</span>(msg-&gt;getControlInfo());
<a name="l01190"></a>01190     <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a> srcRoute = (ctrlInfo ? ctrlInfo-&gt;<a class="code" href="classOverlayCtrlInfo.html#ad1a712f1757d7441e1a74ad98bfd71f4">getSrcRoute</a>()
<a name="l01191"></a>01191                                     : msg-&gt;<a class="code" href="classBaseRpcMessage.html#ada3e122125cfb5acc7350277ca69c45a">getSrcNode</a>());
<a name="l01192"></a>01192 
<a name="l01193"></a>01193     <a class="code" href="RpcMacros_8h.html#aa75b135e279b574267e1a7dc4ab79da4" title="Marks the beginning of a Remote-Procedure-Call Switch block.">RPC_SWITCH_START</a>(msg)
<a name="l01194"></a>01194         <a class="code" href="RpcMacros_8h.html#a0394d2dc4f9f1e15d7e99c9f43da10c7">RPC_ON_RESPONSE</a>(Ping) {
<a name="l01195"></a>01195             <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>) {
<a name="l01196"></a>01196                 <span class="comment">// schedule bucket refresh timer</span>
<a name="l01197"></a>01197                 cancelEvent(<a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01198"></a>01198                 scheduleAt(simTime(), <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01199"></a>01199                 cancelEvent(<a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>);
<a name="l01200"></a>01200                 scheduleAt(simTime() + <a class="code" href="classKademlia.html#a99dbb3ee2302a9861a518b3d75cb3eb2">siblingPingInterval</a>, <a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>);
<a name="l01201"></a>01201                 <a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> = <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa40c37f1f56c6ed8e40ae467e67e61cab">JOIN</a>;
<a name="l01202"></a>01202             }
<a name="l01203"></a>01203         }
<a name="l01204"></a>01204         <a class="code" href="RpcMacros_8h.html#a0394d2dc4f9f1e15d7e99c9f43da10c7">RPC_ON_RESPONSE</a>(FindNode)
<a name="l01205"></a>01205         {
<a name="l01206"></a>01206             <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>) {
<a name="l01207"></a>01207                 <a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> = <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa40c37f1f56c6ed8e40ae467e67e61cab">JOIN</a>;
<a name="l01208"></a>01208 
<a name="l01209"></a>01209                 <span class="comment">// bootstrap node is trustworthy: add all nodes immediately</span>
<a name="l01210"></a>01210                 <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(srcRoute, <span class="keyword">true</span>, rtt, maintenanceLookup);
<a name="l01211"></a>01211                 <span class="keywordflow">for</span> (uint32_t i=0; i&lt;_FindNodeResponse-&gt;getClosestNodesArraySize(); i++)
<a name="l01212"></a>01212                     <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(_FindNodeResponse-&gt;getClosestNodes(i), <span class="keyword">true</span>,
<a name="l01213"></a>01213                                MAXTIME-1, maintenanceLookup);
<a name="l01214"></a>01214 
<a name="l01215"></a>01215                 <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a68e77f3b48652f19219a6c6c9a1a76d2">newMaintenance</a>) {
<a name="l01216"></a>01216                     <a class="code" href="classBaseOverlay.html#a205a7d44401fb3d77b146e23b2904b6f" title="Creates an abstract iterative lookup instance.">createLookup</a>()-&gt;<a class="code" href="classAbstractLookup.html#aa1bda70950cbd160ea78d1fcbd8c7767" title="Lookup siblings for a key.">lookup</a>(<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().getKey(), <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a>, <a class="code" href="classBaseOverlay.html#abffe6fbd25963bc2b7542f22ba6455b9" title="maximum hop count">hopCountMax</a>, 0,
<a name="l01217"></a>01217                                        <span class="keyword">new</span> <a class="code" href="classKademlia.html#a61b072e95046f98ad49a3f5589fe9a45">KademliaLookupListener</a>(<span class="keyword">this</span>));
<a name="l01218"></a>01218                 } <span class="keywordflow">else</span> {
<a name="l01219"></a>01219                     <span class="comment">// schedule bucket refresh timer</span>
<a name="l01220"></a>01220                     cancelEvent(<a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01221"></a>01221                     scheduleAt(simTime(), <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01222"></a>01222                     cancelEvent(<a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>);
<a name="l01223"></a>01223                     scheduleAt(simTime() + <a class="code" href="classKademlia.html#a99dbb3ee2302a9861a518b3d75cb3eb2">siblingPingInterval</a>, <a class="code" href="classKademlia.html#a683327ac98618e38b3dd1dfe5850ab09">siblingPingTimer</a>);
<a name="l01224"></a>01224                 }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226                 <span class="keywordflow">break</span>;
<a name="l01227"></a>01227             }
<a name="l01228"></a>01228 
<a name="l01229"></a>01229             <span class="comment">// add active node</span>
<a name="l01230"></a>01230             <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551a18b63fe85aa5e81cd3fca5e3c7c9df82">SEMI_RECURSIVE_ROUTING</a> ||
<a name="l01231"></a>01231                 <a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551aeec4ce5cac6dae9d3d59b1347a9df957">FULL_RECURSIVE_ROUTING</a> ||
<a name="l01232"></a>01232                 <a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551ad8c4eefed3d826e5da402fe582cad2c1">RECURSIVE_SOURCE_ROUTING</a>) {
<a name="l01233"></a>01233                 rtt = MAXTIME;
<a name="l01234"></a>01234             }
<a name="l01235"></a>01235             <a class="code" href="classKademlia.html#a7581a168ae2e143001a7a93ff4a1779a">setBucketUsage</a>(srcRoute.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l01236"></a>01236 
<a name="l01237"></a>01237             <span class="comment">// add inactive nodes</span>
<a name="l01238"></a>01238             <span class="keywordflow">for</span> (uint32_t i=0; i&lt;_FindNodeResponse-&gt;getClosestNodesArraySize(); i++)
<a name="l01239"></a>01239                 <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(_FindNodeResponse-&gt;getClosestNodes(i), <span class="keyword">false</span>,
<a name="l01240"></a>01240                            MAXTIME, maintenanceLookup);
<a name="l01241"></a>01241             <span class="keywordflow">break</span>;
<a name="l01242"></a>01242         }
<a name="l01243"></a>01243     <a class="code" href="RpcMacros_8h.html#a29a8a3f21e67ecb25f58608a54df5191" title="Marks the end of a Remote-Procedure-Call Switch block.">RPC_SWITCH_END</a>()
<a name="l01244"></a>01244 
<a name="l01245"></a>01245     <span class="comment">// add node that responded</span>
<a name="l01246"></a>01246     <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>(srcRoute, <span class="keyword">true</span>, rtt, maintenanceLookup);
<a name="l01247"></a>01247 }
<a name="l01248"></a>01248 
<a name="l01249"></a>01249 <span class="comment">// In Kademlia this method is used to maintain the routing table.</span>
<a name="l01250"></a><a class="code" href="classKademlia.html#a9c237aa2447a9b2323bf34a95c852005">01250</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a9c237aa2447a9b2323bf34a95c852005" title="This method is called if an RPC timeout has been reached.">Kademlia::handleRpcTimeout</a>(<a class="code" href="classBaseCallMessage.html" title="Class generated from common/CommonMessages.msg by opp_msgc.">BaseCallMessage</a>* msg,
<a name="l01251"></a>01251                                 <span class="keyword">const</span> <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a>&amp; dest,
<a name="l01252"></a>01252                                 cPolymorphic* context, <span class="keywordtype">int</span> rpcId,
<a name="l01253"></a>01253                                 <span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; destKey)
<a name="l01254"></a>01254 {
<a name="l01255"></a>01255     <span class="keywordflow">if</span> (dest.<a class="code" href="classTransportAddress.html#a026e777c423ff2a0280edd2fa5472e74" title="indicates if TransportAddress is specified">isUnspecified</a>()) <span class="keywordflow">return</span>;
<a name="l01256"></a>01256     <span class="keywordflow">try</span> {
<a name="l01257"></a>01257         <a class="code" href="RpcMacros_8h.html#aa75b135e279b574267e1a7dc4ab79da4" title="Marks the beginning of a Remote-Procedure-Call Switch block.">RPC_SWITCH_START</a>(msg)
<a name="l01258"></a>01258         <a class="code" href="RpcMacros_8h.html#ae07fad586ce7b9e82ad12848767a32e5">RPC_ON_CALL</a>(Ping) {
<a name="l01259"></a>01259             <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>) {
<a name="l01260"></a>01260                 <a class="code" href="classKademlia.html#a23662900f3d17541a2b9051a3821a226" title="Join the overlay with a given nodeID in thisNode.key.">joinOverlay</a>();
<a name="l01261"></a>01261                 <span class="keywordflow">return</span>;
<a name="l01262"></a>01262             }
<a name="l01263"></a>01263 
<a name="l01264"></a>01264             <span class="keyword">const</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp; handle = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp;<span class="keyword">&gt;</span>(dest);
<a name="l01265"></a>01265             <a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>(handle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l01266"></a>01266             <span class="keywordflow">break</span>;
<a name="l01267"></a>01267         }
<a name="l01268"></a>01268         <a class="code" href="RpcMacros_8h.html#ae07fad586ce7b9e82ad12848767a32e5">RPC_ON_CALL</a>(FindNode) {
<a name="l01269"></a>01269             <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa4c1b397f6c4682baf7db280e7f15520a">INIT</a>) {
<a name="l01270"></a>01270                 <a class="code" href="classKademlia.html#a23662900f3d17541a2b9051a3821a226" title="Join the overlay with a given nodeID in thisNode.key.">joinOverlay</a>();
<a name="l01271"></a>01271                 <span class="keywordflow">return</span>;
<a name="l01272"></a>01272             }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274             <span class="keyword">const</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp; handle = <span class="keyword">dynamic_cast&lt;</span><span class="keyword">const </span><a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp;<span class="keyword">&gt;</span>(dest);
<a name="l01275"></a>01275             <a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>(handle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l01276"></a>01276             <a class="code" href="classKademlia.html#a7581a168ae2e143001a7a93ff4a1779a">setBucketUsage</a>(handle.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>());
<a name="l01277"></a>01277             <span class="keywordflow">break</span>;
<a name="l01278"></a>01278         }
<a name="l01279"></a>01279         <a class="code" href="RpcMacros_8h.html#a29a8a3f21e67ecb25f58608a54df5191" title="Marks the end of a Remote-Procedure-Call Switch block.">RPC_SWITCH_END</a>()
<a name="l01280"></a>01280     } <span class="keywordflow">catch</span> (...) {
<a name="l01281"></a>01281         EV &lt;&lt; <span class="stringliteral">&quot;[Kademlia:handleRpcTimout() @ &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classTransportAddress.html#a00e613d98d3412e2b92897c25aa0eb4c" title="returns ip address">getIp</a>()
<a name="l01282"></a>01282            &lt;&lt; <span class="stringliteral">&quot; (&quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a>.<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().<a class="code" href="classOverlayKey.html#aabeb4fd284a630a82e982ba34ece4fd9" title="Returns a string representation of this key.">toString</a>(16) &lt;&lt; <span class="stringliteral">&quot;)]\n&quot;</span>
<a name="l01283"></a>01283            &lt;&lt; <span class="stringliteral">&quot;    ERROR: RPC timeout without key (&quot;</span>
<a name="l01284"></a>01284            &lt;&lt; msg &lt;&lt; <span class="stringliteral">&quot; -&gt; &quot;</span> &lt;&lt; dest &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; endl;
<a name="l01285"></a>01285         <span class="keywordflow">return</span>;
<a name="l01286"></a>01286     }
<a name="l01287"></a>01287 }
<a name="l01288"></a>01288 
<a name="l01289"></a>01289 <span class="comment">// R/Kademlia</span>
<a name="l01290"></a><a class="code" href="classKademlia.html#a7545cb508c37d7bf706b3e5a4950c695">01290</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a7545cb508c37d7bf706b3e5a4950c695">Kademlia::proxCallback</a>(<span class="keyword">const</span> <a class="code" href="classTransportAddress.html" title="This class implements a common transport address.">TransportAddress</a>&amp; node, <span class="keywordtype">int</span> rpcId,
<a name="l01291"></a>01291                             cPolymorphic *contextPointer, <a class="code" href="structProx.html">Prox</a> prox)
<a name="l01292"></a>01292 {
<a name="l01293"></a>01293     Enter_Method_Silent();
<a name="l01294"></a>01294 
<a name="l01295"></a>01295     <span class="keywordflow">if</span> (prox != <a class="code" href="structProx.html#a5ded765f6344797ea0e9c35c85cd61af">Prox::PROX_TIMEOUT</a>) {
<a name="l01296"></a>01296         <a class="code" href="classKademlia.html#a9c72c87286495818109f5460a7eefea9" title="Adds a node to the routing table.">routingAdd</a>((<span class="keyword">const</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp;)node, <span class="keyword">true</span>, prox.<a class="code" href="structProx.html#aeb8eca3cac2c681c5e7f1060fcbd7b6f">proximity</a>);
<a name="l01297"></a>01297     } <span class="keywordflow">else</span> {
<a name="l01298"></a>01298         <a class="code" href="classKademlia.html#a21ca74bfdaf4114ca2f468935856e67b" title="Removes a node after a number of timeouts or immediately if immediately is true (behaves like routing...">routingTimeout</a>(((<span class="keyword">const</span> <a class="code" href="classNodeHandle.html" title="This class implements a node handle.">NodeHandle</a>&amp;)node).getKey());
<a name="l01299"></a>01299     }
<a name="l01300"></a>01300 }
<a name="l01301"></a>01301 
<a name="l01302"></a><a class="code" href="classKademlia.html#adac287af3943cfcbc1a3834fa8d0c37d">01302</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#adac287af3943cfcbc1a3834fa8d0c37d">Kademlia::lookupFinished</a>(<span class="keywordtype">bool</span> isValid)
<a name="l01303"></a>01303 {
<a name="l01304"></a>01304     <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fa40c37f1f56c6ed8e40ae467e67e61cab">JOIN</a>) {
<a name="l01305"></a>01305         cancelEvent(<a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size() == 0) {
<a name="l01308"></a>01308             <span class="comment">// initial lookup failed - get new bootstrap node</span>
<a name="l01309"></a>01309             <a class="code" href="classKademlia.html#a23662900f3d17541a2b9051a3821a226" title="Join the overlay with a given nodeID in thisNode.key.">joinOverlay</a>();
<a name="l01310"></a>01310             <span class="keywordflow">return</span>;
<a name="l01311"></a>01311         }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313         scheduleAt(simTime(), <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01314"></a>01314 
<a name="l01315"></a>01315         <span class="keywordflow">if</span> (!<a class="code" href="classKademlia.html#a68e77f3b48652f19219a6c6c9a1a76d2">newMaintenance</a>) {
<a name="l01316"></a>01316             <a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> = <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>;
<a name="l01317"></a>01317             <a class="code" href="classBaseOverlay.html#a9da615809e832cbc4645cc732d510277" title="Sets the overlay ready icon and register/deregisters the node at the GlobalNodeList.">setOverlayReady</a>(<span class="keyword">true</span>);
<a name="l01318"></a>01318         }
<a name="l01319"></a>01319     }
<a name="l01320"></a>01320 }
<a name="l01321"></a>01321 
<a name="l01322"></a>01322 <span class="comment">// handle a expired bucket refresh timer</span>
<a name="l01323"></a><a class="code" href="classKademlia.html#a53a73a3a496d4fe37c0310b7b6eee214">01323</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#a53a73a3a496d4fe37c0310b7b6eee214" title="handle a expired bucket refresh timer">Kademlia::handleBucketRefreshTimerExpired</a>()
<a name="l01324"></a>01324 {
<a name="l01325"></a>01325     <span class="comment">// refresh buckets</span>
<a name="l01326"></a>01326     <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> != <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a> || (((simTime() - <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classKademliaBucket.html#af0d14164aa8f871b1696245b78ad9a6d">getLastUsage</a>()) &gt;
<a name="l01327"></a>01327                             <a class="code" href="classKademlia.html#ae22800e069a69a317d4906a29e4da71d">minSiblingTableRefreshInterval</a>))) {
<a name="l01328"></a>01328         <span class="comment">// R/Kademlia</span>
<a name="l01329"></a>01329         <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551a18b63fe85aa5e81cd3fca5e3c7c9df82">SEMI_RECURSIVE_ROUTING</a> ||
<a name="l01330"></a>01330             <a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551aeec4ce5cac6dae9d3d59b1347a9df957">FULL_RECURSIVE_ROUTING</a> ||
<a name="l01331"></a>01331             <a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551ad8c4eefed3d826e5da402fe582cad2c1">RECURSIVE_SOURCE_ROUTING</a>) {
<a name="l01332"></a>01332             <span class="comment">//TODO real exhaustive-recursive lookup</span>
<a name="l01333"></a>01333             <a class="code" href="classBaseOverlay.html#a205a7d44401fb3d77b146e23b2904b6f" title="Creates an abstract iterative lookup instance.">createLookup</a>()-&gt;<a class="code" href="classAbstractLookup.html#aa1bda70950cbd160ea78d1fcbd8c7767" title="Lookup siblings for a key.">lookup</a>(<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().getKey() + <a class="code" href="classOverlayKey.html#a51a63dbc089143b7742d7da846a16abd" title="OverlayKey with key initialized as 1.">OverlayKey::ONE</a>,
<a name="l01334"></a>01334                                    0, <a class="code" href="classBaseOverlay.html#abffe6fbd25963bc2b7542f22ba6455b9" title="maximum hop count">hopCountMax</a>, 0,
<a name="l01335"></a>01335                                    <span class="keyword">new</span> <a class="code" href="classKademlia.html#a61b072e95046f98ad49a3f5589fe9a45">KademliaLookupListener</a>(<span class="keyword">this</span>));
<a name="l01336"></a>01336         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#ae7a670589ec838bbf79d684fba016185">exhaustiveRefresh</a>) {
<a name="l01337"></a>01337             <span class="comment">//TODO config shit</span>
<a name="l01338"></a>01338             <span class="keywordtype">int</span> baseRedundantNodes = <a class="code" href="classBaseOverlay.html#a32b8cfb47f3ef824dcf6ad882e6a6a9f">iterativeLookupConfig</a>.<a class="code" href="classIterativeLookupConfiguration.html#a5ffefd1d559420cc498307521ae1fac7" title="number of next hops in each step">redundantNodes</a>;
<a name="l01339"></a>01339             <a class="code" href="classBaseOverlay.html#a32b8cfb47f3ef824dcf6ad882e6a6a9f">iterativeLookupConfig</a>.<a class="code" href="classIterativeLookupConfiguration.html#a5ffefd1d559420cc498307521ae1fac7" title="number of next hops in each step">redundantNodes</a> = <a class="code" href="classKademlia.html#ad4d31fcf8c7300404ae07523daab8cc6">siblingRefreshNodes</a>;
<a name="l01340"></a>01340             <a class="code" href="classBaseOverlay.html#a205a7d44401fb3d77b146e23b2904b6f" title="Creates an abstract iterative lookup instance.">createLookup</a>(<a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551ad60cf756d6bb24af372d7fe7c279f44d">EXHAUSTIVE_ITERATIVE_ROUTING</a>)-&gt;<a class="code" href="classAbstractLookup.html#aa1bda70950cbd160ea78d1fcbd8c7767" title="Lookup siblings for a key.">lookup</a>(
<a name="l01341"></a>01341                  <a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().getKey(), <a class="code" href="classKademlia.html#ad4d31fcf8c7300404ae07523daab8cc6">siblingRefreshNodes</a>,
<a name="l01342"></a>01342                  <a class="code" href="classBaseOverlay.html#abffe6fbd25963bc2b7542f22ba6455b9" title="maximum hop count">hopCountMax</a>, 0, <span class="keyword">new</span> <a class="code" href="classKademlia.html#a61b072e95046f98ad49a3f5589fe9a45">KademliaLookupListener</a>(<span class="keyword">this</span>));
<a name="l01343"></a>01343             <a class="code" href="classBaseOverlay.html#a32b8cfb47f3ef824dcf6ad882e6a6a9f">iterativeLookupConfig</a>.<a class="code" href="classIterativeLookupConfiguration.html#a5ffefd1d559420cc498307521ae1fac7" title="number of next hops in each step">redundantNodes</a> = baseRedundantNodes;
<a name="l01344"></a>01344         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a68e77f3b48652f19219a6c6c9a1a76d2">newMaintenance</a>) {
<a name="l01345"></a>01345             <span class="comment">//for (KademliaBucket::iterator i = siblingTable-&gt;begin();</span>
<a name="l01346"></a>01346             <span class="comment">//     i != siblingTable-&gt;end(); i++) {</span>
<a name="l01347"></a>01347 
<a name="l01348"></a>01348             <span class="comment">//    sendSiblingFindNodeCall(*i);</span>
<a name="l01349"></a>01349             <span class="comment">//}</span>
<a name="l01350"></a>01350             <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size()) {
<a name="l01351"></a>01351                 <a class="code" href="classKademlia.html#a837fc1c137eebd1189ff401b4bd97a99">sendSiblingFindNodeCall</a>(<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;at(intuniform(0,<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size()-1)));
<a name="l01352"></a>01352             }
<a name="l01353"></a>01353             <a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> = <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>;
<a name="l01354"></a>01354             <a class="code" href="classBaseOverlay.html#a9da615809e832cbc4645cc732d510277" title="Sets the overlay ready icon and register/deregisters the node at the GlobalNodeList.">setOverlayReady</a>(<span class="keyword">true</span>);
<a name="l01355"></a>01355         } <span class="keywordflow">else</span> {
<a name="l01356"></a>01356             <a class="code" href="classBaseOverlay.html#a205a7d44401fb3d77b146e23b2904b6f" title="Creates an abstract iterative lookup instance.">createLookup</a>()-&gt;<a class="code" href="classAbstractLookup.html#aa1bda70950cbd160ea78d1fcbd8c7767" title="Lookup siblings for a key.">lookup</a>(<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().getKey(), <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a>, <a class="code" href="classBaseOverlay.html#abffe6fbd25963bc2b7542f22ba6455b9" title="maximum hop count">hopCountMax</a>, 0,
<a name="l01357"></a>01357                                    <span class="keyword">new</span> <a class="code" href="classKademlia.html#a61b072e95046f98ad49a3f5589fe9a45">KademliaLookupListener</a>(<span class="keyword">this</span>));
<a name="l01358"></a>01358         }
<a name="l01359"></a>01359         <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;<a class="code" href="classKademliaBucket.html#a8b5481352d9ad3354647e5cae8c6e5fa">setLastUsage</a>(simTime());
<a name="l01360"></a>01360         ++<a class="code" href="classKademlia.html#a9b7cdab70352fcc52c0cfe55541807ef">siblingTableRefreshCount</a>;
<a name="l01361"></a>01361     }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363     <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#ab4be6d88417117fbf33a445d56af2655">state</a> == <a class="code" href="classBaseOverlay.html#a0ad4b12b0c9949661f66db7fbbf7d40fab3a263fb274a58d63b15cd61ba910335">READY</a>) {
<a name="l01364"></a>01364         <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size()) {
<a name="l01365"></a>01365             <span class="comment">// get bit index of most significant digit that differs</span>
<a name="l01366"></a>01366             <span class="comment">// from our next sibling&#39;s key to prevent us from refreshing</span>
<a name="l01367"></a>01367             <span class="comment">// buckets, which can&#39;t contain any nodes</span>
<a name="l01368"></a>01368             int32_t diff = <a class="code" href="classOverlayKey.html#af855a4dfc0e5dc0d2afc6b87fa1d7426" title="Returns the length in number of bits.">OverlayKey::getLength</a>() - <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>*(<a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>().
<a name="l01369"></a>01369                 sharedPrefixLength(<a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;front().getKey(), <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) + 1);
<a name="l01370"></a>01370             <span class="keywordtype">int</span> bucketsRefreshedPerTask = 0;
<a name="l01371"></a>01371             <span class="keywordflow">for</span> (int32_t i = <a class="code" href="classOverlayKey.html#af855a4dfc0e5dc0d2afc6b87fa1d7426" title="Returns the length in number of bits.">OverlayKey::getLength</a>() - <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>; i &gt;= diff; i -=<a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a> ) {
<a name="l01372"></a>01372                 <span class="keywordflow">for</span> (int32_t d=0; d &lt; ((1 &lt;&lt; <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) - 1); d++) {
<a name="l01373"></a>01373                     int32_t index = (i / <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) * ((1 &lt;&lt; <a class="code" href="classKademlia.html#a13735e80816c965e135d6a686d5e4713">b</a>) - 1) + d;
<a name="l01374"></a>01374                     <span class="keywordflow">if</span> (index &lt; 0) <span class="keywordflow">continue</span>;
<a name="l01375"></a>01375                     <span class="keywordflow">if</span> ((<a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index] == NULL) ||
<a name="l01376"></a>01376                         ((simTime() - <a class="code" href="classKademlia.html#a326e44556787c7708ff8b252caff5ad1">routingTable</a>[index]-&gt;getLastUsage()) &gt;
<a name="l01377"></a>01377                         <a class="code" href="classKademlia.html#abda8d541b714ec855d891a2938fa8b3f">minBucketRefreshInterval</a>)) {
<a name="l01378"></a>01378 
<a name="l01379"></a>01379                         <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a> refreshKey =
<a name="l01380"></a>01380                             <a class="code" href="classBaseRpc.html#ac3f420630d5618e81709c078b06fd9da" title="Returns the NodeHandle of this node.">getThisNode</a>().<a class="code" href="classNodeHandle.html#aef531103cdf07c8353267f4d30a80112" title="returns key of this NodeHandle">getKey</a>() ^ (<a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>(d+1) &lt;&lt; i);
<a name="l01381"></a>01381 
<a name="l01382"></a>01382                         <span class="comment">// R/Kademlia</span>
<a name="l01383"></a>01383                         <span class="keywordflow">if</span> (<a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551a18b63fe85aa5e81cd3fca5e3c7c9df82">SEMI_RECURSIVE_ROUTING</a> ||
<a name="l01384"></a>01384                             <a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551aeec4ce5cac6dae9d3d59b1347a9df957">FULL_RECURSIVE_ROUTING</a> ||
<a name="l01385"></a>01385                             <a class="code" href="classBaseOverlay.html#a9e13844ea8090b84a90286f048cdcbf9">defaultRoutingType</a> == <a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551ad8c4eefed3d826e5da402fe582cad2c1">RECURSIVE_SOURCE_ROUTING</a>) {
<a name="l01386"></a>01386                             <span class="comment">//TODO real exhaustive-recursive lookup</span>
<a name="l01387"></a>01387                             <a class="code" href="classBaseOverlay.html#a205a7d44401fb3d77b146e23b2904b6f" title="Creates an abstract iterative lookup instance.">createLookup</a>()-&gt;<a class="code" href="classAbstractLookup.html#aa1bda70950cbd160ea78d1fcbd8c7767" title="Lookup siblings for a key.">lookup</a>(refreshKey, 0,
<a name="l01388"></a>01388                                                    <a class="code" href="classBaseOverlay.html#abffe6fbd25963bc2b7542f22ba6455b9" title="maximum hop count">hopCountMax</a>, 0,
<a name="l01389"></a>01389                                                    <span class="keyword">new</span> <a class="code" href="classKademlia.html#a61b072e95046f98ad49a3f5589fe9a45">KademliaLookupListener</a>(<span class="keyword">this</span>));
<a name="l01390"></a>01390                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classKademlia.html#ae7a670589ec838bbf79d684fba016185">exhaustiveRefresh</a>) {
<a name="l01391"></a>01391                             <span class="comment">//TODO config shit</span>
<a name="l01392"></a>01392                             <span class="keywordtype">int</span> baseRedundantNodes = <a class="code" href="classBaseOverlay.html#a32b8cfb47f3ef824dcf6ad882e6a6a9f">iterativeLookupConfig</a>.<a class="code" href="classIterativeLookupConfiguration.html#a5ffefd1d559420cc498307521ae1fac7" title="number of next hops in each step">redundantNodes</a>;
<a name="l01393"></a>01393                             <a class="code" href="classBaseOverlay.html#a32b8cfb47f3ef824dcf6ad882e6a6a9f">iterativeLookupConfig</a>.<a class="code" href="classIterativeLookupConfiguration.html#a5ffefd1d559420cc498307521ae1fac7" title="number of next hops in each step">redundantNodes</a> = <a class="code" href="classKademlia.html#a5ab8d39b7c098f21d9577d5dfc82a4f4">bucketRefreshNodes</a>;
<a name="l01394"></a>01394                             <a class="code" href="classBaseOverlay.html#a205a7d44401fb3d77b146e23b2904b6f" title="Creates an abstract iterative lookup instance.">createLookup</a>(<a class="code" href="CommonMessages__m_8h.html#a5bbe67ba1134d38bbb89c7c242ba6551ad60cf756d6bb24af372d7fe7c279f44d">EXHAUSTIVE_ITERATIVE_ROUTING</a>)-&gt;<a class="code" href="classAbstractLookup.html#aa1bda70950cbd160ea78d1fcbd8c7767" title="Lookup siblings for a key.">lookup</a>(
<a name="l01395"></a>01395                                 refreshKey, <a class="code" href="classKademlia.html#a5ab8d39b7c098f21d9577d5dfc82a4f4">bucketRefreshNodes</a>, <a class="code" href="classBaseOverlay.html#abffe6fbd25963bc2b7542f22ba6455b9" title="maximum hop count">hopCountMax</a>,
<a name="l01396"></a>01396                                 0, <span class="keyword">new</span> <a class="code" href="classKademlia.html#a61b072e95046f98ad49a3f5589fe9a45">KademliaLookupListener</a>(<span class="keyword">this</span>));
<a name="l01397"></a>01397                             <a class="code" href="classBaseOverlay.html#a32b8cfb47f3ef824dcf6ad882e6a6a9f">iterativeLookupConfig</a>.<a class="code" href="classIterativeLookupConfiguration.html#a5ffefd1d559420cc498307521ae1fac7" title="number of next hops in each step">redundantNodes</a> = baseRedundantNodes;
<a name="l01398"></a>01398                         } <span class="keywordflow">else</span> {
<a name="l01399"></a>01399                             <a class="code" href="classBaseOverlay.html#a205a7d44401fb3d77b146e23b2904b6f" title="Creates an abstract iterative lookup instance.">createLookup</a>()-&gt;<a class="code" href="classAbstractLookup.html#aa1bda70950cbd160ea78d1fcbd8c7767" title="Lookup siblings for a key.">lookup</a>(refreshKey, <a class="code" href="classKademlia.html#aa10a75cebe4964a98840643b84063548">s</a>, <a class="code" href="classBaseOverlay.html#abffe6fbd25963bc2b7542f22ba6455b9" title="maximum hop count">hopCountMax</a>, 0,
<a name="l01400"></a>01400                                              <span class="keyword">new</span> <a class="code" href="classKademlia.html#a61b072e95046f98ad49a3f5589fe9a45">KademliaLookupListener</a>(<span class="keyword">this</span>));
<a name="l01401"></a>01401                         }
<a name="l01402"></a>01402 
<a name="l01403"></a>01403                         ++bucketsRefreshedPerTask;
<a name="l01404"></a>01404                         ++<a class="code" href="classKademlia.html#a210614b1ea667d544d256a1cc5e94490">bucketRefreshCount</a>;
<a name="l01405"></a>01405                         <a class="code" href="classKademlia.html#a7581a168ae2e143001a7a93ff4a1779a">setBucketUsage</a>(refreshKey);
<a name="l01406"></a>01406                     }
<a name="l01407"></a>01407                 }
<a name="l01408"></a>01408             }
<a name="l01409"></a>01409             <a class="code" href="GlobalStatistics_8h.html#af29140ebe8e0a93406a58441f7c5fec8" title="Macro used for recording statistics considering measureNetwIn parameter.">RECORD_STATS</a>(<a class="code" href="classBaseRpc.html#a9552ba3a2b09c83b3c561e65dab9f23d" title="pointer to GlobalStatistics module in this node">globalStatistics</a>-&gt;<a class="code" href="classGlobalStatistics.html#aa41614baf1d51fab0904abb41b642234" title="Record a value to a global cOutVector defined by name.">recordOutVector</a>(
<a name="l01410"></a>01410                                    <span class="stringliteral">&quot;Kademlia: Buckets Refreshed Per Task&quot;</span>,
<a name="l01411"></a>01411                                    bucketsRefreshedPerTask));
<a name="l01412"></a>01412         }
<a name="l01413"></a>01413         <span class="comment">// schedule next bucket refresh process</span>
<a name="l01414"></a>01414         cancelEvent(<a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01415"></a>01415         scheduleAt(simTime() + (std::min(<a class="code" href="classKademlia.html#ae22800e069a69a317d4906a29e4da71d">minSiblingTableRefreshInterval</a>,
<a name="l01416"></a>01416                         <a class="code" href="classKademlia.html#abda8d541b714ec855d891a2938fa8b3f">minBucketRefreshInterval</a>) / 10.0), <a class="code" href="classKademlia.html#aba4bc00b985d8a3758cb2b1b9e4a74b4">bucketRefreshTimer</a>);
<a name="l01417"></a>01417     }
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 <span class="comment">//virtual public: xor metric</span>
<a name="l01421"></a><a class="code" href="classKademlia.html#a8267f4c6d125a1cdd749164f6a1ee65e">01421</a> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a> <a class="code" href="classKademlia.html#a8267f4c6d125a1cdd749164f6a1ee65e" title="This method should implement the distance between two keys.">Kademlia::distance</a>(<span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; x,
<a name="l01422"></a>01422                               <span class="keyword">const</span> <a class="code" href="classOverlayKey.html" title="A common overlay key class.">OverlayKey</a>&amp; y,
<a name="l01423"></a>01423                               <span class="keywordtype">bool</span> useAlternative)<span class="keyword"> const</span>
<a name="l01424"></a>01424 <span class="keyword"></span>{
<a name="l01425"></a>01425     <span class="keywordflow">if</span> (!useAlternative) <span class="keywordflow">return</span> x^y; <span class="comment">// KeyXorMetric().distance(x, y);</span>
<a name="l01426"></a>01426     <span class="keywordflow">return</span> <a class="code" href="classKeyPrefixMetric.html" title="OverlayKey prefix metric.">KeyPrefixMetric</a>().<a class="code" href="classKeyPrefixMetric.html#a78d831ece61ba3e17c9200f4ad733cdb" title="calculates the distance from x to y with the prefix metric">distance</a>(x, y);
<a name="l01427"></a>01427 }
<a name="l01428"></a>01428 
<a name="l01429"></a><a class="code" href="classKademlia.html#acd029f455e0c6150c038c69fa493696c">01429</a> <span class="keywordtype">void</span> <a class="code" href="classKademlia.html#acd029f455e0c6150c038c69fa493696c" title="updates information shown in GUI">Kademlia::updateTooltip</a>()
<a name="l01430"></a>01430 {
<a name="l01431"></a>01431     <span class="keywordflow">if</span> (ev.isGUI()) {
<a name="l01432"></a>01432         std::stringstream ttString;
<a name="l01433"></a>01433 
<a name="l01434"></a>01434         <span class="comment">// show our nodeId in a tooltip</span>
<a name="l01435"></a>01435         ttString &lt;&lt; <span class="stringliteral">&quot;This: &quot;</span> &lt;&lt; <a class="code" href="classBaseRpc.html#a88eb68c06450fd12ea072f471bf1c1b8" title="NodeHandle to this node.">thisNode</a> &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;Siblings: &quot;</span>
<a name="l01436"></a>01436                  &lt;&lt; <a class="code" href="classKademlia.html#a12d33f20db6e3709117f9894e73c6534">siblingTable</a>-&gt;size();
<a name="l01437"></a>01437 
<a name="l01438"></a>01438         getParentModule()-&gt;getParentModule()-&gt;getDisplayString().
<a name="l01439"></a>01439         setTagArg(<span class="stringliteral">&quot;tt&quot;</span>, 0, ttString.str().c_str());
<a name="l01440"></a>01440         getParentModule()-&gt;getDisplayString().
<a name="l01441"></a>01441         setTagArg(<span class="stringliteral">&quot;tt&quot;</span>, 0, ttString.str().c_str());
<a name="l01442"></a>01442         getDisplayString().setTagArg(<span class="stringliteral">&quot;tt&quot;</span>, 0, ttString.str().c_str());
<a name="l01443"></a>01443     }
<a name="l01444"></a>01444 }
<a name="l01445"></a>01445 
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="Kademlia_8cc.html">Kademlia.cc</a>      </li>

    <li class="footer">Generated on Thu Mar 6 2014 14:06:28 for OverSim by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
