<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OverSim: ConnectReaSE.cc Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>


</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">OverSim
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ConnectReaSE_8cc.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">ConnectReaSE.cc</div>  </div>
</div>
<div class="contents">
<a href="ConnectReaSE_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2010 Institut fuer Telematik, Karlsruher Institut fuer Technologie (KIT)</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment">// modify it under the terms of the GNU General Public License</span>
<a name="l00006"></a>00006 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment">// GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l00015"></a>00015 <span class="comment">// along with this program; if not, write to the Free Software</span>
<a name="l00016"></a>00016 <span class="comment">// Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;omnetpp.h&gt;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;IRoutingTable.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;IInterfaceTable.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;IPAddressResolver.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;IPv4InterfaceData.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="ConnectReaSE_8h.html">ConnectReaSE.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="keyword">using namespace </span>::std;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <a class="code" href="ALMTest_8cc.html#a3b5014f410c7989e8bad4b467ecc94cd">Define_Module</a>(<a class="code" href="classConnectReaSE.html">ConnectReaSE</a>);
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="ConnectReaSE_8cc.html#a1638188c632871d5a4a099c223e28daa">00041</a> std::ostream&amp; <a class="code" href="MessageObserver_8cc.html#a8f32b0caa624b1003f9f7a382c634798">operator&lt;&lt;</a>(std::ostream&amp; os, <a class="code" href="classterminalInfo.html">terminalInfo</a>&amp; n)
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043     os &lt;&lt; n.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>;
<a name="l00044"></a>00044     <span class="keywordflow">return</span> os;
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="classConnectReaSE.html#a4318ff9f6c728543ba54d33e9b84b6c9">00047</a> <span class="keywordtype">void</span> <a class="code" href="classConnectReaSE.html#a4318ff9f6c728543ba54d33e9b84b6c9" title="Gather some information about the router node.">ConnectReaSE::initialize</a>(<span class="keywordtype">int</span> stage)
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049     <span class="comment">//EV &lt;&lt; &quot;Connector Stage&quot; &lt;&lt; stage;</span>
<a name="l00050"></a>00050     <span class="keywordflow">if</span> (stage != <a class="code" href="InitStages_8h.html#a42fde1aa1e14a1c45d29061d6e87e532a51360a7e54ff555dc3d078d686500cb9" title="last stage for underlay configurators">MAX_STAGE_UNDERLAY</a>)
<a name="l00051"></a>00051         <span class="keywordflow">return</span>;
<a name="l00052"></a>00052 
<a name="l00053"></a>00053     <span class="comment">//get parameters</span>
<a name="l00054"></a>00054     <a class="code" href="classConnectReaSE.html#a24856f41fcc7f54690a44392de253d3b" title="vector of possible access channels (tx)">channelTypesTx</a> = cStringTokenizer(par(<span class="stringliteral">&quot;channelTypes&quot;</span>), <span class="stringliteral">&quot; &quot;</span>).asVector();
<a name="l00055"></a>00055     <a class="code" href="classConnectReaSE.html#ad78ed96a9c6faf299bd3bd8c074d514a" title="vector of possible access channels (rx)">channelTypesRx</a> = cStringTokenizer(par(<span class="stringliteral">&quot;channelTypesRx&quot;</span>), <span class="stringliteral">&quot; &quot;</span>).asVector();
<a name="l00056"></a>00056     <a class="code" href="classConnectReaSE.html#ae59763cd85903909960aeab8a68dfbd2">channelDiversity</a> = par(<span class="stringliteral">&quot;channelDiversity&quot;</span>);
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     <span class="keywordflow">if</span> (<a class="code" href="classConnectReaSE.html#a24856f41fcc7f54690a44392de253d3b" title="vector of possible access channels (tx)">channelTypesTx</a>.size() &lt; <a class="code" href="classConnectReaSE.html#ad78ed96a9c6faf299bd3bd8c074d514a" title="vector of possible access channels (rx)">channelTypesRx</a>.size()) {
<a name="l00059"></a>00059         <a class="code" href="classConnectReaSE.html#a24856f41fcc7f54690a44392de253d3b" title="vector of possible access channels (tx)">channelTypesTx</a> = <a class="code" href="classConnectReaSE.html#ad78ed96a9c6faf299bd3bd8c074d514a" title="vector of possible access channels (rx)">channelTypesRx</a>;
<a name="l00060"></a>00060     }
<a name="l00061"></a>00061     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classConnectReaSE.html#a24856f41fcc7f54690a44392de253d3b" title="vector of possible access channels (tx)">channelTypesTx</a>.size() &gt; <a class="code" href="classConnectReaSE.html#ad78ed96a9c6faf299bd3bd8c074d514a" title="vector of possible access channels (rx)">channelTypesRx</a>.size()) {
<a name="l00062"></a>00062         <a class="code" href="classConnectReaSE.html#ad78ed96a9c6faf299bd3bd8c074d514a" title="vector of possible access channels (rx)">channelTypesRx</a> = <a class="code" href="classConnectReaSE.html#a24856f41fcc7f54690a44392de253d3b" title="vector of possible access channels (tx)">channelTypesTx</a>;
<a name="l00063"></a>00063     }
<a name="l00064"></a>00064 
<a name="l00065"></a>00065     <span class="comment">// make sure that delay cannot be zero and diversity cannot be below zero</span>
<a name="l00066"></a>00066     <span class="keywordflow">if</span> (<a class="code" href="classConnectReaSE.html#ae59763cd85903909960aeab8a68dfbd2">channelDiversity</a>&gt;=100)
<a name="l00067"></a>00067         <a class="code" href="classConnectReaSE.html#ae59763cd85903909960aeab8a68dfbd2">channelDiversity</a> = 99.99f;
<a name="l00068"></a>00068     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classConnectReaSE.html#ae59763cd85903909960aeab8a68dfbd2">channelDiversity</a>&lt;0)
<a name="l00069"></a>00069         <a class="code" href="classConnectReaSE.html#ae59763cd85903909960aeab8a68dfbd2">channelDiversity</a> = 0;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     <span class="comment">// statistics</span>
<a name="l00072"></a>00072     <a class="code" href="classConnectReaSE.html#a21d47d69488255394b58bf6e8743d9a4" title="vector of node lifetimes">lifetimeVector</a>.setName(<span class="stringliteral">&quot;Terminal Lifetime&quot;</span>);
<a name="l00073"></a>00073 
<a name="l00074"></a>00074     <span class="comment">// set up network</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     cModule* tempModule;
<a name="l00077"></a>00077     cTopology tempTopology(<span class="stringliteral">&quot;tempTopo&quot;</span>);
<a name="l00078"></a>00078     <a class="code" href="structedgePool.html">edgePool</a> tempEdgePool;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     tempTopology.extractByProperty(<span class="stringliteral">&quot;AS&quot;</span>);
<a name="l00082"></a>00082     <a class="code" href="classConnectReaSE.html#a8441d943e922378fab9e9110a07ddc4f">totalCountOfAS</a> = tempTopology.getNumNodes();
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a> = 0;
<a name="l00085"></a>00085     <span class="keywordflow">while</span> (((uint32_t) 1 &lt;&lt; <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a>) &lt; <a class="code" href="classConnectReaSE.html#a8441d943e922378fab9e9110a07ddc4f">totalCountOfAS</a> + 1) {
<a name="l00086"></a>00086         <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a>++;
<a name="l00087"></a>00087     }
<a name="l00088"></a>00088     <a class="code" href="classConnectReaSE.html#a2d261fb5254b0bc82c37604338a35d04">ASShift</a> = 32 - <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090     <span class="keywordflow">if</span> (tempTopology.getNumNodes() == 0) {
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="comment">//no AS topology</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094         tempTopology.extractByProperty(<span class="stringliteral">&quot;RL&quot;</span>);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096         <span class="keywordflow">if</span> (tempTopology.getNumNodes() == 0)
<a name="l00097"></a>00097 
<a name="l00098"></a>00098             <span class="comment">//no router topology</span>
<a name="l00099"></a>00099             opp_error(<span class="stringliteral">&quot;ConnectReaSE: Neither an AS topology nor a router topology was detected.&quot;</span>);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101         <a class="code" href="classConnectReaSE.html#af9833933a3731687ff21cb3288fb5a14" title="Gathers all needed edge router information of a specified autonomous system.">setUpAS</a>(getParentModule());
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103     <span class="keywordflow">else</span> {
<a name="l00104"></a>00104 
<a name="l00105"></a>00105         <span class="comment">// set up all autonomous systems (AS)</span>
<a name="l00106"></a>00106         <span class="keywordtype">int</span> index = 0;
<a name="l00107"></a>00107         std::vector&lt;cModule*&gt; Modules;
<a name="l00108"></a>00108         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;tempTopology.getNumNodes(); i++) {
<a name="l00109"></a>00109 
<a name="l00110"></a>00110             tempModule = tempTopology.getNode(i)-&gt;getModule();
<a name="l00111"></a>00111             Modules.push_back(tempModule);
<a name="l00112"></a>00112             index++;
<a name="l00113"></a>00113         }
<a name="l00114"></a>00114         <span class="keywordflow">for</span> (uint32 i=0; i&lt; Modules.size(); i++) {
<a name="l00115"></a>00115             <a class="code" href="classConnectReaSE.html#af9833933a3731687ff21cb3288fb5a14" title="Gathers all needed edge router information of a specified autonomous system.">setUpAS</a>(Modules[i]);
<a name="l00116"></a>00116         }
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="comment">// put all edge router in one data structure to get a equal probability of selection</span>
<a name="l00120"></a>00120     <span class="keywordflow">for</span> (uint32 i=0; i&lt;<a class="code" href="classConnectReaSE.html#ac663a8011432b547c603d65d2fdf2573">AS_Pool</a>.size(); i++) {
<a name="l00121"></a>00121         <span class="keywordflow">for</span> (uint32 j=0; j&lt; <a class="code" href="classConnectReaSE.html#ac663a8011432b547c603d65d2fdf2573">AS_Pool</a>[i].edgeRouter.size(); j++) {
<a name="l00122"></a>00122             tempEdgePool.<a class="code" href="structedgePool.html#a0bb2dc8707ef38f2a2cf32aab9a00ed3">edge</a> = &amp;<a class="code" href="classConnectReaSE.html#ac663a8011432b547c603d65d2fdf2573">AS_Pool</a>[i].edgeRouter[j];
<a name="l00123"></a>00123             tempEdgePool.<a class="code" href="structedgePool.html#a81524cc97a26dbd600a5c12cbf50ad2d">indexAS</a> = i;
<a name="l00124"></a>00124             <a class="code" href="classConnectReaSE.html#a8edf516fbcddc9160a2d4a3e58f37ba4">globalEdgePool</a>.push_back(tempEdgePool);
<a name="l00125"></a>00125         }
<a name="l00126"></a>00126     }
<a name="l00127"></a>00127     <span class="comment">//cout &lt;&lt; &quot;Number of Edges in Network: &quot; &lt;&lt; globalEdgePool.size() &lt;&lt; endl;</span>
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">for</span> (uint32 i=0; i&lt;<a class="code" href="classConnectReaSE.html#a8edf516fbcddc9160a2d4a3e58f37ba4">globalEdgePool</a>.size(); i++) {
<a name="l00130"></a>00130 
<a name="l00131"></a>00131         <span class="comment">//select channel</span>
<a name="l00132"></a>00132         <a class="code" href="classConnectReaSE.html#a8edf516fbcddc9160a2d4a3e58f37ba4">globalEdgePool</a>[i].edge-&gt;channelTypeTxStr = <a class="code" href="classConnectReaSE.html#a24856f41fcc7f54690a44392de253d3b" title="vector of possible access channels (tx)">channelTypesTx</a>[intuniform(0,<a class="code" href="classConnectReaSE.html#a24856f41fcc7f54690a44392de253d3b" title="vector of possible access channels (tx)">channelTypesTx</a>.size()-1)];
<a name="l00133"></a>00133         <a class="code" href="classConnectReaSE.html#a8edf516fbcddc9160a2d4a3e58f37ba4">globalEdgePool</a>[i].edge-&gt;channelTypeRxStr = <a class="code" href="classConnectReaSE.html#ad78ed96a9c6faf299bd3bd8c074d514a" title="vector of possible access channels (rx)">channelTypesRx</a>[intuniform(0,<a class="code" href="classConnectReaSE.html#ad78ed96a9c6faf299bd3bd8c074d514a" title="vector of possible access channels (rx)">channelTypesRx</a>.size()-1)];
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a><a class="code" href="classConnectReaSE.html#aa37d350c7f2e532e38a086c57fb1aff4">00137</a> <a class="code" href="classAccessInfo.html">AccessInfo</a> <a class="code" href="classConnectReaSE.html#aa37d350c7f2e532e38a086c57fb1aff4" title="Getter for router module.">ConnectReaSE::getAccessNode</a>()
<a name="l00138"></a>00138 {
<a name="l00139"></a>00139     Enter_Method(<span class="stringliteral">&quot;getAccessNode()&quot;</span>);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="keywordtype">bool</span> candidateOK = <span class="keyword">false</span>;
<a name="l00142"></a>00142     <span class="keywordtype">int</span> numTries = 10;
<a name="l00143"></a>00143     uint32 test_IP = 0;
<a name="l00144"></a>00144     <a class="code" href="classAccessInfo.html">AccessInfo</a> node;
<a name="l00145"></a>00145     <a class="code" href="structedgeRoutes.html">edgeRoutes</a>* connectionCandidate;
<a name="l00146"></a>00146     uint32 tempIndex, tempASindex;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="keywordflow">while</span> ((numTries &gt; 0)&amp;&amp;(!candidateOK)) {
<a name="l00149"></a>00149         numTries--;
<a name="l00150"></a>00150         tempIndex = intuniform(0, <a class="code" href="classConnectReaSE.html#a8edf516fbcddc9160a2d4a3e58f37ba4">globalEdgePool</a>.size()-1);
<a name="l00151"></a>00151         connectionCandidate = <a class="code" href="classConnectReaSE.html#a8edf516fbcddc9160a2d4a3e58f37ba4">globalEdgePool</a>[tempIndex].edge;
<a name="l00152"></a>00152         tempASindex = <a class="code" href="classConnectReaSE.html#a8edf516fbcddc9160a2d4a3e58f37ba4">globalEdgePool</a>[tempIndex].indexAS;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154         <span class="comment">//limit terminals per edge router</span>
<a name="l00155"></a>00155         <span class="keywordflow">if</span> (connectionCandidate-&gt;IPAddresses.size() &gt;= ((uint32_t) 1 &lt;&lt; <a class="code" href="classConnectReaSE.html#ac663a8011432b547c603d65d2fdf2573">AS_Pool</a>[tempASindex].edgeShift)) <span class="comment">// maximum reached?</span>
<a name="l00156"></a>00156             <span class="keywordflow">continue</span>;
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="comment">//        test_IP = connectionCandidate-&gt;IPAddress + 1; // begin with first IP after the edge router</span>
<a name="l00159"></a>00159 <span class="comment">//        for (int i = 0; i &lt; (1 &lt;&lt; AS_Pool[tempASindex].edgeShift); i++ ) {</span>
<a name="l00160"></a>00160 <span class="comment">//            test_IP += i;</span>
<a name="l00161"></a>00161 <span class="comment">//            candidateOK = true;</span>
<a name="l00162"></a>00162 <span class="comment">//            for (uint32 j = 0; j &lt; connectionCandidate-&gt;IPAddresses.size(); j++) {</span>
<a name="l00163"></a>00163 <span class="comment">//                if (connectionCandidate-&gt;IPAddresses[j] == test_IP) {</span>
<a name="l00164"></a>00164 <span class="comment">//                    candidateOK =false;</span>
<a name="l00165"></a>00165 <span class="comment">//                    break;</span>
<a name="l00166"></a>00166 <span class="comment">//                }</span>
<a name="l00167"></a>00167 <span class="comment">//            }</span>
<a name="l00168"></a>00168 <span class="comment">//            if (candidateOK) {</span>
<a name="l00169"></a>00169 <span class="comment">//                connectionCandidate-&gt;IPAddresses.push_back(test_IP);</span>
<a name="l00170"></a>00170 <span class="comment">//                break;</span>
<a name="l00171"></a>00171 <span class="comment">//            }</span>
<a name="l00172"></a>00172 <span class="comment">//        }</span>
<a name="l00173"></a>00173 
<a name="l00174"></a>00174         <span class="comment">// FIXME: check overlays for side effects of reused IP addresses</span>
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         test_IP = ++connectionCandidate-&gt;lastIP;
<a name="l00177"></a>00177         connectionCandidate-&gt;IPAddresses.push_back(test_IP);
<a name="l00178"></a>00178         <span class="keywordflow">break</span>;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <span class="comment">// no free IP address after 10 tries</span>
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (numTries == 0) {
<a name="l00184"></a>00184         opp_error(<span class="stringliteral">&quot;Error creating node: No available IP found after four tries!&quot;</span>);
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186     EV &lt;&lt; <span class="stringliteral">&quot;Found available IP: &quot;</span> &lt;&lt; test_IP;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     node.<a class="code" href="classAccessInfo.html#a74b813f7ff1a23b64c2eb801cee8e70c">ASindex</a> = tempASindex;
<a name="l00189"></a>00189     node.<a class="code" href="classAccessInfo.html#ae05b16041d0b945d32ea3125f0cb6407">IPAddress</a> = test_IP;
<a name="l00190"></a>00190     node.<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a> = connectionCandidate;
<a name="l00191"></a>00191     <span class="keywordflow">return</span> node;
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00194"></a><a class="code" href="classConnectReaSE.html#afae70fcc4fd62b2747f9baf1d6447330">00194</a> <span class="keywordtype">int</span> <a class="code" href="classConnectReaSE.html#afae70fcc4fd62b2747f9baf1d6447330" title="Gathers some information about the terminal and appends it to the overlay terminal vector...">ConnectReaSE::addOverlayNode</a>(<a class="code" href="classAccessInfo.html">AccessInfo</a>* overlayNode, <span class="keywordtype">bool</span> migrate)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196         Enter_Method(<span class="stringliteral">&quot;addOverlayNode()&quot;</span>);
<a name="l00197"></a>00197 
<a name="l00198"></a>00198         cModule* node = overlayNode-&gt;<a class="code" href="classAccessInfo.html#a48944dd1e43c1bd33426702a407d03df">terminal</a>;
<a name="l00199"></a>00199         <a class="code" href="classterminalInfo.html">terminalInfo</a> terminal;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201         terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a> = node;
<a name="l00202"></a>00202         terminal.<a class="code" href="classterminalInfo.html#a50fbfff2fba9fcd72e053689db98c923" title="pointer to interface table of this node">interfaceTable</a> = IPAddressResolver().interfaceTableOf(node);
<a name="l00203"></a>00203         terminal.<a class="code" href="classterminalInfo.html#a9bf03765a0e35a01e548613c7a2eab4a" title="pointer to remote interface table">remoteInterfaceTable</a> = overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#ae1e6d1225b81f330cf5ee3d493865b57" title="pointer to interface table of this node">interfaceTable</a>;
<a name="l00204"></a>00204         terminal.<a class="code" href="classterminalInfo.html#a475ba5ee011aac82489771a130df4305" title="pointer to routing table of this node">routingTable</a> = IPAddressResolver().routingTableOf(node);
<a name="l00205"></a>00205         terminal.<a class="code" href="classterminalInfo.html#ab6b7e65e87b22cc68557b57657c44c0e" title="pointer to PPP module">PPPInterface</a> = node-&gt;getSubmodule(<span class="stringliteral">&quot;ppp&quot;</span>, 0);
<a name="l00206"></a>00206         terminal.<a class="code" href="classterminalInfo.html#a0ac54cc168a9d3ca6d9d37e7b37e99b4" title="creation timestamp">createdAt</a> = simTime();
<a name="l00207"></a>00207         terminal.<a class="code" href="classterminalInfo.html#a2efa1f945863b8747b7264695679dcda" title="the IP Address">IPAddress</a> = overlayNode-&gt;<a class="code" href="classAccessInfo.html#ae05b16041d0b945d32ea3125f0cb6407">IPAddress</a>;
<a name="l00208"></a>00208         terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a> = overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>;
<a name="l00209"></a>00209         terminal.<a class="code" href="classterminalInfo.html#a07da8863c6c9af65bc3f336374ef8a92">ASindex</a> = overlayNode-&gt;<a class="code" href="classAccessInfo.html#a74b813f7ff1a23b64c2eb801cee8e70c">ASindex</a>;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <span class="comment">// update display</span>
<a name="l00212"></a>00212         <span class="keywordflow">if</span> (ev.isGUI()) {
<a name="l00213"></a>00213                 <span class="keyword">const</span> <span class="keywordtype">char</span>* ip_disp = <span class="keyword">const_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>
<a name="l00214"></a>00214                 (IPAddress(terminal.<a class="code" href="classterminalInfo.html#a2efa1f945863b8747b7264695679dcda" title="the IP Address">IPAddress</a>).str().c_str());
<a name="l00215"></a>00215                 terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>-&gt;getDisplayString().insertTag(<span class="stringliteral">&quot;t&quot;</span>, 0);
<a name="l00216"></a>00216                 terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;t&quot;</span>, 0, ip_disp);
<a name="l00217"></a>00217                 terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>-&gt;getDisplayString().setTagArg(<span class="stringliteral">&quot;t&quot;</span>, 1, <span class="stringliteral">&quot;l&quot;</span>);
<a name="l00218"></a>00218         }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220         <span class="comment">//find first unused interface</span>
<a name="l00221"></a>00221         <span class="keywordtype">int</span> k = 1;
<a name="l00222"></a>00222         <span class="keywordflow">while</span> ( overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>-&gt;findSubmodule(<span class="stringliteral">&quot;ppp&quot;</span>, k) != -1 )
<a name="l00223"></a>00223             k++;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 
<a name="l00226"></a>00226         cModuleType* pppInterfaceModuleType = cModuleType::get(<span class="stringliteral">&quot;inet.linklayer.ppp.PPPInterface&quot;</span>);
<a name="l00227"></a>00227         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a> = pppInterfaceModuleType-&gt;
<a name="l00228"></a>00228         create(<span class="stringliteral">&quot;ppp&quot;</span>, overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>, 0, k);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#ada7ec401234d5ce01ae2a01788e477c2">countPPPInterfaces</a>++;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 
<a name="l00233"></a>00233         <span class="comment">// connect terminal to access router and vice versa</span>
<a name="l00234"></a>00234         cGate* routerInGate = <a class="code" href="classConnectReaSE.html#ad233dcff5200ab7ccfe0f95dc7961a09" title="Returns a module&#39;s fist unconnected gate.">firstUnusedGate</a>(overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>, <span class="stringliteral">&quot;pppg&quot;</span>, cGate::INPUT);
<a name="l00235"></a>00235         cGate* routerOutGate = <a class="code" href="classConnectReaSE.html#ad233dcff5200ab7ccfe0f95dc7961a09" title="Returns a module&#39;s fist unconnected gate.">firstUnusedGate</a>(overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>, <span class="stringliteral">&quot;pppg&quot;</span>, cGate::OUTPUT);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237         cChannelType* channelTypeRx = cChannelType::find( overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a1e0d033f54f06c7c0d4e900fb6cb9dba" title="the current active channel type (rx)">channelTypeRxStr</a>.c_str() );
<a name="l00238"></a>00238         cChannelType* channelTypeTx = cChannelType::find( overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#afd232b4105f1b6fa30315732e7ef18d5" title="the current active channel type (tx)">channelTypeTxStr</a>.c_str() );
<a name="l00239"></a>00239         <span class="keywordflow">if</span> (!channelTypeRx || !channelTypeTx)
<a name="l00240"></a>00240             opp_error(<span class="stringliteral">&quot;Could not find Channel or ChannelRx Type. Most likely &quot;</span>
<a name="l00241"></a>00241                 <span class="stringliteral">&quot;parameter channelTypes does not match the channels defined &quot;</span>
<a name="l00242"></a>00242                 <span class="stringliteral">&quot;in channels.ned&quot;</span>);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="comment">//create channels</span>
<a name="l00245"></a>00245         cDatarateChannel* channelRx = check_and_cast&lt;cDatarateChannel*&gt;(channelTypeRx-&gt;create(overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a1e0d033f54f06c7c0d4e900fb6cb9dba" title="the current active channel type (rx)">channelTypeRxStr</a>.c_str()));
<a name="l00246"></a>00246         cDatarateChannel* channelTx = check_and_cast&lt;cDatarateChannel*&gt;(channelTypeTx-&gt;create(overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#afd232b4105f1b6fa30315732e7ef18d5" title="the current active channel type (tx)">channelTypeTxStr</a>.c_str()));
<a name="l00247"></a>00247 
<a name="l00248"></a>00248         <span class="comment">//connect terminal</span>
<a name="l00249"></a>00249         terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>-&gt;gate(<span class="stringliteral">&quot;pppg$o&quot;</span>, 0)-&gt;connectTo(routerInGate,channelRx);
<a name="l00250"></a>00250         routerOutGate-&gt;connectTo(terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>-&gt;gate(<span class="stringliteral">&quot;pppg$i&quot;</span>, 0),channelTx);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252         <span class="comment">// connect ppp interface module to router module and vice versa</span>
<a name="l00253"></a>00253         routerInGate-&gt;connectTo(terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;gate(<span class="stringliteral">&quot;phys$i&quot;</span>));
<a name="l00254"></a>00254         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;gate(<span class="stringliteral">&quot;phys$o&quot;</span>)-&gt;connectTo(routerOutGate);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="comment">// connect ppp interface module to network layer module and vice versa</span>
<a name="l00257"></a>00257         cModule* netwModule = overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>-&gt;getSubmodule(<span class="stringliteral">&quot;networkLayer&quot;</span>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259         cGate* netwInGate = <a class="code" href="classConnectReaSE.html#ad233dcff5200ab7ccfe0f95dc7961a09" title="Returns a module&#39;s fist unconnected gate.">firstUnusedGate</a>(netwModule, <span class="stringliteral">&quot;ifIn&quot;</span>);
<a name="l00260"></a>00260         cGate* netwOutGate = <a class="code" href="classConnectReaSE.html#ad233dcff5200ab7ccfe0f95dc7961a09" title="Returns a module&#39;s fist unconnected gate.">firstUnusedGate</a>(netwModule, <span class="stringliteral">&quot;ifOut&quot;</span>);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         netwOutGate-&gt;connectTo(terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;gate(<span class="stringliteral">&quot;netwIn&quot;</span>));
<a name="l00263"></a>00263         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;gate(<span class="stringliteral">&quot;netwOut&quot;</span>)-&gt;connectTo(netwInGate);
<a name="l00264"></a>00264 
<a name="l00265"></a>00265         <span class="comment">// connect network layer module to ip and arp modules</span>
<a name="l00266"></a>00266         cModule* ipModule = overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>-&gt;getSubmodule(<span class="stringliteral">&quot;networkLayer&quot;</span>)-&gt;
<a name="l00267"></a>00267         getSubmodule(<span class="stringliteral">&quot;ip&quot;</span>);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         cGate* ipIn = <a class="code" href="classConnectReaSE.html#ad233dcff5200ab7ccfe0f95dc7961a09" title="Returns a module&#39;s fist unconnected gate.">firstUnusedGate</a>(ipModule, <span class="stringliteral">&quot;queueIn&quot;</span>);
<a name="l00270"></a>00270         netwInGate-&gt;connectTo(ipIn);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="comment">//</span>
<a name="l00273"></a>00273         <span class="comment">// Start ppp interface modules</span>
<a name="l00274"></a>00274         <span class="comment">//</span>
<a name="l00275"></a>00275         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;finalizeParameters();
<a name="l00276"></a>00276         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;setDisplayString(<span class="stringliteral">&quot;i=block/ifcard&quot;</span>);
<a name="l00277"></a>00277         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;buildInside();
<a name="l00278"></a>00278         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;scheduleStart(simTime());
<a name="l00279"></a>00279         terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>-&gt;callInitialize();
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <span class="keywordflow">if</span> ( !migrate) {
<a name="l00282"></a>00282             <span class="comment">// we are already in stage 4 and need to call initialize</span>
<a name="l00283"></a>00283         <span class="comment">// for all previous stages manually</span>
<a name="l00284"></a>00284             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; <a class="code" href="InitStages_8h.html#a42fde1aa1e14a1c45d29061d6e87e532a51360a7e54ff555dc3d078d686500cb9" title="last stage for underlay configurators">MAX_STAGE_UNDERLAY</a> + 1; i++) {
<a name="l00285"></a>00285                 terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>-&gt;callInitialize(i);
<a name="l00286"></a>00286             }
<a name="l00287"></a>00287         }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="comment">//calculate diversity factor for both channels (+/- diversity)</span>
<a name="l00290"></a>00290         <span class="keywordtype">double</span> diversityFactor = (uniform(0 , 2*<a class="code" href="classConnectReaSE.html#ae59763cd85903909960aeab8a68dfbd2">channelDiversity</a>) + (100-<a class="code" href="classConnectReaSE.html#ae59763cd85903909960aeab8a68dfbd2">channelDiversity</a>))/100;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292         <span class="comment">//customize channel delays</span>
<a name="l00293"></a>00293         channelRx-&gt;setDelay(SIMTIME_DBL(channelRx-&gt;getDelay()*diversityFactor));
<a name="l00294"></a>00294         channelTx-&gt;setDelay(SIMTIME_DBL(channelTx-&gt;getDelay()*diversityFactor));
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         terminal.<a class="code" href="classterminalInfo.html#acd356c0302b251f8eb4551b967b9f166" title="pointer to remote interface entry">remoteInterfaceEntry</a> = overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#ae1e6d1225b81f330cf5ee3d493865b57" title="pointer to interface table of this node">interfaceTable</a>-&gt;getInterface(
<a name="l00297"></a>00297         overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#ae1e6d1225b81f330cf5ee3d493865b57" title="pointer to interface table of this node">interfaceTable</a>-&gt;getNumInterfaces() - 1);
<a name="l00298"></a>00298         terminal.<a class="code" href="classterminalInfo.html#a47854146e0218c6e8ccc1cbc0feec54e" title="pointer to interface entry">interfaceEntry</a> = terminal.<a class="code" href="classterminalInfo.html#a50fbfff2fba9fcd72e053689db98c923" title="pointer to interface table of this node">interfaceTable</a>-&gt;getInterfaceByName(<span class="stringliteral">&quot;ppp0&quot;</span>);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         <span class="comment">//</span>
<a name="l00302"></a>00302         <span class="comment">// Fill in interface table.</span>
<a name="l00303"></a>00303         <span class="comment">//</span>
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <span class="comment">// router</span>
<a name="l00306"></a>00306         IPv4InterfaceData* interfaceData = <span class="keyword">new</span> IPv4InterfaceData;
<a name="l00307"></a>00307         interfaceData-&gt;setIPAddress(overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#af3ed267ce08be24bcf462bc73d65710c" title="the IP Address">IPAddress</a>);
<a name="l00308"></a>00308         interfaceData-&gt;setNetmask(IPAddress::ALLONES_ADDRESS);
<a name="l00309"></a>00309         terminal.<a class="code" href="classterminalInfo.html#acd356c0302b251f8eb4551b967b9f166" title="pointer to remote interface entry">remoteInterfaceEntry</a>-&gt;setIPv4Data(interfaceData);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311         <span class="comment">// terminal</span>
<a name="l00312"></a>00312         terminal.<a class="code" href="classterminalInfo.html#a47854146e0218c6e8ccc1cbc0feec54e" title="pointer to interface entry">interfaceEntry</a>-&gt;ipv4Data()-&gt;setIPAddress(IPAddress(terminal.<a class="code" href="classterminalInfo.html#a2efa1f945863b8747b7264695679dcda" title="the IP Address">IPAddress</a>));
<a name="l00313"></a>00313         terminal.<a class="code" href="classterminalInfo.html#a47854146e0218c6e8ccc1cbc0feec54e" title="pointer to interface entry">interfaceEntry</a>-&gt;ipv4Data()-&gt;setNetmask(IPAddress::ALLONES_ADDRESS);
<a name="l00314"></a>00314 
<a name="l00315"></a>00315         <span class="comment">//</span>
<a name="l00316"></a>00316         <span class="comment">// Fill in routing table.</span>
<a name="l00317"></a>00317         <span class="comment">//</span>
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 
<a name="l00320"></a>00320         <span class="comment">// add edge routing entry</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         IPRoute* <a class="code" href="VastDefs_8h.html#a51f63d24f02be00251e895721eae51b0">re</a> = <span class="keyword">new</span> IPRoute();
<a name="l00323"></a>00323         re-&gt;setHost(IPAddress(terminal.<a class="code" href="classterminalInfo.html#a2efa1f945863b8747b7264695679dcda" title="the IP Address">IPAddress</a>));
<a name="l00324"></a>00324         re-&gt;setNetmask(IPAddress::ALLONES_ADDRESS);
<a name="l00325"></a>00325         re-&gt;setInterface(terminal.<a class="code" href="classterminalInfo.html#acd356c0302b251f8eb4551b967b9f166" title="pointer to remote interface entry">remoteInterfaceEntry</a>);
<a name="l00326"></a>00326         re-&gt;setType(IPRoute::DIRECT);
<a name="l00327"></a>00327         re-&gt;setSource(IPRoute::MANUAL);
<a name="l00328"></a>00328         overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#aefa548eb16e3c9b5b599be88877eaf16" title="pointer to routing table of this node">routingTable</a>-&gt;addRoute(re);
<a name="l00329"></a>00329         terminal.<a class="code" href="classterminalInfo.html#a4e1be84f6ca0fcb40430b7fb8ac657f1">remoteRoutingEntry</a> = <a class="code" href="VastDefs_8h.html#a51f63d24f02be00251e895721eae51b0">re</a>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="comment">//  add terminal routing entry</span>
<a name="l00333"></a>00333         IPRoute* te = <span class="keyword">new</span> IPRoute();
<a name="l00334"></a>00334         te-&gt;setHost(IPAddress::UNSPECIFIED_ADDRESS);
<a name="l00335"></a>00335         te-&gt;setNetmask(IPAddress::UNSPECIFIED_ADDRESS);
<a name="l00336"></a>00336         te-&gt;setGateway(overlayNode-&gt;<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#af3ed267ce08be24bcf462bc73d65710c" title="the IP Address">IPAddress</a>);
<a name="l00337"></a>00337         te-&gt;setInterface(terminal.<a class="code" href="classterminalInfo.html#a47854146e0218c6e8ccc1cbc0feec54e" title="pointer to interface entry">interfaceEntry</a>);
<a name="l00338"></a>00338         te-&gt;setType(IPRoute::REMOTE);
<a name="l00339"></a>00339         te-&gt;setSource(IPRoute::MANUAL);
<a name="l00340"></a>00340         terminal.<a class="code" href="classterminalInfo.html#a475ba5ee011aac82489771a130df4305" title="pointer to routing table of this node">routingTable</a>-&gt;addRoute(te);
<a name="l00341"></a>00341         terminal.<a class="code" href="classterminalInfo.html#af926269e7f2ccac4256b6f4ac9b77338" title="pointer to routing entry">routingEntry</a> = te;
<a name="l00342"></a>00342 
<a name="l00343"></a>00343         <span class="comment">// append module to overlay terminal vector</span>
<a name="l00344"></a>00344         <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.push_back(terminal);
<a name="l00345"></a>00345         <a class="code" href="classConnectReaSE.html#a4d5218edbd0da581ade977fbcd190627" title="Displays the current number of terminals connected to the network.">updateDisplayString</a>();
<a name="l00346"></a>00346         <span class="keywordtype">int</span> ID = node-&gt;getId();
<a name="l00347"></a>00347         <span class="keywordflow">return</span> ID;
<a name="l00348"></a>00348 }
<a name="l00349"></a>00349 
<a name="l00350"></a><a class="code" href="classConnectReaSE.html#a05a2bf92b9835d8c8c08984d76f63816">00350</a> cModule* <a class="code" href="classConnectReaSE.html#a05a2bf92b9835d8c8c08984d76f63816" title="Removes a node from the network.">ConnectReaSE::removeOverlayNode</a>(<span class="keywordtype">int</span> ID)
<a name="l00351"></a>00351 {
<a name="l00352"></a>00352     Enter_Method(<span class="stringliteral">&quot;removeOverlayNode()&quot;</span>);
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     cModule* node = NULL;
<a name="l00355"></a>00355     <a class="code" href="classterminalInfo.html">terminalInfo</a> terminal;
<a name="l00356"></a>00356     <span class="keywordtype">int</span> index = 0;
<a name="l00357"></a>00357     uint32 releasedIP;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="comment">// find module</span>
<a name="l00360"></a>00360     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.size(); i++) {
<a name="l00361"></a>00361         <span class="keywordflow">if</span> (<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>[i].module-&gt;getId() == ID) {
<a name="l00362"></a>00362             terminal = <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>[i];
<a name="l00363"></a>00363             node = terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>;
<a name="l00364"></a>00364             index = i;
<a name="l00365"></a>00365             <span class="keywordflow">break</span>;
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (node == NULL) <span class="keywordflow">return</span> NULL;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     releasedIP = IPAddressResolver().addressOf(terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a>).get4().getInt();;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="comment">// free IP address</span>
<a name="l00375"></a>00375     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#a7fa36c1eb55617b5c9b33e37870e2ba6" title="the IP Addresses in use of edge router">IPAddresses</a>.size(); i++) {
<a name="l00376"></a>00376             <span class="keywordflow">if</span> (terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#a7fa36c1eb55617b5c9b33e37870e2ba6" title="the IP Addresses in use of edge router">IPAddresses</a>[i] == releasedIP) {
<a name="l00377"></a>00377                 terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#a7fa36c1eb55617b5c9b33e37870e2ba6" title="the IP Addresses in use of edge router">IPAddresses</a>.erase(terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#a7fa36c1eb55617b5c9b33e37870e2ba6" title="the IP Addresses in use of edge router">IPAddresses</a>.begin() + i);
<a name="l00378"></a>00378                 <span class="keywordflow">break</span>;
<a name="l00379"></a>00379             }
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     cModule* ppp = terminal.<a class="code" href="classterminalInfo.html#aaece03afdd80a1b86413fda0fd52cdd0" title="pointer to remote PPP module">remotePPPInterface</a>;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <span class="comment">// disconnect terminal</span>
<a name="l00387"></a>00387     node-&gt;gate(<span class="stringliteral">&quot;pppg$o&quot;</span>, 0)-&gt;disconnect();
<a name="l00388"></a>00388     node-&gt;gate(<span class="stringliteral">&quot;pppg$i&quot;</span>, 0)-&gt;getPreviousGate()-&gt;disconnect();
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <span class="comment">// disconnect ip and arp modules</span>
<a name="l00391"></a>00391     ppp-&gt;gate(<span class="stringliteral">&quot;netwIn&quot;</span>)-&gt;getPathStartGate()-&gt;disconnect();
<a name="l00392"></a>00392     ppp-&gt;gate(<span class="stringliteral">&quot;netwOut&quot;</span>)-&gt;getNextGate()-&gt;disconnect();
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="comment">// remove associated ppp interface module</span>
<a name="l00395"></a>00395     ppp-&gt;callFinish();
<a name="l00396"></a>00396     ppp-&gt;deleteModule();
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#ada7ec401234d5ce01ae2a01788e477c2">countPPPInterfaces</a>--;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="comment">// remove associated interface table entry</span>
<a name="l00401"></a>00401     terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#ae1e6d1225b81f330cf5ee3d493865b57" title="pointer to interface table of this node">interfaceTable</a>-&gt;deleteInterface(terminal.<a class="code" href="classterminalInfo.html#acd356c0302b251f8eb4551b967b9f166" title="pointer to remote interface entry">remoteInterfaceEntry</a>);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment">// remove routing entries</span>
<a name="l00404"></a>00404 
<a name="l00405"></a>00405     terminal.<a class="code" href="classterminalInfo.html#a475ba5ee011aac82489771a130df4305" title="pointer to routing table of this node">routingTable</a>-&gt;deleteRoute(terminal.<a class="code" href="classterminalInfo.html#af926269e7f2ccac4256b6f4ac9b77338" title="pointer to routing entry">routingEntry</a>);
<a name="l00406"></a>00406     terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#aefa548eb16e3c9b5b599be88877eaf16" title="pointer to routing table of this node">routingTable</a> -&gt;deleteRoute(terminal.<a class="code" href="classterminalInfo.html#a4e1be84f6ca0fcb40430b7fb8ac657f1">remoteRoutingEntry</a>);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="comment">//TODO: implement life vector statistics</span>
<a name="l00409"></a>00409     <a class="code" href="classConnectReaSE.html#a21d47d69488255394b58bf6e8743d9a4" title="vector of node lifetimes">lifetimeVector</a>.record(simTime() - <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>[index].createdAt);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="comment">// remove terminal from overlay terminal vector</span>
<a name="l00412"></a>00412     <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.erase(<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.begin() + index);
<a name="l00413"></a>00413 
<a name="l00414"></a>00414      <a class="code" href="classConnectReaSE.html#a4d5218edbd0da581ade977fbcd190627" title="Displays the current number of terminals connected to the network.">updateDisplayString</a>();
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="keywordflow">return</span> node;
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 
<a name="l00419"></a><a class="code" href="classConnectReaSE.html#a363fd647694e7a4861d9772370215c62">00419</a> cModule* <a class="code" href="classConnectReaSE.html#a363fd647694e7a4861d9772370215c62" title="searches overlayTerminal[] for a given node">ConnectReaSE::getOverlayNode</a>(<span class="keywordtype">int</span> ID)
<a name="l00420"></a>00420 {
<a name="l00421"></a>00421     Enter_Method(<span class="stringliteral">&quot;getOverlayNode()&quot;</span>);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     cModule* node = NULL;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.size(); i++) {
<a name="l00426"></a>00426         <span class="keywordflow">if</span> (<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>[i].module-&gt;getId() == ID) {
<a name="l00427"></a>00427             node = <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>[i].module;
<a name="l00428"></a>00428             <span class="keywordflow">return</span> node;
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431     opp_error(<span class="stringliteral">&quot;Node was not found in global list of overlay terminals&quot;</span>);
<a name="l00432"></a>00432     <span class="keywordflow">return</span> node;
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00435"></a><a class="code" href="classConnectReaSE.html#a20dba668e41ac6e1355a8a3532c25f6d">00435</a> <a class="code" href="classAccessInfo.html">AccessInfo</a> <a class="code" href="classConnectReaSE.html#a20dba668e41ac6e1355a8a3532c25f6d">ConnectReaSE::migrateNode</a>(<span class="keywordtype">int</span> ID)
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     Enter_Method(<span class="stringliteral">&quot;migrateNode()&quot;</span>);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <a class="code" href="classAccessInfo.html">AccessInfo</a> newEdgeRouter;
<a name="l00441"></a>00441     <a class="code" href="classterminalInfo.html">terminalInfo</a> terminal;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.size(); i++) {
<a name="l00444"></a>00444         <span class="keywordflow">if</span> (<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>[i].module-&gt;getId() == ID) {
<a name="l00445"></a>00445             terminal = <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>[i];
<a name="l00446"></a>00446             <span class="keywordflow">break</span>;
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="keywordflow">if</span> (terminal.<a class="code" href="classterminalInfo.html#a094488a8ad3932070581ddc9006e9990">module</a> == NULL) opp_error(<span class="stringliteral">&quot;ConnectReaSE: Cannot find migrating node&quot;</span>);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="keywordflow">do</span> {
<a name="l00453"></a>00453         newEdgeRouter = <a class="code" href="classConnectReaSE.html#aa37d350c7f2e532e38a086c57fb1aff4" title="Getter for router module.">getAccessNode</a>();
<a name="l00454"></a>00454     }
<a name="l00455"></a>00455     <span class="keywordflow">while</span> ((newEdgeRouter.<a class="code" href="classAccessInfo.html#a669108287d313f4f14584077e8b8f20d">edge</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>-&gt;getId() == terminal.<a class="code" href="classterminalInfo.html#af420b1c28fc4a3dc8ab46d67722745a0" title="pointer to connected edge router">edgeRouter</a>-&gt;<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>-&gt;getId()) &amp;&amp; (<a class="code" href="classConnectReaSE.html#ac663a8011432b547c603d65d2fdf2573">AS_Pool</a>[terminal.<a class="code" href="classterminalInfo.html#a07da8863c6c9af65bc3f336374ef8a92">ASindex</a>].edgeRouter.size()!= 1));
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <span class="keywordflow">return</span> newEdgeRouter;
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 
<a name="l00460"></a><a class="code" href="classConnectReaSE.html#a6e79eeb020470d53fcf215f57bfddd59">00460</a> <span class="keywordtype">void</span> <a class="code" href="classConnectReaSE.html#a6e79eeb020470d53fcf215f57bfddd59" title="OMNeT handleMessage method.">ConnectReaSE::handleMessage</a>(cMessage* msg)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462     <a class="code" href="yang_8cc.html#adb989392f8aada21b0f7ec2f7a41dc00">error</a>(<span class="stringliteral">&quot;this module doesn&#39;t handle messages, it runs only in initialize()&quot;</span>);
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a><a class="code" href="classConnectReaSE.html#a4d5218edbd0da581ade977fbcd190627">00465</a> <span class="keywordtype">void</span> <a class="code" href="classConnectReaSE.html#a4d5218edbd0da581ade977fbcd190627" title="Displays the current number of terminals connected to the network.">ConnectReaSE::updateDisplayString</a>()
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (ev.isGUI()) {
<a name="l00468"></a>00468         <span class="keywordtype">char</span> buf[80];
<a name="l00469"></a>00469         <span class="keywordflow">if</span> ( <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.size() == 1 ) {
<a name="l00470"></a>00470             sprintf(buf, <span class="stringliteral">&quot;1 terminal connected&quot;</span>);
<a name="l00471"></a>00471         } <span class="keywordflow">else</span> {
<a name="l00472"></a>00472             sprintf(buf, <span class="stringliteral">&quot;%zi terminals connected&quot;</span>, <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.size());
<a name="l00473"></a>00473         }
<a name="l00474"></a>00474         getDisplayString().setTagArg(<span class="stringliteral">&quot;t&quot;</span>, 0, buf);
<a name="l00475"></a>00475         getDisplayString().setTagArg(<span class="stringliteral">&quot;t&quot;</span>, 2, <span class="stringliteral">&quot;blue&quot;</span>);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         <span class="keywordflow">if</span> ((<a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.size() % 100) == 0) {
<a name="l00478"></a>00478             cerr &lt;&lt; <span class="stringliteral">&quot;ConnectReaSE: &quot;</span> &lt;&lt; <a class="code" href="classConnectReaSE.html#aa7816705c6d6cbb1a59ef0106e4977ff" title="the terminals at this access router">overlayTerminal</a>.size() &lt;&lt; <span class="stringliteral">&quot; Terminals connected in network.&quot;</span> &lt;&lt;endl;
<a name="l00479"></a>00479         }
<a name="l00480"></a>00480     }
<a name="l00481"></a>00481 }
<a name="l00482"></a>00482 
<a name="l00483"></a><a class="code" href="classConnectReaSE.html#ad233dcff5200ab7ccfe0f95dc7961a09">00483</a> cGate* <a class="code" href="classConnectReaSE.html#ad233dcff5200ab7ccfe0f95dc7961a09" title="Returns a module&#39;s fist unconnected gate.">ConnectReaSE::firstUnusedGate</a>(cModule* owner, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, cGate::Type type)
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485     <span class="keywordtype">int</span> index;
<a name="l00486"></a>00486     <span class="keywordflow">for</span> (index = 0; index &lt; owner-&gt;gateSize(name); index++) {
<a name="l00487"></a>00487         cGate *gate = type == <a class="code" href="ProximityLookupMessages__m_8h.html#a02f73627129187329ff5fa9f6519f53dac157bdf0b85a40d2619cbc8bc1ae5fe2">cGate::NONE</a> ? owner-&gt;gate(name, index) : owner-&gt;gateHalf(name, type, index);
<a name="l00488"></a>00488         <span class="keywordflow">if</span> (!gate-&gt;isConnectedOutside()) {
<a name="l00489"></a>00489             <span class="keywordflow">return</span> gate;
<a name="l00490"></a>00490         }
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     owner-&gt;setGateSize(name, index + 2);
<a name="l00494"></a>00494     <span class="keywordflow">return</span> type == <a class="code" href="ProximityLookupMessages__m_8h.html#a02f73627129187329ff5fa9f6519f53dac157bdf0b85a40d2619cbc8bc1ae5fe2">cGate::NONE</a> ? owner-&gt;gate(name, index + 1) : owner-&gt;gateHalf(name, type, index + 1);
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a><a class="code" href="classConnectReaSE.html#ad06fadd6babf16d663b1d3353fb5675b">00497</a> <span class="keywordtype">bool</span> <a class="code" href="classConnectReaSE.html#ad06fadd6babf16d663b1d3353fb5675b" title="Finds submodules with special properties.">ConnectReaSE::extractFromParentModule</a>(cModule* currModule, <span class="keywordtype">void</span>* properties)
<a name="l00498"></a>00498 {
<a name="l00499"></a>00499     <a class="code" href="structtopologyProperty.html">topologyProperty</a>* currProp = (<a class="code" href="structtopologyProperty.html">topologyProperty</a>*)properties;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="keywordflow">if</span> (currModule-&gt;getParentModule() == currProp-&gt;<a class="code" href="structtopologyProperty.html#a698757c69affe4b1f784eab4985f0e85">pModule</a>) {
<a name="l00502"></a>00502         <span class="keywordflow">if</span> (currModule-&gt;getProperties()-&gt;get(currProp-&gt;<a class="code" href="structtopologyProperty.html#a1c2bc020bd4d7a8f08473988ac523e80">property</a>)) {
<a name="l00503"></a>00503             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a><a class="code" href="classConnectReaSE.html#af9833933a3731687ff21cb3288fb5a14">00509</a> <span class="keywordtype">void</span> <a class="code" href="classConnectReaSE.html#af9833933a3731687ff21cb3288fb5a14" title="Gathers all needed edge router information of a specified autonomous system.">ConnectReaSE::setUpAS</a>(cModule* currAS)
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     cTopology edgeTopo(<span class="stringliteral">&quot;Edges&quot;</span>);
<a name="l00513"></a>00513     cTopology Topo(<span class="stringliteral">&quot;All nodes&quot;</span>);
<a name="l00514"></a>00514     <a class="code" href="structtopologyProperty.html">topologyProperty</a>* tempProp = <span class="keyword">new</span> <a class="code" href="structtopologyProperty.html">topologyProperty</a>;
<a name="l00515"></a>00515     cModule* tempNode;
<a name="l00516"></a>00516     uint32 tempIP;
<a name="l00517"></a>00517     <a class="code" href="structedgeRoutes.html">edgeRoutes</a> tempEdge;
<a name="l00518"></a>00518     <a class="code" href="structautoSystem.html">autoSystem</a> tempAS;
<a name="l00519"></a>00519     <span class="keywordtype">int</span> k;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     tempProp-&gt;<a class="code" href="structtopologyProperty.html#a698757c69affe4b1f784eab4985f0e85">pModule</a> = currAS;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     tempProp-&gt;<a class="code" href="structtopologyProperty.html#a1c2bc020bd4d7a8f08473988ac523e80">property</a> = <span class="stringliteral">&quot;EdgeRouter&quot;</span>;
<a name="l00525"></a>00525     edgeTopo.extractFromNetwork(<a class="code" href="classConnectReaSE.html#ad06fadd6babf16d663b1d3353fb5675b" title="Finds submodules with special properties.">extractFromParentModule</a>, (<span class="keywordtype">void</span>*) tempProp);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     tempProp-&gt;property = <span class="stringliteral">&quot;RL&quot;</span>;
<a name="l00528"></a>00528     Topo.extractFromNetwork(<a class="code" href="classConnectReaSE.html#ad06fadd6babf16d663b1d3353fb5675b" title="Finds submodules with special properties.">extractFromParentModule</a>, (<span class="keywordtype">void</span>*) tempProp);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="comment">//get net shift for IP address</span>
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a> = 1;
<a name="l00533"></a>00533     <span class="keywordflow">while</span> ((1 &lt;&lt; <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a>) &lt; edgeTopo.getNumNodes() + 2) {
<a name="l00534"></a>00534         <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a>++;
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536     tempAS.<a class="code" href="structautoSystem.html#a9af673be4fcdbada7561a6e41fd58ec9">edgeShift</a> = <a class="code" href="classConnectReaSE.html#a2d261fb5254b0bc82c37604338a35d04">ASShift</a> - <a class="code" href="classConnectReaSE.html#af855b1db424af57f7b18b186d8da7d1f">nextPow</a>;
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     <span class="comment">// add information about edge router</span>
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; edgeTopo.getNumNodes(); i++) {
<a name="l00541"></a>00541 
<a name="l00542"></a>00542         tempEdge.<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a> = edgeTopo.getNode(i)-&gt;getModule();
<a name="l00543"></a>00543         tempEdge.<a class="code" href="structedgeRoutes.html#af3ed267ce08be24bcf462bc73d65710c" title="the IP Address">IPAddress</a> = IPAddressResolver().addressOf(tempEdge.<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>).get4().getInt();
<a name="l00544"></a>00544         tempEdge.<a class="code" href="structedgeRoutes.html#a7fa36c1eb55617b5c9b33e37870e2ba6" title="the IP Addresses in use of edge router">IPAddresses</a>.push_back(IPAddressResolver().addressOf(tempEdge.<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>).get4().getInt());
<a name="l00545"></a>00545         tempEdge.<a class="code" href="structedgeRoutes.html#ae1e6d1225b81f330cf5ee3d493865b57" title="pointer to interface table of this node">interfaceTable</a> = IPAddressResolver().interfaceTableOf(tempEdge.<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>);
<a name="l00546"></a>00546         tempEdge.<a class="code" href="structedgeRoutes.html#aefa548eb16e3c9b5b599be88877eaf16" title="pointer to routing table of this node">routingTable</a> = IPAddressResolver().routingTableOf(tempEdge.<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548         k = 0;
<a name="l00549"></a>00549         <span class="keywordflow">while</span> ( tempEdge.<a class="code" href="structedgeRoutes.html#a613f4036d30841f3415625d1d1d2c5e4">Router</a>-&gt;findSubmodule(<span class="stringliteral">&quot;ppp&quot;</span>, k) != -1 )
<a name="l00550"></a>00550             k++;
<a name="l00551"></a>00551         tempEdge.<a class="code" href="structedgeRoutes.html#ada7ec401234d5ce01ae2a01788e477c2">countPPPInterfaces</a> = k;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553         <span class="comment">// the last allocated IP is the router address plus the (k - 1) connected ReaSE hosts</span>
<a name="l00554"></a>00554         tempEdge.<a class="code" href="structedgeRoutes.html#a69edfe9d308bc604b82af49f3082837f" title="last assigned IP address FIXME: check overlays for side effects of reused IP addresses">lastIP</a> = tempEdge.<a class="code" href="structedgeRoutes.html#af3ed267ce08be24bcf462bc73d65710c" title="the IP Address">IPAddress</a> + k - 1; <span class="comment">// FIXME: check overlays for side effects of reused IP addresses</span>
<a name="l00555"></a>00555 
<a name="l00556"></a>00556         <span class="comment">// find hosts</span>
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         Topo.calculateUnweightedSingleShortestPathsTo(Topo.getNodeFor(edgeTopo.getNode(i)-&gt;getModule()));
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt; Topo.getNumNodes(); j++) {
<a name="l00561"></a>00561             tempNode = Topo.getNode(j)-&gt;getModule();
<a name="l00562"></a>00562             <span class="keywordflow">if</span> (tempNode-&gt;getProperties()-&gt;get(<span class="stringliteral">&quot;CoreRouter&quot;</span>))
<a name="l00563"></a>00563                 <span class="keywordflow">continue</span>;
<a name="l00564"></a>00564             <span class="keywordflow">if</span> (tempNode-&gt;getProperties()-&gt;get(<span class="stringliteral">&quot;GatewayRouter&quot;</span>))
<a name="l00565"></a>00565                 <span class="keywordflow">continue</span>;
<a name="l00566"></a>00566             <span class="keywordflow">if</span> (tempNode-&gt;getProperties()-&gt;get(<span class="stringliteral">&quot;EdgeRouter&quot;</span>))
<a name="l00567"></a>00567                 <span class="keywordflow">continue</span>;
<a name="l00568"></a>00568             <span class="keywordflow">if</span> (Topo.getNode(j)-&gt;getPath(0)-&gt;getRemoteNode()-&gt;getModule() != edgeTopo.getNode(i)-&gt;getModule())
<a name="l00569"></a>00569                 <span class="keywordflow">continue</span>;
<a name="l00570"></a>00570 
<a name="l00571"></a>00571             <span class="comment">//fill IP table</span>
<a name="l00572"></a>00572             tempIP = IPAddressResolver().addressOf(Topo.getNode(j)-&gt;getModule()).get4().getInt();
<a name="l00573"></a>00573             tempEdge.<a class="code" href="structedgeRoutes.html#a7fa36c1eb55617b5c9b33e37870e2ba6" title="the IP Addresses in use of edge router">IPAddresses</a>.push_back(tempIP);
<a name="l00574"></a>00574         }
<a name="l00575"></a>00575 
<a name="l00576"></a>00576         tempAS.<a class="code" href="structautoSystem.html#afe33fc2285be428f35ab6c22ce376fe3">edgeRouter</a>.push_back(tempEdge);
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keyword">delete</span> tempProp;
<a name="l00580"></a>00580     <a class="code" href="classConnectReaSE.html#ac663a8011432b547c603d65d2fdf2573">AS_Pool</a>.push_back(tempAS);
<a name="l00581"></a>00581 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="ConnectReaSE_8cc.html">ConnectReaSE.cc</a>      </li>

    <li class="footer">Generated on Thu Mar 6 2014 14:06:27 for OverSim by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
